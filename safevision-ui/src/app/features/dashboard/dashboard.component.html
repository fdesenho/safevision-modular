<div class="dashboard-wrapper">

  <header class="dashboard-header">
    <div class="logo-area">
      <h1>ğŸ‘ï¸ SafeVision Monitor</h1>
    </div>

    <div class="user-info">
      <span>OlÃ¡, <strong>{{ auth.currentUser()?.username }}</strong></span>
      <button class="btn-logout" (click)="auth.logout()">Sair</button>
    </div>
  </header>

  <main class="dashboard-grid">

    <section class="left-panel">
      <div class="card video-card">
        <div class="card-header-row">
          <h3>Monitoramento Ativo</h3>
        </div>

        <div class="system-control">
          <div class="status-indicator" [class.active]="isSystemArmed()">
            Status: <strong>{{ isSystemArmed() ? 'PROTEÃ‡ÃƒO ATIVA' : 'STANDBY' }}</strong>
          </div>
          <button
            class="btn-toggle"
            [class.active]="isSystemArmed()"
            (click)="toggleSystem()">
            {{ isSystemArmed() ? 'ğŸ›‘ DESATIVAR' : 'ğŸ›¡ï¸ ATIVAR PROTEÃ‡ÃƒO' }}
          </button>
        </div>

        <div class="video-container">

          <div *ngIf="isVideoLoading() && !isVideoError()" class="video-status loading">
            <p>âŒ› Conectando Ã  cÃ¢mera...</p>
          </div>

          <div *ngIf="isVideoError()" class="video-status error">
            <p>ğŸ”´ CÃ¢mera Offline ou Vision Agent desligado.</p>
            <button (click)="retryVideo()">Tentar Novamente</button>
          </div>

          <img
            *ngIf="videoSrc()"
            [src]="videoSrc()"
            alt="Feed de VÃ­deo"
            (load)="onVideoLoad()"
            (error)="onVideoError()"
            [style.display]="(isVideoLoading() || isVideoError()) ? 'none' : 'block'"
          >
        </div>
      </div>

      <div class="card config-card">
        <h4>âš™ï¸ Configurar Agente</h4>

        <form [formGroup]="configForm" (ngSubmit)="saveConfig()">
          <div class="form-group">
            <label>Nova URL da CÃ¢mera</label>
            <input formControlName="cameraUrl" placeholder="http://192.168..." />
          </div>
          <div class="form-group">
            <label>Telefone para Alerta</label>
            <input formControlName="phone" placeholder="+55 11..." />
          </div>

          <button type="submit" class="btn-save">
            Salvar e Reiniciar Agente
          </button>
        </form>
      </div>
    </section>

    <section class="right-panel">
      <div class="alerts-header">
        <h3>Ãšltimos Alertas</h3>
        <button class="btn-refresh" (click)="forceRefresh()" title="Atualizar">ğŸ”„</button>
      </div>

      <div class="alerts-container">

        <div
          *ngFor="let alert of alerts()"
          class="alert-card"
          [class.critical]="alert.severity === 'CRITICAL'"
          [class.warning]="alert.severity === 'WARNING'"
        >
          <div class="alert-header">
            <strong class="alert-type">{{ alert.alertType }}</strong>
            <span class="badge" [ngClass]="alert.severity">{{ alert.severity }}</span>
          </div>

          <p class="alert-desc">{{ alert.description }}</p>

          <div *ngIf="alert.snapshotUrl" class="evidence-box">
            <img [src]="alert.snapshotUrl" alt="Foto da AmeaÃ§a" class="evidence-img">
          </div>
          <div class="alert-footer">
            <small>{{ alert.createdAt | date:'short' }}</small>
            <button *ngIf="!alert.acknowledged" (click)="ack(alert.id)" class="btn-ack">
              Marcar como Lido
            </button>
            <span *ngIf="alert.acknowledged" class="read-status">âœ… Lido</span>
          </div>
        </div>

        <div *ngIf="alerts().length === 0" class="empty-state">
          Nenhum alerta registrado.
        </div>
      </div>
    </section>

  </main>
</div>
