<mat-toolbar color="primary" class="dashboard-toolbar">
  <span class="brand">üëÅÔ∏è SafeVision</span>
  <span class="spacer"></span>

  <div class="user-info">
    <span class="username">Ol√°, {{ auth.currentUser()?.username }}</span>
    <button mat-icon-button (click)="auth.logout()" matTooltip="Sair do Sistema">
      <mat-icon>logout</mat-icon>
    </button>
  </div>
</mat-toolbar>

<div class="dashboard-content">

  <div class="panel-left">
    <mat-card class="video-card">

      <mat-card-header>
        <mat-card-title>Monitoramento em Tempo Real</mat-card-title>

        <div class="status-badge" [class.online]="isCameraActive()">
          <div class="indicator"></div>
          <span>{{ isCameraActive() ? 'ONLINE' : 'OFFLINE' }}</span>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="video-wrapper">

          @if (isCameraActive() && videoStreamUrl()) {
            <img
              [src]="videoStreamUrl()"
              alt="Feed de V√≠deo"
              class="live-feed"
              (error)="onVideoError()"
            >
          }

          @else if (isLoading() && !isCameraActive()) {
            <div class="overlay loading">
              <mat-spinner diameter="50" color="accent"></mat-spinner>
              <p>Conectando a c√¢mera...</p>
            </div>
          }

          @else {
            <div class="overlay offline">
              <mat-icon class="large-icon">videocam_off</mat-icon>
              <h3>Sistema Desativado</h3>
              <p>Clique em "ATIVAR" para iniciar o Monitoramento.</p>
            </div>
          }
        </div>
      </mat-card-content>

      <mat-card-actions align="end" class="control-actions">

		<button
		          mat-stroked-button
		          color="warn"
		          (click)="toggleSystem(false)"
		          [disabled]="!isCameraActive() || isLoading()">
		            @if (isLoading() && isCameraActive()) {
		                <mat-spinner diameter="20" color="warn"></mat-spinner>
		            } @else {
		                <span class="btn-label">
		                    <mat-icon>stop_circle</mat-icon>
		                    <span>DESATIVAR</span>
		                </span>
		            }
		        </button>

		        <button
		          mat-flat-button
		          color="primary"
		          (click)="toggleSystem(true)"
		          [disabled]="isCameraActive() || isLoading()">
		            @if (isLoading() && !isCameraActive()) {
		                <mat-spinner diameter="20" color="accent"></mat-spinner>
		            } @else {
		                <span class="btn-label">
		                    <mat-icon>play_circle</mat-icon>
		                    <span>ATIVAR</span>
		                </span>
		            }
		        </button>

      </mat-card-actions>
    </mat-card>
  </div>

  <div class="panel-right">
    <div class="alerts-header">
      <h2>üö® √öltimos Alertas</h2>
      <button mat-icon-button (click)="loadAlerts()" matTooltip="Atualizar lista">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>

    <div class="alerts-list">
      @for (alert of alerts(); track alert.id) {
        <mat-card class="alert-item" [class.critical]="alert.severity === 'CRITICAL'">

          <div class="alert-row">
            <div class="alert-icon">
                <mat-icon [class.warn-icon]="alert.severity === 'CRITICAL'">
                    {{ alert.severity === 'CRITICAL' ? 'warning' : 'info' }}
                </mat-icon>
            </div>

            <div class="alert-content">
                <div class="alert-top">
                    <span class="type">{{ alert.alertType }}</span>
                    <span class="time">{{ alert.createdAt | date:'HH:mm:ss' }}</span>
                </div>

                <p class="desc">{{ alert.description }}</p>

                @if (alert.snapshotUrl) {
                    <div class="evidence-wrapper">
                        <img [src]="alert.snapshotUrl" alt="Evid√™ncia" loading="lazy">
                    </div>
                }
            </div>

            <div class="alert-action">
                @if (alert.acknowledged) {
                    <mat-icon class="check-icon" matTooltip="Lido">check_circle</mat-icon>
                } @else {
                    <button mat-icon-button color="primary" (click)="ack(alert.id)" matTooltip="Marcar como lido">
                        <mat-icon>mark_email_read</mat-icon>
                    </button>
                }
            </div>
          </div>

        </mat-card>
      }
      @empty {
        <div class="empty-state">
          <mat-icon>notifications_none</mat-icon>
          <p>Tudo seguro. Nenhum alerta recente.</p>
        </div>
      }
    </div>
  </div>

</div>
