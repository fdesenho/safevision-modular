<app-header></app-header>
<div class="dashboard-content">

  <div class="panel-left">
    <mat-card class="video-card">

      <mat-card-header>
        <mat-card-title>Monitoramento em Tempo Real</mat-card-title>

        <div class="status-badge" [class.online]="isCameraActive()">
          <div class="indicator"></div>
          <span>{{ isCameraActive() ? 'ONLINE' : 'OFFLINE' }}</span>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="video-wrapper">

          @if (isCameraActive() && videoStreamUrl()) {
            <img
              [src]="videoStreamUrl()"
              alt="TransmissÃ£o ao Vivo"
              class="live-feed"
              (error)="onVideoError()"
            >
          }

          @else if (isLoading() && !isCameraActive()) {
            <div class="overlay loading">
              <mat-spinner diameter="50" color="accent"></mat-spinner>
              <p>Conectando Ã  cÃ¢mera...</p>
            </div>
          }

          @else {
            <div class="overlay offline">
              <mat-icon class="large-icon">videocam_off</mat-icon>
              <h3>Sistema Desativado</h3>
              <p>Clique em "ATIVAR" para iniciar o monitoramento.</p>
            </div>
          }
        </div>
      </mat-card-content>

      <mat-card-actions align="end" class="control-actions">
        <button
          mat-stroked-button
          color="warn"
          (click)="toggleSystem(false)"
          [disabled]="!isCameraActive() || isLoading()">
            @if (isLoading() && isCameraActive()) {
                <mat-spinner diameter="20" color="warn"></mat-spinner>
            } @else {
                <span class="btn-label">
                    <mat-icon>stop_circle</mat-icon>
                    <span>DESATIVAR</span>
                </span>
            }
        </button>

        <button
          mat-flat-button
          color="primary"
          (click)="toggleSystem(true)"
          [disabled]="isCameraActive() || isLoading()">
            @if (isLoading() && !isCameraActive()) {
                <mat-spinner diameter="20" color="accent"></mat-spinner>
            } @else {
                <span class="btn-label">
                    <mat-icon>play_circle</mat-icon>
                    <span>ATIVAR</span>
                </span>
            }
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <div class="panel-right">
	<div class="alerts-header">
	      <h2>ðŸš¨ Ãšltimos Alertas</h2>
	      
	      <div class="actions">
			
			
			  <button mat-icon-button (click)="goToHistory()" matTooltip="Ver histÃ³rico completo">
		            <mat-icon>event_note</mat-icon>
	          </button>
	          <button mat-icon-button (click)="loadAlerts()" matTooltip="Atualizar lista">
	            <mat-icon>refresh</mat-icon>
	          </button>
	      </div>
	    </div>

    <div class="alerts-list">
      @for (alert of alerts(); track alert.id) {
        <mat-card class="alert-item" [class.critical]="alert.severity === 'CRITICAL'">

          <div class="alert-row">
            <div class="alert-icon">
                <mat-icon [class.warn-icon]="alert.severity === 'CRITICAL'">
                    {{ alert.severity === 'CRITICAL' ? 'warning' : 'info' }}
                </mat-icon>
            </div>

            <div class="alert-content">
                <div class="alert-top">
                    <span class="type">{{ alert.alertType }}</span>
                    <span class="time">{{ alert.createdAt | date:'HH:mm:ss' }}</span>
                </div>

                <p class="desc">{{ alert.description }}</p>

                @if (alert.snapshotUrl) {
                    <div class="evidence-wrapper">
                        <img [src]="alert.snapshotUrl" alt="EvidÃªncia" loading="lazy">
                    </div>
                }

                @if (alert.latitude && alert.longitude) {
                    <div class="geo-tag-bar">
                        <div class="coords-info">
                            <mat-icon>place</mat-icon>
                            @if (alert.address) {
                                <span class="address-text" [matTooltip]="alert.address">{{ alert.address }}</span>
                            } @else {
                                <span class="raw-coords">{{ alert.latitude | number:'1.4-4' }}, {{ alert.longitude | number:'1.4-4' }}</span>
                            }
                        </div>
						
                        <button mat-stroked-button color="accent" class="btn-map-small" (click)="openLocation(alert)">
                            LocalizaÃ§Ã£o
                        </button>
                    </div>
                }
            </div>

            <div class="alert-action">
                @if (alert.acknowledged) {
                    <mat-icon class="check-icon" matTooltip="Lido">check_circle</mat-icon>
                } @else {
                    <button mat-icon-button color="primary" (click)="ack(alert.id)" matTooltip="Marcar como lido">
                        <mat-icon>mark_email_read</mat-icon>
                    </button>
                }
            </div>
          </div>

        </mat-card>
      }
      @empty {
        <div class="empty-state">
          <mat-icon>notifications_none</mat-icon>
          <p>Tudo seguro. Nenhum alerta recente.</p>
        </div>
      }
    </div>
  </div>

</div>