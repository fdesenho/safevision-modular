This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
alert-service/Dockerfile
alert-service/pom.xml
alert-service/src/main/java/com/safevision/alertservice/AlertServiceApplication.java
alert-service/src/main/java/com/safevision/alertservice/client/AlertPreferenceClient.java
alert-service/src/main/java/com/safevision/alertservice/config/EmailProperties.java
alert-service/src/main/java/com/safevision/alertservice/config/FeignGlobalConfig.java
alert-service/src/main/java/com/safevision/alertservice/config/JwtProperties.java
alert-service/src/main/java/com/safevision/alertservice/config/RabbitMQConfig.java
alert-service/src/main/java/com/safevision/alertservice/config/RabbitQueueProperties.java
alert-service/src/main/java/com/safevision/alertservice/config/SecurityConfig.java
alert-service/src/main/java/com/safevision/alertservice/config/TelegramProperties.java
alert-service/src/main/java/com/safevision/alertservice/config/TelephonyProperties.java
alert-service/src/main/java/com/safevision/alertservice/config/WebSocketConfig.java
alert-service/src/main/java/com/safevision/alertservice/controller/AlertController.java
alert-service/src/main/java/com/safevision/alertservice/dto/AlertEventDTO.java
alert-service/src/main/java/com/safevision/alertservice/dto/AlertResponse.java
alert-service/src/main/java/com/safevision/alertservice/dto/UserContactDTO.java
alert-service/src/main/java/com/safevision/alertservice/listener/AlertListener.java
alert-service/src/main/java/com/safevision/alertservice/model/Alert.java
alert-service/src/main/java/com/safevision/alertservice/repository/AlertRepository.java
alert-service/src/main/java/com/safevision/alertservice/service/AlertService.java
alert-service/src/main/java/com/safevision/alertservice/service/EmailAlertService.java
alert-service/src/main/java/com/safevision/alertservice/service/GeocodingService.java
alert-service/src/main/java/com/safevision/alertservice/service/TelegramService.java
alert-service/src/main/java/com/safevision/alertservice/service/TelephonyService.java
alert-service/src/main/resources/application.yml
auth-service/Dockerfile
auth-service/pom.xml
auth-service/src/main/java/com/safevision/authservice/AuthServiceApplication.java
auth-service/src/main/java/com/safevision/authservice/config/GlobalExceptionHandler.java
auth-service/src/main/java/com/safevision/authservice/config/InternalKeyFilter.java
auth-service/src/main/java/com/safevision/authservice/config/JwtProperties.java
auth-service/src/main/java/com/safevision/authservice/config/SecurityConfig.java
auth-service/src/main/java/com/safevision/authservice/controller/AlertPreferenceController.java
auth-service/src/main/java/com/safevision/authservice/controller/AuthController.java
auth-service/src/main/java/com/safevision/authservice/dto/LoginRequest.java
auth-service/src/main/java/com/safevision/authservice/dto/RegisterRequest.java
auth-service/src/main/java/com/safevision/authservice/dto/TokenResponse.java
auth-service/src/main/java/com/safevision/authservice/dto/UserContactDTO.java
auth-service/src/main/java/com/safevision/authservice/dto/UserProfileDTO.java
auth-service/src/main/java/com/safevision/authservice/dto/UserResponse.java
auth-service/src/main/java/com/safevision/authservice/dto/UserUpdateRequest.java
auth-service/src/main/java/com/safevision/authservice/model/AlertPreference.java
auth-service/src/main/java/com/safevision/authservice/model/User.java
auth-service/src/main/java/com/safevision/authservice/repository/AlertPreferenceRepository.java
auth-service/src/main/java/com/safevision/authservice/repository/UserRepository.java
auth-service/src/main/java/com/safevision/authservice/service/AlertPreferenceService.java
auth-service/src/main/java/com/safevision/authservice/service/AuthenticationService.java
auth-service/src/main/java/com/safevision/authservice/service/JwtService.java
auth-service/src/main/java/com/safevision/authservice/service/UserService.java
auth-service/src/main/resources/application.yml
auth-service/src/main/resources/db/migration/V2__create_alert_preferences.sql
common/pom.xml
common/src/main/java/com/safevision/common/enums/AlertType.java
docker-compose.yml
eureka-server/Dockerfile
eureka-server/pom.xml
eureka-server/src/main/java/com/safevision/eurekaserver/EurekaServerApplication.java
eureka-server/src/main/resources/application.yml
gateway-service/Dockerfile
gateway-service/pom.xml
gateway-service/src/main/java/com/safevision/gatewayservice/config/CorsGlobalConfig.java
gateway-service/src/main/java/com/safevision/gatewayservice/config/JwtProperties.java
gateway-service/src/main/java/com/safevision/gatewayservice/config/SecurityConfig.java
gateway-service/src/main/java/com/safevision/gatewayservice/controller/FallbackController.java
gateway-service/src/main/java/com/safevision/gatewayservice/GatewayServiceApplication.java
gateway-service/src/main/java/com/safevision/gatewayservice/routes/GatewayRoutes.java
gateway-service/src/main/resources/application.yml
pom.xml
recognition-service/Dockerfile
recognition-service/pom.xml
recognition-service/src/main/java/com/safevision/recognitionservice/config/JwtProperties.java
recognition-service/src/main/java/com/safevision/recognitionservice/config/RabbitMQConfig.java
recognition-service/src/main/java/com/safevision/recognitionservice/config/RabbitQueueProperties.java
recognition-service/src/main/java/com/safevision/recognitionservice/config/SecurityConfig.java
recognition-service/src/main/java/com/safevision/recognitionservice/controller/RecognitionController.java
recognition-service/src/main/java/com/safevision/recognitionservice/dto/AlertEventDTO.java
recognition-service/src/main/java/com/safevision/recognitionservice/dto/RawTrackingEvent.java
recognition-service/src/main/java/com/safevision/recognitionservice/facade/TrackingWorkflowFacade.java
recognition-service/src/main/java/com/safevision/recognitionservice/listener/VisionAgentListener.java
recognition-service/src/main/java/com/safevision/recognitionservice/producer/AlertProducer.java
recognition-service/src/main/java/com/safevision/recognitionservice/RecognitionServiceApplication.java
recognition-service/src/main/java/com/safevision/recognitionservice/service/MovementHistoryService.java
recognition-service/src/main/java/com/safevision/recognitionservice/service/ThreatAnalysisService.java
recognition-service/src/main/resources/application.yml
register.json
roadmap.txt
safevision-c4-architecture (5).svg
safevision-ui/.claude/CLAUDE.md
safevision-ui/.cursor/rules/cursor.mdc
safevision-ui/.editorconfig
safevision-ui/.gemini/GEMINI.md
safevision-ui/.github/copilot-instructions.md
safevision-ui/.gitignore
safevision-ui/.junie/guidelines.md
safevision-ui/.vscode/extensions.json
safevision-ui/.vscode/launch.json
safevision-ui/.vscode/tasks.json
safevision-ui/.windsurf/rules/guidelines.md
safevision-ui/AGENTS.md
safevision-ui/angular.json
safevision-ui/architectureDiagramMC4.md
safevision-ui/architectureDiagramMC4PVersionPT.md
safevision-ui/package.json
safevision-ui/public/favicon.ico
safevision-ui/public/how-to-create-software-system-architecture-diagrams-like-v0-zbjqpmaoh41a1.webp
safevision-ui/public/logo.jpeg
safevision-ui/public/logo2.png
safevision-ui/public/logo3.jpeg
safevision-ui/README.md
safevision-ui/src/app/app.config.server.ts
safevision-ui/src/app/app.config.ts
safevision-ui/src/app/app.html
safevision-ui/src/app/app.routes.server.ts
safevision-ui/src/app/app.routes.ts
safevision-ui/src/app/app.scss
safevision-ui/src/app/app.spec.ts
safevision-ui/src/app/app.ts
safevision-ui/src/app/core/guards/auth-guard.spec.ts
safevision-ui/src/app/core/guards/auth-guard.ts
safevision-ui/src/app/core/interceptors/auth-interceptor.spec.ts
safevision-ui/src/app/core/interceptors/auth-interceptor.ts
safevision-ui/src/app/core/interceptors/error.interceptor.ts
safevision-ui/src/app/core/interceptors/global-error.interceptor.ts
safevision-ui/src/app/core/models/app.models.ts
safevision-ui/src/app/core/models/app.models.ts.spec.ts
safevision-ui/src/app/core/services/alert.service.ts
safevision-ui/src/app/core/services/alert.spec.ts
safevision-ui/src/app/core/services/auth.service.ts
safevision-ui/src/app/core/services/auth.spec.ts
safevision-ui/src/app/core/services/notification.service.ts
safevision-ui/src/app/core/services/vision.service.ts
safevision-ui/src/app/core/services/websocket.service.ts
safevision-ui/src/app/features/alert-history/alert-history.component.html
safevision-ui/src/app/features/alert-history/alert-history.component.scss
safevision-ui/src/app/features/alert-history/alert-history.component.ts
safevision-ui/src/app/features/auth/login/login.component.html
safevision-ui/src/app/features/auth/login/login.component.scss
safevision-ui/src/app/features/auth/login/login.component.spec.ts
safevision-ui/src/app/features/auth/login/login.component.ts
safevision-ui/src/app/features/auth/register/register.component.html
safevision-ui/src/app/features/auth/register/register.component.scss
safevision-ui/src/app/features/auth/register/register.component.spec.ts
safevision-ui/src/app/features/auth/register/register.component.ts
safevision-ui/src/app/features/dashboard/dashboard.component.html
safevision-ui/src/app/features/dashboard/dashboard.component.scss
safevision-ui/src/app/features/dashboard/dashboard.component.ts
safevision-ui/src/app/features/settings/settings.html
safevision-ui/src/app/features/settings/settings.scss
safevision-ui/src/app/features/settings/settings.spec.ts
safevision-ui/src/app/features/settings/settings.ts
safevision-ui/src/app/features/user-profile-dialog/user-profile-dialog.component.html
safevision-ui/src/app/features/user-profile-dialog/user-profile-dialog.component.scss
safevision-ui/src/app/features/user-profile-dialog/user-profile-dialog.component.ts
safevision-ui/src/app/shared/components/header/header.component.html
safevision-ui/src/app/shared/components/header/header.component.scss
safevision-ui/src/app/shared/components/header/header.component.ts
safevision-ui/src/app/shared/components/image-preview-dialog/image-preview-dialog.component.ts
safevision-ui/src/app/shared/components/map_dialog/map-dialog.component.html
safevision-ui/src/app/shared/components/map_dialog/map-dialog.component.scss
safevision-ui/src/app/shared/components/map_dialog/map-dialog.component.ts
safevision-ui/src/app/shared/directives/phone-mask.directive.ts
safevision-ui/src/assets/bg-login.jpg
safevision-ui/src/environments/environment.development.ts
safevision-ui/src/environments/environment.ts
safevision-ui/src/index.html
safevision-ui/src/main.server.ts
safevision-ui/src/main.ts
safevision-ui/src/server.ts
safevision-ui/src/styles.scss
safevision-ui/tsconfig.app.json
safevision-ui/tsconfig.json
safevision-ui/tsconfig.spec.json
vision-agent/.gitignore
vision-agent/config.py
vision-agent/debug_sensors.py
vision-agent/detectors/__init__.py
vision-agent/detectors/gaze_detector.py
vision-agent/detectors/weapon_detector.py
vision-agent/Dockerfile
vision-agent/main.py
vision-agent/messaging.py
vision-agent/services/gps_service.py
vision-agent/storage.py
vision-agent/teste_websocket.py
vision-agent/utils.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="alert-service/src/main/java/com/safevision/alertservice/service/GeocodingService.java">
package com.safevision.alertservice.service;

import java.math.BigDecimal;
import java.util.concurrent.CompletableFuture;

import org.springframework.stereotype.Service;
import org.springframework.web.client.RestClient;

import com.fasterxml.jackson.databind.JsonNode;

import lombok.extern.slf4j.Slf4j;

/**
 * Service responsible for interacting with external Geocoding APIs (OpenStreetMap).
 * <p>
 * Design Principles:
 * 1. Asynchronous: Uses CompletableFuture to avoid blocking the main alert processing thread.
 * 2. Graceful Degradation: Returns null if the external API fails, ensuring the system stays up.
 * </p>
 */
@Slf4j
@Service
public class GeocodingService {

    private final RestClient restClient;

    public GeocodingService(RestClient.Builder builder) {
        // Initializes RestClient with the OSM base URL and mandatory User-Agent
        this.restClient = builder
            .baseUrl("https://nominatim.openstreetmap.org")
            .defaultHeader("User-Agent", "SafeVision-App/1.0 (contact@safevision.com)")
            .build();
    }

    /**
     * Performs an asynchronous reverse geocoding lookup.
     *
     * @param lat Latitude
     * @param lon Longitude
     * @return A CompletableFuture containing the human-readable address string, or null if failed.
     */
    public CompletableFuture<String> getAddressFromCoordinates(BigDecimal lat, BigDecimal lon) {
        if (lat == null || lon == null) {
            return CompletableFuture.completedFuture(null);
        }

        return CompletableFuture.supplyAsync(() -> {
            try {
                // Execute HTTP GET to Nominatim
                JsonNode response = restClient.get()
                    .uri(uriBuilder -> uriBuilder
                        .path("/reverse")
                        .queryParam("format", "jsonv2")
                        .queryParam("lat", lat.doubleValue()) 
                        .queryParam("lon", lon.doubleValue())
                        .queryParam("zoom", 18)
                        .build())
                    .retrieve()
                    .body(JsonNode.class);

                // Parse response
                if (response != null && response.has("display_name")) {
                    String fullAddress = response.get("display_name").asText();
                    
                    // Simplify address for better UI display (take first 3 components)
                    String[] parts = fullAddress.split(",");
                    if (parts.length >= 3) {
                         return parts[0] + ", " + parts[1] + ", " + parts[2];
                    }
                    return fullAddress;
                }
            } catch (Exception e) {
                // Log warning but do not throw exception to caller
                log.warn("üåç Geocoding failed for [{}, {}]: {}", lat, lon, e.getMessage());
            }
            return null;
        });
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/dto/UserProfileDTO.java">
package com.safevision.authservice.dto;

import com.safevision.common.enums.AlertType;
import java.util.List;

public record UserProfileDTO(
    String id,
    String username,
    String email,
    String phoneNumber,
    String cameraConnectionUrl,
    List<AlertType> alertPreferences
) {}
</file>

<file path="safevision-ui/src/app/features/alert-history/alert-history.component.html">
<app-header></app-header>

<div class="history-container">

  <div class="page-header">
    <div class="title-group">
        <button mat-icon-button (click)="goBack()" matTooltip="Voltar ao Dashboard">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <h1>Hist√≥rico de Alertas</h1>
    </div>

    <div class="stats-chip">

        <span>Total: <strong>{{ resultsLength }}</strong></span>
    </div>
  </div>

  <div class="table-wrapper mat-elevation-z8">

    @if (isLoading) {
      <div class="loading-shade">
        <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
      </div>
    }

    <table mat-table [dataSource]="dataSource" matSort matSortActive="createdAt" matSortDirection="asc" >

      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Data/Hora </th>
        <td mat-cell *matCellDef="let row">
            <span class="text-data">{{ row.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="severity">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> N√≠vel </th>
        <td mat-cell *matCellDef="let row">
            <div class="severity-badge" [class]="row.severity.toLowerCase()">
                <mat-icon class="badge-icon">
                    {{ row.severity === 'CRITICAL' ? 'warning' : 'info' }}
                </mat-icon>
                <span>{{ row.severity }}</span>
            </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="alertType">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Tipo </th>
        <td mat-cell *matCellDef="let row">
            <span class="type-text">{{ row.alertType }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="description">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Descri√ß√£o </th>
        <td mat-cell *matCellDef="let row">
            <span class="truncate-text" [matTooltip]="row.description">
                {{ row.description }}
            </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="cameraId">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> C√¢mera </th>
        <td mat-cell *matCellDef="let row">
            <code class="cam-badge">{{ row.cameraId }}</code>
        </td>
      </ng-container>

      <ng-container matColumnDef="address">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Localiza√ß√£o </th>
        <td mat-cell *matCellDef="let row">
            <div class="geo-cell">
                @if (row.latitude && row.longitude) {
                    <button mat-icon-button class="btn-map-friendly" (click)="openMap(row)" matTooltip="Abrir Mapa">
                        <mat-icon>place</mat-icon>
                    </button>
                    <span class="geo-text" [matTooltip]="row.address">
                        {{ row.address || 'Coordenadas GPS' }}
                    </span>
                } @else {
                    <mat-icon class="icon-disabled" matTooltip="Sem GPS">location_off</mat-icon>
                    <span class="geo-text disabled">Sem sinal GPS</span>
                }
            </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="snapshotUrl">
        <th mat-header-cell *matHeaderCellDef> Evid√™ncia </th>
        <td mat-cell *matCellDef="let row">
            @if (row.snapshotUrl) {
                <div class="thumb-wrapper" (click)="openImage(row)" matTooltip="Clique para ampliar">
                    <img [src]="row.snapshotUrl" alt="Snapshot" loading="lazy">
                </div>
            } @else {
                <span class="no-data">-</span>
            }
        </td>
      </ng-container>

      <ng-container matColumnDef="acknowledged">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
        <td mat-cell *matCellDef="let row">
            @if (row.acknowledged) {
                <div class="status-indicator success">
                    <mat-icon>verified</mat-icon>
                    <span>Verificado</span>
                </div>
            } @else {
                <div class="status-indicator pending clickable"
                     (click)="markAsRead(row, $event)"
                     matTooltip="Clique para marcar como lido">
                    <mat-icon>pending</mat-icon>
                    <span>Pendente</span>
                </div>
            }
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="element-row"></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="8">
           <div class="empty-state-wrapper">
               <mat-icon class="empty-icon">search_off</mat-icon>
               <p>Nenhum registro encontrado no hist√≥rico.</p>
           </div>
        </td>
      </tr>

    </table>

    <mat-paginator
        [length]="resultsLength"
        [pageSize]="10"
        [pageSizeOptions]="[5, 10, 20, 50]"
        showFirstLastButtons
        aria-label="Selecione a p√°gina">
    </mat-paginator>

  </div>
</div>
</file>

<file path="safevision-ui/src/app/features/alert-history/alert-history.component.scss">
/* Vari√°veis de Cores (Design System) */
$primary: #d63384;
$success: #2e7d32;
$warn: #f44336;
$info: #0288d1;
$dark-glass: rgba(30, 30, 30, 0.7);

.history-container {
    padding: 24px;
    max-width: 100%;
    margin: 0 auto;
    color: #fff;
    animation: fadeIn 0.4s ease-out;

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;

        .title-group {
            display: flex;
            align-items: center;
            gap: 12px;
            h1 { margin: 0; font-size: 1.8rem; font-weight: 300; letter-spacing: 0.5px; }
        }

        .stats {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
    }
}

.table-wrapper {
    position: relative;
    background: $dark-glass;
    backdrop-filter: blur(16px);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

table.alert-table {
    width: 100%;
    background: transparent;

    th.mat-header-cell {
        background: rgba(0, 0, 0, 0.5);
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 16px;
        white-space: nowrap;
    }

    td.mat-cell {
        color: rgba(255, 255, 255, 0.9);
        border-bottom-color: rgba(255, 255, 255, 0.05);
        padding: 8px 16px;
        font-size: 0.9rem;
        vertical-align: middle;
    }

    .table-row {
        transition: background 0.2s;
        &:hover { background: rgba(255, 255, 255, 0.05); }
    }
}

/* --- Colunas Espec√≠ficas --- */

/* 1. Address Wrapper (Icon + Text) */
.address-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: 280px;

    .addr-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .text-muted { opacity: 0.5; }
}

/* 2. Snapshot Image */
.img-thumb-container {
    width: 70px;
    height: 45px;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    background: #000;

    img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s;
        &:hover { transform: scale(1.1); }
    }
}

/* 3. Badges (Severity) */
.badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;

    .badge-icon { font-size: 16px; width: 16px; height: 16px; }

    &.critical { background: rgba($warn, 0.15); color: #ff8a80; border: 1px solid rgba($warn, 0.3); }
    &.warning { background: rgba(#ff9800, 0.15); color: #ffcc80; border: 1px solid rgba(#ff9800, 0.3); }
    &.info { background: rgba($info, 0.15); color: #81d4fa; border: 1px solid rgba($info, 0.3); }
}

/* 4. Status Chips */
.status-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;

    mat-icon { font-size: 18px; width: 18px; height: 18px; }

    &.success { color: #69f0ae; }
    &.pending { color: #ffab40; opacity: 0.8; }
}

/* Utilit√°rios */
.truncate-cell { display: block; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.8; }
.cam-code { font-family: 'Roboto Mono', monospace; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
.bold-text { font-weight: 600; }
.no-img { opacity: 0.3; font-size: 1.2rem; }

/* Loading & Empty States */
.loading-shade {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4); z-index: 10;
    display: flex; align-items: center; justify-content: center;
}

.empty-state {
    display: flex; flex-direction: column; align-items: center; gap: 12px; opacity: 0.6;
    mat-icon { font-size: 48px; width: 48px; height: 48px; }
    p { margin: 0; }
}

/* Paginator Dark Override */
::ng-deep .mat-mdc-paginator {
    background: transparent !important;
    color: #fff !important;
    border-top: 1px solid rgba(255,255,255,0.1);
    .mat-mdc-icon-button { color: rgba(255,255,255,0.9) !important; }
    .mat-mdc-select-value { color: #fff !important; }
}

.thumb-wrapper {
    /* 1. Definimos tamanhos FIXOS para a caixa da imagem */
    width: 80px;
    height: 50px;

    /* 2. Est√©tica para ficar bonito na tabela escura */
    border-radius: 6px;         /* Cantos arredondados */
    overflow: hidden;           /* Garante que a imagem respeite a borda redonda */
    border: 1px solid rgba(255, 255, 255, 0.25); /* Borda sutil para defini√ß√£o */
    cursor: pointer;            /* M√£ozinha para indicar clique */
    background: #1a1a1a;        /* Fundo escuro enquanto carrega */
    position: relative;         /* Para o alinhamento interno */
    margin: 4px 0;              /* Um pequeno respiro vertical na c√©lula */
    box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Sombra leve */

    /* 3. Comportamento da imagem dentro da caixa */
    img {
        width: 100%;
        height: 100%;
        /* O SEGREDO: 'cover' faz a imagem preencher a caixa sem distorcer, cortando excessos se necess√°rio */
        object-fit: cover;
        display: block;         /* Remove espa√ßos em branco indesejados abaixo da imagem */
        transition: transform 0.3s ease; /* Suaviza o efeito de zoom */
        opacity: 0.9;           /* Leve transpar√™ncia para integrar melhor */
    }

    /* 4. Efeito Hover (Zoom suave ao passar o mouse) */
    &:hover {
        border-color: rgba(255, 255, 255, 0.5); /* Real√ßa a borda */
        img {
            transform: scale(1.1); /* Zoom de 10% */
            opacity: 1;            /* Fica totalmente n√≠tida */
        }
    }


    /* --- CORES DE SEVERIDADE (N√çVEL) --- */
.severity-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;

    .badge-icon { font-size: 16px; width: 16px; height: 16px; }

    /* üî¥ CRITICAL: Vermelho Alerta Forte */
    &.critical {
        background: rgba(211, 47, 47, 0.2);
        color: #ff5252;
        border: 1px solid rgba(255, 82, 82, 0.4);
        box-shadow: 0 0 8px rgba(211, 47, 47, 0.3); /* Efeito de brilho */
    }

    /* üü† WARNING: Laranja */
    &.warning {
        background: rgba(255, 152, 0, 0.15);
        color: #ffb74d;
        border: 1px solid rgba(255, 152, 0, 0.3);
    }

    /* üîµ INFO: Azul */
    &.info {
        background: rgba(3, 169, 244, 0.15);
        color: #4fc3f7;
        border: 1px solid rgba(3, 169, 244, 0.3);
    }
}

/* --- BOT√ÉO DE MAPA AMIG√ÅVEL --- */
.btn-map-friendly {
    /* Um Azul Turquesa/Ciano √© "amig√°vel", tecnol√≥gico e lembra GPS */
    color: #40c4ff !important;

    &:hover {
        background-color: rgba(64, 196, 255, 0.15) !important;
        transform: scale(1.1); /* Leve zoom ao passar o mouse */
        transition: transform 0.2s ease;
    }

    mat-icon {
        font-size: 22px; /* √çcone levemente maior */
    }
}
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</file>

<file path="safevision-ui/src/app/features/alert-history/alert-history.component.ts">
import { Component, AfterViewInit, ViewChild, inject, DestroyRef, ChangeDetectorRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { merge, of } from 'rxjs';
import { startWith, switchMap, catchError, map, debounceTime } from 'rxjs/operators';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';

// Material Imports
import { MatTableModule } from '@angular/material/table';
import { MatPaginator, MatPaginatorModule } from '@angular/material/paginator';
import { MatSort, MatSortModule } from '@angular/material/sort';
import { MatIconModule } from '@angular/material/icon';
import { MatButtonModule } from '@angular/material/button';
import { MatTooltipModule } from '@angular/material/tooltip';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatDialog } from '@angular/material/dialog';

// Custom Imports
import { HeaderComponent } from '../../shared/components/header/header.component';
import { AlertService } from '../../core/services/alert.service';
import { AuthService } from '../../core/services/auth.service';
import { Alert } from '../../core/models/app.models';
import { MapDialogComponent } from '../../shared/components/map_dialog/map-dialog.component';
import { ImagePreviewDialogComponent } from '../../shared/components/image-preview-dialog/image-preview-dialog.component';
 // Verifique se a pasta √© map-dialog ou map_dialog

@Component({
  selector: 'app-alert-history',
  standalone: true,
  imports: [
    CommonModule,
    HeaderComponent,
    MatTableModule,
    MatPaginatorModule,
    MatSortModule,
    MatIconModule,
    MatButtonModule,
    MatTooltipModule,
    MatProgressSpinnerModule
  ],
  templateUrl: './alert-history.component.html',
  styleUrls: ['./alert-history.component.scss']
})
export class AlertHistoryComponent implements AfterViewInit {

  private alertService = inject(AlertService);
  private auth = inject(AuthService);
  private dialog = inject(MatDialog);
  private router = inject(Router);
  private destroyRef = inject(DestroyRef);
  private cdr = inject(ChangeDetectorRef);

  // ESTA ORDEM DEVE SER EXATAMENTE A MESMA DO HTML
  displayedColumns: string[] = [
    'createdAt',
    'severity',
    'alertType',
    'description',
    'cameraId',
    'address',
    'snapshotUrl',
    'acknowledged'
  ];

  dataSource: Alert[] = [];
  resultsLength = 0;
  isLoading = true;

  @ViewChild(MatPaginator) paginator!: MatPaginator;
  @ViewChild(MatSort) sort!: MatSort;

  ngAfterViewInit() {
      // Reseta pagina√ß√£o ao ordenar
      this.sort.sortChange.subscribe(() => this.paginator.pageIndex = 0);

      merge(this.sort.sortChange, this.paginator.page)
        .pipe(
          startWith({}),
          debounceTime(300), // Evita o erro AbortError e m√∫ltiplas chamadas
          switchMap(() => {
            this.isLoading = true;
            this.cdr.detectChanges();

            const user = this.auth.currentUser();

            // ‚ö†Ô∏è CORRE√á√ÉO CR√çTICA: Se seus alertas no banco t√™m userId="safe",
            // voc√™ TEM que buscar por username, n√£o ID.
            // Se quiser usar ID, ter√° que apagar o banco e recriar os alertas usando o UUID.
            const identifier = user?.username; // Mudado de user?.id para user?.username para teste

            if (!identifier) return of(null);

            return this.alertService.getAlertHistory(
              identifier,
              this.paginator.pageIndex,
              this.paginator.pageSize,
              this.sort.active,
              this.sort.direction
            ).pipe(catchError((err) => {
                console.error('Erro ao buscar hist√≥rico:', err);
                return of(null);
            }));
          }),
          map(data => {
            this.isLoading = false;
            if (data === null) return [];

            // üõ°Ô∏è BLINDAGEM DE JSON: Aceita os dois formatos (Novo e Antigo)
            // Se data.page existir (Novo Spring Boot), usa ele.
            // Se n√£o, tenta pegar totalElements da raiz (Antigo).
            if (data.page) {
                this.resultsLength = data.page.totalElements;
            } else if ('totalElements' in data) {
                // @ts-ignore
                this.resultsLength = data.totalElements;
            } else {
                this.resultsLength = 0;
            }

            return data.content || [];
          }),
          takeUntilDestroyed(this.destroyRef)
        )
        .subscribe(data => {
          this.dataSource = data;
          this.cdr.detectChanges();
        });
    }

  openMap(alert: Alert) {
    if (!alert.latitude || !alert.longitude) return;

    this.dialog.open(MapDialogComponent, {
      width: '800px',
      maxWidth: '95vw',
      panelClass: 'glass-dialog',
      data: {
        lat: alert.latitude,
        lng: alert.longitude,
        label: alert.alertType,
        timestamp: alert.createdAt,
        address: alert.address
      }
    });
  }

  goBack() {
    this.router.navigate(['/dashboard']);
  }
openImage(alert: Alert) {
    if (!alert.snapshotUrl) return;

    this.dialog.open(ImagePreviewDialogComponent, {
      maxWidth: '95vw',    // Ocupa quase toda a largura
      maxHeight: '95vh',   // Ocupa quase toda a altura
      height: 'auto',
      width: 'auto',
      panelClass: 'fullscreen-dialog', // Classe opcional para remover paddings padr√µes do Material
      backdropClass: 'blur-backdrop',  // Efeito de blur no fundo
      data: {
        imageUrl: alert.snapshotUrl,
        title: ` `,
        date: alert.createdAt
      }
    });
  }
  markAsRead(alert: Alert, event: Event) {
      // Evita que o clique propague (caso tenhamos clique na linha no futuro)
      event.stopPropagation();

      // Se j√° estiver lido, n√£o faz nada
      if (alert.acknowledged) return;

      // Chama o backend
      this.alertService.acknowledge(alert.id).subscribe({
        next: () => {
          // Atualiza o estado LOCALMENTE para feedback instant√¢neo
          alert.acknowledged = true;
          
          // For√ßa o Angular a redesenhar a tabela para mostrar o √≠cone verde
          this.cdr.detectChanges();
        },
        error: (err) => console.error('Erro ao marcar como lido', err)
      });
    }

}
</file>

<file path="safevision-ui/src/app/features/user-profile-dialog/user-profile-dialog.component.html">
<h2 mat-dialog-title>
  <div class="title-wrapper">
      <mat-icon class="title-icon">manage_accounts</mat-icon>
      Configura√ß√µes do Usu√°rio
  </div>
</h2>

<mat-dialog-content class="custom-scrollbar">
  @if (isLoading) {
    <mat-progress-bar mode="indeterminate" class="top-loader"></mat-progress-bar>
  }

  <form [formGroup]="profileForm" class="profile-form">

    <div class="info-text">
      Editando: <strong>{{ username }}</strong>
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>URL da C√¢mera (RTSP/HTTP)</mat-label>
      <input matInput formControlName="cameraConnectionUrl" placeholder="rtsp://192.168...">
      <mat-icon matSuffix>videocam</mat-icon>
    </mat-form-field>

    <div class="alert-selection-container">
        <label class="label-header">Canais de Notifica√ß√£o</label>
        <mat-chip-listbox aria-label="Sele√ß√£o de Alertas" multiple>
            @for (opt of alertOptions; track opt.value) {
            <mat-chip-option
                color="accent"
                [selected]="alertPreferencesControl.value.includes(opt.value)"
                (selectionChange)="toggleAlert(opt.value, $event.selected)">
                <mat-icon matChipAvatar>{{ opt.icon }}</mat-icon>
                {{ opt.label }}
            </mat-chip-option>
            }
        </mat-chip-listbox>
        <mat-hint class="chip-hint">Selecione onde deseja receber alertas</mat-hint>
    </div>


    <div class="row">
      <mat-form-field appearance="outline" class="half-width">
        <mat-label>E-mail *</mat-label>
        <input matInput formControlName="email" type="email">
        <mat-icon matSuffix>email</mat-icon>
        @if (profileForm.get('email')?.hasError('required')) {
            <mat-error>E-mail √© obrigat√≥rio</mat-error>
        }
        @if (profileForm.get('email')?.hasError('email')) {
            <mat-error>E-mail inv√°lido</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="half-width">
        <mat-label>Celular *</mat-label>
        <input matInput formControlName="phoneNumber" type="tel" appPhoneMask placeholder="+55 48 99999-9999">
        <mat-icon matSuffix>smartphone</mat-icon>
        @if (profileForm.get('phoneNumber')?.hasError('required')) {
            <mat-error>Celular √© obrigat√≥rio</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="password-section">
        <mat-form-field appearance="outline" class="full-width warn-field">
            <mat-label>Nova Senha</mat-label>
            <input matInput formControlName="password" type="password" autocomplete="new-password" placeholder="Preencha apenas se quiser alterar">
            <mat-icon matSuffix>lock</mat-icon>
            @if (profileForm.get('password')?.hasError('minlength')) {
                <mat-error>M√≠nimo de 6 caracteres</mat-error>
            }
        </mat-form-field>

        @if (profileForm.get('password')?.value) {
            <mat-form-field appearance="outline" class="full-width warn-field animation-fade">
                <mat-label>Confirmar Nova Senha</mat-label>
                <input matInput formControlName="confirmPassword" type="password" placeholder="Repita a nova senha">
                <mat-icon matSuffix>lock_reset</mat-icon>
            </mat-form-field>

            @if (profileForm.hasError('mismatch') && profileForm.get('confirmPassword')?.touched) {
                <div class="password-error">
                    <mat-icon>error_outline</mat-icon>
                    As senhas n√£o coincidem
                </div>
            }
        }
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button mat-dialog-close [disabled]="isLoading">Cancelar</button>
  <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="profileForm.invalid || isLoading">
    Salvar Altera√ß√µes
  </button>
</mat-dialog-actions>
</file>

<file path="safevision-ui/src/app/features/user-profile-dialog/user-profile-dialog.component.scss">
@use "sass:color";

/* ============================================================
   DESIGN SYSTEM (Baseado no RegisterComponent)
   ============================================================ */
$primary: #d63384;
$accent: #00bcd4;
$error-text: #ff5252;
$glass-bg: rgba(23, 23, 23, 0.95); // Fundo s√≥lido para modal

/* ============================================================
   LAYOUT
   ============================================================ */

:host {
    display: block;
    background: $glass-bg;
    color: #fff;
}

.title-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.4rem;
    font-weight: 300;
}

.top-loader {
    position: absolute;
    top: 0; left: 0; right: 0;
    z-index: 10;
}

.profile-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-top: 10px;
    min-width: 450px;
}

.info-text {
    margin-bottom: 8px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);

    strong { color: $primary; }
}

.full-width {
    width: 100%;
}

.row {
    display: flex;
    gap: 16px;
    .half-width { flex: 1; }
}

/* ============================================================
   CHIPS SECTION (Igual Register)
   ============================================================ */
.alert-selection-container {
    margin: 8px 0 16px 0;
    padding: 12px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);

    .label-header {
        display: block;
        margin-bottom: 10px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        font-weight: 500;
    }

    .chip-hint {
        display: block;
        margin-top: 8px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.4);
    }
}

// Anima√ß√£o para o campo do Telegram
.telegram-field {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ============================================================
   MATERIAL OVERRIDES (Estilo Dark/Glass)
   ============================================================ */

::ng-deep .mat-mdc-form-field {
    .mdc-text-field--filled {
        background-color: rgba(255, 255, 255, 0.05) !important;
        border-radius: 8px;
    }

    .mdc-text-field__input {
        color: #fff !important;
        caret-color: $primary !important;
    }

    .mdc-floating-label { color: rgba(255, 255, 255, 0.6) !important; }
    .mdc-floating-label--float-above { color: $primary !important; }
    .mat-icon { color: rgba(255, 255, 255, 0.7); }

    .mdc-line-ripple::before { border-bottom-color: rgba(255, 255, 255, 0.3) !important; }
    .mdc-line-ripple::after { border-bottom-color: $primary !important; }
}

// Estilo para o campo de senha (aviso sutil)
.warn-field {
    margin-top: 8px;
    .mat-icon { color: #ffb74d !important; }
}

/* Mobile */
@media (max-width: 600px) {
    .profile-form { min-width: auto; }
    .row { flex-direction: column; gap: 0; }
}


// ... estilos anteriores ...

.password-section {
    display: flex;
    flex-direction: column;
}

.password-error {
    color: #ff5252;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 15px;
    margin-left: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(255, 82, 82, 0.1);
    padding: 8px;
    border-radius: 6px;

    mat-icon {
        font-size: 16px;
        height: 16px;
        width: 16px;
    }
}

.animation-fade {
    animation: fadeIn 0.3s ease-out;
}
</file>

<file path="safevision-ui/src/app/features/user-profile-dialog/user-profile-dialog.component.ts">
import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, FormGroup, ReactiveFormsModule, Validators, FormControl } from '@angular/forms';
import { MatDialogRef, MatDialogModule } from '@angular/material/dialog';
import { MatButtonModule } from '@angular/material/button';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatInputModule } from '@angular/material/input';
import { MatIconModule } from '@angular/material/icon';
import { MatSnackBar } from '@angular/material/snack-bar';
import { MatProgressBarModule } from '@angular/material/progress-bar';
import { MatChipsModule } from '@angular/material/chips';

// Imports do Projeto
import { AuthService } from '../../core/services/auth.service';
import { AlertType, UserUpdateRequest } from '../../core/models/app.models';
import { PhoneMaskDirective } from '../../shared/directives/phone-mask.directive';



@Component({
  selector: 'app-user-profile-dialog',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    MatDialogModule,
    MatButtonModule,
    MatFormFieldModule,
    MatInputModule,
    MatIconModule,
    MatChipsModule,
    MatProgressBarModule,
    PhoneMaskDirective // üìç Adicione aqui
  ],
  templateUrl: './user-profile-dialog.component.html',
  styleUrls: ['./user-profile-dialog.component.scss']
})
export class UserProfileDialogComponent implements OnInit {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private snackBar = inject(MatSnackBar);
  public dialogRef = inject(MatDialogRef<UserProfileDialogComponent>);

  profileForm: FormGroup;
  isLoading = false;
  username: string = '';

  alertOptions = [
    { label: 'Telegram', value: AlertType.TELEGRAM, icon: 'send' },
    { label: 'E-mail', value: AlertType.EMAIL, icon: 'email' },
    { label: 'SMS', value: AlertType.SMS, icon: 'sms' }
  ];

  constructor() {
    this.profileForm = this.fb.group({
      email: ['', [Validators.required, Validators.email]], // üìç Obrigat√≥rio
      phoneNumber: ['', [Validators.required]],             // üìç Obrigat√≥rio
      telegramChatId: [''],
      cameraConnectionUrl: [''],

      // Senha e Confirma√ß√£o
      password: ['', [Validators.minLength(6)]],
      confirmPassword: [''],

      alertPreferences: [[]]
    }, { validators: this.passwordMatchValidator }); // üìç Validador de grupo
  }

  get alertPreferencesControl(): FormControl {
    return this.profileForm.get('alertPreferences') as FormControl;
  }

  // üìç L√≥gica de Valida√ß√£o de Senha
  // S√≥ exige confirma√ß√£o se o campo 'password' estiver preenchido
  passwordMatchValidator(g: FormGroup) {
    const pass = g.get('password')?.value;
    const confirm = g.get('confirmPassword')?.value;

    // Se senha estiver vazia, n√£o valida nada (usu√°rio n√£o quer mudar)
    if (!pass) return null;

    // Se senha tem valor, confirma√ß√£o deve ser igual
    return pass === confirm ? null : { mismatch: true };
  }

  ngOnInit(): void {
    const currentUser = this.authService.currentUser();
    if (currentUser) {
      this.username = currentUser.username;
      this.loadFullUserData(this.username);
    }
  }

  toggleAlert(value: AlertType, isChecked: boolean) {
    const currentValues = this.alertPreferencesControl.value as AlertType[];
    if (isChecked) {
      if (!currentValues.includes(value)) {
        this.alertPreferencesControl.setValue([...currentValues, value]);
      }
    } else {
      this.alertPreferencesControl.setValue(currentValues.filter(item => item !== value));
    }
    this.alertPreferencesControl.markAsTouched();
  }

  loadFullUserData(username: string) {
    this.isLoading = true;
    this.profileForm.disable();

    this.authService.getUserProfile(username).subscribe({
      next: (profile) => {
        this.profileForm.patchValue({
          email: profile.email,
          phoneNumber: profile.phoneNumber,
          cameraConnectionUrl: profile.cameraConnectionUrl,
          alertPreferences: profile.alertPreferences || []
        });
        this.isLoading = false;
        this.profileForm.enable();
      },
      error: (err) => {
        console.error(err);
        this.snackBar.open('Erro ao carregar dados do perfil.', 'Fechar');
        this.isLoading = false;
        this.profileForm.enable();
      }
    });
  }

  onSubmit() {
    if (this.profileForm.invalid) return;

    this.isLoading = true;
    this.profileForm.disable();

    // üìç Remove confirmPassword e telegramChatId (se backend n√£o suportar ainda)
    // Extra√≠mos apenas o que o DTO UserUpdateRequest espera
    const { confirmPassword, telegramChatId, ...formData } = this.profileForm.value;

    const updateData: UserUpdateRequest = {
      email: formData.email,
      phoneNumber: formData.phoneNumber,
      cameraConnectionUrl: formData.cameraConnectionUrl,
      password: formData.password || null,
      alertPreferences: formData.alertPreferences
    };

    this.authService.updateUser(updateData).subscribe({
      next: () => {
        this.snackBar.open('Perfil atualizado com sucesso!', 'OK', { duration: 3000 });
        this.dialogRef.close(true);
      },
      error: () => {
        
        this.isLoading = false;
        this.profileForm.enable();
      }
    });
  }
}
</file>

<file path="safevision-ui/src/app/shared/components/header/header.component.html">
<mat-toolbar color="primary" class="app-header">
  
  <span class="brand" (click)="goHome()" matTooltip="Ir para Dashboard">
    üëÅÔ∏è SafeVision
  </span>

  <span class="spacer"></span>

  <div class="user-info">
    <span class="username">Ol√°, {{ auth.currentUser()?.username }}</span>
    
    <button mat-icon-button (click)="openProfileSettings()" matTooltip="Configura√ß√µes de Perfil">
        <mat-icon>manage_accounts</mat-icon>
    </button>

    <div class="divider"></div>

    <button mat-icon-button (click)="auth.logout()" matTooltip="Sair" color="warn">
      <mat-icon>logout</mat-icon>
    </button>
  </div>

</mat-toolbar>
</file>

<file path="safevision-ui/src/app/shared/components/header/header.component.scss">
/* Header Component Styles */

// Toolbar fixa e transl√∫cida
.app-header {
  position: sticky;
  top: 0;
  z-index: 1000; // Alto z-index para ficar sobre mapas e v√≠deos
  background: rgba(0, 0, 0, 0.6) !important;
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
  display: flex;
  align-items: center;
  height: 64px;
  padding: 0 24px;

  .brand {
    font-weight: 700;
    letter-spacing: 1px;
    font-size: 1.2rem;
    cursor: pointer; // Indica que √© clic√°vel
    transition: opacity 0.2s;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;

    &:hover {
      opacity: 0.8;
    }
  }

  .spacer {
    flex: 1 1 auto;
  }

  .user-info {
    display: flex;
    align-items: center;
    
    .username {
        margin-right: 12px;
        font-size: 0.95rem;
        color: #fff;
        font-weight: 600;
        
        // Esconde o nome em telas muito pequenas (mobile)
        @media (max-width: 600px) {
            display: none;
        }
    }
	
	.divider {
	          width: 1px;
	          height: 24px;
	          background: rgba(255,255,255,0.2);
	          margin: 0 8px;
  	}
	
    button {
        color: rgba(255, 255, 255, 0.9);
        &:hover { color: #f44336; } // Vermelho ao passar o mouse (Logout)
    }
  }
}
</file>

<file path="safevision-ui/src/app/shared/components/header/header.component.ts">
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';

// Material Imports
import { MatToolbarModule } from '@angular/material/toolbar';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';
import { MatTooltipModule } from '@angular/material/tooltip';
import { MatDialog, MatDialogModule } from '@angular/material/dialog';

// Components & Services
import { AuthService } from '../../../core/services/auth.service';
import { UserProfileDialogComponent } from '../../../features/user-profile-dialog/user-profile-dialog.component';

@Component({
  selector: 'app-header',
  standalone: true,
  imports: [
    CommonModule,
    MatToolbarModule,
    MatButtonModule,
    MatIconModule,
    MatTooltipModule,
    MatDialogModule
  ],
  templateUrl: './header.component.html',
  styleUrls: ['./header.component.scss']
})
export class HeaderComponent {
  public auth = inject(AuthService);
  private router = inject(Router);
  private dialog = inject(MatDialog);

  goHome() {
    this.router.navigate(['/dashboard']);
  }

  openProfileSettings() {
    // 1. Guarda a refer√™ncia do Dialog aberto
    const dialogRef = this.dialog.open(UserProfileDialogComponent, {
      width: '500px',
      panelClass: 'glass-dialog',
      disableClose: true, // Obriga usar bot√£o de a√ß√£o
      autoFocus: false
    });


    dialogRef.afterClosed().subscribe(result => {
      window.location.reload();

    });
  }
}
</file>

<file path="safevision-ui/src/app/shared/components/image-preview-dialog/image-preview-dialog.component.ts">
import { Component, Inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { MAT_DIALOG_DATA, MatDialogRef, MatDialogModule } from '@angular/material/dialog';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';

@Component({
  selector: 'app-image-preview-dialog',
  standalone: true,
  imports: [CommonModule, MatDialogModule, MatButtonModule, MatIconModule],
  template: `
    <div class="preview-container">
      <div class="header-overlay">
        <span class="title">{{ data.title }}</span>
        <button mat-icon-button (click)="close()" class="close-btn">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="image-wrapper">
        <img [src]="data.imageUrl" [alt]="data.title">
      </div>

      <div class="footer-overlay">
        {{ data.date | date:'dd/MM/yyyy HH:mm:ss' }}
      </div>
    </div>
  `,
  styles: [`
    .preview-container {
      position: relative;
      background: #000;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-radius: 8px; /* Combina com o Glassmorphism */
    }

    .header-overlay {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: 12px 16px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
      color: #fff;

      .title { font-weight: 500; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
      .close-btn { color: #fff; background: rgba(255,255,255,0.1); }
    }

    .image-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px; /* Margem para a imagem n√£o colar na borda */

      img {
        max-width: 100%;
        max-height: 85vh; /* Garante que caiba na tela sem scroll */
        object-fit: contain; /* MANT√âM PROPOR√á√ÉO E RESOLU√á√ÉO */
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        border-radius: 4px;
      }
    }

    .footer-overlay {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      padding: 12px;
      text-align: center;
      color: rgba(255,255,255,0.7);
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      font-size: 0.85rem;
    }
  `]
})
export class ImagePreviewDialogComponent {
  constructor(
    public dialogRef: MatDialogRef<ImagePreviewDialogComponent>,
    @Inject(MAT_DIALOG_DATA) public data: { imageUrl: string; title: string; date: string }
  ) {}

  close(): void {
    this.dialogRef.close();
  }
}
</file>

<file path="safevision-ui/src/app/shared/components/map_dialog/map-dialog.component.html">
<div class="map-container-wrapper">
  <div class="map-header">
    <h3><mat-icon>location_on</mat-icon> Localiza√ß√£o da Amea√ßa</h3>
    
    <div class="location-details">
        @if (data.address) {
            <span class="main-loc">{{ data.address }}</span>
        }
        <span class="sub-loc">Lat: {{data.lat | number:'1.5-5'}} | Lon: {{data.lng | number:'1.5-5'}}</span>
    </div>
  </div>
  
  <div id="leaflet-map" class="leaflet-map"></div>

  <div class="map-footer">
    <span class="time">Ocorr√™ncia: {{data.timestamp | date:'medium'}}</span>
    <button mat-stroked-button (click)="close()">FECHAR MAPA</button>
  </div>
</div>
</file>

<file path="safevision-ui/src/app/shared/components/map_dialog/map-dialog.component.scss">
// Cores Locais (Idealmente viriam de um arquivo de vari√°veis globais)
$dialog-bg: #1e1e1e;
$header-bg: rgba(255, 255, 255, 0.05);
$border-color: rgba(255, 255, 255, 0.1);
$text-color: #fff;
$accent-color: #8282FF;

.map-container-wrapper {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: $dialog-bg;
  color: $text-color;
}

.map-header {
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: $header-bg;
  border-bottom: 1px solid $border-color;
  
  h3 { 
    margin: 0; 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    font-size: 1.1rem; 
  }
}

.location-details {
  display: flex;
  flex-direction: column;
  text-align: right;
  
  .main-loc { 
    font-weight: bold; 
    color: $text-color; 
    font-size: 0.95rem; 
  }
  
  .sub-loc { 
    font-family: monospace; 
    font-size: 0.8rem; 
    opacity: 0.7; 
    color: $accent-color; 
  }
}

.leaflet-map {
  height: 450px;
  width: 100%;
  background: #000;
  z-index: 1; // Garante que o mapa fique no contexto correto de empilhamento
}

.map-footer {
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top: 1px solid $border-color;
  
  .time { 
    opacity: 0.6; 
    font-size: 0.85rem; 
  }
}
</file>

<file path="safevision-ui/src/app/shared/components/map_dialog/map-dialog.component.ts">
import { Component, Inject, AfterViewInit, ChangeDetectionStrategy, PLATFORM_ID } from '@angular/core';
import { CommonModule, isPlatformBrowser } from '@angular/common'; // üëà Importante para SSR
import { MAT_DIALOG_DATA, MatDialogRef, MatDialogModule } from '@angular/material/dialog';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';



/**
 * Interface defining the data passed to the Map Modal.
 */
export interface MapDialogData {
  lat: number;
  lng: number;
  label: string;
  timestamp: string;
  address?: string;
}

@Component({
  selector: 'app-map-dialog',
  standalone: true,
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [CommonModule, MatDialogModule, MatButtonModule, MatIconModule],
  templateUrl: './map-dialog.component.html',
  styleUrls: ['./map-dialog.component.scss']
})
export class MapDialogComponent implements AfterViewInit {
  private map: any;

  constructor(
    public dialogRef: MatDialogRef<MapDialogComponent>,
    @Inject(MAT_DIALOG_DATA) public data: MapDialogData,
    @Inject(PLATFORM_ID) private platformId: Object // üëà Inje√ß√£o para verificar a plataforma
  ) {}

  ngAfterViewInit(): void {
    // üõ°Ô∏è GUARDA SSR: S√≥ executa se estiver no Navegador
    if (isPlatformBrowser(this.platformId)) {
      // Pequeno timeout para garantir que o DOM do modal renderizou
      setTimeout(() => this.initMap(), 100);
    }
  }

  private async initMap(): Promise<void> {
    if (!this.data.lat || !this.data.lng) return;

    // üöÄ IMPORTA√á√ÉO DIN√ÇMICA
    // O Leaflet s√≥ ser√° carregado aqui, dentro do navegador, evitando o erro "window is not defined".
    const L = await import('leaflet');

    // Nota: Como estamos dentro de um modal, precisamos garantir que o container existe
    const mapContainer = document.getElementById('leaflet-map');
    if (!mapContainer) return;

    this.map = L.map('leaflet-map', {
      center: [this.data.lat, this.data.lng],
      zoom: 15
    });

    // Dark Mode Tiles (CartoDB)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(this.map);

    // Visual Circle
    L.circle([this.data.lat, this.data.lng], {
        color: '#d63384',
        fillColor: '#d63384',
        fillOpacity: 0.2,
        radius: 100
    }).addTo(this.map);

    // Precise Marker
    L.circleMarker([this.data.lat, this.data.lng], {
      radius: 8,
      fillColor: '#8282FF',
      color: '#fff',
      weight: 2,
      opacity: 1,
      fillOpacity: 1
    }).addTo(this.map)
    .bindPopup(`<b>${this.data.label}</b><br>${this.data.address || 'Endere√ßo desconhecido'}`)
    .openPopup();
  }

  close() {
    this.dialogRef.close();
  }
}
</file>

<file path="safevision-ui/src/app/shared/directives/phone-mask.directive.ts">
import { Directive, HostListener, ElementRef } from '@angular/core';

@Directive({
  selector: '[appPhoneMask]',
  standalone: true
})
export class PhoneMaskDirective {

  constructor(private el: ElementRef) {}

  @HostListener('input', ['$event'])
  onInputChange(event: any) {
    const input = event.target;
    let value = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero

    // Limita tamanho (DDI + DDD + 9 d√≠gitos) = 13 d√≠gitos max
    if (value.length > 13) {
      value = value.substring(0, 13);
    }

    // Aplica a formata√ß√£o: +55 48 99999-9999
    if (value.length === 0) {
      input.value = '';
    } else if (value.length <= 2) {
      input.value = `+${value}`;
    } else if (value.length <= 4) {
      input.value = `+${value.substring(0, 2)} ${value.substring(2)}`;
    } else if (value.length <= 9) {
      input.value = `+${value.substring(0, 2)} ${value.substring(2, 4)} ${value.substring(4)}`;
    } else {
      input.value = `+${value.substring(0, 2)} ${value.substring(2, 4)} ${value.substring(4, 9)}-${value.substring(9)}`;
    }
  }
}
</file>

<file path="vision-agent/debug_sensors.py">
import requests
import time

# SEU IP
IP = "192.168.0.132:4747"
URL_SENSORS = f"http://{IP}/sensors.json"
URL_ENABLE = f"http://{IP}/enable_sensor?id=gps"

def diagnostico():
    print(f"üîç Investigando {IP}...")

    # 1. Tenta ativar o GPS via comando
    try:
        requests.get(URL_ENABLE, timeout=2)
        print("‚û°Ô∏è Comando de ativa√ß√£o enviado.")
    except:
        print("‚ùå Falha ao conectar para ativar sensor.")

    time.sleep(1)

    # 2. L√™ o JSON cru
    try:
        response = requests.get(URL_SENSORS, timeout=2)
        data = response.json()
        
        print("\nüìã SENSORES DISPON√çVEIS NO JSON:")
        print("-" * 30)
        
        # Lista todas as chaves (sensores) encontrados
        chaves = list(data.keys())
        if not chaves:
            print("‚ö†Ô∏è O JSON est√° vazio! Verifique 'Enable data logging' no App.")
        
        for sensor in chaves:
            print(f"  ‚Ä¢ {sensor}")
            
        print("-" * 30)

        # 3. Verifica especificamente o GPS
        if 'gps' in data:
            print("‚úÖ GPS ENCONTRADO!")
            gps_data = data['gps'].get('data', [])
            if gps_data:
                print(f"üìä Dados brutos: {gps_data[-1]}")
            else:
                print("‚ö†Ô∏è Campo 'gps' existe, mas a lista de dados est√° vazia (Aguardando sat√©lite).")
        else:
            print("‚ùå GPS N√ÉO EST√Å NO JSON.")
            print("   Solu√ß√£o: V√° no App -> Data logging -> Enable data logging.")

    except Exception as e:
        print(f"‚ùå Erro fatal: {e}")

if __name__ == "__main__":
    diagnostico()
</file>

<file path="vision-agent/services/gps_service.py">
import threading
import time
import requests
from urllib.parse import urlparse

class GPSService:
    _instance = None
    _lock = threading.Lock()

    def __new__(cls, *args, **kwargs):
        if not cls._instance:
            with cls._lock:
                if not cls._instance:
                    cls._instance = super(GPSService, cls).__new__(cls)
        return cls._instance

    def __init__(self):
        if getattr(self, '_initialized', False): return
        
        # üëá MUDAN√áA: Inicia com coordenadas de Floripa (Fallback) ao inv√©s de 0.0
        # Ponte Herc√≠lio Luz
        self.current_latitude = -27.5954
        self.current_longitude = -48.5640
        
        self.running = False
        self.gps_thread = None
        self.sensor_url = None 
        self.enable_url = None
        
        self._initialized = True
        print(f"üõ∞Ô∏è [GPS Service] Initialized. Default Location: Florian√≥polis (Fallback active)")

    def start(self):
        if not self.running:
            self.running = True
            self.gps_thread = threading.Thread(target=self._poll_gps_api, daemon=True)
            self.gps_thread.start()

    def stop(self):
        self.running = False
        if self.gps_thread:
            self.gps_thread.join(timeout=1.0)

    def set_target_from_camera_url(self, camera_url: str):
        try:
            parsed = urlparse(camera_url)
            base_url = f"{parsed.scheme}://{parsed.netloc}"
            self.sensor_url = f"{base_url}/sensors.json"
            self.enable_url = f"{base_url}/enable_sensor?id=gps" 
            self._force_enable_gps()
        except Exception as e:
            print(f"‚ùå [GPS] URL Error: {e}")

    def _force_enable_gps(self):
        if self.enable_url:
            try: requests.get(self.enable_url, timeout=1.0)
            except: pass

    def get_coordinates(self):
        return self.current_latitude, self.current_longitude

    def _poll_gps_api(self):
        while self.running:
            if not self.sensor_url:
                time.sleep(2.0)
                continue

            try:
                response = requests.get(self.sensor_url, timeout=2.0)
                if response.status_code == 200:
                    data = response.json()
                    
                    # Se n√£o tem GPS, tenta ativar
                    if 'gps' not in data:
                        self._force_enable_gps()
                    else:
                        # Se tem GPS, atualiza as coordenadas reais
                        self._parse_ipwebcam_data(data)
            except:
                pass # Mant√©m as coordenadas anteriores (ou o default de Floripa)
            
            time.sleep(1.0)

    def _parse_ipwebcam_data(self, data):
        try:
            gps_node = data.get('gps')
            if gps_node and 'data' in gps_node and len(gps_node['data']) > 0:
                latest = gps_node['data'][-1]
                coords = latest[1]
                if len(coords) >= 2:
                    lat, lon = float(coords[0]), float(coords[1])
                    if lat != 0.0:
                        self.current_latitude = lat
                        self.current_longitude = lon
                        # print(f"üìç GPS REAL DETECTADO: {lat}, {lon}")
        except:
            pass
</file>

<file path="alert-service/Dockerfile">
FROM eclipse-temurin:21-jdk
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/client/AlertPreferenceClient.java">
package com.safevision.alertservice.client;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import com.safevision.common.enums.AlertType;
import java.util.List;


@FeignClient(name = "auth-service", path = "/auth")
public interface AlertPreferenceClient {

    
    @GetMapping("/alert-preferences/{username}")
    List<AlertType> getPreferences(@PathVariable("username") String username);
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/EmailProperties.java">
package com.safevision.alertservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

@ConfigurationProperties(prefix = "app.email")
public record EmailProperties(
    String fromAddress,
    boolean enabled
) {}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/FeignGlobalConfig.java">
package com.safevision.alertservice.config;

import feign.RequestInterceptor;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * Global configuration for OpenFeign Clients.
 * <p>
 * This class is responsible for injecting cross-cutting concerns into
 * outgoing HTTP requests made by Feign Clients.
 * </p>
 * <p>
 * It specifically handles Service-to-Service authentication by injecting
 * a shared internal secret key into the request headers.
 * </p>
 */
@Slf4j
@Configuration
@RequiredArgsConstructor
@EnableConfigurationProperties(JwtProperties.class)
public class FeignGlobalConfig {

    private static final String INTERNAL_AUTH_HEADER = "X-Internal-Key";

    private final JwtProperties jwtProperties;

    /**
     * Creates a global RequestInterceptor for all Feign Clients.
     * <p>
     * This interceptor automatically appends the {@code X-Internal-Key} header
     * to every outgoing request, allowing the Auth Service to recognize
     * this service as a trusted internal component.
     * </p>
     *
     * @return The configured {@link RequestInterceptor}.
     */
    @Bean
    public RequestInterceptor internalKeyInterceptor() {
        log.info("Initializing Feign Internal Key Interceptor with header: {}", INTERNAL_AUTH_HEADER);

        return template -> {
            String secretKey = jwtProperties.secret();

            if (secretKey == null || secretKey.isBlank()) {
                log.warn("Internal JWT Secret is missing! Service-to-Service calls may fail with 401.");
            }

            // Using trace/debug level to avoid leaking sensitive data in production logs
            log.trace("Injecting internal authentication header for request to: {}", template.url());

            template.header(INTERNAL_AUTH_HEADER, secretKey);
        };
    }
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/JwtProperties.java">
package com.safevision.alertservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Type-safe configuration properties for JWT settings.
 * Maps properties starting with "safevision.jwt" from application.yml.
 *
 * @param secret The shared secret key used for HMAC signature.
 */
@ConfigurationProperties(prefix = "safevision.jwt")
public record JwtProperties(String secret) {}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/TelegramProperties.java">
package com.safevision.alertservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

@ConfigurationProperties(prefix = "telegram")
public record TelegramProperties(
    String botToken, 
    String chatId,   
    boolean enabled  
) {}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/TelephonyProperties.java">
package com.safevision.alertservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Configuration Record for Telephony settings (Twilio).
 * Replaces scattered @Value annotations with a type-safe object.
 */
@ConfigurationProperties(prefix = "telephony")
public record TelephonyProperties(
    String accountSid,
    String authToken,
    String fromNumber,
    String toNumber, // Fallback number
    String baseUrl
) {}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/dto/UserContactDTO.java">
package com.safevision.alertservice.dto;

/**
 * Data Transfer Object (DTO) representing User Contact Information.
 * <p>
 * This record is used to transport user details (specifically contact info like phone and email)
 * fetched from the **Auth Service** to be used by the **Alert Service** for notifications (Twilio/Email).
 * </p>
 *
 * @param id          The unique UUID of the user.
 * @param username    The user's login username.
 * @param phoneNumber The user's mobile number (formatted for Twilio, e.g., +55...).
 * @param email       The user's email address for notifications.
 */
public record UserContactDTO(
    String id,
    String username,
    String phoneNumber,
    String email
) {}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/service/EmailAlertService.java">
package com.safevision.alertservice.service;

import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestClient;
import org.springframework.web.client.RestTemplate;

import com.safevision.alertservice.config.EmailProperties;
import com.safevision.alertservice.dto.AlertEventDTO;
import com.safevision.alertservice.dto.UserContactDTO;

import jakarta.mail.internet.MimeMessage;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@EnableConfigurationProperties(EmailProperties.class)
public class EmailAlertService {

    private final JavaMailSender mailSender;
    private final EmailProperties props;
    private final RestTemplate restTemplate;
    private final RestClient authServiceClient;
    
    
    
    public EmailAlertService(JavaMailSender mailSender, 
    		EmailProperties props, 
    		RestTemplate restTemplate,
    		RestClient.Builder authServiceClient) {
		this.mailSender=mailSender;
    	this.restTemplate=restTemplate;
		this.props = props;
		this.authServiceClient = authServiceClient.baseUrl("http://auth-service:8080").build();
	}


    public void sendHtmlAlert(AlertEventDTO event) {
        if (!props.enabled()) return;

        try {
            log.info("üìß Preparing email for event: {}", event.alertType());

            MimeMessage message = mailSender.createMimeMessage();
            // true = multipart (permite anexos)
            MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8"); 

            helper.setFrom(props.fromAddress());
            helper.setTo( resolveUserEmail(event.userId()));
            helper.setSubject("üö® SafeVision Alerta: " + event.alertType());

            // Corpo HTML
            String htmlContent = """
                <html>
                <body style="font-family: Arial, sans-serif;">
                    <h2 style="color: #d32f2f;">‚ö†Ô∏è Detec√ß√£o de Amea√ßa Identificada</h2>
                    <p><strong>Tipo:</strong> %s</p>
                    <p><strong>Severidade:</strong> %s</p>
                    <p><strong>C√¢mera:</strong> %s</p>
                    <p><strong>Descri√ß√£o:</strong> %s</p>
                    <hr>
                    <p><em>Verifique o painel administrativo imediatamente.</em></p>
                </body>
                </html>
                """.formatted(event.alertType(), event.severity(), event.cameraId(), event.description());

            helper.setText(htmlContent, true); // true = isHtml

            // Anexar Imagem (Se existir)
            if (event.snapshotUrl() != null && !event.snapshotUrl().isEmpty()) {
                try {
                    byte[] imageBytes = restTemplate.getForObject(event.snapshotUrl(), byte[].class);
                    if (imageBytes != null) {
                        helper.addAttachment("evidence_snapshot.jpg", new ByteArrayResource(imageBytes));
                    }
                } catch (Exception imgEx) {
                    log.warn("Falha ao baixar imagem para o email: {}", imgEx.getMessage());
                }
            }

            mailSender.send(message);
            log.info("‚úÖ Email sent successfully.");

        } catch (Exception e) {
            log.error("‚ùå Failed to send email: {}", e.getMessage());
        }
    }
    private String resolveUserEmail(String username) {
        try {
            var contact = authServiceClient.get()
                    .uri("/auth/contact/{username}", username)
                    .retrieve()
                    .body(UserContactDTO.class);

            if (contact != null && contact.email() != null) {
                return contact.email();
            }
        } catch (Exception e) {
            log.warn("‚ö†Ô∏è Could not fetch user contact from Auth Service: {}. Using fallback.", e.getMessage());
        }
        return null;
        
        
    }
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/service/TelegramService.java">
package com.safevision.alertservice.service;

import com.safevision.alertservice.config.TelegramProperties;
import com.safevision.alertservice.dto.AlertEventDTO;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;

@Slf4j
@Service
@RequiredArgsConstructor
@EnableConfigurationProperties(TelegramProperties.class)
public class TelegramService {

    private final TelegramProperties props;
    private final RestTemplate restTemplate;

    private static final String API_URL_TEMPLATE = "https://api.telegram.org/bot%s/%s";
    private static final String DOCKER_INTERNAL_HOST = "minio";
    private static final String EXTERNAL_HOST = "localhost";

    /**
     * Main entry point. Decides strategy (Photo vs Text) based on payload.
     *
     * @param event The alert event containing detection data.
     */
    public void sendAlert(AlertEventDTO event) {
    	
    	if (!props.enabled()) return;

        if (hasValidSnapshot(event)) {
            sendPhotoAlert(event);
        } else {
            sendTextAlert(event);
        }
    }

    /**
     * Orchestrates the complex flow of sending an image:
     * 1. Resolve internal URL (Docker networking)
     * 2. Download image
     * 3. Build Multipart Request
     * 4. Send to Telegram
     * <p>
     * Falls back to text message on any failure.
     */
    private void sendPhotoAlert(AlertEventDTO event) {
        try {
            String internalUrl = resolveDockerUrl(event.snapshotUrl());
            byte[] imageBytes = downloadImage(internalUrl);

            var requestEntity = buildMultipartRequest(event, imageBytes);
            String telegramApiUrl = getApiUrl("sendPhoto");

            restTemplate.postForObject(telegramApiUrl, requestEntity, String.class);
            log.info("‚úÖ Telegram Photo sent successfully.");

        } catch (Exception e) {
            log.error("‚ùå Failed to send photo ({}). Falling back to text.", e.getMessage());
            sendTextAlert(event);
        }
    }

    /**
     * Sends a simple text-only alert.
     */
    private void sendTextAlert(AlertEventDTO event) {
        try {
            
            String text = """
                üö® <b>SAFEVISION ALERT</b> üö®
                ‚ö†Ô∏è <b>Type:</b> %s
                üìç <b>Cam:</b> %s
                üìù <b>Info:</b> %s
                """.formatted(event.alertType(), event.cameraId(), event.description());

            var payload = new LinkedMultiValueMap<String, Object>();
            payload.add("chat_id", props.chatId());
            payload.add("text", text);
            payload.add("parse_mode", "HTML"); // <--- MUDAN√áA IMPORTANTE

            restTemplate.postForObject(getApiUrl("sendMessage"), payload, String.class);
            log.info("‚úÖ Telegram Text sent.");
        } catch (Exception e) {
            log.error("‚ùå Failed to send Telegram text: {}", e.getMessage());
        }
    }
    // ==================================================================================
    // PRIVATE HELPER METHODS (Low-Level Logic)
    // ==================================================================================

    /**
     * Solves the Docker Networking issue.
     * Replaces 'localhost' (browser friendly) with 'minio' (container friendly).
     */
    private String resolveDockerUrl(String url) {
        if (url == null) return "";
        return url.contains(EXTERNAL_HOST) 
                ? url.replace(EXTERNAL_HOST, DOCKER_INTERNAL_HOST) 
                : url;
    }

    /**
     * Downloads the image bytes from the Storage Service.
     * Throws exception if download fails, triggering the fallback.
     */
    private byte[] downloadImage(String url) {
        log.debug("‚¨áÔ∏è Downloading evidence from: {}", url);
        byte[] bytes = restTemplate.getForObject(url, byte[].class);
        
        if (bytes == null || bytes.length == 0) {
            throw new IllegalStateException("Downloaded image is empty");
        }
        return bytes;
    }

    /**
     * Constructs the HTTP Multipart request required by Telegram API for file uploads.
     */
    private HttpEntity<MultiValueMap<String, Object>> buildMultipartRequest(AlertEventDTO event, byte[] imageBytes) {
        var imageResource = new ByteArrayResource(imageBytes) {
            @Override
            public String getFilename() {
                return "evidence_" + System.currentTimeMillis() + ".jpg";
            }
        };

        var headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);

        var body = new LinkedMultiValueMap<String, Object>();
        body.add("chat_id", props.chatId());
        body.add("photo", imageResource);
        
        // --- CORRE√á√ÉO AQUI: MUDAMOS PARA HTML ---
        // Usamos <b> para negrito. O underscore do WEAPON_DETECTED n√£o vai mais quebrar.
        String caption = "üö® <b>ALERT:</b> %s | üì∏ Evidence".formatted(event.alertType());
        
        body.add("caption", caption);
        body.add("parse_mode", "HTML"); // <--- MUDAN√áA IMPORTANTE

        return new HttpEntity<>(body, headers);
    }

    private String getApiUrl(String method) {
        return API_URL_TEMPLATE.formatted(props.botToken(), method);
    }

    private boolean hasValidSnapshot(AlertEventDTO event) {
        return event.snapshotUrl() != null && !event.snapshotUrl().isBlank();
    }
}
</file>

<file path="auth-service/Dockerfile">
FROM eclipse-temurin:21-jdk
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/config/GlobalExceptionHandler.java">
package com.safevision.authservice.config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

/**
 * Global exception handler for the Auth Service.
 * Centralizes error handling logic to ensure consistent API responses.
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    private static final String AUTH_ERROR_MESSAGE = "Invalid username or password.";

    /**
     * Handles generic runtime exceptions (usually business logic violations).
     * Returns 400 Bad Request.
     */
    @ExceptionHandler(RuntimeException.class)
    public ResponseEntity<ErrorResponse> handleRuntimeException(RuntimeException ex) {
        log.warn("‚ö†Ô∏è Business Logic Error: {}", ex.getMessage());
        
        return ResponseEntity
                .status(HttpStatus.BAD_REQUEST)
                .body(new ErrorResponse(ex.getMessage()));
    }

    /**
     * Handles security/authentication exceptions.
     * Returns 401 Unauthorized.
     */
    @ExceptionHandler({AuthenticationException.class, UsernameNotFoundException.class})
    public ResponseEntity<ErrorResponse> handleAuthException(Exception ex) {
        // We log the specific error for debugging, but return a generic message to the user for security.
        log.warn("‚õî Authentication Failed: {}", ex.getMessage());

        return ResponseEntity
                .status(HttpStatus.UNAUTHORIZED)
                .body(new ErrorResponse(AUTH_ERROR_MESSAGE));
    }

    /**
     * Internal Record to define the error JSON structure.
     * Java 21 Feature: Concise, immutable data carrier.
     */
    public record ErrorResponse(String error) {}
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/config/InternalKeyFilter.java">
package com.safevision.authservice.config;

import java.io.IOException;
import java.util.Collections;

import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;

@RequiredArgsConstructor
public class InternalKeyFilter extends OncePerRequestFilter {

	 private final String key;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {


        String requestKey = request.getHeader("X-Internal-Key");


        if (requestKey != null && requestKey.equals(key)) {
            

            UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(
                    "INTERNAL_SYSTEM", 
                    null, 
                    Collections.singletonList(new SimpleGrantedAuthority("ROLE_INTERNAL"))
            );

           
            SecurityContextHolder.getContext().setAuthentication(auth);
        }


        filterChain.doFilter(request, response);
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/config/JwtProperties.java">
package com.safevision.authservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Type-safe configuration properties for JWT settings.
 * Maps properties starting with "safevision.jwt" from application.yml.
 *
 * @param secret       The shared HMAC secret key.
 * @param expirationMs The token validity duration in milliseconds.
 */
@ConfigurationProperties(prefix = "safevision.jwt")
public record JwtProperties(String secret, long expirationMs) {}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/controller/AlertPreferenceController.java">
package com.safevision.authservice.controller;

import java.util.List;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.safevision.authservice.service.AlertPreferenceService;
import com.safevision.common.enums.AlertType;

@RestController
@RequestMapping("/users")
public class AlertPreferenceController {

    private final AlertPreferenceService service;

    public AlertPreferenceController(AlertPreferenceService service) {
        this.service = service;
    }

    @GetMapping("/{userId}/alert-preferences")
    public List<AlertType> getPreferences(@PathVariable String userId) {
        return service.getPreferencesByUserId(userId);
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/dto/UserContactDTO.java">
package com.safevision.authservice.dto;

/**
 * Data Transfer Object (DTO) representing public User Contact Information.
 * <p>
 * This record is designed to be exposed via API endpoints (e.g., {@code /auth/contact/{username}})
 * to allow other microservices (like the <b>Alert Service</b>) to fetch contact details
 * required for sending notifications (SMS/Email).
 * </p>
 * <p>
 * It intentionally excludes sensitive data like passwords or internal audit logs.
 * </p>
 *
 * @param id          The unique UUID of the user.
 * @param username    The login username.
 * @param phoneNumber The mobile number formatted for SMS providers (e.g., Twilio E.164 format).
 * @param email       The email address for correspondence.
 */
public record UserContactDTO(
    String id,
    String username,
    String phoneNumber,
    String email
) {}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/dto/UserUpdateRequest.java">
package com.safevision.authservice.dto;

import com.safevision.common.enums.AlertType;
import java.util.Set;


public record UserUpdateRequest(
    String email,
    String phoneNumber,
    String cameraConnectionUrl,
    String password,
    Set<AlertType> alertPreferences // üìç CAMPO NOVO
) {}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/model/AlertPreference.java">
package com.safevision.authservice.model;

import com.safevision.common.enums.AlertType;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Index;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Entity
@Table(name = "alert_preferences",
       indexes = {@Index(name = "idx_alertpref_userid", columnList = "user_id")})
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class AlertPreference {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(length = 36, updatable = false, nullable = false)
    private String id;

    // Many preferences can belong to a single user
    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    @Enumerated(EnumType.STRING)
    @Column(name = "alert_type", nullable = false, length = 20)
    private AlertType alertType;
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/repository/AlertPreferenceRepository.java">
package com.safevision.authservice.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;

import com.safevision.authservice.model.AlertPreference;

public interface AlertPreferenceRepository extends JpaRepository<AlertPreference, String> {
    List<AlertPreference> findByUserId(String userId);
    void deleteByUserId(String userId);
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/service/AlertPreferenceService.java">
package com.safevision.authservice.service;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;

import com.safevision.authservice.model.AlertPreference;
import com.safevision.authservice.repository.AlertPreferenceRepository;
import com.safevision.common.enums.AlertType;

@Service
public class AlertPreferenceService {

    private final AlertPreferenceRepository repository;

    public AlertPreferenceService(AlertPreferenceRepository repository) {
        this.repository = repository;
    }

    public List<AlertType> getPreferencesByUserId(String userId) {
        return repository.findByUserId(userId)
                .stream()
                .map(AlertPreference::getAlertType)
                .collect(Collectors.toList());
    }
}
</file>

<file path="auth-service/src/main/resources/db/migration/V2__create_alert_preferences.sql">
-- =============================================
-- V2__create_alert_preferences.sql
-- Create table to store user alert preferences
-- =============================================

CREATE TABLE alert_preferences (
    id BIGINT NOT NULL AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    alert_type VARCHAR(30) NOT NULL,  -- EMAIL, SMS, TELEGRAM (enum no backend)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),

    -- FK para tabela users
    CONSTRAINT fk_alert_pref_user
        FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE CASCADE
);

-- Um usu√°rio pode ter v√°rios tipos de alerta,
-- mas n√£o pode ter o mesmo tipo duplicado
CREATE UNIQUE INDEX ux_user_alert_type
    ON alert_preferences(user_id, alert_type);

-- Index para acelerar buscas por user_id
CREATE INDEX idx_alert_pref_user_id
    ON alert_preferences(user_id);
</file>

<file path="common/pom.xml">
<project>
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.safevision.common</groupId>
    <artifactId>common</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>

  
</project>
</file>

<file path="common/src/main/java/com/safevision/common/enums/AlertType.java">
package com.safevision.common.enums;

public enum AlertType {
    EMAIL,
    SMS,
    TELEGRAM
}
</file>

<file path="eureka-server/pom.xml">
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">

    <modelVersion>4.0.0</modelVersion>
    
 	<parent>
        <groupId>com.safevision</groupId>
        <artifactId>safevision-modular</artifactId>
        <version>1.0.0</version>
        <relativePath>../pom.xml</relativePath>
    </parent>

   
    <artifactId>eureka-server</artifactId>
    <packaging>jar</packaging>
	
   
    <dependencies>

        <!-- Eureka Server -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>

    </dependencies>
	<build>
    <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
            <executions>
                <execution>
                    <goals>
                        <goal>repackage</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
 

</project>
</file>

<file path="gateway-service/Dockerfile">
FROM eclipse-temurin:21-jdk
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
</file>

<file path="gateway-service/src/main/java/com/safevision/gatewayservice/config/JwtProperties.java">
package com.safevision.gatewayservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Type-safe configuration properties for JWT settings in the Gateway.
 * Maps properties starting with "safevision.jwt".
 *
 * @param secret The shared HMAC secret key used to validate tokens.
 */
@ConfigurationProperties(prefix = "safevision.jwt")
public record JwtProperties(String secret) {}
</file>

<file path="gateway-service/src/main/java/com/safevision/gatewayservice/controller/FallbackController.java">
package com.safevision.gatewayservice.controller;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import reactor.core.publisher.Mono;

import java.util.Map;

@RestController
public class FallbackController {

    @RequestMapping("/fallback")
    public Mono<ResponseEntity<Map<String, String>>> fallback() {
        var errorResponse = Map.of(
            "error", "Servi√ßo indisponivel",
            "message", "O servi√ßo est√° offline ou demorando para responder. Tente novamente mais tarde."
        );
        
        return Mono.just(ResponseEntity
                .status(HttpStatus.SERVICE_UNAVAILABLE)
                .body(errorResponse));
    }
}
</file>

<file path="recognition-service/Dockerfile">
FROM eclipse-temurin:21-jdk
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/config/JwtProperties.java">
package com.safevision.recognitionservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Type-safe configuration properties for JWT settings.
 * Maps properties starting with "safevision.jwt" from application.yml.
 *
 * @param secret The shared secret key used for HMAC signature.
 */
@ConfigurationProperties(prefix = "safevision.jwt")
public record JwtProperties(String secret) {}
</file>

<file path="register.json">
{
  "username": "admin_fabiolo",
  "password": "123",
  "email": "teste.login@gmail.com",
  "phoneNumber": "+5548999999999",
  "cameraUrl": "http://192.168.0.132:4747/video",
  "roles": ["ADMIN", "USER"]
}
</file>

<file path="roadmap.txt">
Com base na arquitetura s√≥lida que j√° constru√≠mos (Spring Boot, Python, RabbitMQ, Angular, Postgres), existem tecnologias complementares que elevariam o SafeVision ao n√≠vel de "Big Tech" ou produto comercial de alta performance.

Aqui est√£o as 5 principais tecnologias que eu sugiro adicionar ao seu roadmap para enriquecer o projeto:

1. WebSockets (Substituir o Polling) ‚ö°
O Problema: Atualmente, o seu Frontend Angular fica perguntando ao servidor a cada 5 segundos: "Tem alerta novo?" (Polling). Isso gasta bateria do celular, dados m√≥veis e atrasa o alerta em at√© 5s. A Solu√ß√£o: Spring WebSocket (STOMP).

Como funciona: O servidor mant√©m um canal aberto com o navegador. Assim que o AlertService recebe a mensagem do RabbitMQ, ele "empurra" (Push) o alerta para o Angular em milissegundos.

Benef√≠cio: Alerta instant√¢neo e menor consumo de rede.

2. MinIO (Object Storage - S3 Compatible) üóÑÔ∏è
O Problema: Se o Vision Agent detectar uma arma, onde salvamos a foto ou o v√≠deo da prova? Salvar no banco de dados (BLOB) √© pesad√≠ssimo e salvar no disco do container √© vol√°til (se reiniciar, perde). A Solu√ß√£o: MinIO.

O que √©: Um servidor de armazenamento de arquivos open-source que funciona exatamente igual ao AWS S3.

Fluxo:

Python detecta arma -> Envia foto para o MinIO.

MinIO devolve uma URL (http://minio/safevision/evidencia-123.jpg).

Python envia essa URL no JSON para o RabbitMQ.

Angular mostra a foto do bandido no Card de Alerta.

3. Redis (Cache de Alta Performance) üöÄ
O Problema: Toda vez que o RecognitionService processa um frame, ou o Gateway valida um token, eles consultam o banco de dados ou fazem c√°lculos repetitivos. A Solu√ß√£o: Redis.

Uso 1 (Cache de Token): O Gateway guarda tokens v√°lidos no Redis. Valida√ß√£o ocorre em 0.1ms sem bater no banco.

Uso 2 (Estado do Vision Agent): Em vez de guardar o hist√≥rico de movimento na mem√≥ria RAM do Java (MovementHistoryService), guardamos no Redis. Isso permite que o servi√ßo Java reinicie sem perder o contexto da amea√ßa.

4. Prometheus + Grafana (Monitoramento Profissional) üìä
O Problema: O Zipkin mostra o tempo das requisi√ß√µes, mas n√£o mostra se o servidor est√° ficando sem mem√≥ria, se a CPU est√° em 100% ou quantas mensagens est√£o acumuladas no RabbitMQ. A Solu√ß√£o:

Prometheus: Coleta m√©tricas num√©ricas do Spring Boot (via Actuator).

Grafana: Cria dashboards visuais lindos (estilo NASA).

O que voc√™ v√™: Um gr√°fico em tempo real mostrando "Alertas por Minuto", "Uso de CPU do Python", "Erros de Login".

5. Kubernetes (K8s) (Orquestra√ß√£o de Produ√ß√£o) ‚ò∏Ô∏è
O Problema: O docker-compose √© √≥timo para um servidor s√≥. Mas se voc√™ tiver 1.000 c√¢meras e precisar de 50 servidores processando? A Solu√ß√£o: Kubernetes.

Ele gerencia seus containers automaticamente. Se o vision-agent travar, o K8s mata e sobe outro em segundos. Se o tr√°fego aumentar, ele sobe mais c√≥pias do recognition-service (Auto-scaling).

üó∫Ô∏è Qual implementar primeiro?
Se o objetivo √© melhorar a Experi√™ncia do Usu√°rio e Seguran√ßa, eu recomendo esta ordem:

MinIO: Para poder ver a FOTO do momento da detec√ß√£o no Dashboard (vital para seguran√ßa).

WebSockets: Para o alerta pipocar na tela na hora.

Redis: Para otimizar a performance.

Quer que eu te ajude a configurar o MinIO no docker-compose para come√ßarmos a salvar as fotos das amea√ßas?
</file>

<file path="safevision-c4-architecture (5).svg">
<svg id="mermaid-diagram-1765524990608" width="100%" xmlns="http://www.w3.org/2000/svg" class="flowchart" style="max-width: 5813.52880859375px;" viewBox="0 0 5813.52880859375 2829.546630859375" role="graphics-document document" aria-roledescription="flowchart-v2"><style>#mermaid-diagram-1765524990608{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:18px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-diagram-1765524990608 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-diagram-1765524990608 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-diagram-1765524990608 .error-icon{fill:hsl(220.5882352941, 100%, 98.3333333333%);}#mermaid-diagram-1765524990608 .error-text{fill:rgb(8.5000000002, 5.7500000001, 0);stroke:rgb(8.5000000002, 5.7500000001, 0);}#mermaid-diagram-1765524990608 .edge-thickness-normal{stroke-width:1px;}#mermaid-diagram-1765524990608 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-diagram-1765524990608 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-diagram-1765524990608 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-diagram-1765524990608 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-diagram-1765524990608 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-diagram-1765524990608 .marker{fill:#0b0b0b;stroke:#0b0b0b;}#mermaid-diagram-1765524990608 .marker.cross{stroke:#0b0b0b;}#mermaid-diagram-1765524990608 svg{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:18px;}#mermaid-diagram-1765524990608 p{margin:0;}#mermaid-diagram-1765524990608 .label{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;color:#333;}#mermaid-diagram-1765524990608 .cluster-label text{fill:#333;}#mermaid-diagram-1765524990608 .cluster-label span{color:#333;}#mermaid-diagram-1765524990608 .cluster-label span p{background-color:transparent;}#mermaid-diagram-1765524990608 .label text,#mermaid-diagram-1765524990608 span{fill:#333;color:#333;}#mermaid-diagram-1765524990608 .node rect,#mermaid-diagram-1765524990608 .node circle,#mermaid-diagram-1765524990608 .node ellipse,#mermaid-diagram-1765524990608 .node polygon,#mermaid-diagram-1765524990608 .node path{fill:#fff4dd;stroke:hsl(40.5882352941, 60%, 83.3333333333%);stroke-width:1px;}#mermaid-diagram-1765524990608 .rough-node .label text,#mermaid-diagram-1765524990608 .node .label text,#mermaid-diagram-1765524990608 .image-shape .label,#mermaid-diagram-1765524990608 .icon-shape .label{text-anchor:middle;}#mermaid-diagram-1765524990608 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-diagram-1765524990608 .rough-node .label,#mermaid-diagram-1765524990608 .node .label,#mermaid-diagram-1765524990608 .image-shape .label,#mermaid-diagram-1765524990608 .icon-shape .label{text-align:center;}#mermaid-diagram-1765524990608 .node.clickable{cursor:pointer;}#mermaid-diagram-1765524990608 .root .anchor path{fill:#0b0b0b!important;stroke-width:0;stroke:#0b0b0b;}#mermaid-diagram-1765524990608 .arrowheadPath{fill:#0b0b0b;}#mermaid-diagram-1765524990608 .edgePath .path{stroke:#0b0b0b;stroke-width:2.0px;}#mermaid-diagram-1765524990608 .flowchart-link{stroke:#0b0b0b;fill:none;}#mermaid-diagram-1765524990608 .edgeLabel{background-color:#ffffff;text-align:center;}#mermaid-diagram-1765524990608 .edgeLabel p{background-color:#ffffff;}#mermaid-diagram-1765524990608 .edgeLabel rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-diagram-1765524990608 .labelBkg{background-color:rgba(255, 255, 255, 0.5);}#mermaid-diagram-1765524990608 .cluster rect{fill:#ffffff;stroke:hsl(220.5882352941, 60%, 88.3333333333%);stroke-width:1px;}#mermaid-diagram-1765524990608 .cluster text{fill:#333;}#mermaid-diagram-1765524990608 .cluster span{color:#333;}#mermaid-diagram-1765524990608 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:12px;background:hsl(220.5882352941, 100%, 98.3333333333%);border:1px solid hsl(220.5882352941, 60%, 88.3333333333%);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-diagram-1765524990608 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-diagram-1765524990608 rect.text{fill:none;stroke-width:0;}#mermaid-diagram-1765524990608 .icon-shape,#mermaid-diagram-1765524990608 .image-shape{background-color:#ffffff;text-align:center;}#mermaid-diagram-1765524990608 .icon-shape p,#mermaid-diagram-1765524990608 .image-shape p{background-color:#ffffff;padding:2px;}#mermaid-diagram-1765524990608 .icon-shape rect,#mermaid-diagram-1765524990608 .image-shape rect{opacity:0.5;background-color:#ffffff;fill:#ffffff;}#mermaid-diagram-1765524990608 .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-diagram-1765524990608 .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-diagram-1765524990608 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}#mermaid-diagram-1765524990608 .person>*{fill:#08427b!important;stroke:#052e56!important;stroke-width:2px!important;color:#ffffff!important;}#mermaid-diagram-1765524990608 .person span{fill:#08427b!important;stroke:#052e56!important;stroke-width:2px!important;color:#ffffff!important;}#mermaid-diagram-1765524990608 .person tspan{fill:#ffffff!important;}#mermaid-diagram-1765524990608 .container>*{fill:#1168bd!important;stroke:#0b4884!important;stroke-width:2px!important;color:#ffffff!important;}#mermaid-diagram-1765524990608 .container span{fill:#1168bd!important;stroke:#0b4884!important;stroke-width:2px!important;color:#ffffff!important;}#mermaid-diagram-1765524990608 .container tspan{fill:#ffffff!important;}#mermaid-diagram-1765524990608 .component>*{fill:#85bbf0!important;stroke:#5d82a8!important;stroke-width:2px!important;color:#000000!important;}#mermaid-diagram-1765524990608 .component span{fill:#85bbf0!important;stroke:#5d82a8!important;stroke-width:2px!important;color:#000000!important;}#mermaid-diagram-1765524990608 .component tspan{fill:#000000!important;}#mermaid-diagram-1765524990608 .database>*{fill:#1168bd!important;stroke:#0b4884!important;stroke-width:2px!important;color:#ffffff!important;}#mermaid-diagram-1765524990608 .database span{fill:#1168bd!important;stroke:#0b4884!important;stroke-width:2px!important;color:#ffffff!important;}#mermaid-diagram-1765524990608 .database tspan{fill:#ffffff!important;}#mermaid-diagram-1765524990608 .external>*{fill:#999999!important;stroke:#6b6b6b!important;stroke-width:2px!important;color:#ffffff!important;}#mermaid-diagram-1765524990608 .external span{fill:#999999!important;stroke:#6b6b6b!important;stroke-width:2px!important;color:#ffffff!important;}#mermaid-diagram-1765524990608 .external tspan{fill:#ffffff!important;}</style><g><marker id="mermaid-diagram-1765524990608_flowchart-v2-pointEnd" class="marker flowchart-v2" viewBox="0 0 10 10" refX="5" refY="5" markerUnits="userSpaceOnUse" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaid-diagram-1765524990608_flowchart-v2-pointStart" class="marker flowchart-v2" viewBox="0 0 10 10" refX="4.5" refY="5" markerUnits="userSpaceOnUse" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 5 L 10 10 L 10 0 z" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaid-diagram-1765524990608_flowchart-v2-circleEnd" class="marker flowchart-v2" viewBox="0 0 10 10" refX="11" refY="5" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></circle></marker><marker id="mermaid-diagram-1765524990608_flowchart-v2-circleStart" class="marker flowchart-v2" viewBox="0 0 10 10" refX="-1" refY="5" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></circle></marker><marker id="mermaid-diagram-1765524990608_flowchart-v2-crossEnd" class="marker cross flowchart-v2" viewBox="0 0 11 11" refX="12" refY="5.2" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaid-diagram-1765524990608_flowchart-v2-crossStart" class="marker cross flowchart-v2" viewBox="0 0 11 11" refX="-1" refY="5.2" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2; stroke-dasharray: 1, 0;"></path></marker><g class="root"><g class="clusters"><g class="cluster " id="SafeVision" data-look="classic"><rect style="fill:none !important;stroke:#333 !important;stroke-width:2px !important;stroke-dasharray:5 5 !important" x="542.8023437503725" y="634.59375" width="4470.6328125" height="2186.9529357925057"></rect><g class="cluster-label " transform="translate(2678.1187500003725, 634.59375)"><foreignObject width="200" height="54"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>üõ°Ô∏è Sistema SafeVision - Docker Host</p></span></div></foreignObject></g></g><g class="cluster " id="DevOps" data-look="classic"><rect style="fill:#e6e6fa !important;stroke:#663399 !important;stroke-width:2px !important" x="8" y="247.890625" width="514.8023437503725" height="597.703125"></rect><g class="cluster-label " transform="translate(186.35429687518626, 247.890625)"><foreignObject width="158.09375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel "><p>üõ†Ô∏è DevOps e CI/CD</p></span></div></foreignObject></g></g><g class="cluster " id="Ext" data-look="classic"><rect style="fill:#f0f0f0 !important;stroke:#999 !important;stroke-width:2px !important" x="5033.4351562503725" y="2476.020217895508" width="772.09375" height="218.4264678955078"></rect><g class="cluster-label " transform="translate(5319.4820312503725, 2476.020217895508)"><foreignObject width="200" height="54"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>‚òÅÔ∏è Provedores Externos de Notifica√ß√£o</p></span></div></foreignObject></g></g><g class="cluster " id="LayerData" data-look="classic"><rect style="fill:#fff9e6 !important;stroke:#ffc107 !important;stroke-width:4px !important" x="562.8023437503725" y="1884.59375" width="637.44140625" height="784.8529357910156"></rect><g class="cluster-label " transform="translate(781.5230468753725, 1884.59375)"><foreignObject width="200" height="54"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>üíæ Camada de Dados e Infra</p></span></div></foreignObject></g></g><g class="cluster " id="LayerBack" data-look="classic"><rect style="fill:#e9f7ef !important;stroke:#198754 !important;stroke-width:4px !important" x="2502.3257812503725" y="922.59375" width="2491.109375" height="1873.9529357925057"></rect><g class="cluster-label " transform="translate(3647.8804687503725, 922.59375)"><foreignObject width="200" height="54"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>‚öôÔ∏è Camada de L√≥gica de Neg√≥cio</p></span></div></foreignObject></g></g><g class="cluster " id="LayerEdge" data-look="classic"><rect style="fill:#fff0f5 !important;stroke:#d63384 !important;stroke-width:4px !important" x="1220.2437500003725" y="1243.59375" width="1262.08203125" height="859.4264678955078"></rect><g class="cluster-label " transform="translate(1766.0035156253725, 1243.59375)"><foreignObject width="170.5625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel "><p>üìç Camada Edge / IoT</p></span></div></foreignObject></g></g><g class="cluster " id="LayerFront" data-look="classic"><rect style="fill:#e8f4fa !important;stroke:#0d6efd !important;stroke-width:4px !important" x="1694.91796875" y="659.59375" width="2192.7515625003725" height="161"></rect><g class="cluster-label " transform="translate(2691.2937500001863, 659.59375)"><foreignObject width="200" height="54"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>üíª Camada de Apresenta√ß√£o</p></span></div></foreignObject></g></g><g class="cluster " id="VisionAgent" data-look="classic"><rect style="" x="1240.2437500003725" y="1268.59375" width="912.08203125" height="809.4264678955078"></rect><g class="cluster-label " transform="translate(1600.8785156253725, 1268.59375)"><foreignObject width="190.8125" height="54"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel "><p>üêç Agente de Vis√£o<br/>[Container: Python 3.11]</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path d="M162.328,170.891L162.328,177.307C162.328,183.724,162.328,196.557,162.328,209.391C162.328,222.224,162.328,235.057,162.328,244.974C162.328,254.891,162.328,261.891,162.328,265.391L162.328,268.891" id="L_Dev_GitHub_0" class=" edge-thickness-thick edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Dev_GitHub_0" data-points="W3sieCI6MTYyLjMyODEyNSwieSI6MTcwLjg5MDYyNX0seyJ4IjoxNjIuMzI4MTI1LCJ5IjoyMDkuMzkwNjI1fSx7IngiOjE2Mi4zMjgxMjUsInkiOjI0Ny44OTA2MjV9LHsieCI6MTYyLjMyODEyNSwieSI6MjcyLjg5MDYyNX1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M153.901,356.891L152.613,363.307C151.326,369.724,148.751,382.557,147.463,405.691C146.176,428.824,146.176,462.258,146.176,478.975L146.176,495.692" id="GitHub-cyclic-special-1" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="GitHub-cyclic-special-1" data-points="W3sieCI6MTUzLjkwMDgxNTIxNzM5MTMsInkiOjM1Ni44OTA2MjV9LHsieCI6MTQ2LjE3NTc4MTI1LCJ5IjozOTUuMzkwNjI1fSx7IngiOjE0Ni4xNzU3ODEyNSwieSI6NDk1LjY5MjE4NzQ5OTI1NDk0fV0="></path><path d="M146.176,495.792L146.176,512.509C146.176,529.226,146.176,562.66,146.176,585.793C146.176,608.927,146.176,621.76,146.176,632.344C146.176,642.927,146.176,651.26,137.679,668.835C129.182,686.41,112.189,713.227,103.692,726.635L95.196,740.044" id="GitHub-cyclic-special-mid" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="GitHub-cyclic-special-mid" data-points="W3sieCI6MTQ2LjE3NTc4MTI1LCJ5Ijo0OTUuNzkyMTg3NTAwNzQ1MDZ9LHsieCI6MTQ2LjE3NTc4MTI1LCJ5Ijo1OTYuMDkzNzV9LHsieCI6MTQ2LjE3NTc4MTI1LCJ5Ijo2MzQuNTkzNzV9LHsieCI6MTQ2LjE3NTc4MTI1LCJ5Ijo2NTkuNTkzNzV9LHsieCI6OTUuMTk1NzQ2Nzk3ODMyMzgsInkiOjc0MC4wNDM3NDk5OTkyNTQ5fV0="></path><path d="M95.132,740.044L86.636,726.635C78.139,713.227,61.146,686.41,52.649,668.835C44.152,651.26,44.152,642.927,44.152,632.344C44.152,621.76,44.152,608.927,44.152,585.785C44.152,562.643,44.152,529.193,44.152,495.742C44.152,462.292,44.152,428.841,53.021,406.075C61.89,383.308,79.628,371.225,88.496,365.184L97.365,359.143" id="GitHub-cyclic-special-2" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="GitHub-cyclic-special-2" data-points="W3sieCI6OTUuMTMyMzc4MjAyMTY3NjIsInkiOjc0MC4wNDM3NDk5OTkyNTQ5fSx7IngiOjQ0LjE1MjM0Mzc1LCJ5Ijo2NTkuNTkzNzV9LHsieCI6NDQuMTUyMzQzNzUsInkiOjYzNC41OTM3NX0seyJ4Ijo0NC4xNTIzNDM3NSwieSI6NTk2LjA5Mzc1fSx7IngiOjQ0LjE1MjM0Mzc1LCJ5Ijo0OTUuNzQyMTg3NX0seyJ4Ijo0NC4xNTIzNDM3NSwieSI6Mzk1LjM5MDYyNX0seyJ4IjoxMDAuNjcxMTk1NjUyMTczOSwieSI6MzU2Ljg5MDYyNX1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M254.516,356.891L268.6,363.307C282.684,369.724,310.853,382.557,324.937,398.033C339.021,413.508,339.021,431.625,339.021,440.684L339.021,449.742" id="L_GitHub_DockerReg_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_GitHub_DockerReg_0" data-points="W3sieCI6MjU0LjUxNTc2MDg2OTc1OTU2LCJ5IjozNTYuODkwNjI1fSx7IngiOjMzOS4wMjEwOTM3NTAzNzI1MywieSI6Mzk1LjM5MDYyNX0seyJ4IjozMzkuMDIxMDkzNzUwMzcyNTMsInkiOjQ1My43NDIxODc1fV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3915.244,1087.716L3998.293,1107.279C4081.341,1126.842,4247.439,1165.968,4330.488,1191.948C4413.537,1217.927,4413.537,1230.76,4413.537,1241.344C4413.537,1251.927,4413.537,1260.26,4413.537,1277.844C4413.537,1295.427,4413.537,1322.26,4413.537,1351.344C4413.537,1380.427,4413.537,1411.76,4413.537,1443.094C4413.537,1474.427,4413.537,1505.76,4413.537,1539.344C4413.537,1572.927,4413.537,1608.76,4413.537,1644.594C4413.537,1680.427,4413.537,1716.26,4413.537,1749.844C4413.537,1783.427,4413.537,1814.76,4413.537,1836.844C4413.537,1858.927,4413.537,1871.76,4413.537,1894.296C4413.537,1916.831,4413.537,1949.069,4413.537,1981.307C4413.537,2013.545,4413.537,2045.782,4413.537,2066.068C4413.537,2086.354,4413.537,2094.687,4413.537,2105.27C4413.537,2115.854,4413.537,2128.687,4413.537,2159.77C4413.537,2190.854,4413.537,2240.187,4413.537,2289.52C4413.537,2338.854,4413.537,2388.187,4413.537,2419.27C4413.537,2450.354,4413.537,2463.187,4344.017,2481.805C4274.497,2500.422,4135.456,2524.824,4065.936,2537.025L3996.416,2549.226" id="L_Gateway_Eureka_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Gateway_Eureka_0" data-points="W3sieCI6MzkxNS4yNDM3NTAwMDAzNzI1LCJ5IjoxMDg3LjcxNjQwNjg3NjU4MTV9LHsieCI6NDQxMy41MzY3MTg3NTAzNzI1LCJ5IjoxMjA1LjA5Mzc1fSx7IngiOjQ0MTMuNTM2NzE4NzUwMzcyNSwieSI6MTI0My41OTM3NX0seyJ4Ijo0NDEzLjUzNjcxODc1MDM3MjUsInkiOjEyNjguNTkzNzV9LHsieCI6NDQxMy41MzY3MTg3NTAzNzI1LCJ5IjoxMzQ5LjA5Mzc1fSx7IngiOjQ0MTMuNTM2NzE4NzUwMzcyNSwieSI6MTQ0My4wOTM3NX0seyJ4Ijo0NDEzLjUzNjcxODc1MDM3MjUsInkiOjE1MzcuMDkzNzV9LHsieCI6NDQxMy41MzY3MTg3NTAzNzI1LCJ5IjoxNjQ0LjU5Mzc1fSx7IngiOjQ0MTMuNTM2NzE4NzUwMzcyNSwieSI6MTc1Mi4wOTM3NX0seyJ4Ijo0NDEzLjUzNjcxODc1MDM3MjUsInkiOjE4NDYuMDkzNzV9LHsieCI6NDQxMy41MzY3MTg3NTAzNzI1LCJ5IjoxODg0LjU5Mzc1fSx7IngiOjQ0MTMuNTM2NzE4NzUwMzcyNSwieSI6MTk4MS4zMDY5ODM5NDc3NTR9LHsieCI6NDQxMy41MzY3MTg3NTAzNzI1LCJ5IjoyMDc4LjAyMDIxNzg5NTUwOH0seyJ4Ijo0NDEzLjUzNjcxODc1MDM3MjUsInkiOjIxMDMuMDIwMjE3ODk1NTA4fSx7IngiOjQ0MTMuNTM2NzE4NzUwMzcyNSwieSI6MjE0MS41MjAyMTc4OTU1MDh9LHsieCI6NDQxMy41MzY3MTg3NTAzNzI1LCJ5IjoyMjg5LjUyMDIxNzg5NTUwOH0seyJ4Ijo0NDEzLjUzNjcxODc1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjQ0MTMuNTM2NzE4NzUwMzcyNSwieSI6MjQ3Ni4wMjAyMTc4OTU1MDh9LHsieCI6Mzk5Mi40NzY1NjI1LCJ5IjoyNTQ5LjkxNzkzODM4MTQzMjZ9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3758.537,2360.2L3782.239,2373.086C3805.942,2385.973,3853.347,2411.747,3877.049,2431.05C3900.752,2450.354,3900.752,2463.187,3899.169,2473.603C3897.586,2484.018,3894.421,2492.016,3892.838,2496.015L3891.256,2500.014" id="L_Auth_Eureka_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style="stroke:#663399;stroke-width:1px;stroke-dasharray: 4 2;fill:none;;;stroke:#663399;stroke-width:1px;stroke-dasharray: 4 2;fill:none" data-edge="true" data-et="edge" data-id="L_Auth_Eureka_0" data-points="W3sieCI6Mzc1OC41MzY3MTg3NTAzNzI1LCJ5IjoyMzYwLjE5OTY4NDY1NDAxMzd9LHsieCI6MzkwMC43NTE1NjI1MDAzNzI1LCJ5IjoyNDM3LjUyMDIxNzg5NTUwOH0seyJ4IjozOTAwLjc1MTU2MjUwMDM3MjUsInkiOjI0NzYuMDIwMjE3ODk1NTA4fSx7IngiOjM4ODkuNzgzODM4Nzg3MDUzLCJ5IjoyNTAzLjczMzQ1MTg0MzI2MTd9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd__663399)"></path><path d="M3808.537,2381.61L3795.382,2390.929C3782.228,2400.247,3755.92,2418.884,3742.765,2434.619C3729.611,2450.354,3729.611,2463.187,3735.417,2473.83C3741.224,2484.473,3752.837,2492.926,3758.643,2497.153L3764.45,2501.379" id="L_Recog_Eureka_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style="stroke:#663399;stroke-width:1px;stroke-dasharray: 4 2;fill:none;;;stroke:#663399;stroke-width:1px;stroke-dasharray: 4 2;fill:none" data-edge="true" data-et="edge" data-id="L_Recog_Eureka_0" data-points="W3sieCI6MzgwOC41MzY3MTg3NTAzNzI1LCJ5IjoyMzgxLjYxMDMzNjYyMDM4NH0seyJ4IjozNzI5LjYxMDkzNzUwMDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjM3MjkuNjEwOTM3NTAwMzcyNSwieSI6MjQ3Ni4wMjAyMTc4OTU1MDh9LHsieCI6Mzc2Ny42ODM2NjAzMjE1MTU2LCJ5IjoyNTAzLjczMzQ1MTg0MzI2MTd9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd__663399)"></path><path d="M4118.537,2317.402L4025.192,2337.421C3931.848,2357.441,3745.159,2397.481,3651.815,2423.917C3558.47,2450.354,3558.47,2463.187,3586.836,2478.628C3615.202,2494.068,3671.933,2512.116,3700.299,2521.14L3728.665,2530.164" id="L_Alert_Eureka_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style="stroke:#663399;stroke-width:1px;stroke-dasharray: 4 2;fill:none;;;stroke:#663399;stroke-width:1px;stroke-dasharray: 4 2;fill:none" data-edge="true" data-et="edge" data-id="L_Alert_Eureka_0" data-points="W3sieCI6NDExOC41MzY3MTg3NTAzNzI1LCJ5IjoyMzE3LjQwMTU5MjUzNjc2MTd9LHsieCI6MzU1OC40NzAzMTI1MDAzNzI1LCJ5IjoyNDM3LjUyMDIxNzg5NTUwOH0seyJ4IjozNTU4LjQ3MDMxMjUwMDM3MjUsInkiOjI0NzYuMDIwMjE3ODk1NTA4fSx7IngiOjM3MzIuNDc2NTYyNSwieSI6MjUzMS4zNzY2NjkxNjc4Mjg0fV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd__663399)"></path><path d="M5224.138,498.994L4916.708,515.177C4609.277,531.36,3994.417,563.727,3686.987,586.327C3379.556,608.927,3379.556,621.76,3379.556,632.344C3379.556,642.927,3379.556,651.26,3379.556,658.927C3379.556,666.594,3379.556,673.594,3379.556,677.094L3379.556,680.594" id="L_User_Frontend_0" class=" edge-thickness-thick edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_User_Frontend_0" data-points="W3sieCI6NTIyNC4xMzc4NjI4ODYyNzYsInkiOjQ5OC45OTM1OTgwOTE3MTl9LHsieCI6MzM3OS41NTYyNTAwMDAzNzI1LCJ5Ijo1OTYuMDkzNzV9LHsieCI6MzM3OS41NTYyNTAwMDAzNzI1LCJ5Ijo2MzQuNTkzNzV9LHsieCI6MzM3OS41NTYyNTAwMDAzNzI1LCJ5Ijo2NTkuNTkzNzV9LHsieCI6MzM3OS41NTYyNTAwMDAzNzI1LCJ5Ijo2ODQuNTkzNzV9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3501.431,760.193L3562.471,770.26C3623.511,780.327,3745.59,800.46,3806.63,814.694C3867.67,828.927,3867.67,837.26,3867.67,847.844C3867.67,858.427,3867.67,871.26,3867.67,884.094C3867.67,896.927,3867.67,909.76,3865.464,919.775C3863.259,929.79,3858.849,936.987,3856.644,940.585L3854.439,944.183" id="L_Frontend_Gateway_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Frontend_Gateway_0" data-points="W3sieCI6MzUwMS40MzEyNTAwMDAzNzI1LCJ5Ijo3NjAuMTkzNDY0MzAxNzE5OH0seyJ4IjozODY3LjY2OTUzMTI1MDM3MjUsInkiOjgyMC41OTM3NX0seyJ4IjozODY3LjY2OTUzMTI1MDM3MjUsInkiOjg0NS41OTM3NX0seyJ4IjozODY3LjY2OTUzMTI1MDM3MjUsInkiOjg4NC4wOTM3NX0seyJ4IjozODY3LjY2OTUzMTI1MDM3MjUsInkiOjkyMi41OTM3NX0seyJ4IjozODUyLjM0ODc1NDA2NjM1NzcsInkiOjk0Ny41OTM3NX1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3669.302,1166.594L3662.508,1173.01C3655.713,1179.427,3642.125,1192.26,3635.331,1205.094C3628.537,1217.927,3628.537,1230.76,3628.537,1241.344C3628.537,1251.927,3628.537,1260.26,3628.537,1277.844C3628.537,1295.427,3628.537,1322.26,3628.537,1351.344C3628.537,1380.427,3628.537,1411.76,3628.537,1443.094C3628.537,1474.427,3628.537,1505.76,3628.537,1539.344C3628.537,1572.927,3628.537,1608.76,3628.537,1644.594C3628.537,1680.427,3628.537,1716.26,3628.537,1749.844C3628.537,1783.427,3628.537,1814.76,3628.537,1836.844C3628.537,1858.927,3628.537,1871.76,3628.537,1894.296C3628.537,1916.831,3628.537,1949.069,3628.537,1981.307C3628.537,2013.545,3628.537,2045.782,3628.537,2066.068C3628.537,2086.354,3628.537,2094.687,3628.537,2105.27C3628.537,2115.854,3628.537,2128.687,3628.537,2140.854C3628.537,2153.02,3628.537,2164.52,3628.537,2170.27L3628.537,2176.02" id="L_Gateway_Auth_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Gateway_Auth_0" data-points="W3sieCI6MzY2OS4zMDE3MjM1MDEyMTcsInkiOjExNjYuNTkzNzV9LHsieCI6MzYyOC41MzY3MTg3NTAzNzI1LCJ5IjoxMjA1LjA5Mzc1fSx7IngiOjM2MjguNTM2NzE4NzUwMzcyNSwieSI6MTI0My41OTM3NX0seyJ4IjozNjI4LjUzNjcxODc1MDM3MjUsInkiOjEyNjguNTkzNzV9LHsieCI6MzYyOC41MzY3MTg3NTAzNzI1LCJ5IjoxMzQ5LjA5Mzc1fSx7IngiOjM2MjguNTM2NzE4NzUwMzcyNSwieSI6MTQ0My4wOTM3NX0seyJ4IjozNjI4LjUzNjcxODc1MDM3MjUsInkiOjE1MzcuMDkzNzV9LHsieCI6MzYyOC41MzY3MTg3NTAzNzI1LCJ5IjoxNjQ0LjU5Mzc1fSx7IngiOjM2MjguNTM2NzE4NzUwMzcyNSwieSI6MTc1Mi4wOTM3NX0seyJ4IjozNjI4LjUzNjcxODc1MDM3MjUsInkiOjE4NDYuMDkzNzV9LHsieCI6MzYyOC41MzY3MTg3NTAzNzI1LCJ5IjoxODg0LjU5Mzc1fSx7IngiOjM2MjguNTM2NzE4NzUwMzcyNSwieSI6MTk4MS4zMDY5ODM5NDc3NTR9LHsieCI6MzYyOC41MzY3MTg3NTAzNzI1LCJ5IjoyMDc4LjAyMDIxNzg5NTUwOH0seyJ4IjozNjI4LjUzNjcxODc1MDM3MjUsInkiOjIxMDMuMDIwMjE3ODk1NTA4fSx7IngiOjM2MjguNTM2NzE4NzUwMzcyNSwieSI6MjE0MS41MjAyMTc4OTU1MDh9LHsieCI6MzYyOC41MzY3MTg3NTAzNzI1LCJ5IjoyMTgwLjAyMDIxNzg5NTUwOH1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3498.537,2310.317L3366.009,2331.517C3233.482,2352.718,2968.427,2395.119,2835.9,2422.736C2703.373,2450.354,2703.373,2463.187,2399.05,2484.795C2094.726,2506.403,1486.08,2536.785,1181.757,2551.977L877.434,2567.168" id="L_Auth_Postgres_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Auth_Postgres_0" data-points="W3sieCI6MzQ5OC41MzY3MTg3NTAzNzI1LCJ5IjoyMzEwLjMxNjUyOTM2MDUzNTJ9LHsieCI6MjcwMy4zNzI2NTYyNTAzNzI1LCJ5IjoyNDM3LjUyMDIxNzg5NTUwOH0seyJ4IjoyNzAzLjM3MjY1NjI1MDM3MjUsInkiOjI0NzYuMDIwMjE3ODk1NTA4fSx7IngiOjg3My40MzkwNjI1MDAzNzI1LCJ5IjoyNTY3LjM2NzI0MzMyNzU2MjR9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3655.244,1077.589L3520.454,1098.84C3385.664,1120.091,3116.085,1162.592,2981.295,1190.26C2846.505,1217.927,2846.505,1230.76,2846.505,1241.344C2846.505,1251.927,2846.505,1260.26,2696.538,1276.105C2546.571,1291.949,2246.636,1315.305,2096.669,1326.983L1946.702,1338.66" id="L_Gateway_VA_Flask_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Gateway_VA_Flask_0" data-points="W3sieCI6MzY1NS4yNDM3NTAwMDAzNzI1LCJ5IjoxMDc3LjU4OTM0NTQwMTA3NDV9LHsieCI6Mjg0Ni41MDU0Njg3NTAzNzI1LCJ5IjoxMjA1LjA5Mzc1fSx7IngiOjI4NDYuNTA1NDY4NzUwMzcyNSwieSI6MTI0My41OTM3NX0seyJ4IjoyODQ2LjUwNTQ2ODc1MDM3MjUsInkiOjEyNjguNTkzNzV9LHsieCI6MTk0Mi43MTQwNjI1MDA3NDUsInkiOjEzMzguOTcwODE4MTA0MTMwNn1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1939.597,1404.594L1954.267,1411.01C1968.936,1417.427,1998.276,1430.26,1998.886,1442.827C1999.497,1455.393,1971.379,1467.692,1957.321,1473.841L1943.262,1479.991" id="L_VA_Flask_VA_Core_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_VA_Flask_VA_Core_0" data-points="W3sieCI6MTkzOS41OTY5NzA1Nzg5ODI2LCJ5IjoxNDA0LjU5Mzc1fSx7IngiOjIwMjcuNjE0ODQzNzUwMzcyNSwieSI6MTQ0My4wOTM3NX0seyJ4IjoxOTM5LjU5Njk3MDU3ODk4MjYsInkiOjE0ODEuNTkzNzV9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1932.885,1592.594L1951.651,1601.26C1970.416,1609.927,2007.947,1627.26,2049.734,1645.031C2091.521,1662.801,2137.563,1681.008,2160.585,1690.112L2183.606,1699.215" id="L_VA_Core_Camera_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_VA_Core_Camera_0" data-points="W3sieCI6MTkzMi44ODUyNzYxNjMzNDM0LCJ5IjoxNTkyLjU5Mzc1fSx7IngiOjIwNDUuNDc4MTI1MDAwMzcyNSwieSI6MTY0NC41OTM3NX0seyJ4IjoyMTg3LjMyNTc4MTI1MDM3MjUsInkiOjE3MDAuNjg2MjgwODU3OTg4NX1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M2187.326,1715.017L2146.173,1703.28C2105.02,1691.542,2022.714,1668.068,1971.776,1648.094C1920.838,1628.119,1901.269,1611.644,1891.484,1603.407L1881.7,1595.17" id="L_Camera_VA_Core_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Camera_VA_Core_0" data-points="W3sieCI6MjE4Ny4zMjU3ODEyNTAzNzI1LCJ5IjoxNzE1LjAxNjcxNjkwODgzMDl9LHsieCI6MTk0MC40MDc4MTI1MDAzNzI1LCJ5IjoxNjQ0LjU5Mzc1fSx7IngiOjE4NzguNjM5NjcyOTY1NjY5LCJ5IjoxNTkyLjU5Mzc1fV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1682.714,1497.297L1653.203,1488.264C1623.693,1479.23,1564.671,1461.162,1564.034,1443.289C1563.396,1425.416,1621.143,1407.738,1650.016,1398.9L1678.889,1390.061" id="L_VA_Core_VA_Flask_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_VA_Core_VA_Flask_0" data-points="W3sieCI6MTY4Mi43MTQwNjI1MDA3NDUsInkiOjE0OTcuMjk3NDk0MTI5MTc0NX0seyJ4IjoxNTA1LjY1MDAwMDAwMDM3MjUsInkiOjE0NDMuMDkzNzV9LHsieCI6MTY4Mi43MTQwNjI1MDA3NDUsInkiOjEzODguODkwMDA1ODcwODI1NX1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1770.609,1293.594L1767.448,1289.427C1764.286,1285.26,1757.964,1276.927,1754.803,1268.594C1751.642,1260.26,1751.642,1251.927,1751.642,1241.344C1751.642,1230.76,1751.642,1217.927,1751.642,1186.844C1751.642,1155.76,1751.642,1106.427,1751.642,1059.344C1751.642,1012.26,1751.642,967.427,1751.642,938.594C1751.642,909.76,1751.642,896.927,1751.642,884.094C1751.642,871.26,1751.642,858.427,1751.642,847.844C1751.642,837.26,1751.642,828.927,2001.983,812.381C2252.324,795.835,2753.005,771.077,3003.345,758.697L3253.686,746.318" id="L_VA_Flask_Frontend_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_VA_Flask_Frontend_0" data-points="W3sieCI6MTc3MC42MDg2MDgzMDc5NDE3LCJ5IjoxMjkzLjU5Mzc1fSx7IngiOjE3NTEuNjQyMTg3NTAwMzcyNSwieSI6MTI2OC41OTM3NX0seyJ4IjoxNzUxLjY0MjE4NzUwMDM3MjUsInkiOjEyNDMuNTkzNzV9LHsieCI6MTc1MS42NDIxODc1MDAzNzI1LCJ5IjoxMjA1LjA5Mzc1fSx7IngiOjE3NTEuNjQyMTg3NTAwMzcyNSwieSI6MTA1Ny4wOTM3NX0seyJ4IjoxNzUxLjY0MjE4NzUwMDM3MjUsInkiOjkyMi41OTM3NX0seyJ4IjoxNzUxLjY0MjE4NzUwMDM3MjUsInkiOjg4NC4wOTM3NX0seyJ4IjoxNzUxLjY0MjE4NzUwMDM3MjUsInkiOjg0NS41OTM3NX0seyJ4IjoxNzUxLjY0MjE4NzUwMDM3MjUsInkiOjgyMC41OTM3NX0seyJ4IjozMjU3LjY4MTI1MDAwMDM3MjUsInkiOjc0Ni4xMjA0NDI1MTc3NDQ3fV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1839.209,1592.594L1843.346,1601.26C1847.484,1609.927,1855.758,1627.26,1859.895,1653.835C1864.033,1680.41,1864.033,1716.227,1864.033,1734.135L1864.033,1752.044" id="VA_Core-cyclic-special-1" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="VA_Core-cyclic-special-1" data-points="W3sieCI6MTgzOS4yMDg4NTkwMTIxODA3LCJ5IjoxNTkyLjU5Mzc1fSx7IngiOjE4NjQuMDMyODEyNTAwMzcyNSwieSI6MTY0NC41OTM3NX0seyJ4IjoxODY0LjAzMjgxMjUwMDM3MjUsInkiOjE3NTIuMDQzNzQ5OTk5MjU1fV0="></path><path d="M1864.033,1752.144L1864.033,1767.802C1864.033,1783.46,1864.033,1814.777,1864.033,1836.852C1864.033,1858.927,1864.033,1871.76,1859.561,1894.288C1855.088,1916.815,1846.144,1949.036,1841.671,1965.146L1837.199,1981.257" id="VA_Core-cyclic-special-mid" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="VA_Core-cyclic-special-mid" data-points="W3sieCI6MTg2NC4wMzI4MTI1MDAzNzI1LCJ5IjoxNzUyLjE0Mzc1MDAwMDc0NX0seyJ4IjoxODY0LjAzMjgxMjUwMDM3MjUsInkiOjE4NDYuMDkzNzV9LHsieCI6MTg2NC4wMzI4MTI1MDAzNzI1LCJ5IjoxODg0LjU5Mzc1fSx7IngiOjE4MzcuMTk5MDM2MjgyODk0NCwieSI6MTk4MS4yNTY5ODM5NDcwMDg4fV0="></path><path d="M1837.171,1981.257L1832.699,1965.146C1828.227,1949.036,1819.282,1916.815,1814.81,1894.288C1810.338,1871.76,1810.338,1858.927,1810.338,1836.844C1810.338,1814.76,1810.338,1783.427,1810.338,1749.844C1810.338,1716.26,1810.338,1680.427,1810.514,1654.51C1810.691,1628.593,1811.045,1612.593,1811.222,1604.593L1811.399,1596.593" id="VA_Core-cyclic-special-2" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="VA_Core-cyclic-special-2" data-points="W3sieCI6MTgzNy4xNzEyNzYyMTc4NTA2LCJ5IjoxOTgxLjI1Njk4Mzk0NzAwODh9LHsieCI6MTgxMC4zMzc1MDAwMDAzNzI1LCJ5IjoxODg0LjU5Mzc1fSx7IngiOjE4MTAuMzM3NTAwMDAwMzcyNSwieSI6MTg0Ni4wOTM3NX0seyJ4IjoxODEwLjMzNzUwMDAwMDM3MjUsInkiOjE3NTIuMDkzNzV9LHsieCI6MTgxMC4zMzc1MDAwMDAzNzI1LCJ5IjoxNjQ0LjU5Mzc1fSx7IngiOjE4MTEuNDg3MDkzMDIzODA4NSwieSI6MTU5Mi41OTM3NX1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1682.714,1576.734L1645.623,1588.044C1608.531,1599.354,1534.348,1621.974,1497.257,1651.2C1460.166,1680.427,1460.166,1716.26,1460.166,1749.844C1460.166,1783.427,1460.166,1814.76,1460.166,1836.844C1460.166,1858.927,1460.166,1871.76,1352.933,1891.916C1245.7,1912.071,1031.235,1939.548,924.003,1953.287L816.77,1967.026" id="L_VA_Core_MinIO_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_VA_Core_MinIO_0" data-points="W3sieCI6MTY4Mi43MTQwNjI1MDA3NDUsInkiOjE1NzYuNzMzNjkzMDkyODg0fSx7IngiOjE0NjAuMTY1NjI1MDAwMzcyNSwieSI6MTY0NC41OTM3NX0seyJ4IjoxNDYwLjE2NTYyNTAwMDM3MjUsInkiOjE3NTIuMDkzNzV9LHsieCI6MTQ2MC4xNjU2MjUwMDAzNzI1LCJ5IjoxODQ2LjA5Mzc1fSx7IngiOjE0NjAuMTY1NjI1MDAwMzcyNSwieSI6MTg4NC41OTM3NX0seyJ4Ijo4MTIuODAyMzQzNzUwMzcyNSwieSI6MTk2Ny41MzQwNjI1MzU4NTZ9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M812.802,1964.218L896.283,1950.947C979.765,1937.677,1146.727,1911.135,1230.208,1891.448C1313.689,1871.76,1313.689,1858.927,1313.689,1836.844C1313.689,1814.76,1313.689,1783.427,1313.689,1749.844C1313.689,1716.26,1313.689,1680.427,1374.542,1649.402C1435.394,1618.376,1557.099,1592.158,1617.951,1579.05L1678.804,1565.941" id="L_MinIO_VA_Core_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_MinIO_VA_Core_0" data-points="W3sieCI6ODEyLjgwMjM0Mzc1MDM3MjUsInkiOjE5NjQuMjE4MDYyODI0MTIyNn0seyJ4IjoxMzEzLjY4OTA2MjUwMDM3MjUsInkiOjE4ODQuNTkzNzV9LHsieCI6MTMxMy42ODkwNjI1MDAzNzI1LCJ5IjoxODQ2LjA5Mzc1fSx7IngiOjEzMTMuNjg5MDYyNTAwMzcyNSwieSI6MTc1Mi4wOTM3NX0seyJ4IjoxMzEzLjY4OTA2MjUwMDM3MjUsInkiOjE2NDQuNTkzNzV9LHsieCI6MTY4Mi43MTQwNjI1MDA3NDUsInkiOjE1NjUuMDk4MzU4OTg3NTA0OH1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1739.946,1592.594L1728.583,1601.26C1717.22,1609.927,1694.494,1627.26,1683.13,1646.177C1671.767,1665.094,1671.767,1685.594,1671.767,1695.844L1671.767,1706.094" id="L_VA_Core_VA_Queue_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_VA_Core_VA_Queue_0" data-points="W3sieCI6MTczOS45NDYxNDA5ODg5MjQ4LCJ5IjoxNTkyLjU5Mzc1fSx7IngiOjE2NzEuNzY3MTg3NTAwMzcyNSwieSI6MTY0NC41OTM3NX0seyJ4IjoxNjcxLjc2NzE4NzUwMDM3MjUsInkiOjE3MTAuMDkzNzV9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1671.767,1794.094L1671.767,1802.76C1671.767,1811.427,1671.767,1828.76,1671.767,1843.844C1671.767,1858.927,1671.767,1871.76,1577.984,1891.568C1484.2,1911.375,1296.634,1938.156,1202.85,1951.547L1109.067,1964.937" id="L_VA_Queue_RabbitMQ_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_VA_Queue_RabbitMQ_0" data-points="W3sieCI6MTY3MS43NjcxODc1MDAzNzI1LCJ5IjoxNzk0LjA5Mzc1fSx7IngiOjE2NzEuNzY3MTg3NTAwMzcyNSwieSI6MTg0Ni4wOTM3NX0seyJ4IjoxNjcxLjc2NzE4NzUwMDM3MjUsInkiOjE4ODQuNTkzNzV9LHsieCI6MTEwNS4xMDcwMzEyNTAzNzI1LCJ5IjoxOTY1LjUwMjg2MjY5MTA1fV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M947.076,2037.307L941.667,2044.093C936.258,2050.878,925.441,2064.449,920.032,2075.401C914.623,2086.354,914.623,2094.687,914.623,2105.27C914.623,2115.854,914.623,2128.687,1396.276,2158.677C1877.929,2188.668,2841.235,2235.815,3322.888,2259.388L3804.542,2282.962" id="L_RabbitMQ_Recog_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_RabbitMQ_Recog_0" data-points="W3sieCI6OTQ3LjA3NjM4NjUwMTcxMTMsInkiOjIwMzcuMzA2OTgzOTQ3NzUyOH0seyJ4Ijo5MTQuNjIyNjU2MjUwMzcyNSwieSI6MjA3OC4wMjAyMTc4OTU1MDh9LHsieCI6OTE0LjYyMjY1NjI1MDM3MjUsInkiOjIxMDMuMDIwMjE3ODk1NTA4fSx7IngiOjkxNC42MjI2NTYyNTAzNzI1LCJ5IjoyMTQxLjUyMDIxNzg5NTUwOH0seyJ4IjozODA4LjUzNjcxODc1MDM3MjUsInkiOjIyODMuMTU3NjAzMjE3MjAxfV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M4068.537,2320.986L4148.78,2340.408C4229.024,2359.831,4389.511,2398.675,4469.754,2424.514C4549.998,2450.354,4549.998,2463.187,4549.998,2485.714C4549.998,2508.241,4549.998,2540.462,4549.998,2556.573L4549.998,2572.683" id="Recog-cyclic-special-1" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="Recog-cyclic-special-1" data-points="W3sieCI6NDA2OC41MzY3MTg3NTAzNzI1LCJ5IjoyMzIwLjk4NTg0MTk3NzE3N30seyJ4Ijo0NTQ5Ljk5NzY1NjI1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjQ1NDkuOTk3NjU2MjUwMzcyNSwieSI6MjQ3Ni4wMjAyMTc4OTU1MDh9LHsieCI6NDU0OS45OTc2NTYyNTAzNzI1LCJ5IjoyNTcyLjY4MzQ1MTg0MjUxNjd9XQ=="></path><path d="M4549.998,2572.783L4549.998,2588.894C4549.998,2605.005,4549.998,2637.226,4549.998,2657.503C4549.998,2677.78,4549.998,2686.113,4549.998,2696.697C4549.998,2707.28,4549.998,2720.113,4549.916,2732.947C4549.835,2745.78,4549.672,2758.613,4549.59,2765.03L4549.508,2771.447" id="Recog-cyclic-special-mid" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="Recog-cyclic-special-mid" data-points="W3sieCI6NDU0OS45OTc2NTYyNTAzNzI1LCJ5IjoyNTcyLjc4MzQ1MTg0NDAwN30seyJ4Ijo0NTQ5Ljk5NzY1NjI1MDM3MjUsInkiOjI2NjkuNDQ2Njg1NzkxMDE1Nn0seyJ4Ijo0NTQ5Ljk5NzY1NjI1MDM3MjUsInkiOjI2OTQuNDQ2Njg1NzkxMDE1Nn0seyJ4Ijo0NTQ5Ljk5NzY1NjI1MDM3MjUsInkiOjI3MzIuOTQ2Njg1NzkxMDE1Nn0seyJ4Ijo0NTQ5LjUwODQ0NzgzNTYxMywieSI6Mjc3MS40NDY2ODU3OTEwMTU2fV0="></path><path d="M4549.458,2771.48L4530.138,2765.058C4510.817,2758.636,4472.177,2745.791,4452.857,2732.952C4433.537,2720.113,4433.537,2707.28,4433.537,2696.697C4433.537,2686.113,4433.537,2677.78,4433.537,2657.494C4433.537,2637.209,4433.537,2604.971,4433.537,2572.733C4433.537,2540.496,4433.537,2508.258,4433.537,2485.722C4433.537,2463.187,4433.537,2450.354,4373.342,2425.939C4313.148,2401.525,4192.758,2365.53,4132.564,2347.532L4072.369,2329.535" id="Recog-cyclic-special-2" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="Recog-cyclic-special-2" data-points="W3sieCI6NDU0OS40NTc4MTI0OTkyNTUsInkiOjI3NzEuNDgwMDY1MjcwNTA0NH0seyJ4Ijo0NDMzLjUzNjcxODc1MDM3MjUsInkiOjI3MzIuOTQ2Njg1NzkxMDE1Nn0seyJ4Ijo0NDMzLjUzNjcxODc1MDM3MjUsInkiOjI2OTQuNDQ2Njg1NzkxMDE1Nn0seyJ4Ijo0NDMzLjUzNjcxODc1MDM3MjUsInkiOjI2NjkuNDQ2Njg1NzkxMDE1Nn0seyJ4Ijo0NDMzLjUzNjcxODc1MDM3MjUsInkiOjI1NzIuNzMzNDUxODQzMjYxN30seyJ4Ijo0NDMzLjUzNjcxODc1MDM3MjUsInkiOjI0NzYuMDIwMjE3ODk1NTA4fSx7IngiOjQ0MzMuNTM2NzE4NzUwMzcyNSwieSI6MjQzNy41MjAyMTc4OTU1MDh9LHsieCI6NDA2OC41MzY3MTg3NTAzNzI1LCJ5IjoyMzI4LjM4ODkwNDc2NDE5NDZ9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3808.537,2283.52L3295.813,2259.853C2783.09,2236.186,1757.643,2188.853,1244.92,2158.77C732.197,2128.687,732.197,2115.854,732.197,2105.27C732.197,2094.687,732.197,2086.354,755.39,2073.584C778.583,2060.815,824.97,2043.61,848.163,2035.008L871.357,2026.405" id="L_Recog_RabbitMQ_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Recog_RabbitMQ_0" data-points="W3sieCI6MzgwOC41MzY3MTg3NTAzNzI1LCJ5IjoyMjgzLjUxOTYwNjMxNDIwNX0seyJ4Ijo3MzIuMTk2ODc1MDAwMzcyNSwieSI6MjE0MS41MjAyMTc4OTU1MDh9LHsieCI6NzMyLjE5Njg3NTAwMDM3MjUsInkiOjIxMDMuMDIwMjE3ODk1NTA4fSx7IngiOjczMi4xOTY4NzUwMDAzNzI1LCJ5IjoyMDc4LjAyMDIxNzg5NTUwOH0seyJ4Ijo4NzUuMTA3MDMxMjUwMzcyNSwieSI6MjAyNS4wMTQzNzc0MTY2ODA5fV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3808.537,2311.983L3687.447,2332.906C3566.357,2353.829,3324.177,2395.674,3203.088,2423.014C3081.998,2450.354,3081.998,2463.187,2761.32,2484.867C2440.643,2506.547,1799.289,2537.074,1478.612,2552.337L1157.935,2567.601" id="L_Recog_ZipKin_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Recog_ZipKin_0" data-points="W3sieCI6MzgwOC41MzY3MTg3NTAzNzI1LCJ5IjoyMzExLjk4MjcwNzc0ODM4Nn0seyJ4IjozMDgxLjk5NzY1NjI1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjMwODEuOTk3NjU2MjUwMzcyNSwieSI6MjQ3Ni4wMjAyMTc4OTU1MDh9LHsieCI6MTE1My45MzkwNjI1MDAzNzI1LCJ5IjoyNTY3Ljc5MDk3NDIyNzAwNn1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M1046.78,2037.307L1053.711,2044.093C1060.642,2050.878,1074.503,2064.449,1081.434,2075.401C1088.365,2086.354,1088.365,2094.687,1088.365,2105.27C1088.365,2115.854,1088.365,2128.687,1592.728,2158.724C2097.09,2188.762,3105.816,2236.003,3610.178,2259.624L4114.541,2283.245" id="L_RabbitMQ_Alert_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_RabbitMQ_Alert_0" data-points="W3sieCI6MTA0Ni43ODAzMzYxMzM0NTY4LCJ5IjoyMDM3LjMwNjk4Mzk0Nzc1Mjh9LHsieCI6MTA4OC4zNjQ4NDM3NTAzNzI1LCJ5IjoyMDc4LjAyMDIxNzg5NTUwOH0seyJ4IjoxMDg4LjM2NDg0Mzc1MDM3MjUsInkiOjIxMDMuMDIwMjE3ODk1NTA4fSx7IngiOjEwODguMzY0ODQzNzUwMzcyNSwieSI6MjE0MS41MjAyMTc4OTU1MDh9LHsieCI6NDExOC41MzY3MTg3NTAzNzI1LCJ5IjoyMjgzLjQzMTk0MTQ0NjkzNjR9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M4118.537,2300.959L3859.875,2323.719C3601.214,2346.48,3083.891,2392,2825.229,2421.177C2566.568,2450.354,2566.568,2463.187,2285.046,2484.724C2003.523,2506.262,1440.478,2536.503,1158.956,2551.624L877.433,2566.745" id="L_Alert_Postgres_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Alert_Postgres_0" data-points="W3sieCI6NDExOC41MzY3MTg3NTAzNzI1LCJ5IjoyMzAwLjk1OTE5Mzc5ODAwM30seyJ4IjoyNTY2LjU2Nzk2ODc1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjI1NjYuNTY3OTY4NzUwMzcyNSwieSI6MjQ3Ni4wMjAyMTc4OTU1MDh9LHsieCI6ODczLjQzOTA2MjUwMDM3MjUsInkiOjI1NjYuOTU5NTM5OTU0MzEyfV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M4118.537,2303.627L3912.884,2325.942C3707.232,2348.258,3295.927,2392.889,3090.275,2421.621C2884.623,2450.354,2884.623,2463.187,2596.841,2484.767C2309.06,2506.346,1733.497,2536.673,1445.715,2551.836L1157.934,2566.999" id="L_Alert_ZipKin_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Alert_ZipKin_0" data-points="W3sieCI6NDExOC41MzY3MTg3NTAzNzI1LCJ5IjoyMzAzLjYyNjY3ODUwNjkxNDd9LHsieCI6Mjg4NC42MjI2NTYyNTAzNzI1LCJ5IjoyNDM3LjUyMDIxNzg5NTUwOH0seyJ4IjoyODg0LjYyMjY1NjI1MDM3MjUsInkiOjI0NzYuMDIwMjE3ODk1NTA4fSx7IngiOjExNTMuOTM5MDYyNTAwMzcyNSwieSI6MjU2Ny4yMDkxMjAzODM2OH1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M4378.537,2341.24L4418.871,2357.286C4459.206,2373.333,4539.875,2405.427,4580.21,2427.89C4620.545,2450.354,4620.545,2463.187,4694.537,2482.743C4768.529,2502.3,4916.513,2528.579,4990.505,2541.719L5064.497,2554.858" id="L_Alert_Telegram_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Alert_Telegram_0" data-points="W3sieCI6NDM3OC41MzY3MTg3NTAzNzI1LCJ5IjoyMzQxLjIzOTU2MTgyNzI5Njd9LHsieCI6NDYyMC41NDQ1MzEyNTAzNzI1LCJ5IjoyNDM3LjUyMDIxNzg5NTUwOH0seyJ4Ijo0NjIwLjU0NDUzMTI1MDM3MjUsInkiOjI0NzYuMDIwMjE3ODk1NTA4fSx7IngiOjUwNjguNDM1MTU2MjUwMzcyNSwieSI6MjU1NS41NTc4Njk2MjczMjE1fV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M4378.537,2326.966L4442.504,2345.392C4506.472,2363.818,4634.407,2400.669,4698.374,2425.511C4762.341,2450.354,4762.341,2463.187,4853.271,2483.252C4944.2,2503.318,5126.058,2530.615,5216.988,2544.264L5307.917,2557.913" id="L_Alert_SMS_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Alert_SMS_0" data-points="W3sieCI6NDM3OC41MzY3MTg3NTAzNzI1LCJ5IjoyMzI2Ljk2NjM1MzQ5NTQyOX0seyJ4Ijo0NzYyLjM0MTQwNjI1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjQ3NjIuMzQxNDA2MjUwMzcyNSwieSI6MjQ3Ni4wMjAyMTc4OTU1MDh9LHsieCI6NTMxMS44NzI2NTYyNTAzNzI1LCJ5IjoyNTU4LjUwNjUwMjY0NTMwMTd9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M4378.537,2318.454L4467.699,2338.298C4556.862,2358.142,4735.188,2397.831,4824.351,2424.092C4913.513,2450.354,4913.513,2463.187,5019.172,2483.275C5124.832,2503.362,5336.15,2530.704,5441.809,2544.375L5547.468,2558.046" id="L_Alert_Email_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Alert_Email_0" data-points="W3sieCI6NDM3OC41MzY3MTg3NTAzNzI1LCJ5IjoyMzE4LjQ1MzU2ODQ2MDAyNX0seyJ4Ijo0OTEzLjUxMzI4MTI1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjQ5MTMuNTEzMjgxMjUwMzcyNSwieSI6MjQ3Ni4wMjAyMTc4OTU1MDh9LHsieCI6NTU1MS40MzUxNTYyNTAzNzI1LCJ5IjoyNTU4LjU1OTQzNzgxMjQxMzh9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M5165.154,2530.733L5165.154,2521.615C5165.154,2512.496,5165.154,2494.258,5165.154,2478.722C5165.154,2463.187,5165.154,2450.354,5165.154,2419.27C5165.154,2388.187,5165.154,2338.854,5165.154,2289.52C5165.154,2240.187,5165.154,2190.854,5165.154,2159.77C5165.154,2128.687,5165.154,2115.854,5165.154,2105.27C5165.154,2094.687,5165.154,2086.354,5165.154,2066.068C5165.154,2045.782,5165.154,2013.545,5165.154,1981.307C5165.154,1949.069,5165.154,1916.831,5165.154,1894.296C5165.154,1871.76,5165.154,1858.927,5165.154,1836.844C5165.154,1814.76,5165.154,1783.427,5165.154,1749.844C5165.154,1716.26,5165.154,1680.427,5165.154,1644.594C5165.154,1608.76,5165.154,1572.927,5165.154,1539.344C5165.154,1505.76,5165.154,1474.427,5165.154,1443.094C5165.154,1411.76,5165.154,1380.427,5165.154,1351.344C5165.154,1322.26,5165.154,1295.427,5165.154,1277.844C5165.154,1260.26,5165.154,1251.927,5165.154,1241.344C5165.154,1230.76,5165.154,1217.927,5165.154,1186.844C5165.154,1155.76,5165.154,1106.427,5165.154,1059.344C5165.154,1012.26,5165.154,967.427,5165.154,938.594C5165.154,909.76,5165.154,896.927,5165.154,884.094C5165.154,871.26,5165.154,858.427,5165.154,847.844C5165.154,837.26,5165.154,828.927,5165.154,811.344C5165.154,793.76,5165.154,766.927,5165.154,740.094C5165.154,713.26,5165.154,686.427,5165.154,668.844C5165.154,651.26,5165.154,642.927,5165.154,632.344C5165.154,621.76,5165.154,608.927,5176.838,592.8C5188.522,576.673,5211.891,557.252,5223.575,547.542L5235.259,537.832" id="L_Telegram_User_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Telegram_User_0" data-points="W3sieCI6NTE2NS4xNTM5MDYyNTAzNzI1LCJ5IjoyNTMwLjczMzQ1MTg0MzI2MTd9LHsieCI6NTE2NS4xNTM5MDYyNTAzNzI1LCJ5IjoyNDc2LjAyMDIxNzg5NTUwOH0seyJ4Ijo1MTY1LjE1MzkwNjI1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6MjI4OS41MjAyMTc4OTU1MDh9LHsieCI6NTE2NS4xNTM5MDYyNTAzNzI1LCJ5IjoyMTQxLjUyMDIxNzg5NTUwOH0seyJ4Ijo1MTY1LjE1MzkwNjI1MDM3MjUsInkiOjIxMDMuMDIwMjE3ODk1NTA4fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6MjA3OC4wMjAyMTc4OTU1MDh9LHsieCI6NTE2NS4xNTM5MDYyNTAzNzI1LCJ5IjoxOTgxLjMwNjk4Mzk0Nzc1NH0seyJ4Ijo1MTY1LjE1MzkwNjI1MDM3MjUsInkiOjE4ODQuNTkzNzV9LHsieCI6NTE2NS4xNTM5MDYyNTAzNzI1LCJ5IjoxODQ2LjA5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6MTc1Mi4wOTM3NX0seyJ4Ijo1MTY1LjE1MzkwNjI1MDM3MjUsInkiOjE2NDQuNTkzNzV9LHsieCI6NTE2NS4xNTM5MDYyNTAzNzI1LCJ5IjoxNTM3LjA5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6MTQ0My4wOTM3NX0seyJ4Ijo1MTY1LjE1MzkwNjI1MDM3MjUsInkiOjEzNDkuMDkzNzV9LHsieCI6NTE2NS4xNTM5MDYyNTAzNzI1LCJ5IjoxMjY4LjU5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6MTI0My41OTM3NX0seyJ4Ijo1MTY1LjE1MzkwNjI1MDM3MjUsInkiOjEyMDUuMDkzNzV9LHsieCI6NTE2NS4xNTM5MDYyNTAzNzI1LCJ5IjoxMDU3LjA5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6OTIyLjU5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6ODg0LjA5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6ODQ1LjU5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6ODIwLjU5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6NzQwLjA5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6NjU5LjU5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6NjM0LjU5Mzc1fSx7IngiOjUxNjUuMTUzOTA2MjUwMzcyNSwieSI6NTk2LjA5Mzc1fSx7IngiOjUyMzguMzM1Mjg1ODMxMDQxLCJ5Ijo1MzUuMjc0OTg1NzE5ODcwMn1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M5406.654,2530.733L5406.654,2521.615C5406.654,2512.496,5406.654,2494.258,5406.654,2478.722C5406.654,2463.187,5406.654,2450.354,5406.654,2419.27C5406.654,2388.187,5406.654,2338.854,5406.654,2289.52C5406.654,2240.187,5406.654,2190.854,5406.654,2159.77C5406.654,2128.687,5406.654,2115.854,5406.654,2105.27C5406.654,2094.687,5406.654,2086.354,5406.654,2066.068C5406.654,2045.782,5406.654,2013.545,5406.654,1981.307C5406.654,1949.069,5406.654,1916.831,5406.654,1894.296C5406.654,1871.76,5406.654,1858.927,5406.654,1836.844C5406.654,1814.76,5406.654,1783.427,5406.654,1749.844C5406.654,1716.26,5406.654,1680.427,5406.654,1644.594C5406.654,1608.76,5406.654,1572.927,5406.654,1539.344C5406.654,1505.76,5406.654,1474.427,5406.654,1443.094C5406.654,1411.76,5406.654,1380.427,5406.654,1351.344C5406.654,1322.26,5406.654,1295.427,5406.654,1277.844C5406.654,1260.26,5406.654,1251.927,5406.654,1241.344C5406.654,1230.76,5406.654,1217.927,5406.654,1186.844C5406.654,1155.76,5406.654,1106.427,5406.654,1059.344C5406.654,1012.26,5406.654,967.427,5406.654,938.594C5406.654,909.76,5406.654,896.927,5406.654,884.094C5406.654,871.26,5406.654,858.427,5406.654,847.844C5406.654,837.26,5406.654,828.927,5406.654,811.344C5406.654,793.76,5406.654,766.927,5406.654,740.094C5406.654,713.26,5406.654,686.427,5406.654,668.844C5406.654,651.26,5406.654,642.927,5406.654,632.344C5406.654,621.76,5406.654,608.927,5394.97,592.8C5383.286,576.673,5359.917,557.252,5348.233,547.542L5336.549,537.832" id="L_SMS_User_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_SMS_User_0" data-points="W3sieCI6NTQwNi42NTM5MDYyNTAzNzI1LCJ5IjoyNTMwLjczMzQ1MTg0MzI2MTd9LHsieCI6NTQwNi42NTM5MDYyNTAzNzI1LCJ5IjoyNDc2LjAyMDIxNzg5NTUwOH0seyJ4Ijo1NDA2LjY1MzkwNjI1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6MjI4OS41MjAyMTc4OTU1MDh9LHsieCI6NTQwNi42NTM5MDYyNTAzNzI1LCJ5IjoyMTQxLjUyMDIxNzg5NTUwOH0seyJ4Ijo1NDA2LjY1MzkwNjI1MDM3MjUsInkiOjIxMDMuMDIwMjE3ODk1NTA4fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6MjA3OC4wMjAyMTc4OTU1MDh9LHsieCI6NTQwNi42NTM5MDYyNTAzNzI1LCJ5IjoxOTgxLjMwNjk4Mzk0Nzc1NH0seyJ4Ijo1NDA2LjY1MzkwNjI1MDM3MjUsInkiOjE4ODQuNTkzNzV9LHsieCI6NTQwNi42NTM5MDYyNTAzNzI1LCJ5IjoxODQ2LjA5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6MTc1Mi4wOTM3NX0seyJ4Ijo1NDA2LjY1MzkwNjI1MDM3MjUsInkiOjE2NDQuNTkzNzV9LHsieCI6NTQwNi42NTM5MDYyNTAzNzI1LCJ5IjoxNTM3LjA5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6MTQ0My4wOTM3NX0seyJ4Ijo1NDA2LjY1MzkwNjI1MDM3MjUsInkiOjEzNDkuMDkzNzV9LHsieCI6NTQwNi42NTM5MDYyNTAzNzI1LCJ5IjoxMjY4LjU5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6MTI0My41OTM3NX0seyJ4Ijo1NDA2LjY1MzkwNjI1MDM3MjUsInkiOjEyMDUuMDkzNzV9LHsieCI6NTQwNi42NTM5MDYyNTAzNzI1LCJ5IjoxMDU3LjA5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6OTIyLjU5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6ODg0LjA5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6ODQ1LjU5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6ODIwLjU5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6NzQwLjA5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6NjU5LjU5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6NjM0LjU5Mzc1fSx7IngiOjU0MDYuNjUzOTA2MjUwMzcyNSwieSI6NTk2LjA5Mzc1fSx7IngiOjUzMzMuNDcyNTI2NjY5NzA0LCJ5Ijo1MzUuMjc0OTg1NzE5ODcwMn1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M5660.982,2530.733L5660.982,2521.615C5660.982,2512.496,5660.982,2494.258,5660.982,2478.722C5660.982,2463.187,5660.982,2450.354,5660.982,2419.27C5660.982,2388.187,5660.982,2338.854,5660.982,2289.52C5660.982,2240.187,5660.982,2190.854,5660.982,2159.77C5660.982,2128.687,5660.982,2115.854,5660.982,2105.27C5660.982,2094.687,5660.982,2086.354,5660.982,2066.068C5660.982,2045.782,5660.982,2013.545,5660.982,1981.307C5660.982,1949.069,5660.982,1916.831,5660.982,1894.296C5660.982,1871.76,5660.982,1858.927,5660.982,1836.844C5660.982,1814.76,5660.982,1783.427,5660.982,1749.844C5660.982,1716.26,5660.982,1680.427,5660.982,1644.594C5660.982,1608.76,5660.982,1572.927,5660.982,1539.344C5660.982,1505.76,5660.982,1474.427,5660.982,1443.094C5660.982,1411.76,5660.982,1380.427,5660.982,1351.344C5660.982,1322.26,5660.982,1295.427,5660.982,1277.844C5660.982,1260.26,5660.982,1251.927,5660.982,1241.344C5660.982,1230.76,5660.982,1217.927,5660.982,1186.844C5660.982,1155.76,5660.982,1106.427,5660.982,1059.344C5660.982,1012.26,5660.982,967.427,5660.982,938.594C5660.982,909.76,5660.982,896.927,5660.982,884.094C5660.982,871.26,5660.982,858.427,5660.982,847.844C5660.982,837.26,5660.982,828.927,5660.982,811.344C5660.982,793.76,5660.982,766.927,5660.982,740.094C5660.982,713.26,5660.982,686.427,5660.982,668.844C5660.982,651.26,5660.982,642.927,5660.982,632.344C5660.982,621.76,5660.982,608.927,5609.071,588.622C5557.161,568.317,5453.339,540.539,5401.429,526.651L5349.518,512.762" id="L_Email_User_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Email_User_0" data-points="W3sieCI6NTY2MC45ODIwMzEyNTAzNzI1LCJ5IjoyNTMwLjczMzQ1MTg0MzI2MTd9LHsieCI6NTY2MC45ODIwMzEyNTAzNzI1LCJ5IjoyNDc2LjAyMDIxNzg5NTUwOH0seyJ4Ijo1NjYwLjk4MjAzMTI1MDM3MjUsInkiOjI0MzcuNTIwMjE3ODk1NTA4fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6MjI4OS41MjAyMTc4OTU1MDh9LHsieCI6NTY2MC45ODIwMzEyNTAzNzI1LCJ5IjoyMTQxLjUyMDIxNzg5NTUwOH0seyJ4Ijo1NjYwLjk4MjAzMTI1MDM3MjUsInkiOjIxMDMuMDIwMjE3ODk1NTA4fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6MjA3OC4wMjAyMTc4OTU1MDh9LHsieCI6NTY2MC45ODIwMzEyNTAzNzI1LCJ5IjoxOTgxLjMwNjk4Mzk0Nzc1NH0seyJ4Ijo1NjYwLjk4MjAzMTI1MDM3MjUsInkiOjE4ODQuNTkzNzV9LHsieCI6NTY2MC45ODIwMzEyNTAzNzI1LCJ5IjoxODQ2LjA5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6MTc1Mi4wOTM3NX0seyJ4Ijo1NjYwLjk4MjAzMTI1MDM3MjUsInkiOjE2NDQuNTkzNzV9LHsieCI6NTY2MC45ODIwMzEyNTAzNzI1LCJ5IjoxNTM3LjA5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6MTQ0My4wOTM3NX0seyJ4Ijo1NjYwLjk4MjAzMTI1MDM3MjUsInkiOjEzNDkuMDkzNzV9LHsieCI6NTY2MC45ODIwMzEyNTAzNzI1LCJ5IjoxMjY4LjU5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6MTI0My41OTM3NX0seyJ4Ijo1NjYwLjk4MjAzMTI1MDM3MjUsInkiOjEyMDUuMDkzNzV9LHsieCI6NTY2MC45ODIwMzEyNTAzNzI1LCJ5IjoxMDU3LjA5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6OTIyLjU5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6ODg0LjA5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6ODQ1LjU5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6ODIwLjU5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6NzQwLjA5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6NjU5LjU5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6NjM0LjU5Mzc1fSx7IngiOjU2NjAuOTgyMDMxMjUwMzcyNSwieSI6NTk2LjA5Mzc1fSx7IngiOjUzNDUuNjUzOTEwMTE1OTMsInkiOjUxMS43MjgyMDcwNzIwMjg0NX1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M4248.537,2180.02L4248.537,2173.604C4248.537,2167.187,4248.537,2154.354,4248.537,2141.52C4248.537,2128.687,4248.537,2115.854,4248.537,2105.27C4248.537,2094.687,4248.537,2086.354,4248.537,2066.068C4248.537,2045.782,4248.537,2013.545,4248.537,1981.307C4248.537,1949.069,4248.537,1916.831,4248.537,1894.296C4248.537,1871.76,4248.537,1858.927,4248.537,1836.844C4248.537,1814.76,4248.537,1783.427,4248.537,1749.844C4248.537,1716.26,4248.537,1680.427,4248.537,1644.594C4248.537,1608.76,4248.537,1572.927,4248.537,1539.344C4248.537,1505.76,4248.537,1474.427,4248.537,1443.094C4248.537,1411.76,4248.537,1380.427,4248.537,1351.344C4248.537,1322.26,4248.537,1295.427,4248.537,1277.844C4248.537,1260.26,4248.537,1251.927,4248.537,1241.344C4248.537,1230.76,4248.537,1217.927,4193.623,1193.968C4138.709,1170.009,4028.882,1134.924,3973.968,1117.382L3919.054,1099.84" id="L_Alert_Gateway_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Alert_Gateway_0" data-points="W3sieCI6NDI0OC41MzY3MTg3NTAzNzI1LCJ5IjoyMTgwLjAyMDIxNzg5NTUwOH0seyJ4Ijo0MjQ4LjUzNjcxODc1MDM3MjUsInkiOjIxNDEuNTIwMjE3ODk1NTA4fSx7IngiOjQyNDguNTM2NzE4NzUwMzcyNSwieSI6MjEwMy4wMjAyMTc4OTU1MDh9LHsieCI6NDI0OC41MzY3MTg3NTAzNzI1LCJ5IjoyMDc4LjAyMDIxNzg5NTUwOH0seyJ4Ijo0MjQ4LjUzNjcxODc1MDM3MjUsInkiOjE5ODEuMzA2OTgzOTQ3NzU0fSx7IngiOjQyNDguNTM2NzE4NzUwMzcyNSwieSI6MTg4NC41OTM3NX0seyJ4Ijo0MjQ4LjUzNjcxODc1MDM3MjUsInkiOjE4NDYuMDkzNzV9LHsieCI6NDI0OC41MzY3MTg3NTAzNzI1LCJ5IjoxNzUyLjA5Mzc1fSx7IngiOjQyNDguNTM2NzE4NzUwMzcyNSwieSI6MTY0NC41OTM3NX0seyJ4Ijo0MjQ4LjUzNjcxODc1MDM3MjUsInkiOjE1MzcuMDkzNzV9LHsieCI6NDI0OC41MzY3MTg3NTAzNzI1LCJ5IjoxNDQzLjA5Mzc1fSx7IngiOjQyNDguNTM2NzE4NzUwMzcyNSwieSI6MTM0OS4wOTM3NX0seyJ4Ijo0MjQ4LjUzNjcxODc1MDM3MjUsInkiOjEyNjguNTkzNzV9LHsieCI6NDI0OC41MzY3MTg3NTAzNzI1LCJ5IjoxMjQzLjU5Mzc1fSx7IngiOjQyNDguNTM2NzE4NzUwMzcyNSwieSI6MTIwNS4wOTM3NX0seyJ4IjozOTE1LjI0Mzc1MDAwMDM3MjUsInkiOjEwOTguNjIyNTQ3NzUzODUxfV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M3655.244,1004.616L3621.379,990.945C3587.515,977.275,3519.785,949.934,3485.921,929.847C3452.056,909.76,3452.056,896.927,3452.056,884.094C3452.056,871.26,3452.056,858.427,3452.056,847.844C3452.056,837.26,3452.056,828.927,3448.75,821.089C3445.443,813.251,3438.83,805.909,3435.524,802.237L3432.218,798.566" id="L_Gateway_Frontend_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_Gateway_Frontend_0" data-points="W3sieCI6MzY1NS4yNDM3NTAwMDAzNzI1LCJ5IjoxMDA0LjYxNTc5MDg5Mjg5MDd9LHsieCI6MzQ1Mi4wNTYyNTAwMDAzNzI1LCJ5Ijo5MjIuNTkzNzV9LHsieCI6MzQ1Mi4wNTYyNTAwMDAzNzI1LCJ5Ijo4ODQuMDkzNzV9LHsieCI6MzQ1Mi4wNTYyNTAwMDAzNzI1LCJ5Ijo4NDUuNTkzNzV9LHsieCI6MzQ1Mi4wNTYyNTAwMDAzNzI1LCJ5Ijo4MjAuNTkzNzV9LHsieCI6MzQyOS41NDA3MjIwNTAwNjIsInkiOjc5NS41OTM3NX1d" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M316.71,537.742L311.544,547.467C306.377,557.193,296.045,576.643,290.879,592.785C285.713,608.927,285.713,621.76,285.713,632.344C285.713,642.927,285.713,651.26,285.713,668.844C285.713,686.427,285.713,713.26,285.713,740.094C285.713,766.927,285.713,793.76,285.713,811.344C285.713,828.927,285.713,837.26,769.875,847.844C1254.037,858.427,2222.361,871.26,2706.523,883.427C3190.685,895.594,3190.685,907.094,3190.685,912.844L3190.685,918.594" id="L_DockerReg_LayerBack_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_DockerReg_LayerBack_0" data-points="W3sieCI6MzE2LjcwOTkyMjA4ODI0NzIsInkiOjUzNy43NDIxODc1fSx7IngiOjI4NS43MTI1MDAwMDAzNzI1MywieSI6NTk2LjA5Mzc1fSx7IngiOjI4NS43MTI1MDAwMDAzNzI1MywieSI6NjM0LjU5Mzc1fSx7IngiOjI4NS43MTI1MDAwMDAzNzI1MywieSI6NjU5LjU5Mzc1fSx7IngiOjI4NS43MTI1MDAwMDAzNzI1MywieSI6NzQwLjA5Mzc1fSx7IngiOjI4NS43MTI1MDAwMDAzNzI1MywieSI6ODIwLjU5Mzc1fSx7IngiOjI4NS43MTI1MDAwMDAzNzI1MywieSI6ODQ1LjU5Mzc1fSx7IngiOjMxOTAuNjg1MTU2MjUwMzcyNSwieSI6ODg0LjA5Mzc1fSx7IngiOjMxOTAuNjg1MTU2MjUwMzcyNSwieSI6OTIyLjU5Mzc1fSx7IngiOjMxOTAuNjg1MTU2MjUwMzcyNSwieSI6MTA1Ny4wOTM3NX0seyJ4IjozMTkwLjY4NTE1NjI1MDM3MjUsInkiOjEyMDUuMDkzNzV9LHsieCI6MzE5MC42ODUxNTYyNTAzNzI1LCJ5IjoxMjQzLjU5Mzc1fSx7IngiOjMxOTAuNjg1MTU2MjUwMzcyNSwieSI6MTI2OC41OTM3NX0seyJ4IjozMTkwLjY4NTE1NjI1MDM3MjUsInkiOjEzNDkuMDkzNzV9LHsieCI6MzE5MC42ODUxNTYyNTAzNzI1LCJ5IjoxNDQzLjA5Mzc1fSx7IngiOjMxOTAuNjg1MTU2MjUwMzcyNSwieSI6MTUzNy4wOTM3NX0seyJ4IjozMTkwLjY4NTE1NjI1MDM3MjUsInkiOjE2NDQuNTkzNzV9LHsieCI6MzE5MC42ODUxNTYyNTAzNzI1LCJ5IjoxNzUyLjA5Mzc1fSx7IngiOjMxOTAuNjg1MTU2MjUwMzcyNSwieSI6MTg0Ni4wOTM3NX0seyJ4IjozMTkwLjY4NTE1NjI1MDM3MjUsInkiOjE4ODQuNTkzNzV9LHsieCI6MzE5MC42ODUxNTYyNTAzNzI1LCJ5IjoxOTgxLjMwNjk4Mzk0Nzc1NH0seyJ4IjozMTkwLjY4NTE1NjI1MDM3MjUsInkiOjIwNzguMDIwMjE3ODk1NTA4fSx7IngiOjMxOTAuNjg1MTU2MjUwMzcyNSwieSI6MjEwMy4wMjAyMTc4OTU1MDh9LHsieCI6MzE5MC42ODUxNTYyNTAzNzI1LCJ5IjoyMTQxLjUyMDIxNzg5NTUwOH0seyJ4IjozMTkwLjY4NTE1NjI1MDM3MjUsInkiOjIyODkuNTIwMjE3ODk1NTA4fSx7IngiOjMxOTAuNjg1MTU2MjUwMzcyNSwieSI6MjQzNy41MjAyMTc4OTU1MDh9LHsieCI6MzE5MC42ODUxNTYyNTAzNzI1LCJ5IjoyNDc2LjAyMDIxNzg5NTUwOH0seyJ4IjozNzMyLjQ3NjU2MjUsInkiOjI1NTQuMDE4MjM3MTI1OTQ4fV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M361.332,537.742L366.499,547.467C371.665,557.193,381.997,576.643,387.163,592.785C392.33,608.927,392.33,621.76,392.33,632.344C392.33,642.927,392.33,651.26,608.761,662.424C825.193,673.588,1258.057,687.583,1474.488,694.581L1690.92,701.578" id="L_DockerReg_LayerFront_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_DockerReg_LayerFront_0" data-points="W3sieCI6MzYxLjMzMjI2NTQxMjQ5Nzg2LCJ5Ijo1MzcuNzQyMTg3NX0seyJ4IjozOTIuMzI5Njg3NTAwMzcyNTMsInkiOjU5Ni4wOTM3NX0seyJ4IjozOTIuMzI5Njg3NTAwMzcyNTMsInkiOjYzNC41OTM3NX0seyJ4IjozOTIuMzI5Njg3NTAwMzcyNTMsInkiOjY1OS41OTM3NX0seyJ4IjozMjU3LjY4MTI1MDAwMDM3MjUsInkiOjczNi44MDk0NTM1ODE2NTYzfV0=" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path><path d="M308.339,537.742L301.235,547.467C294.13,557.193,279.921,576.643,272.817,592.785C265.713,608.927,265.713,621.76,265.713,632.344C265.713,642.927,265.713,651.26,265.713,668.844C265.713,686.427,265.713,713.26,265.713,740.094C265.713,766.927,265.713,793.76,265.713,811.344C265.713,828.927,265.713,837.26,533.367,847.844C801.022,858.427,1336.332,871.26,1603.987,884.094C1871.642,896.927,1871.642,909.76,1871.642,938.594C1871.642,967.427,1871.642,1012.26,1871.642,1059.344C1871.642,1106.427,1871.642,1155.76,1871.642,1186.844C1871.642,1217.927,1871.642,1230.76,1871.642,1241.344C1871.642,1251.927,1871.642,1260.26,1869.259,1264.427C1866.875,1268.594,1862.108,1268.594,1859.725,1268.594L1857.342,1268.594" id="L_DockerReg_VisionAgent_0" class=" edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" style=";" data-edge="true" data-et="edge" data-id="L_DockerReg_VisionAgent_0" data-points="W3sieCI6MzA4LjMzOTM0OTg4MTE2MjcsInkiOjUzNy43NDIxODc1fSx7IngiOjI2NS43MTI1MDAwMDAzNzI1MywieSI6NTk2LjA5Mzc1fSx7IngiOjI2NS43MTI1MDAwMDAzNzI1MywieSI6NjM0LjU5Mzc1fSx7IngiOjI2NS43MTI1MDAwMDAzNzI1MywieSI6NjU5LjU5Mzc1fSx7IngiOjI2NS43MTI1MDAwMDAzNzI1MywieSI6NzQwLjA5Mzc1fSx7IngiOjI2NS43MTI1MDAwMDAzNzI1MywieSI6ODIwLjU5Mzc1fSx7IngiOjI2NS43MTI1MDAwMDAzNzI1MywieSI6ODQ1LjU5Mzc1fSx7IngiOjE4NzEuNjQyMTg3NTAwMzcyNSwieSI6ODg0LjA5Mzc1fSx7IngiOjE4NzEuNjQyMTg3NTAwMzcyNSwieSI6OTIyLjU5Mzc1fSx7IngiOjE4NzEuNjQyMTg3NTAwMzcyNSwieSI6MTA1Ny4wOTM3NX0seyJ4IjoxODcxLjY0MjE4NzUwMDM3MjUsInkiOjEyMDUuMDkzNzV9LHsieCI6MTg3MS42NDIxODc1MDAzNzI1LCJ5IjoxMjQzLjU5Mzc1fSx7IngiOjE4NzEuNjQyMTg3NTAwMzcyNSwieSI6MTI2OC41OTM3NX0seyJ4IjoxODUzLjM0MTUyNzU2MjYsInkiOjEyOTMuNTkzNzV9XQ==" marker-end="url(#mermaid-diagram-1765524990608_flowchart-v2-pointEnd)"></path></g><g class="edgeLabels"><g class="edgeLabel" transform="translate(162.328125, 209.390625)"><g class="label" data-id="L_Dev_GitHub_0" transform="translate(-85.5, -13.5)"><foreignObject width="171" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Commit/Push C√≥digo</p></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" data-id="GitHub-cyclic-special-1" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(146.17578125, 596.09375)"><g class="label" data-id="GitHub-cyclic-special-mid" transform="translate(-82.0234375, -13.5)"><foreignObject width="164.046875" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Dispara Build e Teste</p></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" data-id="GitHub-cyclic-special-2" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(339.02109375037253, 395.390625)"><g class="label" data-id="L_GitHub_DockerReg_0" transform="translate(-84.515625, -13.5)"><foreignObject width="169.03125" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Push Imagem Docker</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(4413.5367187503725, 1752.09375)"><g class="label" data-id="L_Gateway_Eureka_0" transform="translate(-75.5703125, -13.5)"><foreignObject width="151.140625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Registro/Heartbeat</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(3900.7515625003725, 2437.520217895508)"><g class="label" data-id="L_Auth_Eureka_0" transform="translate(-75.5703125, -13.5)"><foreignObject width="151.140625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Registro/Heartbeat</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(3729.6109375003725, 2437.520217895508)"><g class="label" data-id="L_Recog_Eureka_0" transform="translate(-75.5703125, -13.5)"><foreignObject width="151.140625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Registro/Heartbeat</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(3558.4703125003725, 2437.520217895508)"><g class="label" data-id="L_Alert_Eureka_0" transform="translate(-75.5703125, -13.5)"><foreignObject width="151.140625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Registro/Heartbeat</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(3379.5562500003725, 596.09375)"><g class="label" data-id="L_User_Frontend_0" transform="translate(-62.84375, -13.5)"><foreignObject width="125.6875" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">1. Login / Ativar</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(3867.6695312503725, 884.09375)"><g class="label" data-id="L_Frontend_Gateway_0" transform="translate(-79.9609375, -13.5)"><foreignObject width="159.921875" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">2. Requisi√ß√£o HTTPS</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(3628.5367187503725, 1644.59375)"><g class="label" data-id="L_Gateway_Auth_0" transform="translate(-100, -27)"><foreignObject width="200" height="54"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="edgeLabel "><p>2a. Autentica√ß√£o/Validar JWT</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(2703.3726562503725, 2437.520217895508)"><g class="label" data-id="L_Auth_Postgres_0" transform="translate(-72.5625, -13.5)"><foreignObject width="145.125" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>2b. Dados Usu√°rio</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(2846.5054687503725, 1205.09375)"><g class="label" data-id="L_Gateway_VA_Flask_0" transform="translate(-84.015625, -13.5)"><foreignObject width="168.03125" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">3. POST /start (Proxy)</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(2027.6148437503725, 1443.09375)"><g class="label" data-id="L_VA_Flask_VA_Core_0" transform="translate(-64.421875, -13.5)"><foreignObject width="128.84375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>3a. Inicia Thread</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(2045.4781250003725, 1644.59375)"><g class="label" data-id="L_VA_Core_Camera_0" transform="translate(-28.6953125, -13.5)"><foreignObject width="57.390625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">4. Ligar</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(2025.04383, 1668.73261)"><g class="label" data-id="L_Camera_VA_Core_0" transform="translate(-56.375, -13.5)"><foreignObject width="112.75" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Frames Brutos</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1505.6500000003725, 1443.09375)"><g class="label" data-id="L_VA_Core_VA_Flask_0" transform="translate(-53.25, -13.5)"><foreignObject width="106.5" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Buffer MJPEG</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1751.6421875003725, 1057.09375)"><g class="label" data-id="L_VA_Flask_Frontend_0" transform="translate(-100, -27)"><foreignObject width="200" height="54"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="edgeLabel "><p>Stream HTTP (Visualiza√ß√£o)</p></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" data-id="VA_Core-cyclic-special-1" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1864.0328125003725, 1846.09375)"><g class="label" data-id="VA_Core-cyclic-special-mid" transform="translate(-33.6953125, -13.5)"><foreignObject width="67.390625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Detectar</p></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" data-id="VA_Core-cyclic-special-2" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1460.1656250003725, 1752.09375)"><g class="label" data-id="L_VA_Core_MinIO_0" transform="translate(-73.03125, -13.5)"><foreignObject width="146.0625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">5. Upload Imagem</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1313.6890625003725, 1752.09375)"><g class="label" data-id="L_MinIO_VA_Core_0" transform="translate(-53.4453125, -13.5)"><foreignObject width="106.890625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>URL Assinada</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1671.7671875003725, 1644.59375)"><g class="label" data-id="L_VA_Core_VA_Queue_0" transform="translate(-71.5625, -13.5)"><foreignObject width="143.125" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">6. Enfileirar Dados</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1671.7671875003725, 1846.09375)"><g class="label" data-id="L_VA_Queue_RabbitMQ_0" transform="translate(-94.484375, -13.5)"><foreignObject width="188.96875" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">7. Publica: vision_events</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(914.6226562503725, 2141.520217895508)"><g class="label" data-id="L_RabbitMQ_Recog_0" transform="translate(-76.2109375, -13.5)"><foreignObject width="152.421875" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">8. Consome Evento</span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" data-id="Recog-cyclic-special-1" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(4549.9976562503725, 2732.9466857910156)"><g class="label" data-id="Recog-cyclic-special-mid" transform="translate(-96.4609375, -13.5)"><foreignObject width="192.921875" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">9. Aplica Regras (Drools)</span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" data-id="Recog-cyclic-special-2" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(732.1968750003725, 2141.520217895508)"><g class="label" data-id="L_Recog_RabbitMQ_0" transform="translate(-74.328125, -13.5)"><foreignObject width="148.65625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">10. Publica: Alertas</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(3081.9976562503725, 2437.520217895508)"><g class="label" data-id="L_Recog_ZipKin_0" transform="translate(-88.6875, -13.5)"><foreignObject width="177.375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Logs de Rastreamento</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1088.3648437503725, 2141.520217895508)"><g class="label" data-id="L_RabbitMQ_Alert_0" transform="translate(-77.53125, -13.5)"><foreignObject width="155.0625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">11. Consome Alerta</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(2566.5679687503725, 2437.520217895508)"><g class="label" data-id="L_Alert_Postgres_0" transform="translate(-44.2421875, -13.5)"><foreignObject width="88.484375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">12. Persiste</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(2884.6226562503725, 2437.520217895508)"><g class="label" data-id="L_Alert_ZipKin_0" transform="translate(-88.6875, -13.5)"><foreignObject width="177.375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Logs de Rastreamento</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(4620.5445312503725, 2437.520217895508)"><g class="label" data-id="L_Alert_Telegram_0" transform="translate(-50.546875, -13.5)"><foreignObject width="101.09375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">13. Envia API</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(4762.3414062503725, 2437.520217895508)"><g class="label" data-id="L_Alert_SMS_0" transform="translate(-71.25, -13.5)"><foreignObject width="142.5" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">13. Envia Gateway</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(4913.5132812503725, 2437.520217895508)"><g class="label" data-id="L_Alert_Email_0" transform="translate(-59.921875, -13.5)"><foreignObject width="119.84375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">13. Envia SMTP</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(5165.1539062503725, 1537.09375)"><g class="label" data-id="L_Telegram_User_0" transform="translate(-69.765625, -13.5)"><foreignObject width="139.53125" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>üö® NOTIFICA√á√ÉO</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(5406.6539062503725, 1537.09375)"><g class="label" data-id="L_SMS_User_0" transform="translate(-69.765625, -13.5)"><foreignObject width="139.53125" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>üö® NOTIFICA√á√ÉO</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(5660.9820312503725, 1537.09375)"><g class="label" data-id="L_Email_User_0" transform="translate(-69.765625, -13.5)"><foreignObject width="139.53125" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>üö® NOTIFICA√á√ÉO</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(4248.5367187503725, 1644.59375)"><g class="label" data-id="L_Alert_Gateway_0" transform="translate(-76.5078125, -13.5)"><foreignObject width="153.015625" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">14. Pub WebSocket</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(3452.0562500003725, 884.09375)"><g class="label" data-id="L_Gateway_Frontend_0" transform="translate(-64.890625, -13.5)"><foreignObject width="129.78125" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel ">15. Push Pop-up</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1599.6741, 863.00786)"><g class="label" data-id="L_DockerReg_LayerBack_0" transform="translate(-86.6171875, -13.5)"><foreignObject width="173.234375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Pull Imagens (Deploy)</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(978.87079, 678.55697)"><g class="label" data-id="L_DockerReg_LayerFront_0" transform="translate(-86.6171875, -13.5)"><foreignObject width="173.234375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Pull Imagens (Deploy)</p></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(1109.18449, 865.81485)"><g class="label" data-id="L_DockerReg_VisionAgent_0" transform="translate(-86.6171875, -13.5)"><foreignObject width="173.234375" height="27"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "><p>Pull Imagens (Deploy)</p></span></div></foreignObject></g></g></g><g class="nodes"><g class="node default person " id="flowchart-User-0" transform="translate(5285.9039062503725, 495.7421875)"><circle class="basic label-container" style="fill:#08427b !important;stroke:#052e56 !important;stroke-width:2px !important" r="61.8515625" cx="0" cy="0"></circle><g class="label" style="color:#ffffff !important" transform="translate(-54.3515625, -27)"><rect></rect><foreignObject width="108.703125" height="54"><div style="color: rgb(255, 255, 255) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üë§ Seguran√ßa<br/>[Pessoa]</p></span></div></foreignObject></g></g><g class="node default person " id="flowchart-Dev-1" transform="translate(162.328125, 89.4453125)"><circle class="basic label-container" style="fill:#08427b !important;stroke:#052e56 !important;stroke-width:2px !important" r="81.4453125" cx="0" cy="0"></circle><g class="label" style="color:#ffffff !important" transform="translate(-73.9453125, -27)"><rect></rect><foreignObject width="147.890625" height="54"><div style="color: rgb(255, 255, 255) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üë®‚Äçüíª Desenvolvedor<br/>[Pessoa]</p></span></div></foreignObject></g></g><g class="node default external " id="flowchart-Telegram-2" transform="translate(5165.1539062503725, 2572.7334518432617)"><rect class="basic label-container" style="fill:#999999 !important;stroke:#6b6b6b !important;stroke-width:2px !important" x="-96.71875" y="-42" width="193.4375" height="84"></rect><g class="label" style="color:#ffffff !important" transform="translate(-66.71875, -27)"><rect></rect><foreignObject width="133.4375" height="54"><div style="color: rgb(255, 255, 255) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>‚úàÔ∏è API Telegram<br/>[Sistema]</p></span></div></foreignObject></g></g><g class="node default external " id="flowchart-SMS-3" transform="translate(5406.6539062503725, 2572.7334518432617)"><rect class="basic label-container" style="fill:#999999 !important;stroke:#6b6b6b !important;stroke-width:2px !important" x="-94.78125" y="-42" width="189.5625" height="84"></rect><g class="label" style="color:#ffffff !important" transform="translate(-64.78125, -27)"><rect></rect><foreignObject width="129.5625" height="54"><div style="color: rgb(255, 255, 255) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üì± Gateway SMS<br/>[Sistema]</p></span></div></foreignObject></g></g><g class="node default external " id="flowchart-Email-4" transform="translate(5660.9820312503725, 2572.7334518432617)"><rect class="basic label-container" style="fill:#999999 !important;stroke:#6b6b6b !important;stroke-width:2px !important" x="-109.546875" y="-42" width="219.09375" height="84"></rect><g class="label" style="color:#ffffff !important" transform="translate(-79.546875, -27)"><rect></rect><foreignObject width="159.09375" height="54"><div style="color: rgb(255, 255, 255) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üìß Servi√ßo de Email<br/>[Sistema]</p></span></div></foreignObject></g></g><g class="node default external " id="flowchart-GitHub-5" transform="translate(162.328125, 314.890625)"><rect class="basic label-container" style="fill:#999999 !important;stroke:#6b6b6b !important;stroke-width:2px !important" x="-119.328125" y="-42" width="238.65625" height="84"></rect><g class="label" style="color:#ffffff !important" transform="translate(-89.328125, -27)"><rect></rect><foreignObject width="178.65625" height="54"><div style="color: rgb(255, 255, 255) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üêô GitHub<br/>[Sistema: VCS/Actions]</p></span></div></foreignObject></g></g><g class="node default external " id="flowchart-DockerReg-6" transform="translate(339.02109375037253, 495.7421875)"><rect class="basic label-container" style="fill:#999999 !important;stroke:#6b6b6b !important;stroke-width:2px !important" x="-107" y="-42" width="214" height="84"></rect><g class="label" style="color:#ffffff !important" transform="translate(-77, -27)"><rect></rect><foreignObject width="154" height="54"><div style="color: rgb(255, 255, 255) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üê≥ Docker Registry<br/>[Sistema: Artefatos]</p></span></div></foreignObject></g></g><g class="node default container " id="flowchart-Frontend-7" transform="translate(3379.5562500003725, 740.09375)"><rect class="basic label-container" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important" x="-121.875" y="-55.5" width="243.75" height="111"></rect><g class="label" style="color:#ffffff !important" transform="translate(-91.875, -40.5)"><rect></rect><foreignObject width="183.75" height="81"><div style="color: rgb(255, 255, 255) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üñ•Ô∏è Aplica√ß√£o Frontend<br/>[Container: Angular 21]<br/>Tech: RxStomp, Axios</p></span></div></foreignObject></g></g><g class="node default component " id="flowchart-Camera-8" transform="translate(2317.3257812503725, 1752.09375)"><rect class="basic label-container" style="fill:#85bbf0 !important;stroke:#5d82a8 !important;stroke-width:2px !important" x="-130" y="-55.5" width="260" height="111"></rect><g class="label" style="color:#000000 !important" transform="translate(-100, -40.5)"><rect></rect><foreignObject width="200" height="81"><div style="color: rgb(0, 0, 0) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#000000 !important" class="nodeLabel "><p>üìπ Dispositivo de C√¢mera<br/>[Hardware]</p></span></div></foreignObject></g></g><g class="node default component " id="flowchart-VA_Flask-9" transform="translate(1812.714062500745, 1349.09375)"><rect class="basic label-container" style="fill:#85bbf0 !important;stroke:#5d82a8 !important;stroke-width:2px !important" x="-130" y="-55.5" width="260" height="111"></rect><g class="label" style="color:#000000 !important" transform="translate(-100, -40.5)"><rect></rect><foreignObject width="200" height="81"><div style="color: rgb(0, 0, 0) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#000000 !important" class="nodeLabel "><p>üåê Servidor Flask<br/>[Componente: API/MJPEG]</p></span></div></foreignObject></g></g><g class="node default component " id="flowchart-VA_Core-10" transform="translate(1812.714062500745, 1537.09375)"><rect class="basic label-container" style="fill:#85bbf0 !important;stroke:#5d82a8 !important;stroke-width:2px !important" x="-130" y="-55.5" width="260" height="111"></rect><g class="label" style="color:#000000 !important" transform="translate(-100, -40.5)"><rect></rect><foreignObject width="200" height="81"><div style="color: rgb(0, 0, 0) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#000000 !important" class="nodeLabel "><p>üß† Motor de Vigil√¢ncia<br/>[Componente: OpenCV/YOLOv8]</p></span></div></foreignObject></g></g><g class="node default component " id="flowchart-VA_Queue-11" transform="translate(1671.7671875003725, 1752.09375)"><rect class="basic label-container" style="fill:#85bbf0 !important;stroke:#5d82a8 !important;stroke-width:2px !important" x="-103.5703125" y="-42" width="207.140625" height="84"></rect><g class="label" style="color:#000000 !important" transform="translate(-73.5703125, -27)"><rect></rect><foreignObject width="147.140625" height="54"><div style="color: rgb(0, 0, 0) !important; display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#000000 !important" class="nodeLabel "><p>üîÑ Fila Ass√≠ncrona<br/>[Componente]</p></span></div></foreignObject></g></g><g class="node default container " id="flowchart-Eureka-12" transform="translate(3862.4765625, 2572.7334518432617)"><rect class="basic label-container" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important" x="-130" y="-69" width="260" height="138"></rect><g class="label" style="color:#ffffff !important" transform="translate(-100, -54)"><rect></rect><foreignObject width="200" height="108"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üîç Servidor Eureka<br/>[Container: Spring Boot]<br/>Tech: Descoberta de Servi√ßo</p></span></div></foreignObject></g></g><g class="node default container " id="flowchart-Gateway-13" transform="translate(3785.2437500003725, 1057.09375)"><rect class="basic label-container" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important" x="-130" y="-109.5" width="260" height="219"></rect><g class="label" style="color:#ffffff !important" transform="translate(-100, -94.5)"><rect></rect><foreignObject width="200" height="189"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>‚õ©Ô∏è API Gateway<br/>[Container: Spring Boot 3]<br/>Tech: Spring Security, Spring Cloud Circuit Breaker,<br/>Resilience4j</p></span></div></foreignObject></g></g><g class="node default container " id="flowchart-Auth-14" transform="translate(3628.5367187503725, 2289.520217895508)"><rect class="basic label-container" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important" x="-130" y="-109.5" width="260" height="219"></rect><g class="label" style="color:#ffffff !important" transform="translate(-100, -94.5)"><rect></rect><foreignObject width="200" height="189"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üîê Servi√ßo de Autentica√ß√£o<br/>[Container: Spring Boot 3]<br/>Tech: Spring Security, Spring Web,<br/>Spring Data JPA</p></span></div></foreignObject></g></g><g class="node default container " id="flowchart-Recog-15" transform="translate(3938.5367187503725, 2289.520217895508)"><rect class="basic label-container" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important" x="-130" y="-109.5" width="260" height="219"></rect><g class="label" style="color:#ffffff !important" transform="translate(-100, -94.5)"><rect></rect><foreignObject width="200" height="189"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üß† Servi√ßo de Reconhecimento<br/>[Container: Java 21]<br/>Tech: Drools, Spring AMQP,<br/>Slf4j, Spring Cloud Sleuth</p></span></div></foreignObject></g></g><g class="node default container " id="flowchart-Alert-16" transform="translate(4248.5367187503725, 2289.520217895508)"><rect class="basic label-container" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important" x="-130" y="-109.5" width="260" height="219"></rect><g class="label" style="color:#ffffff !important" transform="translate(-100, -94.5)"><rect></rect><foreignObject width="200" height="189"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üö® Servi√ßo de Alerta<br/>[Container: Spring Boot 3]<br/>Tech: Spring Web, Java Mail, Spring AMQP,<br/>Spring Data JPA, Slf4j, Spring Cloud Sleuth</p></span></div></foreignObject></g></g><g class="node default database " id="flowchart-MinIO-17" transform="translate(705.3023437503725, 1981.306983947754)"><path d="M0,15.808823529411764 a107.5,15.808823529411764 0,0,0 215,0 a107.5,15.808823529411764 0,0,0 -215,0 l0,111.80882352941177 a107.5,15.808823529411764 0,0,0 215,0 l0,-111.80882352941177" class="basic label-container" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important" label-offset-y="15.808823529411764" transform="translate(-107.5, -71.71323529411765)"></path><g class="label" style="color:#ffffff !important" transform="translate(-100, -30.5)"><rect></rect><foreignObject width="200" height="81"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üóÑÔ∏è MinIO<br/>[Container: Object Storage]</p></span></div></foreignObject></g></g><g class="node default database " id="flowchart-RabbitMQ-18" transform="translate(989.6070312503725, 1981.306983947754)"><g class="basic label-container outer-path"><path d="M-110 -55.5 C-50.55542621803153 -55.5, 8.889147563936945 -55.5, 110 -55.5 C110 -55.5, 110 -55.5, 110 -55.5 C110.13405558506295 -55.49445541998839, 110.2681111701259 -55.48891083997678, 110.41289672736166 -55.48292246503335 C110.5584362871025 -55.4647809778308, 110.70397584684333 -55.44663949062825, 110.82297295140367 -55.43180651701361 C110.91240319119727 -55.413054967625754, 111.00183343099087 -55.394303418237904, 111.227427435704 -55.34700132969665 C111.36247363533205 -55.30679633411136, 111.4975198349601 -55.26659133852606, 111.62349734602341 -55.229086208503176 C111.7283265207939 -55.18818173757655, 111.83315569556439 -55.147277266649915, 112.00847712326485 -55.07886663327529 C112.13719523297013 -55.01594018382854, 112.26591334267542 -54.95301373438179, 112.37973696518537 -54.89736875603244 C112.49431115108213 -54.82909735995327, 112.60888533697889 -54.760825963874105, 112.73474079061214 -54.685832391312644 C112.83787830858869 -54.61219361886941, 112.94101582656523 -54.53855484642618, 113.07106356344833 -54.44570254698197 C113.19664887289855 -54.339337215602846, 113.32223418234875 -54.23297188422372, 113.3864078581287 -54.17861955336566 C113.45377089945845 -54.111256512035915, 113.52113394078819 -54.04389347070617, 113.67861955336566 -53.886407858128706 C113.74282823438446 -53.810596811704244, 113.80703691540326 -53.73478576527978, 113.94570254698196 -53.57106356344834 C114.03296180423037 -53.44884936955998, 114.12022106147877 -53.32663517567162, 114.18583239131264 -53.234740790612136 C114.24175713258849 -53.14088696498162, 114.29768187386432 -53.04703313935111, 114.39736875603245 -52.879736965185366 C114.45686867543435 -52.75802793471622, 114.51636859483625 -52.63631890424708, 114.57886663327528 -52.508477123264846 C114.62033340009913 -52.40220690761188, 114.66180016692297 -52.29593669195891, 114.72908620850318 -52.12349734602342 C114.76180819075846 -52.01358614510069, 114.79453017301374 -51.90367494417795, 114.84700132969665 -51.727427435703994 C114.8788364445059 -51.57559881118024, 114.91067155931513 -51.42377018665649, 114.93180651701361 -51.32297295140367 C114.94696954488394 -51.20132799606198, 114.96213257275427 -51.07968304072028, 114.98292246503335 -50.91289672736166 C114.9868558577596 -50.81779605930492, 114.99078925048582 -50.72269539124817, 115 -50.5 C115 -50.5, 115 -50.5, 115 -50.5 C115 -16.91008227615451, 115 16.679835447690976, 115 50.5 C115 50.5, 115 50.5, 115 50.5 C114.99603890380212 50.59577047624639, 114.99207780760423 50.691540952492794, 114.98292246503335 50.91289672736166 C114.9665553207387 51.044201672114035, 114.95018817644407 51.175506616866414, 114.93180651701361 51.32297295140367 C114.90024016812988 51.47351977245241, 114.86867381924615 51.62406659350115, 114.84700132969665 51.727427435703994 C114.80414968179032 51.87136358376979, 114.76129803388399 52.0152997318356, 114.72908620850318 52.12349734602342 C114.69072328012817 52.22181310545581, 114.65236035175315 52.3201288648882, 114.57886663327528 52.508477123264846 C114.54149539125348 52.58492122066233, 114.50412414923169 52.66136531805981, 114.39736875603245 52.879736965185366 C114.31668014331608 53.01514992938485, 114.2359915305997 53.150562893584336, 114.18583239131264 53.234740790612136 C114.09225311620433 53.365806720264295, 113.99867384109602 53.496872649916455, 113.94570254698196 53.57106356344834 C113.86367582420517 53.66791233202306, 113.78164910142839 53.764761100597774, 113.67861955336566 53.886407858128706 C113.60305250503757 53.96197490645681, 113.52748545670946 54.037541954784906, 113.3864078581287 54.17861955336566 C113.31063861663206 54.242792827416714, 113.23486937513542 54.30696610146777, 113.07106356344833 54.44570254698197 C112.94882038869287 54.532982496171776, 112.82657721393738 54.62026244536159, 112.73474079061214 54.685832391312644 C112.62359848959348 54.752058827875175, 112.51245618857482 54.818285264437705, 112.37973696518537 54.89736875603244 C112.29976799489285 54.93646320341007, 112.21979902460033 54.9755576507877, 112.00847712326485 55.07886663327529 C111.91883994600423 55.113843168378516, 111.8292027687436 55.14881970348175, 111.62349734602341 55.229086208503176 C111.51148180569585 55.26243467974308, 111.39946626536829 55.29578315098298, 111.227427435704 55.34700132969665 C111.0748512906841 55.378993183071444, 110.92227514566419 55.410985036446235, 110.82297295140367 55.43180651701361 C110.70249736261773 55.44682378349478, 110.58202177383178 55.461841049975945, 110.41289672736166 55.48292246503335 C110.25679669112084 55.48937881029002, 110.10069665488002 55.4958351555467, 110 55.5 C110 55.5, 110 55.5, 110 55.5 C55.28023736309977 55.5, 0.5604747261995442 55.5, -110 55.5 C-110 55.5, -110 55.5, -110 55.5 C-110.12229127111777 55.49494199561238, -110.24458254223556 55.48988399122476, -110.41289672736166 55.48292246503335 C-110.51820977503145 55.46979520733128, -110.62352282270125 55.45666794962922, -110.82297295140367 55.43180651701361 C-110.94194389830433 55.40686093270481, -111.06091484520499 55.381915348396014, -111.227427435704 55.34700132969665 C-111.33986972974297 55.313525808372184, -111.45231202378194 55.280050287047715, -111.62349734602341 55.229086208503176 C-111.71884074200574 55.191883099945436, -111.81418413798806 55.154679991387695, -112.00847712326485 55.07886663327529 C-112.14043376941693 55.014356959832575, -112.272390415569 54.94984728638986, -112.37973696518537 54.89736875603245 C-112.46473103594228 54.84672328276455, -112.54972510669917 54.79607780949665, -112.73474079061214 54.685832391312644 C-112.846089674877 54.60633081602698, -112.95743855914189 54.52682924074132, -113.07106356344833 54.44570254698197 C-113.1656132980946 54.36562300661627, -113.26016303274086 54.28554346625056, -113.3864078581287 54.17861955336566 C-113.50300410578599 54.06202330570838, -113.61960035344326 53.9454270580511, -113.67861955336566 53.886407858128706 C-113.73730154393664 53.81712216278553, -113.7959835345076 53.747836467442355, -113.94570254698196 53.57106356344834 C-114.00305290510636 53.49073938916126, -114.06040326323077 53.41041521487418, -114.18583239131264 53.234740790612136 C-114.25913451156144 53.11172396022137, -114.33243663181024 52.98870712983061, -114.39736875603245 52.879736965185366 C-114.43995597902584 52.79262340817551, -114.48254320201924 52.705509851165644, -114.57886663327528 52.508477123264846 C-114.61711574717494 52.410453045334705, -114.6553648610746 52.31242896740456, -114.72908620850318 52.12349734602342 C-114.76724273399549 51.995331836147535, -114.80539925948779 51.86716632627166, -114.84700132969665 51.727427435703994 C-114.87661628724152 51.586187226698634, -114.9062312447864 51.44494701769327, -114.93180651701361 51.32297295140367 C-114.95024559960439 51.175045941213, -114.96868468219516 51.02711893102233, -114.98292246503335 50.91289672736166 C-114.98776114313605 50.79590827690536, -114.99259982123876 50.678919826449054, -115 50.5 C-115 50.5, -115 50.5, -115 50.5 C-115 29.496262753408004, -115 8.492525506816008, -115 -50.5 C-115 -50.5, -115 -50.5, -115 -50.5 C-114.99333282158041 -50.661197512144724, -114.9866656431608 -50.82239502428945, -114.98292246503335 -50.91289672736166 C-114.96451918249687 -51.060536532645656, -114.94611589996038 -51.20817633792965, -114.93180651701361 -51.32297295140367 C-114.90042369054014 -51.47264451394355, -114.86904086406666 -51.62231607648343, -114.84700132969665 -51.727427435703994 C-114.81114555230722 -51.84786486892989, -114.77528977491781 -51.968302302155784, -114.72908620850318 -52.12349734602342 C-114.6779488002689 -52.25455129156196, -114.62681139203461 -52.3856052371005, -114.57886663327528 -52.508477123264846 C-114.53559407094745 -52.59699256429026, -114.49232150861963 -52.685508005315675, -114.39736875603245 -52.879736965185366 C-114.32890210519055 -52.994638830853845, -114.26043545434865 -53.10954069652232, -114.18583239131264 -53.234740790612136 C-114.13053601467713 -53.31218818483207, -114.07523963804164 -53.38963557905199, -113.94570254698196 -53.57106356344834 C-113.87611681188787 -53.65322328562289, -113.80653107679377 -53.73538300779744, -113.67861955336566 -53.886407858128706 C-113.56678113377654 -53.998246277717826, -113.45494271418741 -54.110084697306945, -113.3864078581287 -54.17861955336566 C-113.2844616335842 -54.264963601120904, -113.1825154090397 -54.35130764887616, -113.07106356344833 -54.44570254698197 C-112.9765316536569 -54.51319703327878, -112.88199974386546 -54.58069151957559, -112.73474079061214 -54.685832391312644 C-112.62854748128547 -54.74910986891595, -112.5223541719588 -54.81238734651925, -112.37973696518537 -54.89736875603245 C-112.2469163186504 -54.962300813524614, -112.11409567211545 -55.027232871016786, -112.00847712326485 -55.07886663327528 C-111.88578154434578 -55.12674259673402, -111.7630859654267 -55.17461856019276, -111.62349734602341 -55.229086208503176 C-111.50088822375199 -55.265588525733996, -111.37827910148054 -55.302090842964816, -111.227427435704 -55.34700132969665 C-111.09619639290605 -55.374517585785476, -110.9649653501081 -55.40203384187429, -110.82297295140367 -55.43180651701361 C-110.70939805952592 -55.44596361252221, -110.59582316764818 -55.460120708030814, -110.41289672736167 -55.48292246503335 C-110.29460700895916 -55.48781496397642, -110.17631729055665 -55.49270746291949, -110 -55.5 C-110 -55.5, -110 -55.5, -110 -55.5" stroke="none" stroke-width="0" fill="#1168bd" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important"></path><path d="M-110 -55.5 C-31.425100487479725 -55.5, 47.14979902504055 -55.5, 110 -55.5 M-110 -55.5 C-51.39522778577995 -55.5, 7.209544428440097 -55.5, 110 -55.5 M110 -55.5 C110 -55.5, 110 -55.5, 110 -55.5 M110 -55.5 C110 -55.5, 110 -55.5, 110 -55.5 M110 -55.5 C110.08458529502336 -55.496501526319534, 110.1691705900467 -55.49300305263907, 110.41289672736166 -55.48292246503335 M110 -55.5 C110.1186421486035 -55.495092924435994, 110.237284297207 -55.49018584887199, 110.41289672736166 -55.48292246503335 M110.41289672736166 -55.48292246503335 C110.50752414925049 -55.471127169195825, 110.60215157113932 -55.459331873358295, 110.82297295140367 -55.43180651701361 M110.41289672736166 -55.48292246503335 C110.5585741308783 -55.46476379562206, 110.70425153439493 -55.44660512621078, 110.82297295140367 -55.43180651701361 M110.82297295140367 -55.43180651701361 C110.97984028399678 -55.39891489622349, 111.13670761658989 -55.36602327543337, 111.227427435704 -55.34700132969665 M110.82297295140367 -55.43180651701361 C110.9536674712851 -55.404402757950294, 111.08436199116653 -55.376998998886975, 111.227427435704 -55.34700132969665 M111.227427435704 -55.34700132969665 C111.37754158398396 -55.302310411436764, 111.52765573226391 -55.257619493176875, 111.62349734602341 -55.229086208503176 M111.227427435704 -55.34700132969665 C111.32759626418593 -55.3171797773835, 111.42776509266785 -55.287358225070356, 111.62349734602341 -55.229086208503176 M111.62349734602341 -55.229086208503176 C111.72698903588703 -55.18870362580669, 111.83048072575065 -55.148321043110194, 112.00847712326485 -55.07886663327529 M111.62349734602341 -55.229086208503176 C111.75702157180257 -55.176984893927894, 111.89054579758172 -55.12488357935261, 112.00847712326485 -55.07886663327529 M112.00847712326485 -55.07886663327529 C112.08904699123593 -55.03947842492278, 112.16961685920701 -55.00009021657026, 112.37973696518537 -54.89736875603244 M112.00847712326485 -55.07886663327529 C112.12758671150021 -55.020637503746606, 112.24669629973558 -54.96240837421793, 112.37973696518537 -54.89736875603244 M112.37973696518537 -54.89736875603244 C112.47693869467811 -54.83944909706354, 112.57414042417086 -54.781529438094644, 112.73474079061214 -54.685832391312644 M112.37973696518537 -54.89736875603244 C112.51807045436686 -54.81493988815959, 112.65640394354837 -54.73251102028674, 112.73474079061214 -54.685832391312644 M112.73474079061214 -54.685832391312644 C112.84561639364196 -54.60666873233381, 112.95649199667177 -54.52750507335497, 113.07106356344833 -54.44570254698197 M112.73474079061214 -54.685832391312644 C112.83389896469065 -54.61503481580269, 112.93305713876917 -54.54423724029274, 113.07106356344833 -54.44570254698197 M113.07106356344833 -54.44570254698197 C113.19600708691051 -54.33988078060731, 113.32095061037269 -54.23405901423265, 113.3864078581287 -54.17861955336566 M113.07106356344833 -54.44570254698197 C113.14733022623584 -54.3811079785879, 113.22359688902333 -54.31651341019383, 113.3864078581287 -54.17861955336566 M113.3864078581287 -54.17861955336566 C113.47281452849869 -54.092212882995675, 113.55922119886868 -54.005806212625686, 113.67861955336566 -53.886407858128706 M113.3864078581287 -54.17861955336566 C113.45606760020394 -54.10895981129043, 113.52572734227917 -54.0393000692152, 113.67861955336566 -53.886407858128706 M113.67861955336566 -53.886407858128706 C113.77956873624058 -53.76721738313357, 113.88051791911549 -53.648026908138434, 113.94570254698196 -53.57106356344834 M113.67861955336566 -53.886407858128706 C113.7527907896869 -53.798834044885865, 113.82696202600815 -53.71126023164303, 113.94570254698196 -53.57106356344834 M113.94570254698196 -53.57106356344834 C114.00194054046622 -53.492297352775566, 114.05817853395048 -53.4135311421028, 114.18583239131264 -53.234740790612136 M113.94570254698196 -53.57106356344834 C114.03610008171114 -53.44445393846643, 114.1264976164403 -53.31784431348452, 114.18583239131264 -53.234740790612136 M114.18583239131264 -53.234740790612136 C114.26134329938509 -53.108017135969234, 114.33685420745753 -52.981293481326325, 114.39736875603245 -52.879736965185366 M114.18583239131264 -53.234740790612136 C114.26726331782223 -53.09808206312932, 114.34869424433181 -52.96142333564651, 114.39736875603245 -52.879736965185366 M114.39736875603245 -52.879736965185366 C114.46379970594062 -52.74385028520763, 114.53023065584878 -52.6079636052299, 114.57886663327528 -52.508477123264846 M114.39736875603245 -52.879736965185366 C114.46946843612149 -52.732254712285176, 114.54156811621051 -52.584772459384986, 114.57886663327528 -52.508477123264846 M114.57886663327528 -52.508477123264846 C114.61024975891169 -52.42804906521505, 114.6416328845481 -52.34762100716525, 114.72908620850318 -52.12349734602342 M114.57886663327528 -52.508477123264846 C114.61224613485652 -52.42293279215034, 114.64562563643776 -52.337388461035836, 114.72908620850318 -52.12349734602342 M114.72908620850318 -52.12349734602342 C114.76155100469099 -52.0144500178733, 114.79401580087881 -51.90540268972318, 114.84700132969665 -51.727427435703994 M114.72908620850318 -52.12349734602342 C114.76172058399271 -52.01388041103964, 114.79435495948223 -51.90426347605587, 114.84700132969665 -51.727427435703994 M114.84700132969665 -51.727427435703994 C114.86586600919468 -51.63745765367464, 114.88473068869271 -51.54748787164528, 114.93180651701361 -51.32297295140367 M114.84700132969665 -51.727427435703994 C114.864003072952 -51.64634240402013, 114.88100481620737 -51.56525737233627, 114.93180651701361 -51.32297295140367 M114.93180651701361 -51.32297295140367 C114.9437480364259 -51.22717245508838, 114.9556895558382 -51.13137195877309, 114.98292246503335 -50.91289672736166 M114.93180651701361 -51.32297295140367 C114.94360001972215 -51.228359914840624, 114.95539352243068 -51.13374687827758, 114.98292246503335 -50.91289672736166 M114.98292246503335 -50.91289672736166 C114.9867206651079 -50.82106471626011, 114.99051886518244 -50.72923270515856, 115 -50.5 M114.98292246503335 -50.91289672736166 C114.98800979441289 -50.7898964433086, 114.99309712379244 -50.66689615925553, 115 -50.5 M115 -50.5 C115 -50.5, 115 -50.5, 115 -50.5 M115 -50.5 C115 -50.5, 115 -50.5, 115 -50.5 M115 -50.5 C115 -20.567161464914182, 115 9.365677070171635, 115 50.5 M115 -50.5 C115 -10.925575499114032, 115 28.648849001771936, 115 50.5 M115 50.5 C115 50.5, 115 50.5, 115 50.5 M115 50.5 C115 50.5, 115 50.5, 115 50.5 M115 50.5 C114.99363427216048 50.65390910909246, 114.98726854432097 50.80781821818492, 114.98292246503335 50.91289672736166 M115 50.5 C114.99425817461987 50.63882453838712, 114.98851634923976 50.77764907677424, 114.98292246503335 50.91289672736166 M114.98292246503335 50.91289672736166 C114.96768316188853 51.03515359890104, 114.95244385874369 51.15741047044041, 114.93180651701361 51.32297295140367 M114.98292246503335 50.91289672736166 C114.96921561330629 51.02285955144087, 114.95550876157924 51.13282237552007, 114.93180651701361 51.32297295140367 M114.93180651701361 51.32297295140367 C114.90495572369225 51.451030256734, 114.8781049303709 51.57908756206432, 114.84700132969665 51.727427435703994 M114.93180651701361 51.32297295140367 C114.91204788846036 51.417206171974485, 114.8922892599071 51.51143939254529, 114.84700132969665 51.727427435703994 M114.84700132969665 51.727427435703994 C114.80649242367484 51.86349445249376, 114.76598351765301 51.99956146928352, 114.72908620850318 52.12349734602342 M114.84700132969665 51.727427435703994 C114.81446300932636 51.83672172722969, 114.78192468895607 51.94601601875538, 114.72908620850318 52.12349734602342 M114.72908620850318 52.12349734602342 C114.68355761657165 52.24017712729242, 114.63802902464013 52.356856908561426, 114.57886663327528 52.508477123264846 M114.72908620850318 52.12349734602342 C114.68527654966651 52.23577187931495, 114.64146689082983 52.348046412606486, 114.57886663327528 52.508477123264846 M114.57886663327528 52.508477123264846 C114.51507752516176 52.63895982947739, 114.45128841704823 52.76944253568995, 114.39736875603245 52.879736965185366 M114.57886663327528 52.508477123264846 C114.5206762085045 52.62750753965251, 114.4624857837337 52.74653795604017, 114.39736875603245 52.879736965185366 M114.39736875603245 52.879736965185366 C114.35351994153031 52.95332477080596, 114.30967112702817 53.026912576426554, 114.18583239131264 53.234740790612136 M114.39736875603245 52.879736965185366 C114.32365786276596 53.00343980521426, 114.24994696949948 53.12714264524316, 114.18583239131264 53.234740790612136 M114.18583239131264 53.234740790612136 C114.11866412803411 53.328815796638125, 114.05149586475558 53.42289080266411, 113.94570254698196 53.57106356344834 M114.18583239131264 53.234740790612136 C114.13698256458908 53.3031592299029, 114.08813273786551 53.37157766919367, 113.94570254698196 53.57106356344834 M113.94570254698196 53.57106356344834 C113.87557193695254 53.653866618243384, 113.8054413269231 53.73666967303842, 113.67861955336566 53.886407858128706 M113.94570254698196 53.57106356344834 C113.85088079934573 53.68301938932793, 113.7560590517095 53.79497521520753, 113.67861955336566 53.886407858128706 M113.67861955336566 53.886407858128706 C113.61612056275129 53.94890684874308, 113.55362157213692 54.011405839357444, 113.3864078581287 54.17861955336566 M113.67861955336566 53.886407858128706 C113.58858799706701 53.976439414427354, 113.49855644076837 54.066470970726, 113.3864078581287 54.17861955336566 M113.3864078581287 54.17861955336566 C113.26377044517486 54.28248814377182, 113.14113303222099 54.38635673417798, 113.07106356344833 54.44570254698197 M113.3864078581287 54.17861955336566 C113.26798484786633 54.27891872676909, 113.14956183760395 54.37921790017253, 113.07106356344833 54.44570254698197 M113.07106356344833 54.44570254698197 C112.94420016241416 54.536281274329795, 112.81733676137999 54.62686000167763, 112.73474079061214 54.685832391312644 M113.07106356344833 54.44570254698197 C112.95714971407641 54.527035472154154, 112.8432358647045 54.60836839732633, 112.73474079061214 54.685832391312644 M112.73474079061214 54.685832391312644 C112.60042783283801 54.76586554247136, 112.46611487506388 54.845898693630076, 112.37973696518537 54.89736875603244 M112.73474079061214 54.685832391312644 C112.6255632214286 54.75088810181454, 112.51638565224508 54.81594381231643, 112.37973696518537 54.89736875603244 M112.37973696518537 54.89736875603244 C112.24620752192696 54.96264732312834, 112.11267807866855 55.02792589022424, 112.00847712326485 55.07886663327529 M112.37973696518537 54.89736875603244 C112.25493097907642 54.95838268479133, 112.13012499296745 55.01939661355023, 112.00847712326485 55.07886663327529 M112.00847712326485 55.07886663327529 C111.88030247832711 55.12888053492877, 111.75212783338938 55.178894436582254, 111.62349734602341 55.229086208503176 M112.00847712326485 55.07886663327529 C111.8619588598023 55.13603823708831, 111.71544059633976 55.193209840901325, 111.62349734602341 55.229086208503176 M111.62349734602341 55.229086208503176 C111.48687755632918 55.26975968214886, 111.35025776663494 55.310433155794534, 111.227427435704 55.34700132969665 M111.62349734602341 55.229086208503176 C111.4808184732745 55.271563549330125, 111.3381396005256 55.314040890157074, 111.227427435704 55.34700132969665 M111.227427435704 55.34700132969665 C111.0988766049293 55.373955604421674, 110.9703257741546 55.4009098791467, 110.82297295140367 55.43180651701361 M111.227427435704 55.34700132969665 C111.08079644021753 55.377746616302176, 110.93416544473104 55.4084919029077, 110.82297295140367 55.43180651701361 M110.82297295140367 55.43180651701361 C110.73896291339285 55.44227835733093, 110.65495287538204 55.45275019764825, 110.41289672736166 55.48292246503335 M110.82297295140367 55.43180651701361 C110.70371083559004 55.44667252424652, 110.58444871977643 55.461538531479434, 110.41289672736166 55.48292246503335 M110.41289672736166 55.48292246503335 C110.28090953573546 55.4883814956596, 110.14892234410928 55.49384052628585, 110 55.5 M110.41289672736166 55.48292246503335 C110.2838678735247 55.488259137903555, 110.15483901968774 55.49359581077376, 110 55.5 M110 55.5 C110 55.5, 110 55.5, 110 55.5 M110 55.5 C110 55.5, 110 55.5, 110 55.5 M110 55.5 C62.532952778538906 55.5, 15.065905557077812 55.5, -110 55.5 M110 55.5 C43.82438341169966 55.5, -22.351233176600687 55.5, -110 55.5 M-110 55.5 C-110 55.5, -110 55.5, -110 55.5 M-110 55.5 C-110 55.5, -110 55.5, -110 55.5 M-110 55.5 C-110.15154672450703 55.49373198110969, -110.30309344901407 55.48746396221938, -110.41289672736166 55.48292246503335 M-110 55.5 C-110.1428926341077 55.49408991693627, -110.28578526821539 55.48817983387253, -110.41289672736166 55.48292246503335 M-110.41289672736166 55.48292246503335 C-110.55368037863508 55.46537380120303, -110.6944640299085 55.4478251373727, -110.82297295140367 55.43180651701361 M-110.41289672736166 55.48292246503335 C-110.5445094955475 55.46651695058774, -110.67612226373335 55.45011143614214, -110.82297295140367 55.43180651701361 M-110.82297295140367 55.43180651701361 C-110.97160914806588 55.40064078393533, -111.12024534472808 55.36947505085705, -111.227427435704 55.34700132969665 M-110.82297295140367 55.43180651701361 C-110.98455226876969 55.39792689691377, -111.1461315861357 55.364047276813935, -111.227427435704 55.34700132969665 M-111.227427435704 55.34700132969665 C-111.32942652578933 55.31663488489569, -111.43142561587464 55.28626844009474, -111.62349734602341 55.229086208503176 M-111.227427435704 55.34700132969665 C-111.32604754296497 55.31764085166788, -111.42466765022594 55.288280373639104, -111.62349734602341 55.229086208503176 M-111.62349734602341 55.229086208503176 C-111.76071737720409 55.175542786185204, -111.89793740838475 55.12199936386723, -112.00847712326485 55.07886663327529 M-111.62349734602341 55.229086208503176 C-111.77308705396639 55.17071612333488, -111.92267676190936 55.11234603816657, -112.00847712326485 55.07886663327529 M-112.00847712326485 55.07886663327529 C-112.15064415334864 55.009365407285834, -112.29281118343243 54.93986418129638, -112.37973696518537 54.89736875603245 M-112.00847712326485 55.07886663327529 C-112.09240375528812 55.03783740297242, -112.17633038731138 54.99680817266955, -112.37973696518537 54.89736875603245 M-112.37973696518537 54.89736875603245 C-112.46945522330901 54.84390827810759, -112.55917348143265 54.79044780018273, -112.73474079061214 54.685832391312644 M-112.37973696518537 54.89736875603245 C-112.5174835955863 54.81528958009009, -112.65523022598722 54.73321040414773, -112.73474079061214 54.685832391312644 M-112.73474079061214 54.685832391312644 C-112.86902082048745 54.589958292753224, -113.00330085036275 54.4940841941938, -113.07106356344833 54.44570254698197 M-112.73474079061214 54.685832391312644 C-112.84068836500805 54.61018727714937, -112.94663593940395 54.5345421629861, -113.07106356344833 54.44570254698197 M-113.07106356344833 54.44570254698197 C-113.17733227038683 54.355697543385396, -113.28360097732532 54.265692539788816, -113.3864078581287 54.17861955336566 M-113.07106356344833 54.44570254698197 C-113.18412235864064 54.34994663199, -113.29718115383295 54.25419071699804, -113.3864078581287 54.17861955336566 M-113.3864078581287 54.17861955336566 C-113.49747379584271 54.06755361565165, -113.60853973355673 53.956487677937645, -113.67861955336566 53.886407858128706 M-113.3864078581287 54.17861955336566 C-113.45689012489629 54.10813728659807, -113.52737239166387 54.03765501983049, -113.67861955336566 53.886407858128706 M-113.67861955336566 53.886407858128706 C-113.77722615066982 53.76998326869049, -113.87583274797397 53.653558679252264, -113.94570254698196 53.57106356344834 M-113.67861955336566 53.886407858128706 C-113.73364251314216 53.82144237228099, -113.78866547291865 53.756476886433276, -113.94570254698196 53.57106356344834 M-113.94570254698196 53.57106356344834 C-114.01259632827843 53.47737299335766, -114.0794901095749 53.38368242326699, -114.18583239131264 53.234740790612136 M-113.94570254698196 53.57106356344834 C-114.03263605973753 53.44930560310886, -114.11956957249308 53.32754764276938, -114.18583239131264 53.234740790612136 M-114.18583239131264 53.234740790612136 C-114.26654267562303 53.099291456785195, -114.34725295993343 52.96384212295825, -114.39736875603245 52.879736965185366 M-114.18583239131264 53.234740790612136 C-114.23030222331651 53.16011078315043, -114.2747720553204 53.08548077568872, -114.39736875603245 52.879736965185366 M-114.39736875603245 52.879736965185366 C-114.46229786184718 52.746922356403125, -114.52722696766189 52.614107747620885, -114.57886663327528 52.508477123264846 M-114.39736875603245 52.879736965185366 C-114.46347272135519 52.744519142867794, -114.52957668667791 52.60930132055022, -114.57886663327528 52.508477123264846 M-114.57886663327528 52.508477123264846 C-114.61967102764142 52.403904422738194, -114.66047542200756 52.299331722211534, -114.72908620850318 52.12349734602342 M-114.57886663327528 52.508477123264846 C-114.61874340279935 52.406281721465874, -114.65862017232342 52.30408631966691, -114.72908620850318 52.12349734602342 M-114.72908620850318 52.12349734602342 C-114.77493306592102 51.96950046655518, -114.82077992333888 51.81550358708694, -114.84700132969665 51.727427435703994 M-114.72908620850318 52.12349734602342 C-114.76385602220645 52.00670760051923, -114.79862583590975 51.889917855015035, -114.84700132969665 51.727427435703994 M-114.84700132969665 51.727427435703994 C-114.88067977651858 51.566807557694794, -114.9143582233405 51.406187679685594, -114.93180651701361 51.32297295140367 M-114.84700132969665 51.727427435703994 C-114.87207931001595 51.607825063275676, -114.89715729033526 51.48822269084736, -114.93180651701361 51.32297295140367 M-114.93180651701361 51.32297295140367 C-114.94665759545096 51.20383060142341, -114.96150867388832 51.08468825144315, -114.98292246503335 50.91289672736166 M-114.93180651701361 51.32297295140367 C-114.95011943275915 51.176058111103124, -114.96843234850469 51.02914327080257, -114.98292246503335 50.91289672736166 M-114.98292246503335 50.91289672736166 C-114.98934598337883 50.75759037265813, -114.9957695017243 50.60228401795459, -115 50.5 M-114.98292246503335 50.91289672736166 C-114.98721443406477 50.809126483560775, -114.99150640309618 50.70535623975989, -115 50.5 M-115 50.5 C-115 50.5, -115 50.5, -115 50.5 M-115 50.5 C-115 50.5, -115 50.5, -115 50.5 M-115 50.5 C-115 21.778652793164493, -115 -6.942694413671013, -115 -50.5 M-115 50.5 C-115 18.668635364657973, -115 -13.162729270684054, -115 -50.5 M-115 -50.5 C-115 -50.5, -115 -50.5, -115 -50.5 M-115 -50.5 C-115 -50.5, -115 -50.5, -115 -50.5 M-115 -50.5 C-114.99641063818544 -50.58678276750382, -114.99282127637088 -50.67356553500764, -114.98292246503335 -50.91289672736166 M-115 -50.5 C-114.99477756818206 -50.626266759851895, -114.98955513636413 -50.752533519703796, -114.98292246503335 -50.91289672736166 M-114.98292246503335 -50.91289672736166 C-114.9625294600447 -51.076499023838366, -114.94213645505606 -51.24010132031507, -114.93180651701361 -51.32297295140367 M-114.98292246503335 -50.91289672736166 C-114.97079091104004 -51.010221770642055, -114.95865935704673 -51.107546813922454, -114.93180651701361 -51.32297295140367 M-114.93180651701361 -51.32297295140367 C-114.90725570627617 -51.440061136809746, -114.88270489553874 -51.55714932221582, -114.84700132969665 -51.727427435703994 M-114.93180651701361 -51.32297295140367 C-114.9142217237719 -51.40683867597921, -114.8966369305302 -51.490704400554755, -114.84700132969665 -51.727427435703994 M-114.84700132969665 -51.727427435703994 C-114.81710418953146 -51.82785015930536, -114.78720704936627 -51.92827288290673, -114.72908620850318 -52.12349734602342 M-114.84700132969665 -51.727427435703994 C-114.8195778736274 -51.819541200894264, -114.79215441755815 -51.911654966084534, -114.72908620850318 -52.12349734602342 M-114.72908620850318 -52.12349734602342 C-114.67354373693892 -52.26584050135324, -114.61800126537467 -52.40818365668306, -114.57886663327528 -52.508477123264846 M-114.72908620850318 -52.12349734602342 C-114.67100495142424 -52.27234685101125, -114.61292369434528 -52.42119635599908, -114.57886663327528 -52.508477123264846 M-114.57886663327528 -52.508477123264846 C-114.53428123990112 -52.59967800311816, -114.48969584652697 -52.69087888297146, -114.39736875603245 -52.879736965185366 M-114.57886663327528 -52.508477123264846 C-114.53222791025067 -52.603878156051174, -114.48558918722605 -52.699279188837494, -114.39736875603245 -52.879736965185366 M-114.39736875603245 -52.879736965185366 C-114.32584789726542 -52.99976445310091, -114.25432703849837 -53.11979194101646, -114.18583239131264 -53.234740790612136 M-114.39736875603245 -52.879736965185366 C-114.34470541946064 -52.96811744750808, -114.29204208288883 -53.05649792983079, -114.18583239131264 -53.234740790612136 M-114.18583239131264 -53.234740790612136 C-114.10433501486763 -53.34888496832258, -114.02283763842262 -53.46302914603303, -113.94570254698196 -53.57106356344834 M-114.18583239131264 -53.234740790612136 C-114.10449881546668 -53.348655551309385, -114.02316523962072 -53.46257031200663, -113.94570254698196 -53.57106356344834 M-113.94570254698196 -53.57106356344834 C-113.85742733819545 -53.67528990551389, -113.76915212940895 -53.77951624757944, -113.67861955336566 -53.886407858128706 M-113.94570254698196 -53.57106356344834 C-113.8849354598008 -53.642811127707155, -113.82416837261965 -53.71455869196597, -113.67861955336566 -53.886407858128706 M-113.67861955336566 -53.886407858128706 C-113.60269300006449 -53.96233441142988, -113.52676644676332 -54.038260964731045, -113.3864078581287 -54.17861955336566 M-113.67861955336566 -53.886407858128706 C-113.57941985398149 -53.98560755751288, -113.48022015459732 -54.08480725689705, -113.3864078581287 -54.17861955336566 M-113.3864078581287 -54.17861955336566 C-113.29724487779964 -54.25413674555135, -113.20808189747056 -54.32965393773704, -113.07106356344833 -54.44570254698197 M-113.3864078581287 -54.17861955336566 C-113.30595891025946 -54.2467563365346, -113.22550996239022 -54.31489311970354, -113.07106356344833 -54.44570254698197 M-113.07106356344833 -54.44570254698197 C-112.99435991532738 -54.500467899109495, -112.91765626720643 -54.55523325123702, -112.73474079061214 -54.685832391312644 M-113.07106356344833 -54.44570254698197 C-112.93704250546416 -54.54139174316508, -112.80302144748 -54.63708093934819, -112.73474079061214 -54.685832391312644 M-112.73474079061214 -54.685832391312644 C-112.66148306132024 -54.729484523014065, -112.58822533202833 -54.77313665471548, -112.37973696518537 -54.89736875603245 M-112.73474079061214 -54.685832391312644 C-112.61480197907673 -54.757300410426275, -112.49486316754133 -54.82876842953991, -112.37973696518537 -54.89736875603245 M-112.37973696518537 -54.89736875603245 C-112.27146408726246 -54.950300140704506, -112.16319120933953 -55.00323152537656, -112.00847712326485 -55.07886663327528 M-112.37973696518537 -54.89736875603245 C-112.30400932666491 -54.93438974265189, -112.22828168814446 -54.971410729271334, -112.00847712326485 -55.07886663327528 M-112.00847712326485 -55.07886663327528 C-111.92737838216411 -55.11051146025026, -111.84627964106336 -55.14215628722524, -111.62349734602341 -55.229086208503176 M-112.00847712326485 -55.07886663327528 C-111.8861157284091 -55.12661219770787, -111.76375433355335 -55.17435776214045, -111.62349734602341 -55.229086208503176 M-111.62349734602341 -55.229086208503176 C-111.49199212120347 -55.26823701021319, -111.36048689638352 -55.307387811923206, -111.227427435704 -55.34700132969665 M-111.62349734602341 -55.229086208503176 C-111.48140846777927 -55.271387900355734, -111.33931958953514 -55.3136895922083, -111.227427435704 -55.34700132969665 M-111.227427435704 -55.34700132969665 C-111.13829554310176 -55.3656903222569, -111.04916365049951 -55.38437931481715, -110.82297295140367 -55.43180651701361 M-111.227427435704 -55.34700132969665 C-111.12727498084988 -55.36800109116264, -111.02712252599576 -55.389000852628634, -110.82297295140367 -55.43180651701361 M-110.82297295140367 -55.43180651701361 C-110.68817094714288 -55.448609569321384, -110.5533689428821 -55.46541262162915, -110.41289672736167 -55.48292246503335 M-110.82297295140367 -55.43180651701361 C-110.7366366822458 -55.442568321741014, -110.65030041308793 -55.45333012646842, -110.41289672736167 -55.48292246503335 M-110.41289672736167 -55.48292246503335 C-110.30574860792179 -55.487354144034626, -110.19860048848192 -55.491785823035904, -110 -55.5 M-110.41289672736167 -55.48292246503335 C-110.2958741855329 -55.487762553165645, -110.17885164370412 -55.49260264129794, -110 -55.5 M-110 -55.5 C-110 -55.5, -110 -55.5, -110 -55.5 M-110 -55.5 C-110 -55.5, -110 -55.5, -110 -55.5" stroke="#0b4884" stroke-width="2" fill="none" stroke-dasharray="0 0" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important"></path></g><g class="label" style="color:#ffffff !important" transform="translate(-100, -40.5)"><rect></rect><foreignObject width="200" height="81"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üêá RabbitMQ<br/>[Container: Broker de Mensagens]</p></span></div></foreignObject></g></g><g class="node default database " id="flowchart-Postgres-19" transform="translate(765.9390625003725, 2572.7334518432617)"><path d="M0,15.808823529411764 a107.5,15.808823529411764 0,0,0 215,0 a107.5,15.808823529411764 0,0,0 -215,0 l0,111.80882352941177 a107.5,15.808823529411764 0,0,0 215,0 l0,-111.80882352941177" class="basic label-container" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important" label-offset-y="15.808823529411764" transform="translate(-107.5, -71.71323529411765)"></path><g class="label" style="color:#ffffff !important" transform="translate(-100, -30.5)"><rect></rect><foreignObject width="200" height="81"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üêò PostgreSQL<br/>[Container: Banco de Dados]</p></span></div></foreignObject></g></g><g class="node default database " id="flowchart-ZipKin-20" transform="translate(1038.4390625003725, 2572.7334518432617)"><g class="basic label-container outer-path"><path d="M-110 -55.5 C-38.217283134268285 -55.5, 33.56543373146343 -55.5, 110 -55.5 C110 -55.5, 110 -55.5, 110 -55.5 C110.1470845525602 -55.49391653790658, 110.2941691051204 -55.487833075813164, 110.41289672736166 -55.48292246503335 C110.51463187103077 -55.470241192599865, 110.61636701469989 -55.45755992016638, 110.82297295140367 -55.43180651701361 C110.97916845289072 -55.399055764392855, 111.13536395437778 -55.3663050117721, 111.227427435704 -55.34700132969665 C111.32978142633134 -55.31652922642649, 111.43213541695867 -55.28605712315632, 111.62349734602341 -55.229086208503176 C111.73950301294937 -55.183820656804556, 111.85550867987534 -55.13855510510594, 112.00847712326485 -55.07886663327529 C112.1530010500683 -55.00821319068927, 112.29752497687174 -54.93755974810325, 112.37973696518537 -54.89736875603244 C112.47883824168483 -54.83831721272982, 112.57793951818427 -54.7792656694272, 112.73474079061214 -54.685832391312644 C112.84185408770473 -54.609354967141556, 112.94896738479733 -54.532877542970475, 113.07106356344833 -54.44570254698197 C113.16545875731256 -54.36575389598194, 113.2598539511768 -54.285805244981916, 113.3864078581287 -54.17861955336566 C113.47450771611993 -54.09051969537443, 113.56260757411115 -54.00241983738321, 113.67861955336566 -53.886407858128706 C113.77055909420908 -53.777855047378964, 113.8624986350525 -53.66930223662923, 113.94570254698196 -53.57106356344834 C114.03888279957641 -53.44055649959922, 114.13206305217086 -53.310049435750095, 114.18583239131264 -53.234740790612136 C114.23296149155676 -53.15564795521361, 114.28009059180089 -53.07655511981509, 114.39736875603245 -52.879736965185366 C114.46884307116419 -52.733533916751455, 114.54031738629592 -52.58733086831754, 114.57886663327528 -52.508477123264846 C114.61619631851708 -52.41280933904247, 114.65352600375887 -52.31714155482009, 114.72908620850318 -52.12349734602342 C114.75444169403383 -52.038329771427506, 114.77979717956448 -51.9531621968316, 114.84700132969665 -51.727427435703994 C114.87239450556314 -51.60632182678128, 114.89778768142962 -51.48521621785858, 114.93180651701361 -51.32297295140367 C114.94431925806227 -51.22258984592624, 114.9568319991109 -51.1222067404488, 114.98292246503335 -50.91289672736166 C114.9869600339171 -50.81527731203916, 114.99099760280083 -50.71765789671666, 115 -50.5 C115 -50.5, 115 -50.5, 115 -50.5 C115 -27.734588824086575, 115 -4.969177648173151, 115 50.5 C115 50.5, 115 50.5, 115 50.5 C114.99401210391021 50.64477397962194, 114.98802420782043 50.789547959243876, 114.98292246503335 50.91289672736166 C114.96578111116213 51.05041274619332, 114.9486397572909 51.18792876502498, 114.93180651701361 51.32297295140367 C114.90274394852884 51.46157869617987, 114.87368138004406 51.60018444095607, 114.84700132969665 51.727427435703994 C114.80419132362478 51.87122371131348, 114.76138131755289 52.01501998692297, 114.72908620850318 52.12349734602342 C114.69132355989309 52.220274720263106, 114.65356091128301 52.31705209450279, 114.57886663327528 52.508477123264846 C114.52744477715167 52.61366221118832, 114.47602292102806 52.71884729911179, 114.39736875603245 52.879736965185366 C114.3323039762881 52.98892975452157, 114.26723919654374 53.09812254385777, 114.18583239131264 53.234740790612136 C114.10799329667428 53.34376122585542, 114.03015420203593 53.4527816610987, 113.94570254698196 53.57106356344834 C113.88313698331436 53.644934584882165, 113.82057141964675 53.718805606315996, 113.67861955336566 53.886407858128706 C113.57349327125317 53.9915341402412, 113.46836698914068 54.09666042235369, 113.3864078581287 54.17861955336566 C113.27881825444378 54.2697432994391, 113.17122865075885 54.36086704551255, 113.07106356344833 54.44570254698197 C112.94084603125731 54.53867607794589, 112.81062849906627 54.631649608909804, 112.73474079061214 54.685832391312644 C112.66344227052603 54.728317087726225, 112.59214375043993 54.770801784139806, 112.37973696518537 54.89736875603244 C112.25209717358558 54.95976804787948, 112.12445738198579 55.02216733972651, 112.00847712326485 55.07886663327529 C111.89576873731903 55.12284558194298, 111.78306035137321 55.16682453061068, 111.62349734602341 55.229086208503176 C111.50854344245292 55.26330946838234, 111.39358953888244 55.2975327282615, 111.227427435704 55.34700132969665 C111.13455314712198 55.366475020175706, 111.04167885853994 55.38594871065475, 110.82297295140367 55.43180651701361 C110.65895811391596 55.452250945185654, 110.49494327642823 55.47269537335769, 110.41289672736166 55.48292246503335 C110.25147588471818 55.4895988804707, 110.09005504207468 55.496275295908056, 110 55.5 C110 55.5, 110 55.5, 110 55.5 C37.9138096302127 55.5, -34.172380739574606 55.5, -110 55.5 C-110 55.5, -110 55.5, -110 55.5 C-110.13247830802098 55.49452065664941, -110.26495661604196 55.48904131329881, -110.41289672736166 55.48292246503335 C-110.55569242839115 55.46512299946249, -110.69848812942065 55.44732353389162, -110.82297295140367 55.43180651701361 C-110.9155696080026 55.41239103983976, -111.00816626460153 55.3929755626659, -111.227427435704 55.34700132969665 C-111.34152602735132 55.31303270720966, -111.45562461899864 55.27906408472266, -111.62349734602341 55.229086208503176 C-111.76811819569345 55.17265497784946, -111.91273904536347 55.11622374719575, -112.00847712326485 55.07886663327529 C-112.1261149774094 55.02135699070207, -112.24375283155396 54.96384734812885, -112.37973696518537 54.89736875603245 C-112.48166762423638 54.83663126667378, -112.5835982832874 54.775893777315105, -112.73474079061214 54.685832391312644 C-112.85181786893669 54.60224096407837, -112.96889494726125 54.5186495368441, -113.07106356344833 54.44570254698197 C-113.14453714823827 54.383473594981076, -113.21801073302822 54.32124464298018, -113.3864078581287 54.17861955336566 C-113.48630773378888 54.078719677705486, -113.58620760944905 53.978819802045315, -113.67861955336566 53.886407858128706 C-113.74978239833118 53.802386045847626, -113.82094524329669 53.71836423356655, -113.94570254698196 53.57106356344834 C-114.01700975319713 53.47119160715597, -114.0883169594123 53.371319650863605, -114.18583239131264 53.234740790612136 C-114.26197191172858 53.106962188339104, -114.33811143214452 52.979183586066064, -114.39736875603245 52.879736965185366 C-114.43929259080687 52.793980390466714, -114.48121642558128 52.70822381574806, -114.57886663327528 52.508477123264846 C-114.63632088170584 52.361234503727324, -114.69377513013639 52.2139918841898, -114.72908620850318 52.12349734602342 C-114.75796015825333 52.02651145844294, -114.78683410800348 51.92952557086247, -114.84700132969665 51.727427435703994 C-114.87264188983548 51.605141997086164, -114.89828244997432 51.48285655846833, -114.93180651701361 51.32297295140367 C-114.94794748378509 51.19348250933118, -114.96408845055655 51.0639920672587, -114.98292246503335 50.91289672736166 C-114.98881627644201 50.770397505601906, -114.99471008785068 50.62789828384216, -115 50.5 C-115 50.5, -115 50.5, -115 50.5 C-115 25.076773507110012, -115 -0.3464529857799761, -115 -50.5 C-115 -50.5, -115 -50.5, -115 -50.5 C-114.99581702137392 -50.60113509875421, -114.99163404274785 -50.702270197508426, -114.98292246503335 -50.91289672736166 C-114.96503460690009 -51.05640155518284, -114.94714674876683 -51.19990638300402, -114.93180651701361 -51.32297295140367 C-114.91082391876199 -51.423043551135024, -114.88984132051039 -51.52311415086637, -114.84700132969665 -51.727427435703994 C-114.80031648744249 -51.884239056620245, -114.75363164518832 -52.0410506775365, -114.72908620850318 -52.12349734602342 C-114.68398551741562 -52.239080511413036, -114.63888482632805 -52.35466367680265, -114.57886663327528 -52.508477123264846 C-114.51085439542301 -52.64759837943202, -114.44284215757072 -52.786719635599184, -114.39736875603245 -52.879736965185366 C-114.33701112753909 -52.9810301354505, -114.27665349904572 -53.08232330571563, -114.18583239131264 -53.234740790612136 C-114.1101119616712 -53.340793850898514, -114.03439153202974 -53.4468469111849, -113.94570254698196 -53.57106356344834 C-113.8607800902829 -53.67133131860448, -113.77585763358385 -53.771599073760626, -113.67861955336566 -53.886407858128706 C-113.59740901126443 -53.96761840022994, -113.5161984691632 -54.04882894233117, -113.3864078581287 -54.17861955336566 C-113.29978887835283 -54.251982086992534, -113.21316989857694 -54.32534462061942, -113.07106356344833 -54.44570254698197 C-112.96102016235797 -54.52427202519663, -112.8509767612676 -54.60284150341129, -112.73474079061214 -54.685832391312644 C-112.65264133745615 -54.734753046872406, -112.57054188430017 -54.78367370243217, -112.37973696518537 -54.89736875603245 C-112.30095118330374 -54.935884777842034, -112.22216540142212 -54.97440079965161, -112.00847712326485 -55.07886663327528 C-111.85708043391614 -55.13794180477607, -111.70568374456741 -55.19701697627686, -111.62349734602341 -55.229086208503176 C-111.47383672385912 -55.27364210618842, -111.32417610169483 -55.318198003873654, -111.227427435704 -55.34700132969665 C-111.13295682908124 -55.36680973287074, -111.03848622245847 -55.38661813604484, -110.82297295140367 -55.43180651701361 C-110.69831403542176 -55.447345234685955, -110.57365511943983 -55.4628839523583, -110.41289672736167 -55.48292246503335 C-110.28764853842118 -55.488102768446765, -110.16240034948069 -55.49328307186018, -110 -55.5 C-110 -55.5, -110 -55.5, -110 -55.5" stroke="none" stroke-width="0" fill="#1168bd" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important"></path><path d="M-110 -55.5 C-58.914826497249706 -55.5, -7.829652994499412 -55.5, 110 -55.5 M-110 -55.5 C-30.40191103065048 -55.5, 49.19617793869904 -55.5, 110 -55.5 M110 -55.5 C110 -55.5, 110 -55.5, 110 -55.5 M110 -55.5 C110 -55.5, 110 -55.5, 110 -55.5 M110 -55.5 C110.10987961238645 -55.495455345614765, 110.21975922477291 -55.49091069122954, 110.41289672736166 -55.48292246503335 M110 -55.5 C110.08294064315734 -55.49656954962388, 110.16588128631469 -55.49313909924776, 110.41289672736166 -55.48292246503335 M110.41289672736166 -55.48292246503335 C110.53202537444079 -55.468073094660845, 110.65115402151993 -55.453223724288335, 110.82297295140367 -55.43180651701361 M110.41289672736166 -55.48292246503335 C110.50949074293901 -55.47088203354819, 110.60608475851635 -55.45884160206304, 110.82297295140367 -55.43180651701361 M110.82297295140367 -55.43180651701361 C110.97747095194734 -55.39941169291154, 111.13196895249102 -55.36701686880947, 111.227427435704 -55.34700132969665 M110.82297295140367 -55.43180651701361 C110.97480051954126 -55.399971623705255, 111.12662808767885 -55.368136730396905, 111.227427435704 -55.34700132969665 M111.227427435704 -55.34700132969665 C111.34394439159855 -55.31231272897886, 111.4604613474931 -55.277624128261074, 111.62349734602341 -55.229086208503176 M111.227427435704 -55.34700132969665 C111.37332474723374 -55.303565818130124, 111.51922205876348 -55.2601303065636, 111.62349734602341 -55.229086208503176 M111.62349734602341 -55.229086208503176 C111.76641441632471 -55.173319794622145, 111.909331486626 -55.11755338074111, 112.00847712326485 -55.07886663327529 M111.62349734602341 -55.229086208503176 C111.76037575701768 -55.17567608679558, 111.89725416801194 -55.12226596508799, 112.00847712326485 -55.07886663327529 M112.00847712326485 -55.07886663327529 C112.0956350473047 -55.03625772056258, 112.18279297134454 -54.99364880784988, 112.37973696518537 -54.89736875603244 M112.00847712326485 -55.07886663327529 C112.08713751947349 -55.04041190878612, 112.1657979156821 -55.00195718429695, 112.37973696518537 -54.89736875603244 M112.37973696518537 -54.89736875603244 C112.50356118808332 -54.82358553427533, 112.62738541098128 -54.74980231251821, 112.73474079061214 -54.685832391312644 M112.37973696518537 -54.89736875603244 C112.47468584841728 -54.84079150205796, 112.56963473164919 -54.78421424808348, 112.73474079061214 -54.685832391312644 M112.73474079061214 -54.685832391312644 C112.8110857235054 -54.63132315693492, 112.88743065639866 -54.576813922557186, 113.07106356344833 -54.44570254698197 M112.73474079061214 -54.685832391312644 C112.8280373459425 -54.61921993114784, 112.92133390127287 -54.55260747098303, 113.07106356344833 -54.44570254698197 M113.07106356344833 -54.44570254698197 C113.18921672661718 -54.345631922408415, 113.30736988978602 -54.24556129783487, 113.3864078581287 -54.17861955336566 M113.07106356344833 -54.44570254698197 C113.19083617876359 -54.34426031640641, 113.31060879407885 -54.24281808583085, 113.3864078581287 -54.17861955336566 M113.3864078581287 -54.17861955336566 C113.49350770124994 -54.07151971024442, 113.60060754437119 -53.96441986712318, 113.67861955336566 -53.886407858128706 M113.3864078581287 -54.17861955336566 C113.44849707797304 -54.11653033352132, 113.51058629781738 -54.05444111367698, 113.67861955336566 -53.886407858128706 M113.67861955336566 -53.886407858128706 C113.73727129655694 -53.817157875799246, 113.79592303974822 -53.74790789346979, 113.94570254698196 -53.57106356344834 M113.67861955336566 -53.886407858128706 C113.74235119691924 -53.811160048775115, 113.80608284047283 -53.73591223942153, 113.94570254698196 -53.57106356344834 M113.94570254698196 -53.57106356344834 C114.01690378969325 -53.471340018277225, 114.08810503240453 -53.371616473106116, 114.18583239131264 -53.234740790612136 M113.94570254698196 -53.57106356344834 C114.0068225696166 -53.485459645511405, 114.06794259225123 -53.399855727574476, 114.18583239131264 -53.234740790612136 M114.18583239131264 -53.234740790612136 C114.25671421778846 -53.11578573725533, 114.32759604426427 -52.99683068389852, 114.39736875603245 -52.879736965185366 M114.18583239131264 -53.234740790612136 C114.22847788999232 -53.16317240950389, 114.27112338867201 -53.09160402839566, 114.39736875603245 -52.879736965185366 M114.39736875603245 -52.879736965185366 C114.4372521519131 -52.79815417493548, 114.47713554779374 -52.716571384685594, 114.57886663327528 -52.508477123264846 M114.39736875603245 -52.879736965185366 C114.45703523393213 -52.75768723386343, 114.51670171183181 -52.635637502541485, 114.57886663327528 -52.508477123264846 M114.57886663327528 -52.508477123264846 C114.61886081183158 -52.40598082790389, 114.65885499038787 -52.30348453254294, 114.72908620850318 -52.12349734602342 M114.57886663327528 -52.508477123264846 C114.616479640859 -52.412083246108736, 114.65409264844273 -52.31568936895263, 114.72908620850318 -52.12349734602342 M114.72908620850318 -52.12349734602342 C114.77427276421926 -51.97171838087485, 114.81945931993535 -51.819939415726274, 114.84700132969665 -51.727427435703994 M114.72908620850318 -52.12349734602342 C114.76143140420757 -52.014851748815566, 114.79377659991195 -51.90620615160771, 114.84700132969665 -51.727427435703994 M114.84700132969665 -51.727427435703994 C114.87363657172008 -51.6003981416522, 114.90027181374353 -51.473368847600405, 114.93180651701361 -51.32297295140367 M114.84700132969665 -51.727427435703994 C114.86549739593227 -51.639215650934844, 114.8839934621679 -51.55100386616569, 114.93180651701361 -51.32297295140367 M114.93180651701361 -51.32297295140367 C114.95125653180715 -51.166935766668054, 114.97070654660068 -51.010898581932445, 114.98292246503335 -50.91289672736166 M114.93180651701361 -51.32297295140367 C114.94241424911046 -51.237872725496864, 114.95302198120729 -51.15277249959005, 114.98292246503335 -50.91289672736166 M114.98292246503335 -50.91289672736166 C114.98670112951187 -50.821537043424684, 114.99047979399037 -50.730177359487705, 115 -50.5 M114.98292246503335 -50.91289672736166 C114.98812249683975 -50.78717154985632, 114.99332252864613 -50.66144637235097, 115 -50.5 M115 -50.5 C115 -50.5, 115 -50.5, 115 -50.5 M115 -50.5 C115 -50.5, 115 -50.5, 115 -50.5 M115 -50.5 C115 -15.751925874739847, 115 18.996148250520307, 115 50.5 M115 -50.5 C115 -26.49425964214743, 115 -2.48851928429486, 115 50.5 M115 50.5 C115 50.5, 115 50.5, 115 50.5 M115 50.5 C115 50.5, 115 50.5, 115 50.5 M115 50.5 C114.99633786089808 50.588542360081654, 114.99267572179618 50.67708472016331, 114.98292246503335 50.91289672736166 M115 50.5 C114.99486908926868 50.62405398399038, 114.98973817853735 50.748107967980765, 114.98292246503335 50.91289672736166 M114.98292246503335 50.91289672736166 C114.96608186275081 51.04799997521599, 114.94924126046826 51.18310322307031, 114.93180651701361 51.32297295140367 M114.98292246503335 50.91289672736166 C114.97095766262863 51.008884010814555, 114.95899286022393 51.10487129426745, 114.93180651701361 51.32297295140367 M114.93180651701361 51.32297295140367 C114.90405473457648 51.45532727086383, 114.87630295213934 51.58768159032399, 114.84700132969665 51.727427435703994 M114.93180651701361 51.32297295140367 C114.90178408610721 51.46615648998021, 114.87176165520083 51.60934002855674, 114.84700132969665 51.727427435703994 M114.84700132969665 51.727427435703994 C114.81368698097226 51.839328360522366, 114.78037263224786 51.951229285340744, 114.72908620850318 52.12349734602342 M114.84700132969665 51.727427435703994 C114.82263411415768 51.80927546991343, 114.79826689861872 51.89112350412287, 114.72908620850318 52.12349734602342 M114.72908620850318 52.12349734602342 C114.69572379559723 52.2089978826165, 114.66236138269127 52.294498419209575, 114.57886663327528 52.508477123264846 M114.72908620850318 52.12349734602342 C114.67981601703592 52.249766025101586, 114.63054582556865 52.37603470417976, 114.57886663327528 52.508477123264846 M114.57886663327528 52.508477123264846 C114.51511172837147 52.638889865693685, 114.45135682346763 52.76930260812252, 114.39736875603245 52.879736965185366 M114.57886663327528 52.508477123264846 C114.50963769790829 52.650087173977944, 114.44040876254128 52.79169722469104, 114.39736875603245 52.879736965185366 M114.39736875603245 52.879736965185366 C114.34558720868496 52.96663761424976, 114.29380566133749 53.05353826331416, 114.18583239131264 53.234740790612136 M114.39736875603245 52.879736965185366 C114.3322204550869 52.989069921182605, 114.26707215414135 53.09840287717984, 114.18583239131264 53.234740790612136 M114.18583239131264 53.234740790612136 C114.13327520114966 53.308351715473904, 114.08071801098667 53.38196264033568, 113.94570254698196 53.57106356344834 M114.18583239131264 53.234740790612136 C114.09718862355436 53.35889411212123, 114.00854485579607 53.48304743363031, 113.94570254698196 53.57106356344834 M113.94570254698196 53.57106356344834 C113.84597188229047 53.688815336742906, 113.74624121759899 53.80656711003748, 113.67861955336566 53.886407858128706 M113.94570254698196 53.57106356344834 C113.84188162751501 53.69364469143064, 113.73806070804804 53.81622581941294, 113.67861955336566 53.886407858128706 M113.67861955336566 53.886407858128706 C113.59056120531423 53.974466206180146, 113.50250285726278 54.06252455423158, 113.3864078581287 54.17861955336566 M113.67861955336566 53.886407858128706 C113.56905810859752 53.995969302896846, 113.45949666382937 54.10553074766499, 113.3864078581287 54.17861955336566 M113.3864078581287 54.17861955336566 C113.26957303388558 54.277573601825985, 113.15273820964246 54.376527650286306, 113.07106356344833 54.44570254698197 M113.3864078581287 54.17861955336566 C113.27776024571172 54.27063938712547, 113.16911263329474 54.36265922088528, 113.07106356344833 54.44570254698197 M113.07106356344833 54.44570254698197 C112.99411133991073 54.5006453785457, 112.91715911637311 54.55558821010943, 112.73474079061214 54.685832391312644 M113.07106356344833 54.44570254698197 C112.96244997751488 54.52325115679644, 112.85383639158144 54.60079976661091, 112.73474079061214 54.685832391312644 M112.73474079061214 54.685832391312644 C112.64370860180779 54.74007580198296, 112.55267641300345 54.79431921265328, 112.37973696518537 54.89736875603244 M112.73474079061214 54.685832391312644 C112.63295987844148 54.74648065089848, 112.53117896627083 54.80712891048431, 112.37973696518537 54.89736875603244 M112.37973696518537 54.89736875603244 C112.27941264330484 54.94641432843519, 112.1790883214243 54.995459900837936, 112.00847712326485 55.07886663327529 M112.37973696518537 54.89736875603244 C112.26223973544154 54.95480965152522, 112.14474250569772 55.01225054701799, 112.00847712326485 55.07886663327529 M112.00847712326485 55.07886663327529 C111.90433304462799 55.11950377886104, 111.80018896599113 55.160140924446786, 111.62349734602341 55.229086208503176 M112.00847712326485 55.07886663327529 C111.86646314243383 55.13428066055153, 111.7244491616028 55.18969468782777, 111.62349734602341 55.229086208503176 M111.62349734602341 55.229086208503176 C111.47455866096239 55.273427176200535, 111.32561997590136 55.31776814389789, 111.227427435704 55.34700132969665 M111.62349734602341 55.229086208503176 C111.52391961234184 55.25873178426975, 111.42434187866027 55.28837736003632, 111.227427435704 55.34700132969665 M111.227427435704 55.34700132969665 C111.13338447239329 55.36672006549755, 111.03934150908259 55.386438801298446, 110.82297295140367 55.43180651701361 M111.227427435704 55.34700132969665 C111.0982820737879 55.37408026449288, 110.96913671187178 55.40115919928912, 110.82297295140367 55.43180651701361 M110.82297295140367 55.43180651701361 C110.6996920221756 55.44717346881622, 110.57641109294751 55.462540420618815, 110.41289672736166 55.48292246503335 M110.82297295140367 55.43180651701361 C110.7364990820333 55.44258547358962, 110.65002521266292 55.45336443016562, 110.41289672736166 55.48292246503335 M110.41289672736166 55.48292246503335 C110.29042267174266 55.48798802944386, 110.16794861612368 55.49305359385438, 110 55.5 M110.41289672736166 55.48292246503335 C110.30042221599444 55.487574445234316, 110.18794770462725 55.492226425435284, 110 55.5 M110 55.5 C110 55.5, 110 55.5, 110 55.5 M110 55.5 C110 55.5, 110 55.5, 110 55.5 M110 55.5 C22.308743388214666 55.5, -65.38251322357067 55.5, -110 55.5 M110 55.5 C27.024281064351925 55.5, -55.95143787129615 55.5, -110 55.5 M-110 55.5 C-110 55.5, -110 55.5, -110 55.5 M-110 55.5 C-110 55.5, -110 55.5, -110 55.5 M-110 55.5 C-110.1631842455264 55.49325064967991, -110.32636849105278 55.486501299359816, -110.41289672736166 55.48292246503335 M-110 55.5 C-110.1610461817871 55.49333908065029, -110.32209236357419 55.48667816130058, -110.41289672736166 55.48292246503335 M-110.41289672736166 55.48292246503335 C-110.56439402418337 55.46403834667813, -110.71589132100507 55.44515422832292, -110.82297295140367 55.43180651701361 M-110.41289672736166 55.48292246503335 C-110.57422756901065 55.46281259659371, -110.73555841065964 55.44270272815407, -110.82297295140367 55.43180651701361 M-110.82297295140367 55.43180651701361 C-110.98278696057548 55.39829704311784, -111.14260096974729 55.36478756922207, -111.227427435704 55.34700132969665 M-110.82297295140367 55.43180651701361 C-110.94946409419116 55.4052841134443, -111.07595523697864 55.378761709875, -111.227427435704 55.34700132969665 M-111.227427435704 55.34700132969665 C-111.31468082807964 55.32102486930808, -111.40193422045527 55.29504840891952, -111.62349734602341 55.229086208503176 M-111.227427435704 55.34700132969665 C-111.34857635023015 55.310933735146776, -111.46972526475628 55.27486614059689, -111.62349734602341 55.229086208503176 M-111.62349734602341 55.229086208503176 C-111.73580466677846 55.185263755958545, -111.84811198753351 55.14144130341391, -112.00847712326485 55.07886663327529 M-111.62349734602341 55.229086208503176 C-111.73056754319587 55.18730728792178, -111.83763774036834 55.14552836734039, -112.00847712326485 55.07886663327529 M-112.00847712326485 55.07886663327529 C-112.12829287058449 55.02029228360611, -112.24810861790411 54.961717933936924, -112.37973696518537 54.89736875603245 M-112.00847712326485 55.07886663327529 C-112.11801873826569 55.025315000840294, -112.22756035326651 54.97176336840529, -112.37973696518537 54.89736875603245 M-112.37973696518537 54.89736875603245 C-112.49494123582348 54.8287219109409, -112.61014550646156 54.76007506584934, -112.73474079061214 54.685832391312644 M-112.37973696518537 54.89736875603245 C-112.51016423458117 54.819650972582785, -112.64059150397698 54.74193318913313, -112.73474079061214 54.685832391312644 M-112.73474079061214 54.685832391312644 C-112.83678642918483 54.61297320577953, -112.93883206775752 54.54011402024641, -113.07106356344833 54.44570254698197 M-112.73474079061214 54.685832391312644 C-112.82665369389039 54.620207839724706, -112.91856659716865 54.55458328813677, -113.07106356344833 54.44570254698197 M-113.07106356344833 54.44570254698197 C-113.19672574702173 54.33927210654174, -113.32238793059513 54.232841666101514, -113.3864078581287 54.17861955336566 M-113.07106356344833 54.44570254698197 C-113.17827010870592 54.35490323484703, -113.28547665396349 54.26410392271209, -113.3864078581287 54.17861955336566 M-113.3864078581287 54.17861955336566 C-113.4927133998713 54.07231401162306, -113.59901894161392 53.96600846988046, -113.67861955336566 53.886407858128706 M-113.3864078581287 54.17861955336566 C-113.47468598111541 54.090341430378956, -113.56296410410211 54.002063307392255, -113.67861955336566 53.886407858128706 M-113.67861955336566 53.886407858128706 C-113.7517198718247 53.80009847521646, -113.82482019028376 53.71378909230421, -113.94570254698196 53.57106356344834 M-113.67861955336566 53.886407858128706 C-113.73878934002691 53.81536552526113, -113.79895912668815 53.74432319239356, -113.94570254698196 53.57106356344834 M-113.94570254698196 53.57106356344834 C-114.01505612174881 53.4739278382464, -114.08440969651566 53.37679211304446, -114.18583239131264 53.234740790612136 M-113.94570254698196 53.57106356344834 C-114.03318048582271 53.44854308693314, -114.12065842466346 53.326022610417944, -114.18583239131264 53.234740790612136 M-114.18583239131264 53.234740790612136 C-114.23232603814095 53.15671438364446, -114.27881968496925 53.07868797667679, -114.39736875603245 52.879736965185366 M-114.18583239131264 53.234740790612136 C-114.26295061519407 53.1053197119986, -114.3400688390755 52.97589863338505, -114.39736875603245 52.879736965185366 M-114.39736875603245 52.879736965185366 C-114.4513561113397 52.76930406480351, -114.50534346664695 52.65887116442165, -114.57886663327528 52.508477123264846 M-114.39736875603245 52.879736965185366 C-114.46803556032262 52.7351857065792, -114.5387023646128 52.59063444797304, -114.57886663327528 52.508477123264846 M-114.57886663327528 52.508477123264846 C-114.6167669123714 52.41134703231847, -114.65466719146752 52.314216941372095, -114.72908620850318 52.12349734602342 M-114.57886663327528 52.508477123264846 C-114.62032385922187 52.40223135878475, -114.66178108516844 52.29598559430466, -114.72908620850318 52.12349734602342 M-114.72908620850318 52.12349734602342 C-114.77062478241284 51.983971735765174, -114.81216335632249 51.84444612550693, -114.84700132969665 51.727427435703994 M-114.72908620850318 52.12349734602342 C-114.76881865425672 51.990038413300475, -114.80855110001026 51.85657948057753, -114.84700132969665 51.727427435703994 M-114.84700132969665 51.727427435703994 C-114.88079541494258 51.56625605276181, -114.91458950018853 51.40508466981962, -114.93180651701361 51.32297295140367 M-114.84700132969665 51.727427435703994 C-114.86568925083102 51.63830065296605, -114.88437717196541 51.54917387022811, -114.93180651701361 51.32297295140367 M-114.93180651701361 51.32297295140367 C-114.94208806688518 51.24048951302545, -114.95236961675674 51.158006074647226, -114.98292246503335 50.91289672736166 M-114.93180651701361 51.32297295140367 C-114.94269287438462 51.235637462241876, -114.95357923175563 51.14830197308008, -114.98292246503335 50.91289672736166 M-114.98292246503335 50.91289672736166 C-114.98802204246556 50.78960031269761, -114.99312161989778 50.66630389803355, -115 50.5 M-114.98292246503335 50.91289672736166 C-114.98728111951428 50.807514178042325, -114.9916397739952 50.70213162872298, -115 50.5 M-115 50.5 C-115 50.5, -115 50.5, -115 50.5 M-115 50.5 C-115 50.5, -115 50.5, -115 50.5 M-115 50.5 C-115 21.39887789035796, -115 -7.702244219284083, -115 -50.5 M-115 50.5 C-115 23.212974634734877, -115 -4.074050730530246, -115 -50.5 M-115 -50.5 C-115 -50.5, -115 -50.5, -115 -50.5 M-115 -50.5 C-115 -50.5, -115 -50.5, -115 -50.5 M-115 -50.5 C-114.99387924717502 -50.64798615932353, -114.98775849435002 -50.79597231864705, -114.98292246503335 -50.91289672736166 M-115 -50.5 C-114.99538852403255 -50.61149520929025, -114.9907770480651 -50.72299041858049, -114.98292246503335 -50.91289672736166 M-114.98292246503335 -50.91289672736166 C-114.97146141527597 -51.00484266967798, -114.96000036551858 -51.09678861199429, -114.93180651701361 -51.32297295140367 M-114.98292246503335 -50.91289672736166 C-114.96289958547304 -51.07352970322602, -114.94287670591274 -51.23416267909039, -114.93180651701361 -51.32297295140367 M-114.93180651701361 -51.32297295140367 C-114.90263360650631 -51.46210494141592, -114.87346069599901 -51.601236931428176, -114.84700132969665 -51.727427435703994 M-114.93180651701361 -51.32297295140367 C-114.90671818386402 -51.44262469874371, -114.88162985071443 -51.56227644608374, -114.84700132969665 -51.727427435703994 M-114.84700132969665 -51.727427435703994 C-114.82296567596606 -51.8081617734309, -114.79893002223547 -51.88889611115781, -114.72908620850318 -52.12349734602342 M-114.84700132969665 -51.727427435703994 C-114.8149396645026 -51.83512067071548, -114.78287799930855 -51.94281390572698, -114.72908620850318 -52.12349734602342 M-114.72908620850318 -52.12349734602342 C-114.6825737854529 -52.24269847036218, -114.63606136240261 -52.361899594700944, -114.57886663327528 -52.508477123264846 M-114.72908620850318 -52.12349734602342 C-114.67788303123135 -52.254719843159734, -114.62667985395953 -52.38594234029605, -114.57886663327528 -52.508477123264846 M-114.57886663327528 -52.508477123264846 C-114.53664717666369 -52.5948384021167, -114.49442772005212 -52.681199680968554, -114.39736875603245 -52.879736965185366 M-114.57886663327528 -52.508477123264846 C-114.52563985627158 -52.6173542358599, -114.4724130792679 -52.726231348454945, -114.39736875603245 -52.879736965185366 M-114.39736875603245 -52.879736965185366 C-114.3165188459302 -53.01542062132517, -114.23566893582796 -53.15110427746498, -114.18583239131264 -53.234740790612136 M-114.39736875603245 -52.879736965185366 C-114.3498811433127 -52.959431462149155, -114.30239353059297 -53.039125959112944, -114.18583239131264 -53.234740790612136 M-114.18583239131264 -53.234740790612136 C-114.10095480185959 -53.353619251205295, -114.01607721240653 -53.472497711798454, -113.94570254698196 -53.57106356344834 M-114.18583239131264 -53.234740790612136 C-114.11899911435216 -53.32834661910767, -114.0521658373917 -53.421952447603196, -113.94570254698196 -53.57106356344834 M-113.94570254698196 -53.57106356344834 C-113.84736814623155 -53.68716677102286, -113.74903374548113 -53.80326997859738, -113.67861955336566 -53.886407858128706 M-113.94570254698196 -53.57106356344834 C-113.86416041093219 -53.66734018155562, -113.78261827488242 -53.763616799662906, -113.67861955336566 -53.886407858128706 M-113.67861955336566 -53.886407858128706 C-113.61029193079538 -53.954735480698986, -113.54196430822509 -54.02306310326927, -113.3864078581287 -54.17861955336566 M-113.67861955336566 -53.886407858128706 C-113.58546777799542 -53.979559633498944, -113.49231600262517 -54.07271140886919, -113.3864078581287 -54.17861955336566 M-113.3864078581287 -54.17861955336566 C-113.27622986764213 -54.27193555123272, -113.16605187715555 -54.36525154909979, -113.07106356344833 -54.44570254698197 M-113.3864078581287 -54.17861955336566 C-113.30298429276876 -54.24927570903534, -113.2195607274088 -54.31993186470502, -113.07106356344833 -54.44570254698197 M-113.07106356344833 -54.44570254698197 C-112.9981410866357 -54.49776819468568, -112.92521860982305 -54.549833842389404, -112.73474079061214 -54.685832391312644 M-113.07106356344833 -54.44570254698197 C-112.9951572339862 -54.499898624528974, -112.91925090452408 -54.55409470207598, -112.73474079061214 -54.685832391312644 M-112.73474079061214 -54.685832391312644 C-112.63744828426184 -54.743806141547815, -112.54015577791154 -54.801779891782985, -112.37973696518537 -54.89736875603245 M-112.73474079061214 -54.685832391312644 C-112.63847797239929 -54.74319258059497, -112.54221515418645 -54.80055276987729, -112.37973696518537 -54.89736875603245 M-112.37973696518537 -54.89736875603245 C-112.27651606044962 -54.947830381506705, -112.17329515571386 -54.99829200698096, -112.00847712326485 -55.07886663327528 M-112.37973696518537 -54.89736875603245 C-112.29054987738095 -54.94096966646283, -112.20136278957654 -54.9845705768932, -112.00847712326485 -55.07886663327528 M-112.00847712326485 -55.07886663327528 C-111.86518353754998 -55.1347799639266, -111.72188995183511 -55.190693294577905, -111.62349734602341 -55.229086208503176 M-112.00847712326485 -55.07886663327528 C-111.87058253295768 -55.1326732693812, -111.7326879426505 -55.186479905487126, -111.62349734602341 -55.229086208503176 M-111.62349734602341 -55.229086208503176 C-111.49867982723843 -55.26624599386211, -111.37386230845345 -55.30340577922104, -111.227427435704 -55.34700132969665 M-111.62349734602341 -55.229086208503176 C-111.49458771125964 -55.26746426957305, -111.36567807649588 -55.30584233064292, -111.227427435704 -55.34700132969665 M-111.227427435704 -55.34700132969665 C-111.10603278269315 -55.37245511173512, -110.9846381296823 -55.3979088937736, -110.82297295140367 -55.43180651701361 M-111.227427435704 -55.34700132969665 C-111.10077845745433 -55.373556827882176, -110.97412947920465 -55.400112326067706, -110.82297295140367 -55.43180651701361 M-110.82297295140367 -55.43180651701361 C-110.69637731902084 -55.447586646133566, -110.569781686638 -55.463366775253526, -110.41289672736167 -55.48292246503335 M-110.82297295140367 -55.43180651701361 C-110.71192324397408 -55.44564884860901, -110.6008735365445 -55.4594911802044, -110.41289672736167 -55.48292246503335 M-110.41289672736167 -55.48292246503335 C-110.30167590604384 -55.48752259223031, -110.19045508472601 -55.49212271942728, -110 -55.5 M-110.41289672736167 -55.48292246503335 C-110.30126561112856 -55.487539562153536, -110.18963449489546 -55.492156659273725, -110 -55.5 M-110 -55.5 C-110 -55.5, -110 -55.5, -110 -55.5 M-110 -55.5 C-110 -55.5, -110 -55.5, -110 -55.5" stroke="#0b4884" stroke-width="2" fill="none" stroke-dasharray="0 0" style="fill:#1168bd !important;stroke:#0b4884 !important;stroke-width:2px !important"></path></g><g class="label" style="color:#ffffff !important" transform="translate(-100, -40.5)"><rect></rect><foreignObject width="200" height="81"><div style="color: rgb(255, 255, 255) !important; display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span style="color:#ffffff !important" class="nodeLabel "><p>üìâ ZipKin<br/>[Container: Rastreamento]</p></span></div></foreignObject></g></g><g class="label edgeLabel" id="GitHub---GitHub---1" transform="translate(146.17578125, 495.7421875)"><rect width="0.1" height="0.1"></rect><g class="label" style="" transform="translate(0, 0)"><rect></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 10px; text-align: center;"><span class="nodeLabel "></span></div></foreignObject></g></g><g class="label edgeLabel" id="GitHub---GitHub---2" transform="translate(95.1640625, 740.09375)"><rect width="0.1" height="0.1"></rect><g class="label" style="" transform="translate(0, 0)"><rect></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 10px; text-align: center;"><span class="nodeLabel "></span></div></foreignObject></g></g><g class="label edgeLabel" id="VA_Core---VA_Core---1" transform="translate(1864.0328125003725, 1752.09375)"><rect width="0.1" height="0.1"></rect><g class="label" style="" transform="translate(0, 0)"><rect></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 10px; text-align: center;"><span class="nodeLabel "></span></div></foreignObject></g></g><g class="label edgeLabel" id="VA_Core---VA_Core---2" transform="translate(1837.1851562503725, 1981.306983947754)"><rect width="0.1" height="0.1"></rect><g class="label" style="" transform="translate(0, 0)"><rect></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 10px; text-align: center;"><span class="nodeLabel "></span></div></foreignObject></g></g><g class="label edgeLabel" id="Recog---Recog---1" transform="translate(4549.9976562503725, 2572.7334518432617)"><rect width="0.1" height="0.1"></rect><g class="label" style="" transform="translate(0, 0)"><rect></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 10px; text-align: center;"><span class="nodeLabel "></span></div></foreignObject></g></g><g class="label edgeLabel" id="Recog---Recog---2" transform="translate(4549.5078125, 2771.4966857917607)"><rect width="0.1" height="0.1"></rect><g class="label" style="" transform="translate(0, 0)"><rect></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 10px; text-align: center;"><span class="nodeLabel "></span></div></foreignObject></g></g></g></g><marker id="mermaid-diagram-1765524990608_flowchart-v2-pointEnd__663399" class="marker flowchart-v2" viewBox="0 0 10 10" refX="5" refY="5" markerUnits="userSpaceOnUse" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;" stroke="#663399" fill="#663399"></path></marker></g></svg>
</file>

<file path="safevision-ui/.claude/CLAUDE.md">
You are an expert in TypeScript, Angular, and scalable web application development. You write functional, maintainable, performant, and accessible code following Angular and TypeScript best practices.

## TypeScript Best Practices

- Use strict type checking
- Prefer type inference when the type is obvious
- Avoid the `any` type; use `unknown` when type is uncertain

## Angular Best Practices

- Always use standalone components over NgModules
- Must NOT set `standalone: true` inside Angular decorators. It's the default in Angular v20+.
- Use signals for state management
- Implement lazy loading for feature routes
- Do NOT use the `@HostBinding` and `@HostListener` decorators. Put host bindings inside the `host` object of the `@Component` or `@Directive` decorator instead
- Use `NgOptimizedImage` for all static images.
  - `NgOptimizedImage` does not work for inline base64 images.

## Accessibility Requirements

- It MUST pass all AXE checks.
- It MUST follow all WCAG AA minimums, including focus management, color contrast, and ARIA attributes.

### Components

- Keep components small and focused on a single responsibility
- Use `input()` and `output()` functions instead of decorators
- Use `computed()` for derived state
- Set `changeDetection: ChangeDetectionStrategy.OnPush` in `@Component` decorator
- Prefer inline templates for small components
- Prefer Reactive forms instead of Template-driven ones
- Do NOT use `ngClass`, use `class` bindings instead
- Do NOT use `ngStyle`, use `style` bindings instead
- When using external templates/styles, use paths relative to the component TS file.

## State Management

- Use signals for local component state
- Use `computed()` for derived state
- Keep state transformations pure and predictable
- Do NOT use `mutate` on signals, use `update` or `set` instead

## Templates

- Keep templates simple and avoid complex logic
- Use native control flow (`@if`, `@for`, `@switch`) instead of `*ngIf`, `*ngFor`, `*ngSwitch`
- Use the async pipe to handle observables
- Do not assume globals like (`new Date()`) are available.
- Do not write arrow functions in templates (they are not supported).

## Services

- Design services around a single responsibility
- Use the `providedIn: 'root'` option for singleton services
- Use the `inject()` function instead of constructor injection
</file>

<file path="safevision-ui/.cursor/rules/cursor.mdc">
---
context: true
priority: high
scope: project
---

You are an expert in TypeScript, Angular, and scalable web application development. You write functional, maintainable, performant, and accessible code following Angular and TypeScript best practices.

## TypeScript Best Practices

- Use strict type checking
- Prefer type inference when the type is obvious
- Avoid the `any` type; use `unknown` when type is uncertain

## Angular Best Practices

- Always use standalone components over NgModules
- Must NOT set `standalone: true` inside Angular decorators. It's the default in Angular v20+.
- Use signals for state management
- Implement lazy loading for feature routes
- Do NOT use the `@HostBinding` and `@HostListener` decorators. Put host bindings inside the `host` object of the `@Component` or `@Directive` decorator instead
- Use `NgOptimizedImage` for all static images.
  - `NgOptimizedImage` does not work for inline base64 images.

## Accessibility Requirements

- It MUST pass all AXE checks.
- It MUST follow all WCAG AA minimums, including focus management, color contrast, and ARIA attributes.

### Components

- Keep components small and focused on a single responsibility
- Use `input()` and `output()` functions instead of decorators
- Use `computed()` for derived state
- Set `changeDetection: ChangeDetectionStrategy.OnPush` in `@Component` decorator
- Prefer inline templates for small components
- Prefer Reactive forms instead of Template-driven ones
- Do NOT use `ngClass`, use `class` bindings instead
- Do NOT use `ngStyle`, use `style` bindings instead
- When using external templates/styles, use paths relative to the component TS file.

## State Management

- Use signals for local component state
- Use `computed()` for derived state
- Keep state transformations pure and predictable
- Do NOT use `mutate` on signals, use `update` or `set` instead

## Templates

- Keep templates simple and avoid complex logic
- Use native control flow (`@if`, `@for`, `@switch`) instead of `*ngIf`, `*ngFor`, `*ngSwitch`
- Use the async pipe to handle observables
- Do not assume globals like (`new Date()`) are available.
- Do not write arrow functions in templates (they are not supported).

## Services

- Design services around a single responsibility
- Use the `providedIn: 'root'` option for singleton services
- Use the `inject()` function instead of constructor injection
</file>

<file path="safevision-ui/.editorconfig">
# Editor configuration, see https://editorconfig.org
root = true

[*]
charset = utf-8
indent_style = space
indent_size = 2
insert_final_newline = true
trim_trailing_whitespace = true

[*.ts]
quote_type = single
ij_typescript_use_double_quotes = false

[*.md]
max_line_length = off
trim_trailing_whitespace = false
</file>

<file path="safevision-ui/.gemini/GEMINI.md">
You are an expert in TypeScript, Angular, and scalable web application development. You write functional, maintainable, performant, and accessible code following Angular and TypeScript best practices.

## TypeScript Best Practices

- Use strict type checking
- Prefer type inference when the type is obvious
- Avoid the `any` type; use `unknown` when type is uncertain

## Angular Best Practices

- Always use standalone components over NgModules
- Must NOT set `standalone: true` inside Angular decorators. It's the default in Angular v20+.
- Use signals for state management
- Implement lazy loading for feature routes
- Do NOT use the `@HostBinding` and `@HostListener` decorators. Put host bindings inside the `host` object of the `@Component` or `@Directive` decorator instead
- Use `NgOptimizedImage` for all static images.
  - `NgOptimizedImage` does not work for inline base64 images.

## Accessibility Requirements

- It MUST pass all AXE checks.
- It MUST follow all WCAG AA minimums, including focus management, color contrast, and ARIA attributes.

### Components

- Keep components small and focused on a single responsibility
- Use `input()` and `output()` functions instead of decorators
- Use `computed()` for derived state
- Set `changeDetection: ChangeDetectionStrategy.OnPush` in `@Component` decorator
- Prefer inline templates for small components
- Prefer Reactive forms instead of Template-driven ones
- Do NOT use `ngClass`, use `class` bindings instead
- Do NOT use `ngStyle`, use `style` bindings instead
- When using external templates/styles, use paths relative to the component TS file.

## State Management

- Use signals for local component state
- Use `computed()` for derived state
- Keep state transformations pure and predictable
- Do NOT use `mutate` on signals, use `update` or `set` instead

## Templates

- Keep templates simple and avoid complex logic
- Use native control flow (`@if`, `@for`, `@switch`) instead of `*ngIf`, `*ngFor`, `*ngSwitch`
- Use the async pipe to handle observables
- Do not assume globals like (`new Date()`) are available.
- Do not write arrow functions in templates (they are not supported).

## Services

- Design services around a single responsibility
- Use the `providedIn: 'root'` option for singleton services
- Use the `inject()` function instead of constructor injection
</file>

<file path="safevision-ui/.github/copilot-instructions.md">
You are an expert in TypeScript, Angular, and scalable web application development. You write functional, maintainable, performant, and accessible code following Angular and TypeScript best practices.

## TypeScript Best Practices

- Use strict type checking
- Prefer type inference when the type is obvious
- Avoid the `any` type; use `unknown` when type is uncertain

## Angular Best Practices

- Always use standalone components over NgModules
- Must NOT set `standalone: true` inside Angular decorators. It's the default in Angular v20+.
- Use signals for state management
- Implement lazy loading for feature routes
- Do NOT use the `@HostBinding` and `@HostListener` decorators. Put host bindings inside the `host` object of the `@Component` or `@Directive` decorator instead
- Use `NgOptimizedImage` for all static images.
  - `NgOptimizedImage` does not work for inline base64 images.

## Accessibility Requirements

- It MUST pass all AXE checks.
- It MUST follow all WCAG AA minimums, including focus management, color contrast, and ARIA attributes.

### Components

- Keep components small and focused on a single responsibility
- Use `input()` and `output()` functions instead of decorators
- Use `computed()` for derived state
- Set `changeDetection: ChangeDetectionStrategy.OnPush` in `@Component` decorator
- Prefer inline templates for small components
- Prefer Reactive forms instead of Template-driven ones
- Do NOT use `ngClass`, use `class` bindings instead
- Do NOT use `ngStyle`, use `style` bindings instead
- When using external templates/styles, use paths relative to the component TS file.

## State Management

- Use signals for local component state
- Use `computed()` for derived state
- Keep state transformations pure and predictable
- Do NOT use `mutate` on signals, use `update` or `set` instead

## Templates

- Keep templates simple and avoid complex logic
- Use native control flow (`@if`, `@for`, `@switch`) instead of `*ngIf`, `*ngFor`, `*ngSwitch`
- Use the async pipe to handle observables
- Do not assume globals like (`new Date()`) are available.
- Do not write arrow functions in templates (they are not supported).

## Services

- Design services around a single responsibility
- Use the `providedIn: 'root'` option for singleton services
- Use the `inject()` function instead of constructor injection
</file>

<file path="safevision-ui/.gitignore">
# See https://docs.github.com/get-started/getting-started-with-git/ignoring-files for more about ignoring files.

# Compiled output
/dist
/tmp
/out-tsc
/bazel-out

# Node
/node_modules
npm-debug.log
yarn-error.log

# IDEs and editors
.idea/
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# Visual Studio Code
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
.history/*

# Miscellaneous
/.angular/cache
.sass-cache/
/connect.lock
/coverage
/libpeerconnection.log
testem.log
/typings
__screenshots__/

# System files
.DS_Store
Thumbs.db
</file>

<file path="safevision-ui/.junie/guidelines.md">
You are an expert in TypeScript, Angular, and scalable web application development. You write functional, maintainable, performant, and accessible code following Angular and TypeScript best practices.

## TypeScript Best Practices

- Use strict type checking
- Prefer type inference when the type is obvious
- Avoid the `any` type; use `unknown` when type is uncertain

## Angular Best Practices

- Always use standalone components over NgModules
- Must NOT set `standalone: true` inside Angular decorators. It's the default in Angular v20+.
- Use signals for state management
- Implement lazy loading for feature routes
- Do NOT use the `@HostBinding` and `@HostListener` decorators. Put host bindings inside the `host` object of the `@Component` or `@Directive` decorator instead
- Use `NgOptimizedImage` for all static images.
  - `NgOptimizedImage` does not work for inline base64 images.

## Accessibility Requirements

- It MUST pass all AXE checks.
- It MUST follow all WCAG AA minimums, including focus management, color contrast, and ARIA attributes.

### Components

- Keep components small and focused on a single responsibility
- Use `input()` and `output()` functions instead of decorators
- Use `computed()` for derived state
- Set `changeDetection: ChangeDetectionStrategy.OnPush` in `@Component` decorator
- Prefer inline templates for small components
- Prefer Reactive forms instead of Template-driven ones
- Do NOT use `ngClass`, use `class` bindings instead
- Do NOT use `ngStyle`, use `style` bindings instead
- When using external templates/styles, use paths relative to the component TS file.

## State Management

- Use signals for local component state
- Use `computed()` for derived state
- Keep state transformations pure and predictable
- Do NOT use `mutate` on signals, use `update` or `set` instead

## Templates

- Keep templates simple and avoid complex logic
- Use native control flow (`@if`, `@for`, `@switch`) instead of `*ngIf`, `*ngFor`, `*ngSwitch`
- Use the async pipe to handle observables
- Do not assume globals like (`new Date()`) are available.
- Do not write arrow functions in templates (they are not supported).

## Services

- Design services around a single responsibility
- Use the `providedIn: 'root'` option for singleton services
- Use the `inject()` function instead of constructor injection
</file>

<file path="safevision-ui/.vscode/extensions.json">
{
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=827846
  "recommendations": ["angular.ng-template"]
}
</file>

<file path="safevision-ui/.vscode/launch.json">
{
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
  "version": "0.2.0",
  "configurations": [
    {
      "name": "ng serve",
      "type": "chrome",
      "request": "launch",
      "preLaunchTask": "npm: start",
      "url": "http://localhost:4200/"
    },
    {
      "name": "ng test",
      "type": "chrome",
      "request": "launch",
      "preLaunchTask": "npm: test",
      "url": "http://localhost:9876/debug.html"
    }
  ]
}
</file>

<file path="safevision-ui/.vscode/tasks.json">
{
  // For more information, visit: https://go.microsoft.com/fwlink/?LinkId=733558
  "version": "2.0.0",
  "tasks": [
    {
      "type": "npm",
      "script": "start",
      "isBackground": true,
      "problemMatcher": {
        "owner": "typescript",
        "pattern": "$tsc",
        "background": {
          "activeOnStart": true,
          "beginsPattern": {
            "regexp": "(.*?)"
          },
          "endsPattern": {
            "regexp": "bundle generation complete"
          }
        }
      }
    },
    {
      "type": "npm",
      "script": "test",
      "isBackground": true,
      "problemMatcher": {
        "owner": "typescript",
        "pattern": "$tsc",
        "background": {
          "activeOnStart": true,
          "beginsPattern": {
            "regexp": "(.*?)"
          },
          "endsPattern": {
            "regexp": "bundle generation complete"
          }
        }
      }
    }
  ]
}
</file>

<file path="safevision-ui/.windsurf/rules/guidelines.md">
You are an expert in TypeScript, Angular, and scalable web application development. You write functional, maintainable, performant, and accessible code following Angular and TypeScript best practices.

## TypeScript Best Practices

- Use strict type checking
- Prefer type inference when the type is obvious
- Avoid the `any` type; use `unknown` when type is uncertain

## Angular Best Practices

- Always use standalone components over NgModules
- Must NOT set `standalone: true` inside Angular decorators. It's the default in Angular v20+.
- Use signals for state management
- Implement lazy loading for feature routes
- Do NOT use the `@HostBinding` and `@HostListener` decorators. Put host bindings inside the `host` object of the `@Component` or `@Directive` decorator instead
- Use `NgOptimizedImage` for all static images.
  - `NgOptimizedImage` does not work for inline base64 images.

## Accessibility Requirements

- It MUST pass all AXE checks.
- It MUST follow all WCAG AA minimums, including focus management, color contrast, and ARIA attributes.

### Components

- Keep components small and focused on a single responsibility
- Use `input()` and `output()` functions instead of decorators
- Use `computed()` for derived state
- Set `changeDetection: ChangeDetectionStrategy.OnPush` in `@Component` decorator
- Prefer inline templates for small components
- Prefer Reactive forms instead of Template-driven ones
- Do NOT use `ngClass`, use `class` bindings instead
- Do NOT use `ngStyle`, use `style` bindings instead
- When using external templates/styles, use paths relative to the component TS file.

## State Management

- Use signals for local component state
- Use `computed()` for derived state
- Keep state transformations pure and predictable
- Do NOT use `mutate` on signals, use `update` or `set` instead

## Templates

- Keep templates simple and avoid complex logic
- Use native control flow (`@if`, `@for`, `@switch`) instead of `*ngIf`, `*ngFor`, `*ngSwitch`
- Use the async pipe to handle observables
- Do not assume globals like (`new Date()`) are available.
- Do not write arrow functions in templates (they are not supported).

## Services

- Design services around a single responsibility
- Use the `providedIn: 'root'` option for singleton services
- Use the `inject()` function instead of constructor injection
</file>

<file path="safevision-ui/AGENTS.md">
You are an expert in TypeScript, Angular, and scalable web application development. You write functional, maintainable, performant, and accessible code following Angular and TypeScript best practices.

## TypeScript Best Practices

- Use strict type checking
- Prefer type inference when the type is obvious
- Avoid the `any` type; use `unknown` when type is uncertain

## Angular Best Practices

- Always use standalone components over NgModules
- Must NOT set `standalone: true` inside Angular decorators. It's the default in Angular v20+.
- Use signals for state management
- Implement lazy loading for feature routes
- Do NOT use the `@HostBinding` and `@HostListener` decorators. Put host bindings inside the `host` object of the `@Component` or `@Directive` decorator instead
- Use `NgOptimizedImage` for all static images.
  - `NgOptimizedImage` does not work for inline base64 images.

## Accessibility Requirements

- It MUST pass all AXE checks.
- It MUST follow all WCAG AA minimums, including focus management, color contrast, and ARIA attributes.

### Components

- Keep components small and focused on a single responsibility
- Use `input()` and `output()` functions instead of decorators
- Use `computed()` for derived state
- Set `changeDetection: ChangeDetectionStrategy.OnPush` in `@Component` decorator
- Prefer inline templates for small components
- Prefer Reactive forms instead of Template-driven ones
- Do NOT use `ngClass`, use `class` bindings instead
- Do NOT use `ngStyle`, use `style` bindings instead
- When using external templates/styles, use paths relative to the component TS file.

## State Management

- Use signals for local component state
- Use `computed()` for derived state
- Keep state transformations pure and predictable
- Do NOT use `mutate` on signals, use `update` or `set` instead

## Templates

- Keep templates simple and avoid complex logic
- Use native control flow (`@if`, `@for`, `@switch`) instead of `*ngIf`, `*ngFor`, `*ngSwitch`
- Use the async pipe to handle observables
- Do not assume globals like (`new Date()`) are available.
- Do not write arrow functions in templates (they are not supported).

## Services

- Design services around a single responsibility
- Use the `providedIn: 'root'` option for singleton services
- Use the `inject()` function instead of constructor injection
</file>

<file path="safevision-ui/architectureDiagramMC4.md">
graph TD
    %% === ESTILOS C4 MODEL ===
    classDef person fill:#08427b,stroke:#052e56,stroke-width:2px,color:#ffffff;
    classDef container fill:#1168bd,stroke:#0b4884,stroke-width:2px,color:#ffffff;
    classDef component fill:#85bbf0,stroke:#5d82a8,stroke-width:2px,color:#000000;
    classDef database fill:#1168bd,stroke:#0b4884,stroke-width:2px,color:#ffffff;
    classDef external fill:#999999,stroke:#6b6b6b,stroke-width:2px,color:#ffffff;

    %% === ATORES ===
    User(("üë§ Security Guard<br/>[Person]"))
    Dev(("üë®‚Äçüíª Developer<br/>[Person]"))
    class User,Dev person

    %% === SISTEMAS EXTERNOS (NOTIFICA√á√ïES) ===
    subgraph Ext [‚òÅÔ∏è External Notification Providers]
        direction TB
        Telegram["‚úàÔ∏è Telegram API<br/>[System]"]
        SMS["üì± SMS Gateway<br/>[System]"]
        Email["üìß Email Service<br/>[System]"]
    end
    class Telegram,SMS,Email external

    %% === DEVOPS & INFRA (GITHUB/DOCKER) ===
    subgraph DevOps [üõ†Ô∏è DevOps & CI/CD]
        direction TB
        GitHub["üêô GitHub<br/>[System: VCS/Actions]"]
        DockerReg["üê≥ Docker Registry<br/>[System: Artifacts]"]
    end
    class GitHub,DockerReg external

    %% === LIMITE DO SISTEMA SAFEVISION ===
    subgraph SafeVision [üõ°Ô∏è SafeVision System - Docker Host]
        direction TB

        %% --- CAMADA DE APRESENTA√á√ÉO ---
        subgraph LayerFront [üíª Presentation Layer]
            Frontend["üñ•Ô∏è Frontend Application<br/>[Container: Angular 21]<br/>Tech: RxStomp, Axios"]
        end
        class Frontend container

        %% --- CAMADA DE BORDA / EDGE ---
        subgraph LayerEdge [üìç Edge / IoT Layer]
            direction TB
            Camera["üìπ Camera Device<br/>[Hardware]"]
            
            subgraph VisionAgent ["üêç Vision Agent<br/>[Container: Python 3.11]"]
                VA_Flask["üåê Flask Server<br/>[Component: API/MJPEG]"]
                VA_Core["üß† Surveillance Engine<br/>[Component: OpenCV/YOLOv8]"]
                VA_Queue["üîÑ Async Queue<br/>[Component]"]
            end
        end
        class Camera component
        class VisionAgent container
        class VA_Flask,VA_Core,VA_Queue component

        %% --- CAMADA DE BACKEND ---
        subgraph LayerBack [‚öôÔ∏è Business Logic Layer]
            direction TB
            Eureka["üîç Eureka Server<br/>[Container: Spring Boot]<br/>Tech: Service Discovery"]
            
            Gateway["‚õ©Ô∏è API Gateway<br/>[Container: Spring Boot 3]<br/>Tech: Spring Security, Spring Cloud Circuit Breaker,<br/>Resilience4j"]

            Auth["üîê Auth Service<br/>[Container: Spring Boot 3]<br/>Tech: Spring Security, Spring Web,<br/>Spring Data JPA"]
            
            Recog["üß† Recognition Service<br/>[Container: Java 21]<br/>Tech: Drools, Spring AMQP,<br/>Slf4j, Spring Cloud Sleuth"]
            
            Alert["üö® Alert Service<br/>[Container: Spring Boot 3]<br/>Tech: Spring Web, Java Mail, Spring AMQP,<br/>Spring Data JPA, Slf4j, Spring Cloud Sleuth"]
        end
        class Gateway,Recog,Alert,Auth,Eureka container

        %% --- CAMADA DE DADOS E INFRA ---
        subgraph LayerData [üíæ Data & Infra Layer]
            MinIO[("üóÑÔ∏è MinIO<br/>[Container: Object Storage]")]
            RabbitMQ("üêá RabbitMQ<br/>[Container: Message Broker]")
            Postgres[("üêò PostgreSQL<br/>[Container: Database]")]
            ZipKin("üìâ ZipKin<br/>[Container: Tracing]")
        end
        class MinIO,RabbitMQ,Postgres,ZipKin database
    end

    %% === REALCE DAS LINHAS DAS CAMADAS (Bordas Grossas) ===
    style SafeVision fill:none,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
    style LayerFront fill:#e8f4fa,stroke:#0d6efd,stroke-width:4px
    style LayerEdge fill:#fff0f5,stroke:#d63384,stroke-width:4px
    style LayerBack fill:#e9f7ef,stroke:#198754,stroke-width:4px
    style LayerData fill:#fff9e6,stroke:#ffc107,stroke-width:4px
    style Ext fill:#f0f0f0,stroke:#999,stroke-width:2px
    style DevOps fill:#e6e6fa,stroke:#663399,stroke-width:2px

    %% === FLUXO DEVOPS (Deploy) ===
    Dev ==>|"Commit/Push Code"| GitHub
    GitHub -->|"Trigger Build & Test"| GitHub
    GitHub -->|"Push Docker Image"| DockerReg
    DockerReg -.->|"Pull Images (Deploy)"| LayerBack
    DockerReg -.->|"Pull Images (Deploy)"| LayerFront
    DockerReg -.->|"Pull Images (Deploy)"| VisionAgent

    %% === SERVICE DISCOVERY (REGISTRO) ===
    Gateway & Auth & Recog & Alert -.->|"Register/Heartbeat"| Eureka

    %% === FLUXO 1: ATIVA√á√ÉO & AUTENTICA√á√ÉO ===
    User ==>|"1. Login / Ativar"| Frontend
    Frontend -->|"2. HTTPS Request"| Gateway
    Gateway -->|"2a. Auth/Validate JWT"| Auth
    Auth -->|"2b. User Data"| Postgres
    
    Gateway -->|"3. POST /start (Proxy)"| VA_Flask
    VA_Flask -->|"3a. Spawn Thread"| VA_Core
    VA_Core -->|"4. Power On"| Camera

    %% === FLUXO 2: V√çDEO STREAM ===
    Camera -->|"Raw Frames"| VA_Core
    VA_Core -->|"MJPEG Buffer"| VA_Flask
    VA_Flask -.->|"HTTP Stream (Display)"| Frontend

    %% === FLUXO 3: DETEC√á√ÉO E EVID√äNCIA ===
    VA_Core -- "Detect" --> VA_Core
    VA_Core -->|"5. Upload Image"| MinIO
    MinIO -- "Signed URL" --> VA_Core

    %% === FLUXO 4: MENSAGERIA E REGRAS ===
    VA_Core -->|"6. Enqueue Data"| VA_Queue
    VA_Queue -->|"7. Publica: vision_events"| RabbitMQ
    
    RabbitMQ -->|"8. Consume Event"| Recog
    Recog -->|"9. Apply Rules (Drools)"| Recog
    Recog -->|"10. Publica: Alerts"| RabbitMQ
    Recog -.->|"Trace Logs"| ZipKin

    %% === FLUXO 5: ALERTA E NOTIFICA√á√ÉO ===
    RabbitMQ -->|"11. Consume Alert"| Alert
    Alert -->|"12. Persist"| Postgres
    Alert -.->|"Trace Logs"| ZipKin
    
    Alert -->|"13. Send API"| Telegram
    Alert -->|"13. Send Gateway"| SMS
    Alert -->|"13. Send SMTP"| Email
    
    Telegram & SMS & Email -.->|"üö® NOTIFICA√á√ÉO"| User
    
    Alert -->|"14. WebSocket Pub"| Gateway
    Gateway -->|"15. Push Pop-up"| Frontend

    %% === AJUSTE DE LINKS (Layout) ===
    linkStyle 7,8,9 stroke:#663399,stroke-width:1px,stroke-dasharray: 4 2;
</file>

<file path="safevision-ui/architectureDiagramMC4PVersionPT.md">
# SafeVision - Arquitetura de Software (C4 Model)

Este documento descreve a arquitetura do sistema SafeVision utilizando a abordagem C4 Model (N√≠vel de Container e Componente).

## Diagrama de Container (Mermaid)

O diagrama abaixo ilustra os Containers (aplica√ß√µes, servi√ßos, bancos de dados) e suas intera√ß√µes, organizados em camadas arquiteturais.

```mermaid
graph TD
    %% === ESTILOS C4 MODEL ===
    classDef person fill:#08427b,stroke:#052e56,stroke-width:2px,color:#ffffff;
    classDef container fill:#1168bd,stroke:#0b4884,stroke-width:2px,color:#ffffff;
    classDef component fill:#85bbf0,stroke:#5d82a8,stroke-width:2px,color:#000000;
    classDef database fill:#1168bd,stroke:#0b4884,stroke-width:2px,color:#ffffff;
    classDef external fill:#999999,stroke:#6b6b6b,stroke-width:2px,color:#ffffff;

    %% === ATORES ===
    User(("üë§ Seguran√ßa<br/>[Pessoa]"))
    Dev(("üë®‚Äçüíª Desenvolvedor<br/>[Pessoa]"))
    class User,Dev person

    %% === SISTEMAS EXTERNOS (NOTIFICA√á√ïES) ===
    subgraph Ext [‚òÅÔ∏è Provedores Externos de Notifica√ß√£o]
        direction TB
        Telegram["‚úàÔ∏è API Telegram<br/>[Sistema]"]
        SMS["üì± Gateway SMS<br/>[Sistema]"]
        Email["üìß Servi√ßo de Email<br/>[Sistema]"]
    end
    class Telegram,SMS,Email external

    %% === DEVOPS & INFRA (GITHUB/DOCKER) ===
    subgraph DevOps [üõ†Ô∏è DevOps e CI/CD]
        direction TB
        GitHub["üêô GitHub<br/>[Sistema: VCS/Actions]"]
        DockerReg["üê≥ Docker Registry<br/>[Sistema: Artefatos]"]
    end
    class GitHub,DockerReg external

    %% === LIMITE DO SISTEMA SAFEVISION ===
    subgraph SafeVision [üõ°Ô∏è Sistema SafeVision - Docker Host]
        direction TB

        %% --- CAMADA DE APRESENTA√á√ÉO ---
        subgraph LayerFront [üíª Camada de Apresenta√ß√£o]
            Frontend["üñ•Ô∏è Aplica√ß√£o Frontend<br/>[Container: Angular 21]<br/>Tech: RxStomp, Axios"]
        end
        class Frontend container

        %% --- CAMADA DE BORDA / EDGE ---
        subgraph LayerEdge [üìç Camada Edge / IoT]
            direction TB
            Camera["üìπ Dispositivo de C√¢mera<br/>[Hardware]"]
            
            subgraph VisionAgent ["üêç Agente de Vis√£o<br/>[Container: Python 3.11]"]
                VA_Flask["üåê Servidor Flask<br/>[Componente: API/MJPEG]"]
                VA_Core["üß† Motor de Vigil√¢ncia<br/>[Componente: OpenCV/YOLOv8]"]
                VA_Queue["üîÑ Fila Ass√≠ncrona<br/>[Componente]"]
            end
        end
        class Camera component
        class VisionAgent container
        class VA_Flask,VA_Core,VA_Queue component

        %% --- CAMADA DE BACKEND ---
        subgraph LayerBack [‚öôÔ∏è Camada de L√≥gica de Neg√≥cio]
            direction TB
            Eureka["üîç Servidor Eureka<br/>[Container: Spring Boot]<br/>Tech: Descoberta de Servi√ßo"]
            
            Gateway["‚õ©Ô∏è API Gateway<br/>[Container: Spring Boot 3]<br/>Tech: Spring Security, Spring Cloud Circuit Breaker,<br/>Resilience4j"]

            Auth["üîê Servi√ßo de Autentica√ß√£o<br/>[Container: Spring Boot 3]<br/>Tech: Spring Security, Spring Web,<br/>Spring Data JPA"]
            
            Recog["üß† Servi√ßo de Reconhecimento<br/>[Container: Java 21]<br/>Tech: Drools, Spring AMQP,<br/>Slf4j, Spring Cloud Sleuth"]
            
            Alert["üö® Servi√ßo de Alerta<br/>[Container: Spring Boot 3]<br/>Tech: Spring Web, Java Mail, Spring AMQP,<br/>Spring Data JPA, Slf4j, Spring Cloud Sleuth"]
        end
        class Gateway,Recog,Alert,Auth,Eureka container

        %% --- CAMADA DE DADOS E INFRA ---
        subgraph LayerData [üíæ Camada de Dados e Infra]
            MinIO[("üóÑÔ∏è MinIO<br/>[Container: Object Storage]")]
            RabbitMQ("üêá RabbitMQ<br/>[Container: Broker de Mensagens]")
            Postgres[("üêò PostgreSQL<br/>[Container: Banco de Dados]")]
            ZipKin("üìâ ZipKin<br/>[Container: Rastreamento]")
        end
        class MinIO,RabbitMQ,Postgres,ZipKin database
    end

    %% === REALCE DAS LINHAS DAS CAMADAS (Bordas Grossas) ===
    style SafeVision fill:none,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
    style LayerFront fill:#e8f4fa,stroke:#0d6efd,stroke-width:4px
    style LayerEdge fill:#fff0f5,stroke:#d63384,stroke-width:4px
    style LayerBack fill:#e9f7ef,stroke:#198754,stroke-width:4px
    style LayerData fill:#fff9e6,stroke:#ffc107,stroke-width:4px
    style Ext fill:#f0f0f0,stroke:#999,stroke-width:2px
    style DevOps fill:#e6e6fa,stroke:#663399,stroke-width:2px

    %% === FLUXO DEVOPS (Deploy) ===
    Dev ==>|"Commit/Push C√≥digo"| GitHub
    GitHub -->|"Dispara Build e Teste"| GitHub
    GitHub -->|"Push Imagem Docker"| DockerReg
    DockerReg -.->|"Pull Imagens (Deploy)"| LayerBack
    DockerReg -.->|"Pull Imagens (Deploy)"| LayerFront
    DockerReg -.->|"Pull Imagens (Deploy)"| VisionAgent

    %% === SERVICE DISCOVERY (REGISTRO) ===
    Gateway & Auth & Recog & Alert -.->|"Registro/Heartbeat"| Eureka

    %% === FLUXO 1: ATIVA√á√ÉO & AUTENTICA√á√ÉO ===
    User ==>|"1. Login / Ativar"| Frontend
    Frontend -->|"2. Requisi√ß√£o HTTPS"| Gateway
    Gateway -->|"2a. Autentica√ß√£o/Validar JWT"| Auth
    Auth -->|"2b. Dados Usu√°rio"| Postgres
    
    Gateway -->|"3. POST /start (Proxy)"| VA_Flask
    VA_Flask -->|"3a. Inicia Thread"| VA_Core
    VA_Core -->|"4. Ligar"| Camera

    %% === FLUXO 2: V√çDEO STREAM ===
    Camera -->|"Frames Brutos"| VA_Core
    VA_Core -->|"Buffer MJPEG"| VA_Flask
    VA_Flask -.->|"Stream HTTP (Visualiza√ß√£o)"| Frontend

    %% === FLUXO 3: DETEC√á√ÉO E EVID√äNCIA ===
    VA_Core -- "Detectar" --> VA_Core
    VA_Core -->|"5. Upload Imagem"| MinIO
    MinIO -- "URL Assinada" --> VA_Core

    %% === FLUXO 4: MENSAGERIA E REGRAS ===
    VA_Core -->|"6. Enfileirar Dados"| VA_Queue
    VA_Queue -->|"7. Publica: vision_events"| RabbitMQ
    
    RabbitMQ -->|"8. Consome Evento"| Recog
    Recog -->|"9. Aplica Regras (Drools)"| Recog
    Recog -->|"10. Publica: Alertas"| RabbitMQ
    Recog -.->|"Logs de Rastreamento"| ZipKin

    %% === FLUXO 5: ALERTA E NOTIFICA√á√ÉO ===
    RabbitMQ -->|"11. Consome Alerta"| Alert
    Alert -->|"12. Persiste"| Postgres
    Alert -.->|"Logs de Rastreamento"| ZipKin
    
    Alert -->|"13. Envia API"| Telegram
    Alert -->|"13. Envia Gateway"| SMS
    Alert -->|"13. Envia SMTP"| Email
    
    Telegram & SMS & Email -.->|"üö® NOTIFICA√á√ÉO"| User
    
    Alert -->|"14. Pub WebSocket"| Gateway
    Gateway -->|"15. Push Pop-up"| Frontend

    %% === AJUSTE DE LINKS (Layout) ===
    linkStyle 7,8,9 stroke:#663399,stroke-width:1px,stroke-dasharray: 4 2;
```

---

## Camadas da Arquitetura

### 1. Presentation Layer (Apresenta√ß√£o)
*   **Frontend Application**: Single Page Application (SPA) desenvolvida em **Angular 21**. Respons√°vel pela intera√ß√£o com o usu√°rio, exibi√ß√£o do stream de v√≠deo e alertas em tempo real.

### 2. Edge / IoT Layer (Borda)
*   **Vision Agent**: Container **Python 3.11** rodando pr√≥ximo √† c√¢mera. Respons√°vel pelo processamento pesado de vis√£o computacional (**OpenCV**, **YOLOv8**).
*   **Camera Device**: Hardware f√≠sico de captura.

### 3. Business Logic Layer (Backend - Spring Cloud)
A camada de backend foi enriquecida com componentes da stack Spring Cloud para resili√™ncia e observabilidade.

*   **Eureka Server**: Servidor de descoberta de servi√ßos (Service Discovery). Permite que os microservi√ßos se encontrem dinamicamente.
*   **API Gateway**: Ponto de entrada seguro (**Spring Boot 3**, **Spring Security**). Implementa **Resilience4j Circuit Breaker** para falhar graciosamente em caso de sobrecarga.
*   **Auth Service**: Servi√ßo dedicado para autentica√ß√£o e autoriza√ß√£o (**OAuth2**, **JWT**), utilizando **Spring Data JPA** para persist√™ncia de usu√°rios.
*   **Recognition Service**: Servi√ßo de regras de neg√≥cio (**Drools**). Utiliza **Spring AMQP** para mensageria, **Slf4j** para logs estruturados e **Spring Cloud Sleuth** para rastreamento distribu√≠do.
*   **Alert Service**: Gerenciador de notifica√ß√µes. Utiliza **Spring Data JPA** para persist√™ncia de alertas, **Java Mail** para envios e **Sleuth/Slf4j** para monitoramento.

### 4. Data & Infra Layer (Dados)
*   **MinIO**: Armazenamento de objetos para evid√™ncias (imagens/v√≠deos das detec√ß√µes).
*   **RabbitMQ**: Message Broker para desacoplamento ass√≠ncrono.
*   **PostgreSQL**: Persist√™ncia de logs de auditoria, usu√°rios (Auth) e alertas.
*   **ZipKin**: Coleta e visualiza√ß√£o de tra√ßos distribu√≠dos gerados pelo Sleuth.

### 5. DevOps & Infrastructure (Novo)
*   **GitHub**: Reposit√≥rio de c√≥digo fonte e plataforma de CI/CD (GitHub Actions) que dispara os builds.
*   **Docker Registry**: Armazena as imagens de container geradas.
*   **Docker Host**: Ambiente de execu√ß√£o onde todos os containers da aplica√ß√£o SafeVision s√£o implantados.
</file>

<file path="safevision-ui/README.md">
# SafevisionUi

This project was generated using [Angular CLI](https://github.com/angular/angular-cli) version 21.0.1.

## Development server

To start a local development server, run:

```bash
ng serve
```

Once the server is running, open your browser and navigate to `http://localhost:4200/`. The application will automatically reload whenever you modify any of the source files.

## Code scaffolding

Angular CLI includes powerful code scaffolding tools. To generate a new component, run:

```bash
ng generate component component-name
```

For a complete list of available schematics (such as `components`, `directives`, or `pipes`), run:

```bash
ng generate --help
```

## Building

To build the project run:

```bash
ng build
```

This will compile your project and store the build artifacts in the `dist/` directory. By default, the production build optimizes your application for performance and speed.

## Running unit tests

To execute unit tests with the [Vitest](https://vitest.dev/) test runner, use the following command:

```bash
ng test
```

## Running end-to-end tests

For end-to-end (e2e) testing, run:

```bash
ng e2e
```

Angular CLI does not come with an end-to-end testing framework by default. You can choose one that suits your needs.

## Additional Resources

For more information on using the Angular CLI, including detailed command references, visit the [Angular CLI Overview and Command Reference](https://angular.dev/tools/cli) page.
</file>

<file path="safevision-ui/src/app/app.config.server.ts">
import { mergeApplicationConfig, ApplicationConfig } from '@angular/core';
import { provideServerRendering, withRoutes } from '@angular/ssr';
import { appConfig } from './app.config';
import { serverRoutes } from './app.routes.server';

const serverConfig: ApplicationConfig = {
  providers: [
    provideServerRendering(withRoutes(serverRoutes))
  ]
};

export const config = mergeApplicationConfig(appConfig, serverConfig);
</file>

<file path="safevision-ui/src/app/app.routes.server.ts">
import { RenderMode, ServerRoute } from '@angular/ssr';

export const serverRoutes: ServerRoute[] = [
  {
    path: '**',
    renderMode: RenderMode.Prerender
  }
];
</file>

<file path="safevision-ui/src/app/app.routes.ts">
import { Routes } from '@angular/router';
import { LoginComponent } from './features/auth/login/login.component';
import { DashboardComponent } from './features/dashboard/dashboard.component';
import { RegisterComponent } from './features/auth/register/register.component';
import { authGuard } from './core/guards/auth-guard';


export const routes: Routes = [
  // Rota padr√£o redireciona para login
  { path: '', redirectTo: 'login', pathMatch: 'full' },

  // Rota de Login
  { path: 'login', component: LoginComponent },

  // Rota de Registro
  { path: 'register', component: RegisterComponent },

  // Rota Protegida
  {
    path: 'dashboard',
    component: DashboardComponent,
    canActivate: [authGuard]
  },

  {
          path: 'history',
          loadComponent: () => import('./features/alert-history/alert-history.component')
              .then(m => m.AlertHistoryComponent),
          canActivate: [authGuard]
   },

  // (Opcional) Rota Curinga: Se digitar algo errado, vai pro login
  { path: '**', redirectTo: 'login' }
];
</file>

<file path="safevision-ui/src/app/app.spec.ts">
import { TestBed } from '@angular/core/testing';
import { App } from './app';

describe('App', () => {
  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [App],
    }).compileComponents();
  });

  it('should create the app', () => {
    const fixture = TestBed.createComponent(App);
    const app = fixture.componentInstance;
    expect(app).toBeTruthy();
  });

  it('should render title', async () => {
    const fixture = TestBed.createComponent(App);
    await fixture.whenStable();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h1')?.textContent).toContain('Hello, safevision-ui');
  });
});
</file>

<file path="safevision-ui/src/app/app.ts">
import { Component, signal } from '@angular/core';
import { RouterOutlet } from '@angular/router';

@Component({
  selector: 'app-root',
  imports: [RouterOutlet],
  templateUrl: './app.html',
  styleUrl: './app.scss'
})
export class App {
  protected readonly title = signal('safevision-ui');
}
</file>

<file path="safevision-ui/src/app/core/guards/auth-guard.spec.ts">
import { TestBed } from '@angular/core/testing';
import { CanActivateFn } from '@angular/router';

import { authGuard } from './auth-guard';

describe('authGuard', () => {
  const executeGuard: CanActivateFn = (...guardParameters) => 
      TestBed.runInInjectionContext(() => authGuard(...guardParameters));

  beforeEach(() => {
    TestBed.configureTestingModule({});
  });

  it('should be created', () => {
    expect(executeGuard).toBeTruthy();
  });
});
</file>

<file path="safevision-ui/src/app/core/guards/auth-guard.ts">
import { CanActivateFn } from '@angular/router';

export const authGuard: CanActivateFn = (route, state) => {
  return true;
};
</file>

<file path="safevision-ui/src/app/core/interceptors/auth-interceptor.spec.ts">
import { HttpInterceptorFn } from '@angular/common/http';
import { inject } from '@angular/core';
import { catchError, throwError } from 'rxjs';
import { Router } from '@angular/router';

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const router = inject(Router);
  const token = localStorage.getItem('safevision_token');

  let authReq = req;

  if (token) {
    authReq = req.clone({
      setHeaders: { Authorization: `Bearer ${token}` }
    });
  }

  return next(authReq).pipe(
    catchError(error => {
      if (error.status === 401) {
        localStorage.removeItem('safevision_token');
        router.navigate(['/login']);
      }
      return throwError(() => error);
    })
  );
};
</file>

<file path="safevision-ui/src/app/core/services/notification.service.ts">
import { Injectable, inject } from '@angular/core';
import { MatSnackBar, MatSnackBarConfig, MatSnackBarHorizontalPosition, MatSnackBarVerticalPosition } from '@angular/material/snack-bar';

@Injectable({ providedIn: 'root' })
export class NotificationService {
  private snackBar = inject(MatSnackBar);

 
  showError(message: string) {
    this.openSnackBar(message, 'Fechar', 'error-snackbar', 5000, 'center', 'bottom');
  }


  showSuccess(message: string) {
    this.openSnackBar(message, 'OK', 'success-snackbar', 4000, 'end', 'top');
  }

 
  showInfo(message: string) {
    this.openSnackBar(message, 'OK', 'info-snackbar', 4000, 'end', 'top');
  }

  
  private openSnackBar(
    message: string,
    action: string,
    panelClass: string,
    duration: number,
    horizontalPosition: MatSnackBarHorizontalPosition,
    verticalPosition: MatSnackBarVerticalPosition
  ) {
    const config: MatSnackBarConfig = {
      duration: duration,
      horizontalPosition: horizontalPosition,
      verticalPosition: verticalPosition,
      panelClass: [panelClass] // Adiciona a classe CSS
    };

    this.snackBar.open(message, action, config);
  }
}
</file>

<file path="safevision-ui/src/app/features/auth/register/register.component.spec.ts">
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { Register } from './register.component';

describe('Register', () => {
  let component: Register;
  let fixture: ComponentFixture<Register>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [Register]
    })
    .compileComponents();

    fixture = TestBed.createComponent(Register);
    component = fixture.componentInstance;
    await fixture.whenStable();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});
</file>

<file path="safevision-ui/src/app/features/settings/settings.html">
<p>settings works!</p>
</file>

<file path="safevision-ui/src/app/features/settings/settings.spec.ts">
import { ComponentFixture, TestBed } from '@angular/core/testing';

import { Settings } from './settings';

describe('Settings', () => {
  let component: Settings;
  let fixture: ComponentFixture<Settings>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [Settings]
    })
    .compileComponents();

    fixture = TestBed.createComponent(Settings);
    component = fixture.componentInstance;
    await fixture.whenStable();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});
</file>

<file path="safevision-ui/src/app/features/settings/settings.ts">
import { Component } from '@angular/core';

@Component({
  selector: 'app-settings',
  imports: [],
  templateUrl: './settings.html',
  styleUrl: './settings.scss',
})
export class Settings {

}
</file>

<file path="safevision-ui/src/environments/environment.development.ts">
const HOST_IP = '192.168.112.1';

export const environment = {
  production: false,
  // 'https://api.safevision.com'
  apiUrl: `http://${HOST_IP}:8080`,
  visionAgentUrl: `http://${HOST_IP}:5000`
};
</file>

<file path="safevision-ui/src/environments/environment.ts">
const HOST_IP = '192.168.112.1';

export const environment = {
  production: true,
  apiUrl: `http://${HOST_IP}:8080`,
  visionAgentUrl: `http://${HOST_IP}:5000`
};
</file>

<file path="safevision-ui/src/main.server.ts">
import { BootstrapContext, bootstrapApplication } from '@angular/platform-browser';
import { App } from './app/app';
import { config } from './app/app.config.server';

const bootstrap = (context: BootstrapContext) =>
    bootstrapApplication(App, config, context);

export default bootstrap;
</file>

<file path="safevision-ui/src/main.ts">
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { App } from './app/app';

bootstrapApplication(App, appConfig)
  .catch((err) => console.error(err));
</file>

<file path="safevision-ui/src/server.ts">
import {
  AngularNodeAppEngine,
  createNodeRequestHandler,
  isMainModule,
  writeResponseToNodeResponse,
} from '@angular/ssr/node';
import express from 'express';
import { join } from 'node:path';

const browserDistFolder = join(import.meta.dirname, '../browser');

const app = express();
const angularApp = new AngularNodeAppEngine();

/**
 * Example Express Rest API endpoints can be defined here.
 * Uncomment and define endpoints as necessary.
 *
 * Example:
 * ```ts
 * app.get('/api/{*splat}', (req, res) => {
 *   // Handle API request
 * });
 * ```
 */

/**
 * Serve static files from /browser
 */
app.use(
  express.static(browserDistFolder, {
    maxAge: '1y',
    index: false,
    redirect: false,
  }),
);

/**
 * Handle all other requests by rendering the Angular application.
 */
app.use((req, res, next) => {
  angularApp
    .handle(req)
    .then((response) =>
      response ? writeResponseToNodeResponse(response, res) : next(),
    )
    .catch(next);
});

/**
 * Start the server if this module is the main entry point, or it is ran via PM2.
 * The server listens on the port defined by the `PORT` environment variable, or defaults to 4000.
 */
if (isMainModule(import.meta.url) || process.env['pm_id']) {
  const port = process.env['PORT'] || 4000;
  app.listen(port, (error) => {
    if (error) {
      throw error;
    }

    console.log(`Node Express server listening on http://localhost:${port}`);
  });
}

/**
 * Request handler used by the Angular CLI (for dev-server and during build) or Firebase Cloud Functions.
 */
export const reqHandler = createNodeRequestHandler(app);
</file>

<file path="safevision-ui/tsconfig.app.json">
/* To learn more about Typescript configuration file: https://www.typescriptlang.org/docs/handbook/tsconfig-json.html. */
/* To learn more about Angular compiler options: https://angular.dev/reference/configs/angular-compiler-options. */
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./out-tsc/app",
    "types": [
      "node"
    ]
  },
  "include": [
    "src/**/*.ts"
  ],
  "exclude": [
    "src/**/*.spec.ts"
  ]
}
</file>

<file path="safevision-ui/tsconfig.json">
/* To learn more about Typescript configuration file: https://www.typescriptlang.org/docs/handbook/tsconfig-json.html. */
/* To learn more about Angular compiler options: https://angular.dev/reference/configs/angular-compiler-options. */
{
  "compileOnSave": false,
  "compilerOptions": {
    "strict": true,
    "noImplicitOverride": true,
    "noPropertyAccessFromIndexSignature": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "skipLibCheck": true,
    "isolatedModules": true,
    "experimentalDecorators": true,
    "importHelpers": true,
    "target": "ES2022",
    "module": "preserve"
  },
  "angularCompilerOptions": {
    "enableI18nLegacyMessageIdFormat": false,
    "strictInjectionParameters": true,
    "strictInputAccessModifiers": true,
    "strictTemplates": true
  },
  "files": [],
  "references": [
    {
      "path": "./tsconfig.app.json"
    },
    {
      "path": "./tsconfig.spec.json"
    }
  ]
}
</file>

<file path="safevision-ui/tsconfig.spec.json">
/* To learn more about Typescript configuration file: https://www.typescriptlang.org/docs/handbook/tsconfig-json.html. */
/* To learn more about Angular compiler options: https://angular.dev/reference/configs/angular-compiler-options. */
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./out-tsc/spec",
    "types": [
      "vitest/globals"
    ]
  },
  "include": [
    "src/**/*.d.ts",
    "src/**/*.spec.ts"
  ]
}
</file>

<file path="vision-agent/.gitignore">
/movement.mp4
/movementEmpty.mp4
</file>

<file path="vision-agent/teste_websocket.py">
import time
import uuid
import json
from messaging import RabbitMQClient

# --- CONFIGURA√á√ÉO DO ALERTA SIMULADO ---
payload = {
    "detectionId": str(uuid.uuid4()),
    "timestamp": int(time.time()),
    "isFacingCamera": False, # False = Alerta de Arma
    "depthPosition": 0,
    "gazeDirection": "unknown",
    "cameraId": "TESTE_SCRIPT_PYTHON",
    "userId": "safe",  # <--- TEM QUE SER O MESMO USER DO DASHBOARD
    "hasWeapon": True, # <--- True = Gatilho para Alerta Vermelho
    "weaponType": "TESTE_WEBSOCKET",
    "weaponLocation": "Simulacao Manual",
    # URL de uma imagem que sabemos que funciona (do seu teste anterior)
    "snapshotUrl": "http://192.168.112.1:9000/safevision-evidence/safe_1765430275_fa74f8.jpg",
    
    # üìç Coordenadas de Florian√≥polis, SC, Brasil
    "latitude": -27.5969, 
    "longitude": -48.5495
}

print("üöÄ Enviando simula√ß√£o de arma para o RabbitMQ...")

try:
    # Usa a mesma classe de conex√£o do main.py
    client = RabbitMQClient()
    client.send_event(payload)
    
    # Tenta fechar a conex√£o graciosamente
    if hasattr(client, 'close'):
        client.close()
    elif hasattr(client, 'connection') and client.connection:
        client.connection.close()
        
    print(f"‚úÖ Mensagem enviada para a fila 'vision_events'!")
    print(f"üìç GPS enviado: Lat {payload['latitude']}, Lon {payload['longitude']}")
    print("üëÄ OLHE PARA O SEU DASHBOARD AGORA (Pop-up deve aparecer com endere√ßo).")
    
except Exception as e:
    print(f"‚ùå Erro ao conectar no RabbitMQ: {e}")
</file>

<file path="vision-agent/utils.py">
import numpy as np

def calculate_distance(p1, p2):
    """Calcula dist√¢ncia euclidiana entre dois pontos (x, y)"""
    return np.sqrt((p1[0] - p2[0])**2 + (p1[1] - p2[1])**2)
</file>

<file path=".gitignore">
target/
!.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
*.class
.classpath
.project
.settings/
.idea/
*.iml
.DS_Store

# --- ARQUIVOS DE SEGURAN√áA ---
.env
/logs
/login.json
/event.json
/admin_user.json
/alert_critical.json
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/RabbitQueueProperties.java">
package com.safevision.alertservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Type-safe configuration properties for RabbitMQ queues.
 * Maps properties starting with "rabbitmq.queues" from application.yml.
 *
 * @param alerts The name of the alerts queue.
 */
@ConfigurationProperties(prefix = "spring.rabbitmq.queues")
public record RabbitQueueProperties(String alerts) {}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/WebSocketConfig.java">
package com.safevision.alertservice.config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

/**
 * Configuration class for WebSocket using STOMP protocol.
 * Enables real-time communication between the backend and the frontend (Angular).
 */
@Slf4j
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    private static final String BROKER_PREFIX = "/topic";
    private static final String APP_PREFIX = "/app";
    private static final String ENDPOINT_WS = "/ws";
    private static final String ENDPOINT_ALERT = "alert/ws";

    /**
     * Configures the message broker options.
     */
    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        log.info("Configuring WebSocket Message Broker...");

        // Enables a simple in-memory broker to send messages to clients.
        // Prefix for messages going FROM server TO client (Push).
        config.enableSimpleBroker(BROKER_PREFIX);
        
        // Prefix for messages coming FROM client TO server (e.g. chat messages).
        config.setApplicationDestinationPrefixes(APP_PREFIX);
    }

    /**
     * Registers the STOMP endpoints mapping each to a specific URL.
     */
    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        log.info("Registering STOMP Endpoint at: {}", ENDPOINT_WS);
        
        registry.addEndpoint(ENDPOINT_ALERT)
        .setAllowedOriginPatterns("*") // Allows connections from any origin (CORS)
        .withSockJS(); // Fallback options for older browsers
        
        
        
        // Defines the connection endpoint (Handshake).
        // Angular will connect to: http://localhost:8080/alert/ws (via Gateway)
        registry.addEndpoint(ENDPOINT_WS)
                .setAllowedOriginPatterns("*") // Allows connections from any origin (CORS)
                .withSockJS(); // Fallback options for older browsers
    }
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/dto/AlertEventDTO.java">
package com.safevision.alertservice.dto;

import java.math.BigDecimal;

public record AlertEventDTO(
    
    String userId,
    String alertType,
    String description,
    String severity,
    String cameraId,
    String snapshotUrl,
    BigDecimal latitude,
    BigDecimal longitude,
    String address // üìç Novo campo
) {}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/dto/AlertResponse.java">
package com.safevision.alertservice.dto;
import java.math.BigDecimal;
import java.time.LocalDateTime;

public record AlertResponse(
    String id,
    String alertType,
    String description,
    String severity,
    String cameraId,
    boolean acknowledged,
    LocalDateTime createdAt,
    String snapshotUrl,
    BigDecimal latitude,
    BigDecimal longitude,
    String address // üìç Adicionado
) {}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/listener/AlertListener.java">
package com.safevision.alertservice.listener;

import com.safevision.alertservice.dto.AlertEventDTO;
import com.safevision.alertservice.service.AlertService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

/**
 * Listener responsible for consuming processed alerts from the RabbitMQ queue.
 * This component acts as the bridge between the Recognition Service (Producer)
 * and the Alert Service logic (Persistence/Notification).
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class AlertListener {

    private final AlertService alertService;

    /**
     * Consumes alert events from the queue defined in RabbitMQConfig.
     * Uses SpEL to resolve the queue name bean 'alertsQueueName'.
     *
     * @param event The DTO containing alert details.
     */
    @RabbitListener(queues = "#{alertsQueueName}")
    public void receiveAlert(AlertEventDTO event) {
        log.info("üì® [RabbitMQ] Received alert event type: {}", event.alertType());
        log.debug("Alert payload: {}", event);

        try {
            // Delegate to the service layer for persistence and notification logic
            alertService.createAlert(event);
            
        } catch (Exception e) {
            // Log the full stack trace for debugging purposes
            log.error("‚ùå Error processing RabbitMQ alert: {}", e.getMessage(), e);

            // Note: In a production environment with DLQ (Dead Letter Queue) configured,
            // you might want to throw a specific AmqpRejectAndDontRequeueException here
            // to move the failed message to the DLQ instead of losing it.
        }
    }
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/repository/AlertRepository.java">
package com.safevision.alertservice.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import com.safevision.alertservice.model.Alert;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * Repository interface for managing {@link Alert} entities in the PostgreSQL database.
 * <p>
 * Extends JpaRepository to provide standard CRUD operations.
 * Custom finder methods are automatically implemented by Spring Data based on method names.
 * </p>
 */
@Repository
public interface AlertRepository extends JpaRepository<Alert, String> {

    /**
     * Finds all alerts belonging to a specific user, sorted by creation date (newest first).
     * Used for populating the user's dashboard history.
     *
     * @param userId The UUID of the user.
     * @return A list of alerts.
     */
    List<Alert> findByUserIdOrderByCreatedAtDesc(String userId);

    /**
     * Finds only unacknowledged (unread) alerts for a specific user, sorted by newest first.
     * Useful for showing active notifications or badges.
     *
     * @param userId The UUID of the user.
     * @return A list of unread alerts.
     */
    List<Alert> findByUserIdAndAcknowledgedFalseOrderByCreatedAtDesc(String userId);
    
 
    Page<Alert> findByUserId(String userId, Pageable pageable);
    
   
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/AuthServiceApplication.java">
package com.safevision.authservice;

import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.EnableConfigurationProperties;

/**
 * Entry point for the Authentication Service.
 * <p>
 * This microservice acts as the <b>Identity Provider (IdP)</b> for the SafeVision architecture.
 * It is responsible for:
 * <ul>
 * <li>User Registration and Management (PostgreSQL).</li>
 * <li>Authentication (Login).</li>
 * <li>Generating JWT Tokens signed with the shared secret.</li>
 * </ul>
 * </p>
 */
@Slf4j
@SpringBootApplication
@EnableConfigurationProperties // Enables support for @ConfigurationProperties records
public class AuthServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(AuthServiceApplication.class, args);
        log.info("üöÄ Auth Service (Identity Provider) started successfully!");
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/dto/LoginRequest.java">
package com.safevision.authservice.dto;

/**
 * Data Transfer Object (DTO) for User Authentication.
 * <p>
 * This record encapsulates the credentials sent by the client (Frontend)
 * to the {@code /auth/login} endpoint.
 * </p>
 *
 * @param username The unique username identifying the user in the system.
 * @param password The raw password provided by the user (to be verified against the stored hash).
 */
public record LoginRequest(
    String username,
    String password
) {}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/dto/TokenResponse.java">
package com.safevision.authservice.dto;

/**
 * Data Transfer Object (DTO) for the Authentication Token.
 * <p>
 * This record encapsulates the JWT (JSON Web Token) returned to the client
 * upon successful authentication (login). It serves as the standard response
 * contract for the {@code /auth/login} endpoint.
 * </p>
 *
 * @param token The signed JWT string containing user claims and expiration.
 */
public record TokenResponse(String token) {

    /**
     * Compact Constructor for validation.
     * Ensures the DTO is never created with an invalid token.
     */
    public TokenResponse {
        if (token == null || token.isBlank()) {
            throw new IllegalArgumentException("Token cannot be null or empty");
        }
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/dto/UserResponse.java">
package com.safevision.authservice.dto;

import java.util.Set;

/**
 * Data Transfer Object (DTO) representing the safe public view of a User.
 * <p>
 * This record is used to return user details to the frontend or other services
 * after registration or updates, strictly excluding sensitive data like passwords.
 * </p>
 *
 * @param id       The unique UUID of the user.
 * @param username The login username.
 * @param roles    The security roles assigned to the user (e.g., ADMIN, USER).
 */
public record UserResponse(
    String id,
    String username,
    Set<String> roles
) {

    /**
     * Compact Constructor for validation and defensive copying.
     * Ensures the DTO is never created with null core fields and that the roles set is immutable.
     */
    public UserResponse {
        if (id == null || id.isBlank()) {
            throw new IllegalArgumentException("User ID cannot be null or empty");
        }
        if (username == null || username.isBlank()) {
            throw new IllegalArgumentException("Username cannot be null or empty");
        }
        
        // Defensive copy: Ensures the Set inside the record cannot be modified externally later.
        // Also handles null by defaulting to an empty set.
        roles = (roles != null) ? Set.copyOf(roles) : Set.of();
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/service/JwtService.java">
package com.safevision.authservice.service;

import com.safevision.authservice.config.JwtProperties;
import com.safevision.authservice.model.User;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.stereotype.Service;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Date;
import java.util.Map;

/**
 * Service responsible for generating and signing JSON Web Tokens (JWT).
 * It uses a shared secret key to ensure tokens can be validated by other microservices.
 */
@Slf4j
@Service
@EnableConfigurationProperties(JwtProperties.class)
public class JwtService {

    private static final String CLAIM_ID = "id";
    private static final String CLAIM_ROLES = "roles";
    

    private final SecretKey key;
    private final long expirationMs;

    /**
     * Constructor injection ensures the key is initialized only once and is immutable.
     *
     * @param properties The type-safe configuration object.
     */
    public JwtService(JwtProperties properties) {
        this.expirationMs = properties.expirationMs();
        this.key = Keys.hmacShaKeyFor(properties.secret().getBytes(StandardCharsets.UTF_8));
    }

    /**
     * Generates a signed JWT for a specific user.
     * Includes custom claims (ID, Roles) to allow stateless authorization in other services.
     *
     * @param user The authenticated user model.
     * @return The compact JWT string.
     */
    public String generateToken(User user) {
        var now = System.currentTimeMillis();
        var validity = new Date(now + expirationMs);

        
        var claims = Map.of(
            CLAIM_ID, user.getId(),
            CLAIM_ROLES, user.getRoles()
            
        );

        log.debug("Generating JWT for user: {}", user.getUsername());

        return Jwts.builder()
                .claims(claims) 
                .subject(user.getUsername()) 
                .issuedAt(new Date(now))
                .expiration(validity)
                .signWith(key, Jwts.SIG.HS256) 
                .compact();
    }
}
</file>

<file path="eureka-server/Dockerfile">
FROM eclipse-temurin:21-jdk


RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY target/*.jar app.jar


EXPOSE 8761

ENTRYPOINT ["java", "-jar", "app.jar"]
</file>

<file path="eureka-server/src/main/java/com/safevision/eurekaserver/EurekaServerApplication.java">
package com.safevision.eurekaserver;

import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

/**
 * Entry point for the Eureka Service Discovery Server.
 * <p>
 * This server acts as the central registry ("Phone Book") for the microservices architecture.
 * All services (Auth, Alert, Recognition, Gateway) register here so they can find each other
 * dynamically without hardcoded IP addresses.
 * </p>
 */
@Slf4j
@EnableEurekaServer
@SpringBootApplication
public class EurekaServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
        log.info("üöÄ Eureka Service Registry started successfully!");
    }
}
</file>

<file path="eureka-server/src/main/resources/application.yml">
server:
  port: 8761

spring:
  application:
    name: eureka-server

eureka:
  client:
    register-with-eureka: false
    fetch-registry: false
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://localhost:8761/eureka/}
  server:
    enable-self-preservation: false 
    wait-time-in-ms-when-sync-empty: 5

management:
  endpoints:
    web:
      exposure:
        include: "*"

# --- LOGGING PERSISTENTE ---
logging:
  file:
    name: /var/logs/${spring.application.name}.log 
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 7
  level:
    root: INFO
</file>

<file path="gateway-service/pom.xml">
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">

    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.safevision</groupId>
        <artifactId>safevision-modular</artifactId>
        <version>1.0.0</version>
        <relativePath>../pom.xml</relativePath>
    </parent>

    <artifactId>gateway-service</artifactId>
    <packaging>jar</packaging>

    <dependencies>

        <!-- CORE: Spring Cloud Gateway (Baseado em Netty/WebFlux) -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-gateway</artifactId>
        </dependency>

        <!-- SECURITY: Reactive Security (WebFlux) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

        <dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
		</dependency>

        <!-- UTILS: JJWT (Necess√°rio apenas se voc√™ estiver usando classes do JJWT manualmente
             para gerar chaves ou l√≥gica customizada. Se usar apenas o Nimbus nativo do Spring, poderia remover) -->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-api</artifactId>
            <version>0.11.5</version>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-impl</artifactId>
            <version>0.11.5</version>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-jackson</artifactId>
            <version>0.11.5</version>
            <scope>runtime</scope>
        </dependency>

        <!-- DOCS: Swagger for WebFlux (N√ÉO use a vers√£o springdoc-openapi-starter-webmvc-ui) -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webflux-ui</artifactId>
            <version>2.5.0</version>
        </dependency>

        <!-- DISCOVERY: Eureka Client -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>

        <!-- RESILIENCE: Circuit Breaker (Vers√£o Reactor) -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- METRICS: Prometheus -->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-registry-prometheus</artifactId>
            <scope>runtime</scope>
        </dependency>
        
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path="gateway-service/src/main/java/com/safevision/gatewayservice/routes/GatewayRoutes.java">
package com.safevision.gatewayservice.routes;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.gateway.route.RouteLocator;
import org.springframework.cloud.gateway.route.builder.GatewayFilterSpec;
import org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;
import org.springframework.cloud.gateway.route.builder.UriSpec;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import reactor.core.publisher.Mono;

import java.util.function.Function;

/**
 * Configuration class for API Gateway Routes.
 * <p>
 * Defines the routing logic, filters (Circuit Breaker), and fallback mechanisms
 * for all downstream microservices.
 * </p>
 */
@Slf4j
@Configuration
@RequiredArgsConstructor
public class GatewayRoutes {

    // --- CONSTANTS ---
    private static final String V3_API_DOCS = "/v3/api-docs";
    private static final String FALLBACK_URI = "forward:/fallback";
    
    // Java 21 Text Block for readable JSON
    private static final String FALLBACK_JSON = """
        {
            "error": "Service Unavailable",
            "message": "The downstream microservice is offline or taking too long to respond. Please try again later."
        }
        """;

    // --- INJECTED SERVICE URLS ---
    @Value("${safevision.services.auth}")
    private String authServiceUrl;

    @Value("${safevision.services.alert}")
    private String alertServiceUrl;

    @Value("${safevision.services.recognition}")
    private String recognitionServiceUrl;

    /**
     * Defines the route locator with specific predicates and filters.
     */
    @Bean
    public RouteLocator routes(RouteLocatorBuilder builder) {
        log.info("Configuring Gateway Routes...");

        return builder.routes()

                // ======================================
                // AUTH SERVICE
                // ======================================
                .route("auth-service", r -> r
                        .path("/auth/**")
                        .filters(this.applyCircuitBreaker("authServiceCircuitBreaker"))
                        .uri(authServiceUrl)
                )
                .route("auth-service-swagger", r -> r
                        .path("/aggregate/auth-service" + V3_API_DOCS)
                        .filters(f -> applySwaggerRewrite(f, "authServiceSwaggerCircuitBreaker"))
                        .uri(authServiceUrl)
                )

                // ======================================
                // ALERT SERVICE
                // ======================================
                .route("alert-service", r -> r
                        .path("/alert/**") // Singular path
                        .filters(this.applyCircuitBreaker("alertServiceCircuitBreaker"))
                        .uri(alertServiceUrl)
                )
                .route("alert-websocket", r -> r
                        .path("/alert/ws/**") // WebSocket Handshake
                        .filters(f -> f.rewritePath("/alert/ws/(?<segment>.*)", "/ws/${segment}"))
                        .uri(alertServiceUrl)
                )
                .route("alert-service-swagger", r -> r
                        .path("/aggregate/alert-service" + V3_API_DOCS)
                        .filters(f -> applySwaggerRewrite(f, "alertServiceSwaggerCircuitBreaker"))
                        .uri(alertServiceUrl)
                )

                // ======================================
                // RECOGNITION SERVICE
                // ======================================
                .route("recognition-service", r -> r
                        .path("/recognition/**")
                        .filters(this.applyCircuitBreaker("recognitionServiceCircuitBreaker"))
                        .uri(recognitionServiceUrl)
                )
                .route("recognition-service-swagger", r -> r
                        .path("/aggregate/recognition-service" + V3_API_DOCS)
                        .filters(f -> applySwaggerRewrite(f, "recognitionServiceSwaggerCircuitBreaker"))
                        .uri(recognitionServiceUrl)
                )

                // ======================================
                // GLOBAL FALLBACK ROUTE
                // ======================================
                .route("fallbackRoute", r -> r
                        .path("/fallback")
                        .filters(f -> f.filter((exchange, chain) -> {
                            var response = exchange.getResponse();
                            response.setStatusCode(HttpStatus.SERVICE_UNAVAILABLE);
                            response.getHeaders().setContentType(MediaType.APPLICATION_JSON);
                            
                            return response.writeWith(
                                Mono.just(response.bufferFactory().wrap(FALLBACK_JSON.getBytes()))
                            );
                        }))
                        .uri("no://op")
                )

                .build();
    }

    // --- HELPER METHODS (Clean Code / DRY) ---

    /**
     * Applies the standard Circuit Breaker filter configuration.
     *
     * @param name The name of the circuit breaker instance.
     * @return A function that applies the filter.
     */
    private Function<GatewayFilterSpec, UriSpec> applyCircuitBreaker(String name) {
        return f -> f.circuitBreaker(c -> c
                .setName(name)
                .setFallbackUri(FALLBACK_URI)
        );
    }

    /**
     * Applies both Swagger path rewriting and Circuit Breaker.
     */
    private UriSpec applySwaggerRewrite(GatewayFilterSpec f, String cbName) {
        return f.rewritePath("/aggregate/[^/]+" + V3_API_DOCS, V3_API_DOCS)
                .circuitBreaker(c -> c
                        .setName(cbName)
                        .setFallbackUri(FALLBACK_URI)
                );
    }
}
</file>

<file path="recognition-service/pom.xml">
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.safevision</groupId>
        <artifactId>safevision-modular</artifactId>
        <version>1.0.0</version>
        <relativePath>../pom.xml</relativePath>
    </parent>

    <artifactId>recognition-service</artifactId>
    <packaging>jar</packaging>

   

    <dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-amqp</artifactId>
		</dependency>
	    <!-- REST (Spring MVC) -->
	    <dependency>
	        <groupId>org.springframework.boot</groupId>
	        <artifactId>spring-boot-starter-web</artifactId>
	    </dependency>
	
	    <!-- Eureka Discovery Client -->
	    <dependency>
	        <groupId>org.springframework.cloud</groupId>
	        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
	    </dependency>
	
	  
		<dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
		</dependency>
		   
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/config/RabbitMQConfig.java">
package com.safevision.recognitionservice.config;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;
import org.springframework.amqp.support.converter.MessageConverter;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * Infrastructure configuration for RabbitMQ.
 * Responsible for declaring queues and configuring the JSON message converter.
 */
@Slf4j
@Configuration
@RequiredArgsConstructor
@EnableConfigurationProperties(RabbitQueueProperties.class) // Activates the Record
public class RabbitMQConfig {

    private final RabbitQueueProperties queueProperties;

    // -----------------------------------------------------------------------
    // STRING BEANS (For usage in @RabbitListener via SpEL)
    // -----------------------------------------------------------------------

    /**
     * Exposes the raw tracking queue name as a String Bean.
     * Bean Name: 'rawTrackingQueueName'
     */
    @Bean
    public String rawTrackingQueueName() {
        return queueProperties.rawTracking();
    }

    /**
     * Exposes the alerts queue name as a String Bean.
     * Bean Name: 'alertsQueueName'
     */
    @Bean
    public String alertsQueueName() {
        return queueProperties.alerts();
    }

    // -----------------------------------------------------------------------
    // INFRASTRUCTURE BEANS (Physical Queues)
    // -----------------------------------------------------------------------

    /**
     * Declares the Raw Tracking Queue (Input).
     */
    @Bean
    public Queue rawTrackingQueue() {
        log.info("Configuring Raw Input Queue: {}", queueProperties.rawTracking());
        return new Queue(queueProperties.rawTracking(), true);
    }

    /**
     * Declares the Alerts Queue (Output).
     */
    @Bean
    public Queue alertsQueue() {
        log.info("Configuring Alert Output Queue: {}", queueProperties.alerts());
        return new Queue(queueProperties.alerts(), true);
    }

    /**
     * Configures the Jackson converter to serialize/deserialize messages as JSON.
     */
    @Bean
    public MessageConverter jsonMessageConverter() {
        return new Jackson2JsonMessageConverter();
    }
}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/config/RabbitQueueProperties.java">
package com.safevision.recognitionservice.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Type-safe configuration properties for RabbitMQ queues.
 * Maps properties starting with "rabbitmq.queues" from application.yml.
 * <p>
 * Utilizes Java 21 Records for immutability and concise syntax.
 * </p>
 *
 * @param rawTracking The name of the input queue (from Vision Agent).
 * @param alerts      The name of the output queue (to Alert Service).
 */
@ConfigurationProperties(prefix = "spring.rabbitmq.queues")
public record RabbitQueueProperties(String rawTracking, String alerts) {}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/config/SecurityConfig.java">
package com.safevision.recognitionservice.config;

import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;
import org.springframework.security.web.SecurityFilterChain;

/**
 * Security configuration class for the Recognition Service.
 * Configures JWT validation, CORS, and endpoint protection.
 */
@Slf4j
@Configuration
@EnableWebSecurity
@EnableMethodSecurity // Enables @PreAuthorize support
@RequiredArgsConstructor
@EnableConfigurationProperties(JwtProperties.class) // Enables the record
public class SecurityConfig {

    private final JwtProperties jwtProperties;

    // List of endpoints that do not require authentication
    private static final String[] PUBLIC_ENDPOINTS = {
        "/v3/api-docs/**",
        "/swagger-ui/**",
        "/swagger-ui.html"
    };

    /**
     * Configures the HTTP security filter chain.
     */
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        log.info("Initializing Security Filter Chain for Recognition Service...");

        http
            // Disable CSRF as we use stateless JWTs
            .csrf(AbstractHttpConfigurer::disable)
            
            .authorizeHttpRequests(auth -> auth
                // 1. Allow public endpoints (Swagger)
                .requestMatchers(PUBLIC_ENDPOINTS).permitAll()
                
                // 2. Block everything else.
                // This ensures internal calls (e.g., /recognition/simulate) must carry a valid JWT.
                .anyRequest().authenticated()
            )
            
            // Ensure stateless session management (no JSESSIONID)
            .sessionManagement(sess -> sess.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            
            // Configure Resource Server to accept JWTs
            .oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()));

        return http.build();
    }

    /**
     * Configures the JWT Decoder using the shared secret key.
     */
    @Bean
    public JwtDecoder jwtDecoder() {
        // Uses the secret from the type-safe record
        byte[] keyBytes = jwtProperties.secret().getBytes();
        SecretKey originalKey = new SecretKeySpec(keyBytes, 0, keyBytes.length, "HmacSHA256");
        
        return NimbusJwtDecoder.withSecretKey(originalKey).build();
    }
}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/controller/RecognitionController.java">
package com.safevision.recognitionservice.controller;

import com.safevision.recognitionservice.dto.AlertEventDTO;
import com.safevision.recognitionservice.producer.AlertProducer;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * REST Controller for external interaction with the Recognition Service.
 * <p>
 * Primarily used for health checks, configuration, and manual simulation
 * of the alert pipeline without requiring a physical camera or Python Agent.
 * </p>
 */
@Slf4j
@RestController
@RequestMapping("/recognition")
@RequiredArgsConstructor
public class RecognitionController {

    private final AlertProducer alertProducer;

    /**
     * Manually triggers a detection event and sends it directly to the Alert Service queue.
     * <p>
     * This endpoint is useful for integration testing (RabbitMQ -> Alert Service -> Frontend)
     * independently of the Edge/Python layer.
     * </p>
     *
     * @return Confirmation message.
     */
    @PostMapping("/simulate")
    public ResponseEntity<String> simulateDetection() {
        log.info("üîÑ Manual simulation triggered via HTTP endpoint.");

        // 1. Create a CRITICAL test DTO
        // Adjusted constructor to match the new DTO signature with GPS fields.
        var testAlert = new AlertEventDTO(
            "superadmin",       // userId
            "MANUAL_TRIGGER",   // alertType
            "Manual API test triggered via HTTP endpoint.", // description
            "CRITICAL",         // severity
            "CAM-TEST-00",      // cameraId
            null,               // snapshotUrl (no image for manual test)
            null,               // latitude (no GPS for manual test)
            null,               // longitude
            null                // address
        );

        // 2. Dispatch to RabbitMQ
        alertProducer.sendAlert(testAlert);

        log.info("‚úÖ Simulation sent to queue successfully.");
        return ResponseEntity.ok("Manual simulation successfully sent to Alert queue.");
    }
}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/dto/RawTrackingEvent.java">
package com.safevision.recognitionservice.dto;

import java.math.BigDecimal;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

/**
 * Data Transfer Object (DTO) representing the raw telemetry received from the Vision Agent.
 * <p>
 * This Java Record serves as an immutable carrier for the data coming from RabbitMQ.
 * It includes behavioral analysis, threat detection, and geolocation metadata.
 * </p>
 *
 * @param detectionId    Unique UUID for the detection session.
 * @param timestamp      Unix timestamp of capture.
 * @param cameraId       Identifier of the recording device.
 * @param userId         The user associated with the device.
 * @param isFacingCamera Behavioral flag: is the subject looking at the lens?
 * @param gazeDirection  Estimated direction of gaze.
 * @param depthPosition  Proximity score.
 * @param hasWeapon      Threat flag: was a weapon detected?
 * @param weaponType     Classification of the weapon (e.g., KNIFE).
 * @param weaponLocation Relative location of the weapon (e.g., HAND).
 * @param snapshotUrl    MinIO URL for the evidence image.
 * @param latitude       GPS Latitude (nullable if no signal).
 * @param longitude      GPS Longitude (nullable if no signal).
 */
@JsonIgnoreProperties(ignoreUnknown = true)
public record RawTrackingEvent(
    String detectionId,
    long timestamp,
    String cameraId,
    String userId,
    boolean isFacingCamera,
    String gazeDirection,
    int depthPosition,
    boolean hasWeapon,
    String weaponType,
    String weaponLocation,
    String snapshotUrl,
    BigDecimal latitude,
    BigDecimal longitude
) {
    /**
     * Validation constructor.
     * Ensures critical identity fields are present.
     */
    public RawTrackingEvent {
        if (detectionId == null || detectionId.isBlank()) {
            throw new IllegalArgumentException("Detection ID cannot be null");
        }
        if (userId == null || userId.isBlank()) {
            throw new IllegalArgumentException("User ID cannot be null");
        }
    }
}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/facade/TrackingWorkflowFacade.java">
package com.safevision.recognitionservice.facade;

import com.safevision.recognitionservice.dto.RawTrackingEvent;
import com.safevision.recognitionservice.service.MovementHistoryService;
import com.safevision.recognitionservice.service.ThreatAnalysisService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

/**
 * Facade Pattern: Orchestrates the threat detection pipeline.
 * <p>
 * This class decouples the message listener (Infrastructure Layer) from the
 * business logic (Domain Layer). It ensures that raw events go through the
 * correct sequence of processing steps: History Recording -> Threat Analysis.
 * </p>
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class TrackingWorkflowFacade {

    private final ThreatAnalysisService threatAnalysisService;
    private final MovementHistoryService movementHistoryService;

    /**
     * Orchestrates the processing of a single raw tracking event.
     *
     * @param event The raw telemetry data received from the Vision Agent.
     */
    public void processEvent(RawTrackingEvent event) {
        if (event == null) {
            log.warn("‚ö†Ô∏è Received null event in workflow. Skipping.");
            return;
        }

        log.debug("üîÑ Starting workflow for Detection ID: {}", event.toString());

        // Step 1: Record state history (Required for time-based rules like Loitering)
        movementHistoryService.recordEvent(event);

        // Step 2: Execute the Threat Analysis Engine (The "Brain")
        // This checks all rules (Weapon, Stare, Loitering) and triggers alerts if necessary.
        threatAnalysisService.analyze(event);
        
        log.trace("‚úÖ Workflow completed for Detection ID: {}", event.detectionId());
    }
}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/listener/VisionAgentListener.java">
package com.safevision.recognitionservice.listener;

import com.safevision.recognitionservice.dto.RawTrackingEvent;
import com.safevision.recognitionservice.facade.TrackingWorkflowFacade;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

/**
 * Infrastructure Layer: RabbitMQ Message Listener.
 * <p>
 * This component acts as the entry point for the Recognition Service.
 * It consumes high-frequency raw data from the Vision Agent and delegates
 * the processing to the Business Facade.
 * </p>
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class VisionAgentListener {

    // Injection of the Facade, adhering to the Facade Pattern to decouple
    // infrastructure logic (RabbitMQ) from domain logic (Threat Analysis).
    private final TrackingWorkflowFacade trackingWorkflow;

    /**
     * Consumes raw tracking events from the Python Agent.
     * <p>
     * Uses SpEL (Spring Expression Language) to resolve the queue name dynamically
     * from the Bean 'rawTrackingQueueName' defined in RabbitMQConfig.
     * </p>
     *
     * @param event DTO containing raw tracking data (gaze, position, objects).
     */
    @RabbitListener(queues = "#{rawTrackingQueueName}")
    public void handleRawTrackingEvent(RawTrackingEvent event) {
        
        try {
            if (event == null) {
                log.warn("‚ö†Ô∏è Received null event from RabbitMQ. Skipping.");
                return;
            }

            // Use 'debug' for high-frequency events to avoid log flooding in production
            log.debug("ü§ñ [Recognition] Received raw event ID: {}", event.detectionId());
            
            // Delegate to the Facade (Business Logic)
            trackingWorkflow.processEvent(event);
            
        } catch (Exception e) {
            // Error Handling Pattern: Log and suppress.
            // We catch generic exceptions here to prevent the RabbitMQ listener container
            // from entering an infinite retry loop for "poison pill" messages.
            var eventId = (event != null) ? event.detectionId() : "unknown";
            log.error("‚ùå Error processing tracking event {}: {}", eventId, e.getMessage(), e);
        }
    }
}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/producer/AlertProducer.java">
package com.safevision.recognitionservice.producer;

import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.stereotype.Service;

import com.safevision.recognitionservice.dto.AlertEventDTO;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * Producer class responsible for sending final, filtered alerts to the RabbitMQ output queue.
 * <p>
 * Adheres to the Single Responsibility Principle (SRP) by focusing only on the
 * communication layer with the Message Broker.
 * </p>
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class AlertProducer {

    private final RabbitTemplate rabbitTemplate;
    private final String alertsQueueName;

   
    /**
     * Sends the final filtered alert DTO to the output queue.
     *
     * @param finalAlert The DTO containing the threat details and evidence URL.
     */
    public void sendAlert(AlertEventDTO finalAlert) {
        log.debug("Attempting to send alert to queue: {}", alertsQueueName);

        try {
            rabbitTemplate.convertAndSend(alertsQueueName, finalAlert);
            log.info("‚úÖ [AlertProducer] Critical Alert dispatched to RabbitMQ successfully.");

        } catch (Exception e) {
            log.error("‚ùå Error publishing alert to RabbitMQ: {}", e.getMessage(), e);
        }
    }
}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/service/MovementHistoryService.java">
package com.safevision.recognitionservice.service;

import com.safevision.recognitionservice.dto.RawTrackingEvent;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Service responsible for managing the recent historical state (tracking data)
 * for each detected object in memory.
 * <p>
 * This acts as an in-memory 'Repository' or 'Cache' for time-series analysis
 * required by the ThreatAnalysisService. It stores a sliding window of depth/position data.
 * </p>
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class MovementHistoryService {

    // Thread-safe map to store history per detectionId
    private final Map<String, LinkedList<Integer>> historyMap = new ConcurrentHashMap<>();
    
    // Window size: Analyze the last 10 events (~1.5 to 2 seconds of video)
    private static final int HISTORY_WINDOW_SIZE = 10;

    /**
     * Records the new depth measurement for the tracked object.
     * Maintains a fixed-size sliding window by evicting old data.
     *
     * @param event The raw tracking data event.
     */
    public void recordEvent(RawTrackingEvent event) {
        var id = event.detectionId();
        
        // Get or create the history list for this object
        var history = historyMap.computeIfAbsent(id, k -> new LinkedList<>());
        
        // Add new data point to the head (LIFO access for recent checks)
        history.addFirst(event.depthPosition());
        
        // Maintain window size
        while (history.size() > HISTORY_WINDOW_SIZE) {
            history.removeLast();
        }
    }

    /**
     * Retrieves the list of recent depth measurements for the tracked object.
     * Returns an empty list if no history is found (Null Object Pattern).
     *
     * @param detectionId The ID of the tracked object.
     * @return A list of the last N depth values.
     */
    public List<Integer> getDepths(String detectionId) {
        return historyMap.getOrDefault(detectionId, new LinkedList<>());
    }
    
    /**
     * Clears the tracking history for a specific object.
     * Typically called after a CRITICAL alert is fired to reset the analysis state.
     *
     * @param detectionId The ID of the object whose history must be cleared.
     */
    public void clearHistory(String detectionId) {
        if (historyMap.containsKey(detectionId)) {
            log.debug("Clearing tracking history for ID: {}", detectionId);
            historyMap.remove(detectionId);
        }
    }
}
</file>

<file path="safevision-ui/angular.json">
{
  "$schema": "./node_modules/@angular/cli/lib/config/schema.json",
  "version": 1,
  "cli": {
    "packageManager": "npm"
  },
  "newProjectRoot": "projects",
  "projects": {
    "safevision-ui": {
      "projectType": "application",
      "schematics": {
        "@schematics/angular:component": {
          "style": "scss"
        }
      },
      "root": "",
      "sourceRoot": "src",
      "prefix": "app",
      "architect": {
        "build": {
          "builder": "@angular/build:application",
          "options": {
            "browser": "src/main.ts",
            "tsConfig": "tsconfig.app.json",
            "inlineStyleLanguage": "scss",
            "assets": [
              {
                "glob": "**/*",
                "input": "public",
                "src/assets"
              }
            ],
            "styles": [
              "src/styles.scss",
			  "node_modules/leaflet/dist/leaflet.css"
            ],
            "server": "src/main.server.ts",
            "outputMode": "server",
            "ssr": {
              "entry": "src/server.ts"
            }
          },
          "configurations": {
            "production": {
              "budgets": [
                {
                  "type": "initial",
                  "maximumWarning": "500kB",
                  "maximumError": "1MB"
                },
                {
                  "type": "anyComponentStyle",
                  "maximumWarning": "4kB",
                  "maximumError": "8kB"
                }
              ],
              "outputHashing": "all"
            },
            "development": {
              "optimization": false,
              "extractLicenses": false,
              "sourceMap": true
            }
          },
          "defaultConfiguration": "production"
        },
        "serve": {
          "builder": "@angular/build:dev-server",
          "configurations": {
            "production": {
              "buildTarget": "safevision-ui:build:production"
            },
            "development": {
              "buildTarget": "safevision-ui:build:development"
            }
          },
          "defaultConfiguration": "development"
        },
        "test": {
          "builder": "@angular/build:unit-test"
        }
      }
    }
  }
}
</file>

<file path="safevision-ui/package.json">
{
  "name": "safevision-ui",
  "version": "0.0.0",
  "scripts": {
    "ng": "ng",
    "start": "ng serve",
    "build": "ng build",
    "watch": "ng build --watch --configuration development",
    "test": "ng test",
    "serve:ssr:safevision-ui": "node dist/safevision-ui/server/server.mjs"
  },
  "prettier": {
    "printWidth": 100,
    "singleQuote": true,
    "overrides": [
      {
        "files": "*.html",
        "options": {
          "parser": "angular"
        }
      }
    ]
  },
  "private": true,
  "packageManager": "npm@10.9.0",
  "dependencies": {
    "@angular/cdk": "^21.0.2",
    "@angular/common": "^21.0.0",
    "@angular/compiler": "^21.0.0",
    "@angular/core": "^21.0.0",
    "@angular/forms": "^21.0.0",
    "@angular/material": "^21.0.2",
    "@angular/platform-browser": "^21.0.0",
    "@angular/platform-server": "^21.0.0",
    "@angular/router": "^21.0.0",
    "@angular/ssr": "^21.0.1",
    "@stomp/rx-stomp": "^2.3.0",
    "express": "^5.1.0",
    "jwt-decode": "^4.0.0",
    "leaflet": "^1.9.4",
    "ngx-mask": "^20.0.3",
    "rxjs": "~7.8.0",
    "tslib": "^2.3.0"
  },
  "devDependencies": {
    "@angular/build": "^21.0.1",
    "@angular/cli": "^21.0.1",
    "@angular/compiler-cli": "^21.0.0",
    "@types/express": "^5.0.1",
    "@types/leaflet": "^1.9.21",
    "@types/node": "^20.17.19",
    "jsdom": "^27.1.0",
    "typescript": "~5.9.2",
    "vitest": "^4.0.8"
  }
}
</file>

<file path="safevision-ui/src/app/app.config.ts">
import { ApplicationConfig, ErrorHandler } from '@angular/core';
import { provideRouter } from '@angular/router';
import { routes } from './app.routes';
import { provideHttpClient, withInterceptors, withFetch } from '@angular/common/http';
import { authInterceptor } from './core/interceptors/auth-interceptor';
import { errorInterceptor } from './core/interceptors/error.interceptor';
import { GlobalErrorHandler } from './core/interceptors/global-error.interceptor';
import { provideEnvironmentNgxMask } from 'ngx-mask';
export const appConfig: ApplicationConfig = {
  providers: [
    // üî• IMPORTANTE: sem isso, nenhuma rota funciona!
    provideRouter(routes),

    // Interceptores HTTP
    provideHttpClient(withInterceptors([authInterceptor, errorInterceptor]), withFetch()),
    provideEnvironmentNgxMask(),
    // Handler global de erros
    { provide: ErrorHandler, useClass: GlobalErrorHandler }
  ]
};
</file>

<file path="safevision-ui/src/app/app.html">
<router-outlet></router-outlet>
</file>

<file path="safevision-ui/src/app/core/interceptors/auth-interceptor.ts">
import { HttpInterceptorFn } from '@angular/common/http';
import { inject, PLATFORM_ID } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import { Router } from '@angular/router';
import { catchError, throwError } from 'rxjs';

export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const router = inject(Router);
  const platformId = inject(PLATFORM_ID);

  // 1. DEFINI√á√ÉO DE ROTAS P√öBLICAS (Otimiza√ß√£o de Performance)
  // Nessas rotas, N√ÉO enviamos o token para evitar que o Backend
  // gaste CPU (BCrypt/JWT) tentando validar um token desnecess√°rio.
  const skipTokenUrls = [
    '/auth/login',
    '/auth/register'
    // OBS: '/auth/camera-url' N√ÉO est√° aqui, pois ele PRECISA de token.
  ];

  // Verifica se a URL atual faz parte da lista de exce√ß√£o
  const shouldSkipToken = skipTokenUrls.some(url => req.url.includes(url));

  let token = null;

  // S√≥ tenta ler do localStorage se for navegador (SSR Safety)
  if (isPlatformBrowser(platformId)) {
    token = localStorage.getItem('safevision_token');
  }

  let authReq = req;

  // 2. L√ìGICA DE INJE√á√ÉO DO TOKEN AJUSTADA
  // S√≥ adiciona o header se:
  // a) O token existe
  // b) E a rota N√ÉO for p√∫blica (shouldSkipToken == false)
  if (token && !shouldSkipToken) {
    authReq = req.clone({
      setHeaders: { Authorization: `Bearer ${token}` }
    });
  }

  return next(authReq).pipe(
    catchError(error => {
      if (error.status === 401) {
        // S√≥ tenta limpar storage se for navegador
        if (isPlatformBrowser(platformId)) {
            localStorage.removeItem('safevision_token');
        }
        router.navigate(['/login']);
      }
      return throwError(() => error);
    })
  );
};
</file>

<file path="safevision-ui/src/app/core/interceptors/error.interceptor.ts">
import { HttpErrorResponse, HttpInterceptorFn } from '@angular/common/http';
import { inject } from '@angular/core';
import { catchError, throwError } from 'rxjs';
// Importa o SnackBar do Material diretamente
import { MatSnackBar } from '@angular/material/snack-bar';

export const errorInterceptor: HttpInterceptorFn = (req, next) => {
  // Injeta o componente de notifica√ß√£o do Material
  const snackBar = inject(MatSnackBar);

  return next(req).pipe(
    catchError((error: HttpErrorResponse) => {
      let errorMessage = 'Ocorreu um erro desconhecido.';

      // L√≥gica de identifica√ß√£o do erro
	  if (typeof ErrorEvent !== 'undefined' && error.error instanceof ErrorEvent) {
          
          errorMessage = `Erro: ${error.error.message}`;
      } else {
        // Erro do lado do servidor
        switch (error.status) {
          case 0:
            errorMessage = 'Servidor indispon√≠vel. Verifique sua conex√£o.';
            break;
          case 400:
            errorMessage = error.error?.error || 'Dados inv√°lidos.';
            break;
          case 401:
            errorMessage = 'Sess√£o expirada. Fa√ßa login novamente.';
            break;
          case 403:
            errorMessage = 'Acesso negado.';
            break;
          case 404:
            errorMessage = 'Recurso n√£o encontrado.';
            break;
          case 500:
            errorMessage = 'Erro interno no servidor.';
            break;
          default:
            errorMessage = `Erro (${error.status}): ${error.statusText}`;
        }
      }

      // Exibe o SnackBar se n√£o for um erro de sess√£o (o AuthInterceptor j√° trata redirects)
      if (error.status !== 401) {
        snackBar.open(errorMessage, 'FECHAR', {
          duration: 5000,
          horizontalPosition: 'right',
          verticalPosition: 'top',
          panelClass: ['snackbar-error'] // Usa a classe vermelha definida no styles.scss
        });
      }

      return throwError(() => error);
    })
  );
};
</file>

<file path="safevision-ui/src/app/core/interceptors/global-error.interceptor.ts">
import { ErrorHandler, Injectable, NgZone, inject } from '@angular/core';
// Importa diretamente o SnackBar do Material
import { MatSnackBar } from '@angular/material/snack-bar';

@Injectable()
export class GlobalErrorHandler implements ErrorHandler {
  // Inje√ß√£o direta do componente visual
  private snackBar = inject(MatSnackBar);
  private zone = inject(NgZone);

  handleError(error: any): void {
    // 1. Loga o erro real no console para o programador
    console.error('üî• CRITICAL APP ERROR:', error);

    // 2. Tenta extrair uma mensagem leg√≠vel, se existir
    const message = error?.message || 'Ocorreu um erro inesperado.';

    // 3. Executa a abertura do SnackBar dentro da NgZone
    // Isso garante que a UI atualize mesmo se o erro vier de um evento ass√≠ncrono externo
    this.zone.run(() => {
      this.snackBar.open(
        `Erro de Aplica√ß√£o: ${message}`, // Mensagem para o utilizador
        'FECHAR',
        {
          duration: 5000,
          horizontalPosition: 'right',
          verticalPosition: 'top',
          panelClass: ['snackbar-error'] // Usa a mesma classe vermelha do styles.scss
        }
      );
    });

    // TODO: Integra√ß√£o com Sentry/LogRocket seria feita aqui
  }
}
</file>

<file path="safevision-ui/src/app/core/models/app.models.ts">
// --- MODELOS DE USU√ÅRIO ---


export enum AlertType {
  TELEGRAM = 'TELEGRAM',
  EMAIL = 'EMAIL',
  SMS = 'SMS'
}
export interface User {
  id: string;
  username: string;
  email?: string;
  phoneNumber?: string;
  cameraConnectionUrl?: string;
  roles: string[];
}



export interface LoginRequest {
  username: string;
  password: string;
}

export interface RegisterRequest {
  username: string;
  password: string;
  email: string;
  phoneNumber: string;
  cameraUrl: string;
  roles: string[];
  alertTypes: AlertType[];
}

export interface UserUpdateRequest {
  email?: string;
  phoneNumber?: string;
  cameraConnectionUrl?: string;
  password?: string;
  alertPreferences?: AlertType[]; // üìç NOVO
}

// --- MODELOS DE RESPOSTA (RESPONSES) ---

export interface AuthResponse {
  token: string;
}

export interface UserResponse {
  id: string;
  username: string;
  roles: string[];
}



export interface Alert {
  id: string;
  alertType: string;
  description: string;
  severity: 'INFO' | 'WARNING' | 'CRITICAL';
  cameraId: string;
  acknowledged: boolean;
  createdAt: string; // ISO Date String
  snapshotUrl?: string; // Opcional: nem todo alerta tem foto

  // üìç NOVOS CAMPOS DE GEOLOCALIZA√á√ÉO
  // Devem ser opcionais (?) pois alertas antigos ou c√¢meras sem GPS vir√£o nulos
  latitude?: number;
  longitude?: number;
  address?: string; // Endere√ßo leg√≠vel (Ex: "Rua X, Centro")
}

export interface UserProfileDTO {
  id: string;
  username: string;
  email: string;
  phoneNumber: string;
  cameraConnectionUrl: string;
  alertPreferences: AlertType[];
}

export interface Page<T> {
  content: T[];
  page: {          // üëà Agora os metadados ficam aqui dentro
    totalElements: number;
    totalPages: number;
    size: number;
    number: number;
  };
}
</file>

<file path="safevision-ui/src/app/core/services/alert.service.ts">
import { Injectable, inject } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';
import {  Alert,Page } from '../models/app.models'; // Importe Alert se ainda usar no dashboard
import { environment } from '../../../environments/environment';

@Injectable({ providedIn: 'root' })
export class AlertService {
  private http = inject(HttpClient);
  private readonly API_URL = `${environment.apiUrl}/alert`; // Base: /alert

  /**
   * Busca hist√≥rico paginado e ordenado usando o ID do usu√°rio.
   * URL gerada: /alert/{userId}/history?page=0&size=10&sort=createdAt,desc
   */
  getAlertHistory(
    userId: string,
    page: number,
    size: number,
    activeSort: string = 'createdAt',
    direction: string = 'desc'
  ): Observable<Page<Alert>> {

    let params = new HttpParams()
      .set('page', page.toString())
      .set('size', size.toString())
      .set('sort', `${activeSort},${direction}`);
    console.log(`Fetching alert history for user ${userId} with params:`, params);
    return this.http.get<Page<Alert>>(`${this.API_URL}/history/${userId}`, { params });
  }

  // --- M√©todos Legados (Dashboard) ---

  getRecentAlerts(username: string): Observable<Alert[]> {
    return this.http.get<Alert[]>(`${this.API_URL}/user/${username}`);
  }

  acknowledge(id: string): Observable<void> {
    return this.http.patch<void>(`${this.API_URL}/${id}/ack`, {});
  }
}
</file>

<file path="safevision-ui/src/app/core/services/auth.service.ts">
import { Injectable, inject, signal, computed, PLATFORM_ID } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Router } from '@angular/router';
import { Observable, tap } from 'rxjs';
import { jwtDecode } from 'jwt-decode';
import { isPlatformBrowser } from '@angular/common'; // <--- Importante
import { AlertType, AuthResponse, LoginRequest, RegisterRequest, User, UserProfileDTO, UserUpdateRequest } from '../models/app.models';
import { environment } from '../../../environments/environment';
@Injectable({ providedIn: 'root' })
export class AuthService {
  private http = inject(HttpClient);
  private router = inject(Router);
  private platformId = inject(PLATFORM_ID); // <--- Identifica se √© Navegador ou Servidor

  private readonly API_URL = `${environment.apiUrl}/auth`;
  private readonly TOKEN_KEY = 'safevision_token';

  private userSignal = signal<User | null>(null);

  public currentUser = this.userSignal.asReadonly();
  public isLoggedIn = computed(() => !!this.userSignal());

  constructor() {
    // CORRE√á√ÉO: S√≥ carrega do storage se estiver no navegador
    if (isPlatformBrowser(this.platformId)) {
      console.log('üîë [AuthService] API configurada para:', this.API_URL);
      this.loadUserFromStorage();
    }
  }

  login(credentials: LoginRequest) {
    return this.http
      .post<AuthResponse>(`${this.API_URL}/login`, credentials)
      .pipe(tap((res) => this.saveSession(res.token)));
  }

  register(data: RegisterRequest) {
    return this.http.post(`${this.API_URL}/register`, data);
  }

  updateUser(data: UserUpdateRequest) {
    return this.http.put<User>(`${this.API_URL}/update`, data).pipe(
      tap((updatedUser) => {
        this.userSignal.update((current) => (current ? { ...current, ...updatedUser } : null));
      })
    );
  }

  logout() {
    // Prote√ß√£o no Logout
    if (isPlatformBrowser(this.platformId)) {
      localStorage.removeItem(this.TOKEN_KEY);
    }
    this.userSignal.set(null);
    this.router.navigate(['/login']);
  }

  // M√©todo p√∫blico seguro para pegar o token
  getToken(): string | null {
    if (isPlatformBrowser(this.platformId)) {
      return localStorage.getItem(this.TOKEN_KEY);
    }
    return null;
  }

  private saveSession(token: string) {
    // Prote√ß√£o ao Salvar
    if (isPlatformBrowser(this.platformId)) {
      localStorage.setItem(this.TOKEN_KEY, token);
    }
    this.decodeToken(token);
  }

  private loadUserFromStorage() {
    // Reutiliza o m√©todo getToken que j√° √© protegido
    const token = this.getToken();
    if (token) this.decodeToken(token);
  }

  private decodeToken(token: string) {
    try {
      const decoded: any = jwtDecode(token);
      this.userSignal.set({
        id: decoded.id,
        username: decoded.sub,
        roles: decoded.roles,
      } as User);
    } catch {
      this.logout();
    }
  }

  getAlertPreferences(username: string): Observable<AlertType[]> {
      return this.http.get<AlertType[]>(`${this.API_URL}/alert-preferences/${username}`);
  }


  getUserContact(username: string): Observable<any> {
    return this.http.get<any>(`${this.API_URL}/contact/${username}`);
  }

  getUserProfile(username: string): Observable<UserProfileDTO> {
      return this.http.get<UserProfileDTO>(`${this.API_URL}/profile/${username}`);
  }
}
</file>

<file path="safevision-ui/src/app/core/services/vision.service.ts">
import { Injectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../../environments/environment';

@Injectable({ providedIn: 'root' })
export class VisionService {
  private http = inject(HttpClient);

  private readonly AGENT_BASE = `${environment.visionAgentUrl}`;



  startDetection(userId: string, cameraUrl: string): Observable<any> {
     console.log(`üîå Ativando prote√ß√£o para: ${userId}`);
    return this.http.post(`${this.AGENT_BASE}/toggle/on`, { userId, cameraUrl });
  }

  // ‚ö†Ô∏è CORRE√á√ÉO AQUI: Agora precisamos passar o userId tamb√©m
  stopDetection(userId: string | undefined): Observable<any> {
    console.log(`üí§ Desativando prote√ß√£o para: ${userId}`);

    return this.http.post(`${this.AGENT_BASE}/toggle/off`, { userId });
  }
}
</file>

<file path="safevision-ui/src/app/core/services/websocket.service.ts">
import { Injectable, inject, PLATFORM_ID, OnDestroy } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import { RxStomp } from '@stomp/rx-stomp';
import { AuthService } from './auth.service';
import { Observable, Subject } from 'rxjs';
import { map } from 'rxjs/operators'; // <--- IMPORTANTE: Faltava isso
import { IMessage } from '@stomp/stompjs'; // <--- IMPORTANTE: Para tipar a mensagem
import { Alert } from '../models/app.models';
import { environment } from '../../../environments/environment';

@Injectable()
export class WebSocketService implements OnDestroy {

  private rxStomp = new RxStomp();
  private platformId = inject(PLATFORM_ID);
  private authService = inject(AuthService);

  private alertSubject = new Subject<Alert>();
  private isConnected = false;

  constructor() {
    // Evita erro no SSR (Server Side Rendering)
    if (!isPlatformBrowser(this.platformId)) return;

    this.configure();

    // üî• S√≥ depois de conectar vamos registrar o watch
    this.rxStomp.connected$.subscribe(() => {
      console.log('üü¢ [WebSocket] Conectado com sucesso.');
      this.isConnected = true;
      this.subscribeToAlerts();
    });

    this.rxStomp.activate();
  }

  private configure() {
    const token = this.authService.getToken();

    // Transforma http -> ws e https -> wss
    const wsUrl = environment.apiUrl.replace(/^http/, 'ws') + '/alert/ws/websocket';

    console.log(`üîå [WebSocket] Tentando conectar em: ${wsUrl}`);

    this.rxStomp.configure({
      brokerURL: wsUrl,
      connectHeaders: {
        Authorization: token ? `Bearer ${token}` : ''
      },
      // Debug: mostre o log para facilitar a detec√ß√£o de erros
      debug: (msg: string) => console.debug(new Date(), msg),
      reconnectDelay: 5000,
      heartbeatIncoming: 0,
      heartbeatOutgoing: 20000,
    });
  }

  private subscribeToAlerts() {
    const username = this.authService.currentUser()?.username;

    if (!username) {
      console.warn('‚ö†Ô∏è [WebSocket] Usu√°rio n√£o identificado. N√£o foi poss√≠vel inscrever no t√≥pico.');
      return;
    }

    const topic = `/topic/alert/${username}`;
    console.log(`üì° [WebSocket] Inscrevendo no t√≥pico: ${topic}`);

    this.rxStomp.watch(topic).subscribe({
      next: (msg: IMessage) => { // <--- Tipagem aqui tamb√©m √© boa pr√°tica
        try {
          const alert = JSON.parse(msg.body) as Alert;
          console.log('üö® [WebSocket] ALERTA RECEBIDO:', alert);
          this.alertSubject.next(alert);
        } catch (e) {
          console.error('‚ùå [WebSocket] Erro ao processar mensagem JSON:', e);
        }
      },
      error: (err) => console.error('‚ùå [WebSocket] Erro na subscri√ß√£o:', err)
    });
  }

  // --- AQUI ESTAVA O ERRO ---
  watchAlerts(topicUrl: string): Observable<Alert> {
      const destination = topicUrl || '/topic/alert';

      return this.rxStomp.watch(destination).pipe(
        // Adicionamos a tipagem ': IMessage' aqui
        map((message: IMessage) => JSON.parse(message.body) as Alert)
      );
  }

  ngOnDestroy() {
    console.log('üîå [WebSocket] Encerrando conex√£o e limpando recursos.');
    this.rxStomp.deactivate(); // Fecha a conex√£o TCP/WS
  }
}
</file>

<file path="safevision-ui/src/app/features/auth/login/login.component.html">
<div class="login-wrapper">
  <mat-card class="login-card">

    <mat-card-header>
      <mat-card-title>üîê SafeVision</mat-card-title>
      <mat-card-subtitle><br/>Entre para monitorar</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="loginForm" (ngSubmit)="onSubmit()">

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Usu√°rio</mat-label>
          <input matInput formControlName="username" placeholder="Ex: admin">

          <mat-icon matSuffix>person</mat-icon>

          @if (loginForm.get('username')?.hasError('required')) {
            <mat-error>Usu√°rio √© obrigat√≥rio</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Senha</mat-label>

          <input
            matInput
            [type]="hidePassword() ? 'password' : 'text'"
            formControlName="password"
            placeholder="Digite sua senha"
          >


         <button
            mat-icon-button
            matSuffix
            (click)="togglePassword($event)"
            type="button"
            [attr.aria-label]="hidePassword() ? 'Mostrar senha' : 'Ocultar senha'"
          >
            <mat-icon>{{ hidePassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>

          @if (loginForm.get('password')?.hasError('required')) {
            <mat-error>Senha √© obrigat√≥ria</mat-error>
          }
        </mat-form-field>

        <div class="actions">
          <button
            mat-flat-button
            color="primary"
            type="submit"
            [disabled]="loginForm.invalid || isLoading()"
            class="submit-btn"
          >
            @if (isLoading()) {
              <mat-spinner diameter="20" color="accent"></mat-spinner>
            } @else {
              <span>Entrar</span>
            }
          </button>
        </div>

      </form>
    </mat-card-content>

    <mat-card-footer>
      <p>N√£o tem conta? <a mat-button color="accent" routerLink="/register">Registre-se</a></p>
    </mat-card-footer>

  </mat-card>
</div>
</file>

<file path="safevision-ui/src/app/features/auth/login/login.component.scss">
/* ============================================================
   SAFE VISION - Login Screen (Premium Edition)
   Estilo moderno com Glassmorphism + anima√ß√µes suaves
   ============================================================ */
@use "sass:color";

.login-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  position: relative; // <-- ESSENCIAL
  z-index: 2;

}

/* ============================================================
   GLASS CARD
   ============================================================ */

.login-card {
  position: relative;
  z-index: 2;

  width: 100%;
  max-width: 420px;
  padding: 35px;
  border-radius: 20px;

  /* Glassmorphism */
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(15px);

  /* Borda de vidro */
  border: 1px solid rgba(255, 255, 255, 0.25);

  /* Sombra suave */
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.55);

  animation: fadeInUp 0.7s ease forwards;
  transform: translateY(20px);
  opacity: 0;

}

/* Login Card Animation */
@keyframes fadeInUp {
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* ============================================================
   TITLES
   ============================================================ */

mat-card-header {
  justify-content: center;
  text-align: center;
  margin-bottom: 2rem;

  mat-card-title {
    font-size: 2.3rem;
    font-weight: 800;
    color: #fff;
    letter-spacing: -0.5px;
    text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
  }

  mat-card-subtitle {
    color: #eee;
    font-weight: 500;
    font-size: 1.1rem;
  }
}

/* ============================================================
   INPUTS
   ============================================================ */

.full-width {
  width: 100%;
  margin-bottom: 18px;
}

.mat-mdc-form-field {
  --mdc-filled-text-field-container-color: rgba(255, 255, 255, 0.12) !important;
  --mdc-filled-text-field-input-text-color: #fff !important;
  --mdc-filled-text-field-label-text-color: #ccc !important;
  --mdc-filled-text-field-focus-label-text-color: #fff !important;
  --mdc-filled-text-field-active-indicator-color: #d63384 !important;
  --mdc-filled-text-field-hover-label-text-color: #fff !important;

  .mat-mdc-form-field-icon-prefix,
  .mat-mdc-form-field-icon-suffix {
    color: #fff !important;
  }
}

/* ============================================================
   BUTTON LOGIN (modernizado)
   ============================================================ */

.actions button {
  width: 100%;
  margin-top: 15px;

  height: 50px;
  font-size: 1.2rem;
  font-weight: 700;

  background: linear-gradient(135deg, #d63384, #a01d63) !important;
  color: #fff !important;

  border-radius: 12px;
  box-shadow: 0 8px 18px rgba(214, 51, 132, 0.4);

  transition: 0.25s ease;

  &:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 10px 25px rgba(214, 51, 132, 0.55);
  }

  &:disabled {
    background: rgba(255, 255, 255, 0.2) !important;
    box-shadow: none;
    transform: none;
  }
}

/* ============================================================
   FOOTER LINK (modernizado)
   ============================================================ */

mat-card-footer {
  text-align: center;
  padding: 18px 10px 5px;

  p {
    color: #eee;
    margin: 0;
  }

  a {
    color: #ff6bb9;
    font-weight: 700;
    text-decoration: none;
    transition: 0.2s;

    &:hover {
      /* Substituindo darken(#d63384, 15%) ‚Üí color.adjust */
      color: color.adjust(#ff6bb9, $lightness: -15%);
      text-decoration: underline;
    }
  }
}

/* ============================================================
   RESPONSIVE
   ============================================================ */

@media (max-width: 480px) {
  .login-card {
    padding: 25px;
    max-width: 90%;
  }

  mat-card-title {
    font-size: 1.9rem !important;
  }

  /* No arquivo styles.scss global */
.error-snackbar {
  --mdc-snackbar-container-color: #f44336; /* Vermelho Material */
  --mat-mdc-snack-bar-button-color: #fff; /* Texto do bot√£o branco */
  --mdc-snackbar-supporting-text-color: #fff; /* Texto da mensagem branco */
}
}
</file>

<file path="safevision-ui/src/app/features/auth/login/login.component.ts">
import { Component, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';
import { Router, RouterLink } from '@angular/router';
import { AuthService } from '../../../core/services/auth.service';
import { NotificationService } from '../../../core/services/notification.service'; // <--- SEU NOVO SERVI√áO

// M√≥dulos Visuais
import { MatCardModule } from '@angular/material/card';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatInputModule } from '@angular/material/input';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    RouterLink,
    MatCardModule,
    MatFormFieldModule,
    MatInputModule,
    MatButtonModule,
    MatIconModule,
    MatProgressSpinnerModule
   
  ],
  templateUrl: './login.component.html',
  styleUrl: './login.component.scss'
})
export class LoginComponent {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private router = inject(Router);
  
  // ‚úÖ Injetamos nosso servi√ßo limpo, n√£o o MatSnackBar direto
  private notifier = inject(NotificationService);

  isLoading = signal(false);
  hidePassword = signal(true); 

  loginForm = this.fb.nonNullable.group({
    username: ['', Validators.required],
    password: ['', Validators.required]
  });

  togglePassword(event: Event) {
    event.preventDefault(); 
    this.hidePassword.update(value => !value);
  }

  onSubmit() {
    if (this.loginForm.invalid) return;

    this.isLoading.set(true);
    const credentials = this.loginForm.getRawValue();

    this.authService.login(credentials).subscribe({
      next: () => {
        this.router.navigate(['/dashboard']);
        
        this.notifier.showSuccess('Bem-vindo ao SafeVision!');
      },
      error: (err) => {
        this.isLoading.set(false);
        
        const mensagem = err.status === 401 || err.status === 403
          ? 'Usu√°rio ou senha incorretos!'
          : 'Servidor indispon√≠vel.';

        // ‚úÖ Chamada limpa e reutiliz√°vel
        this.notifier.showError(mensagem);
      }
    });
  }
}
</file>

<file path="safevision-ui/src/app/features/auth/register/register.component.html">
<div class="register-wrapper">
  <mat-card class="register-card">
    
    <mat-card-header>
      <mat-card-title>
        @if (isRegisterSuccess()) {
          Tudo pronto! üéâ
        } @else {
          üìù Criar Conta
        }
      </mat-card-title>
      
      @if (!isRegisterSuccess()) {
        <mat-card-subtitle><br /> Junte-se ao SafeVision</mat-card-subtitle>
      }
    </mat-card-header>

    <mat-card-content>
      
      @if (isRegisterSuccess()) {
        <div class="success-state">
          <div class="icon-circle">
            <mat-icon>check_circle</mat-icon>
          </div>
          
          <h3>Cadastro Realizado!</h3>
          <p>Sua conta foi criada com sucesso.</p>
          <p class="sub-text">Agora voc√™ j√° pode acessar o sistema.</p>

          <button mat-flat-button color="primary" class="login-btn" (click)="goToLogin()">
            IR PARA O LOGIN
          </button>
        </div>
      } 
      
      @else {
        <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Usu√°rio</mat-label>
            <input matInput formControlName="username" placeholder="Seu usu√°rio √∫nico" />
            <mat-icon matSuffix>person</mat-icon>
            @if (registerForm.get('username')?.hasError('required')) {
              <mat-error>Usu√°rio √© obrigat√≥rio</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Senha</mat-label>
            <input matInput type="password" formControlName="password" placeholder="M√≠nimo 6 caracteres" />
            <mat-icon matSuffix>lock</mat-icon>
            @if (registerForm.get('password')?.hasError('required')) {
              <mat-error>Senha √© obrigat√≥ria</mat-error>
            }
            @if (registerForm.get('password')?.hasError('minlength')) {
              <mat-error>M√≠nimo de 6 caracteres</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Confirmar Senha</mat-label>
            <input matInput type="password" formControlName="confirmPassword" placeholder="Repita a senha" />
            <mat-icon matSuffix>lock</mat-icon>
          </mat-form-field>

          @if (registerForm.hasError('mismatch') && registerForm.get('confirmPassword')?.touched) {
            <div class="password-error">
              <mat-icon>error_outline</mat-icon>
              As senhas n√£o coincidem
            </div>
          }

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>E-mail</mat-label>
            <input matInput type="email" formControlName="email" placeholder="seu@email.com" />
            <mat-icon matSuffix>email</mat-icon>
            @if (registerForm.get('email')?.hasError('email')) {
              <mat-error>E-mail inv√°lido</mat-error>
            }
            @if (registerForm.get('email')?.hasError('required')) {
              <mat-error>E-mail √© obrigat√≥rio</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Celular (com DDI e DDD)</mat-label>
            <input matInput formControlName="phoneNumber" placeholder="+55 11 99999-9999" />
            <mat-icon matSuffix>smartphone</mat-icon>
            <mat-hint>Para alertas SMS cr√≠ticos</mat-hint>
            @if (registerForm.get('phoneNumber')?.hasError('required')) {
              <mat-error>Telefone √© obrigat√≥rio</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>URL da C√¢mera</mat-label>
            <input matInput formControlName="cameraUrl" placeholder="http://192.168.0.15:4747/video" />
            <mat-icon matSuffix>videocam</mat-icon>
            @if (registerForm.get('cameraUrl')?.hasError('required')) {
              <mat-error>URL √© obrigat√≥rio</mat-error>
            }
          </mat-form-field>

          <div class="alert-selection-container">
            <label class="mat-subtitle-2 label-header">Canais de Notifica√ß√£o</label>

            <mat-chip-listbox aria-label="Sele√ß√£o de Alertas" multiple>
              @for (opt of alertOptions; track opt.value) {
                <mat-chip-option
                  color="accent"
                  [selected]="alertTypesArray.value.includes(opt.value)"
                  (selectionChange)="toggleAlert(opt.value, $event.selected)">
                  <mat-icon matChipAvatar>
                    {{ opt.value === 'TELEGRAM' ? 'send' : (opt.value === 'EMAIL' ? 'email' : 'sms') }}
                  </mat-icon>
                  {{ opt.label }}
                </mat-chip-option>
              }
            </mat-chip-listbox>

            @if (registerForm.get('alertTypes')?.touched && registerForm.get('alertTypes')?.hasError('required')) {
              <mat-error class="chip-error">
                <mat-icon style="font-size: 12px; height: 12px; width: 12px;">error</mat-icon>
                Escolha pelo menos um canal
              </mat-error>
            }
          </div>

          <div class="actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="registerForm.invalid || isLoading()">
              @if (isLoading()) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <span>Registrar</span>
              }
            </button>
          </div>

        </form>
      }

    </mat-card-content>

    @if (!isRegisterSuccess()) {
      <mat-card-footer>
        <p>J√° tem conta? <a mat-button color="accent" routerLink="/login">Fa√ßa Login</a></p>
      </mat-card-footer>
    }
  </mat-card>
</div>
</file>

<file path="safevision-ui/src/app/features/auth/register/register.component.scss">
/* ============================================================
   SAFE VISION - REGISTER SCREEN (Premium Edition)
   Design System + Sass Modules + Modern Effects
   ============================================================ */
@use "sass:color";

/* ============================================================
   DESIGN SYSTEM (Shared Variables)
   ============================================================ */

/* Paleta principal */
$primary: #d63384; // Rose Brand Color
$primary-hover: color.adjust($primary, $lightness: -10%);
$accent: #00bcd4; // Cyan (Safe/Active)

/* Estados */
$error-text: #ff5252;
$success-text: #69f0ae;

/* Glassmorphism (padr√£o do sistema) */
$glass-bg: rgba(23, 23, 23, 0.75); // Fundo mais escuro para contraste
$glass-border: rgba(255, 255, 255, 0.15);
$glass-blur: 20px;

/* Sombra padr√£o */
$shadow-strong: 0 20px 45px rgba(0, 0, 0, 0.6);

/* Breakpoints */
$max-mobile: 480px;

/* ============================================================
   WRAPPER & LAYOUT
   ============================================================ */

.register-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  box-sizing: border-box;

  position: relative;
  z-index: 10;
}

/* ============================================================
   CARD (Glass style)
   ============================================================ */

.register-card {
  position: relative;
  z-index: 10;

  width: 100%;
  max-width: 480px; // Largura confort√°vel
  padding: 20px;

  border-radius: 24px;

  /* Glassmorphism */
  background: $glass-bg !important;
  backdrop-filter: blur($glass-blur) !important;
  border: 1px solid $glass-border;
  box-shadow: $shadow-strong;

  /* Anima√ß√£o de Entrada */
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ============================================================
   HEADER & TYPOGRAPHY
   ============================================================ */

mat-card-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  margin-bottom: 1.5rem;

  mat-card-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 5px;
    letter-spacing: 0.5px;
  }

  mat-card-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.95rem;
  }
}

/* ============================================================
   FORMS & INPUTS (Material Overrides)
   ============================================================ */

.full-width {
  width: 100%;
  margin-bottom: 0.8rem;
}

// Customiza√ß√£o profunda do Material Form Field para Dark Theme
.mat-mdc-form-field {
  .mdc-text-field--filled {
    background-color: rgba(255, 255, 255, 0.05) !important;
    border-radius: 8px;
  }

  // Cor do Texto
  .mdc-text-field__input {
    color: #fff !important;
    caret-color: $primary !important;
  }

  // Cor dos Labels
  .mdc-floating-label {
    color: rgba(255, 255, 255, 0.6) !important;
  }
  .mdc-floating-label--float-above {
    color: $primary !important;
  }

  // √çcones
  .mat-icon {
    color: rgba(255, 255, 255, 0.7);
  }

  // Linha inferior e erros
  .mdc-line-ripple::before {
    border-bottom-color: rgba(255, 255, 255, 0.3) !important;
  }
  .mdc-line-ripple::after {
    border-bottom-color: $primary !important;
  }
}

// Estilo de erro espec√≠fico
mat-error {
  color: $error-text !important;
  font-size: 0.8rem;
}

mat-hint {
  color: rgba(255, 255, 255, 0.5);
}

// Erro de senha n√£o coincidente
.password-error {
  color: $error-text;
  font-size: 12px;
  margin-top: -10px;
  margin-bottom: 15px;
  margin-left: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255, 82, 82, 0.1);
  padding: 8px;
  border-radius: 6px;

  mat-icon {
    font-size: 16px;
    height: 16px;
    width: 16px;
  }
}
</file>

<file path="safevision-ui/src/app/features/auth/register/register.component.ts">
import { Component, inject, signal } from '@angular/core';
import { FormBuilder, FormGroup, ReactiveFormsModule, Validators, FormControl } from '@angular/forms';
import { Router, RouterLink } from '@angular/router';
import { AuthService } from '../../../core/services/auth.service';
import { CommonModule } from '@angular/common';

// Imports do Material
import { MatCardModule } from '@angular/material/card';
import { MatInputModule } from '@angular/material/input';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';
import { MatCheckboxModule } from '@angular/material/checkbox';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatSnackBar, MatSnackBarModule } from '@angular/material/snack-bar';
import { MatChipsModule } from '@angular/material/chips';
import { AlertType } from '../../../core/models/app.models';

// Enum para tipagem forte


@Component({
  selector: 'app-register',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    RouterLink,
    MatCardModule, MatInputModule, MatButtonModule, MatIconModule,
    MatCheckboxModule, MatProgressSpinnerModule, MatSnackBarModule,
    MatChipsModule
  ],
  templateUrl: './register.component.html',
  styleUrls: ['./register.component.scss']
})
export class RegisterComponent {
  private fb = inject(FormBuilder);
  private authService = inject(AuthService);
  private router = inject(Router);
  private snackBar = inject(MatSnackBar);

  // Controle de Estado da UI
  isLoading = signal<boolean>(false);

  // ‚úÖ NOVO: Controla se mostramos o form ou a tela de "Check" verde
  isRegisterSuccess = signal<boolean>(false);

  // ‚ùå REMOVIDOS: successMessage e errorMessage (para evitar duplica√ß√£o visual com o SnackBar)

  // Op√ß√µes para o *ngFor do HTML
  alertOptions = [
    { label: 'üì± Telegram', value: AlertType.TELEGRAM },
    { label: 'üìß E-mail', value: AlertType.EMAIL },
    { label: 'üí¨ SMS', value: AlertType.SMS }
  ];

  // Defini√ß√£o do Formul√°rio
  registerForm = this.fb.group({
    username: ['', Validators.required],
    password: ['', [Validators.required, Validators.minLength(6)]],
    confirmPassword: ['', Validators.required],
    email: ['', [Validators.required, Validators.email]],
    phoneNumber: ['', Validators.required],
    cameraUrl: ['', Validators.required],
    alertTypes: [[AlertType.EMAIL], Validators.required]
  }, { validators: this.passwordMatchValidator });

  // --- GETTERS ---

  get alertTypesArray(): FormControl {
    return this.registerForm.get('alertTypes') as FormControl;
  }

  // Validador personalizado de senha
  passwordMatchValidator(g: FormGroup) {
    return g.get('password')?.value === g.get('confirmPassword')?.value
      ? null : { mismatch: true };
  }

  // --- L√ìGICA DOS CHECKBOXES ---

  toggleAlert(value: string, isChecked: boolean) {
    const currentValues = this.alertTypesArray.value as string[];

    if (isChecked) {
      this.alertTypesArray.setValue([...currentValues, value]);
    } else {
      this.alertTypesArray.setValue(currentValues.filter(item => item !== value));
    }
    this.alertTypesArray.markAsTouched();
  }

  // --- SUBMIT ---

  onSubmit() {
    if (this.registerForm.invalid) return;

    this.isLoading.set(true);

    // Removemos confirmPassword do payload
    const { confirmPassword, ...registerData } = this.registerForm.getRawValue();

    const finalPayload = {
      ...registerData,
      role: 'USER'
    };

    console.log('Enviando Payload:', finalPayload);

    this.authService.register(finalPayload as any).subscribe({
      next: () => {
        this.isLoading.set(false);

        // ‚úÖ SUCESSO:
        // 1. Muda o estado para mostrar a tela de sucesso (troca o HTML)
        this.isRegisterSuccess.set(true);

        // 2. Opcional: Mostra um feedback r√°pido no topo, mas sem texto no card
        this.snackBar.open('Cadastro realizado com sucesso!', 'OK', {
          duration: 3000,
          panelClass: ['success-snackbar'] // Use a classe CSS que definimos antes
        });

        // ‚ùå REMOVIDO: setTimeout e router.navigate autom√°tico
      },
      error: (err) => {
        console.error(err);
        this.isLoading.set(false);

        // ‚úÖ ERRO:
        // Mostra APENAS no SnackBar (mais limpo que texto vermelho no card)
        this.snackBar.open('Falha ao registrar. Verifique os dados ou tente outro usu√°rio.', 'Fechar', {
          duration: 5000,
          panelClass: ['error-snackbar'] // Use a classe CSS de erro (vermelho)
        });
      }
    });
  }

  // A√ß√£o do bot√£o "IR PARA O LOGIN" na tela de sucesso
  goToLogin() {
    this.router.navigate(['/login']);
  }
}
</file>

<file path="safevision-ui/src/app/features/dashboard/dashboard.component.html">
<app-header></app-header>
<div class="dashboard-content">

  <div class="panel-left">
    <mat-card class="video-card">

      <mat-card-header>
        <mat-card-title>Monitoramento em Tempo Real</mat-card-title>

        <div class="status-badge" [class.online]="isCameraActive()">
          <div class="indicator"></div>
          <span>{{ isCameraActive() ? 'ONLINE' : 'OFFLINE' }}</span>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="video-wrapper">

          @if (isCameraActive() && videoStreamUrl()) {
            <img
              [src]="videoStreamUrl()"
              alt="Transmiss√£o ao Vivo"
              class="live-feed"
              (error)="onVideoError()"
            >
          }

          @else if (isLoading() && !isCameraActive()) {
            <div class="overlay loading">
              <mat-spinner diameter="50" color="accent"></mat-spinner>
              <p>Conectando √† c√¢mera...</p>
            </div>
          }

          @else {
            <div class="overlay offline">
              <mat-icon class="large-icon">videocam_off</mat-icon>
              <h3>Sistema Desativado</h3>
              <p>Clique em "ATIVAR" para iniciar o monitoramento.</p>
            </div>
          }
        </div>
      </mat-card-content>

      <mat-card-actions align="end" class="control-actions">
        <button
          mat-stroked-button
          color="warn"
          (click)="toggleSystem(false)"
          [disabled]="!isCameraActive() || isLoading()">
            @if (isLoading() && isCameraActive()) {
                <mat-spinner diameter="20" color="warn"></mat-spinner>
            } @else {
                <span class="btn-label">
                    <mat-icon>stop_circle</mat-icon>
                    <span>DESATIVAR</span>
                </span>
            }
        </button>

        <button
          mat-flat-button
          color="primary"
          (click)="toggleSystem(true)"
          [disabled]="isCameraActive() || isLoading()">
            @if (isLoading() && !isCameraActive()) {
                <mat-spinner diameter="20" color="accent"></mat-spinner>
            } @else {
                <span class="btn-label">
                    <mat-icon>play_circle</mat-icon>
                    <span>ATIVAR</span>
                </span>
            }
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <div class="panel-right">
	<div class="alerts-header">
	      <h2>üö® √öltimos Alertas</h2>
	      
	      <div class="actions">
			
			
			  <button mat-icon-button (click)="goToHistory()" matTooltip="Ver hist√≥rico completo">
		            <mat-icon>event_note</mat-icon>
	          </button>
	          <button mat-icon-button (click)="loadAlerts()" matTooltip="Atualizar lista">
	            <mat-icon>refresh</mat-icon>
	          </button>
	      </div>
	    </div>

    <div class="alerts-list">
      @for (alert of alerts(); track alert.id) {
        <mat-card class="alert-item" [class.critical]="alert.severity === 'CRITICAL'">

          <div class="alert-row">
            <div class="alert-icon">
                <mat-icon [class.warn-icon]="alert.severity === 'CRITICAL'">
                    {{ alert.severity === 'CRITICAL' ? 'warning' : 'info' }}
                </mat-icon>
            </div>

            <div class="alert-content">
                <div class="alert-top">
                    <span class="type">{{ alert.alertType }}</span>
                    <span class="time">{{ alert.createdAt | date:'HH:mm:ss' }}</span>
                </div>

                <p class="desc">{{ alert.description }}</p>

                @if (alert.snapshotUrl) {
                    <div class="evidence-wrapper">
                        <img [src]="alert.snapshotUrl" alt="Evid√™ncia" loading="lazy">
                    </div>
                }

                @if (alert.latitude && alert.longitude) {
                    <div class="geo-tag-bar">
                        <div class="coords-info">
                            <mat-icon>place</mat-icon>
                            @if (alert.address) {
                                <span class="address-text" [matTooltip]="alert.address">{{ alert.address }}</span>
                            } @else {
                                <span class="raw-coords">{{ alert.latitude | number:'1.4-4' }}, {{ alert.longitude | number:'1.4-4' }}</span>
                            }
                        </div>
						
                        <button mat-stroked-button color="accent" class="btn-map-small" (click)="openLocation(alert)">
                            Localiza√ß√£o
                        </button>
                    </div>
                }
            </div>

            <div class="alert-action">
                @if (alert.acknowledged) {
                    <mat-icon class="check-icon" matTooltip="Lido">check_circle</mat-icon>
                } @else {
                    <button mat-icon-button color="primary" (click)="ack(alert.id)" matTooltip="Marcar como lido">
                        <mat-icon>mark_email_read</mat-icon>
                    </button>
                }
            </div>
          </div>

        </mat-card>
      }
      @empty {
        <div class="empty-state">
          <mat-icon>notifications_none</mat-icon>
          <p>Tudo seguro. Nenhum alerta recente.</p>
        </div>
      }
    </div>
  </div>

</div>
</file>

<file path="safevision-ui/src/app/features/dashboard/dashboard.component.scss">
/* ============================================================
   SAFE VISION ‚Äî Dashboard Style
   ============================================================ */
@use "sass:color";

// Vari√°veis Locais
$primary: #d63384;
$warn: #f44336;
$success: #2e7d32;
$glass-border: rgba(255, 255, 255, 0.18);
$shadow-hard: 0 18px 45px rgba(0, 0, 0, 0.55);

// Toolbar e Layout
.dashboard-toolbar {
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(0, 0, 0, 0.6) !important;
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
  display: flex;
  align-items: center;

  .brand { font-weight: 700; letter-spacing: 1px; font-size: 1.2rem; }
  .spacer { flex: 1 1 auto; }
  .user-info {
    display: flex;
    align-items: center;
    .username { margin-right: 12px; font-weight: 600; }
    button { color: rgba(255, 255, 255, 0.9); }
  }
}

.dashboard-content {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 24px;
  padding: 24px;
  max-width: 1600px;
  margin: 0 auto;
  height: calc(100vh - 64px);

  @media (max-width: 900px) {
    grid-template-columns: 1fr;
    height: auto;
  }
}

// Card de V√≠deo
.video-card {
  background: rgba(255, 255, 255, 0.05) !important;
  backdrop-filter: blur(16px) !important;
  border: 1px solid $glass-border !important;
  border-radius: 16px;
  box-shadow: $shadow-hard !important;
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;

  mat-card-header {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    mat-card-title { color: #fff; font-size: 1.2rem; letter-spacing: 0.5px; }

    .status-badge {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.1);
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;

      .indicator {
        width: 8px; height: 8px; border-radius: 50%;
        background-color: #ff5252; box-shadow: 0 0 5px rgba(255, 82, 82, 0.4);
      }

      &.online {
        color: #fff;
        background: rgba(0, 230, 118, 0.15);
        border: 1px solid rgba(0, 230, 118, 0.3);
        .indicator {
            background-color: #00e676;
            box-shadow: 0 0 10px #00e676;
            animation: pulse 2s infinite;
        }
      }
    }
  }

  mat-card-content {
    flex-grow: 1; padding: 0; position: relative;
    background: #000; display: flex; align-items: center; justify-content: center;
  }

  .video-wrapper {
    width: 100%; height: 100%; position: relative;
    display: flex; align-items: center; justify-content: center;

    .live-feed { width: 100%; height: 100%; object-fit: contain; display: block; }

    .overlay {
      position: absolute; inset: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: white; text-align: center; background: rgba(0, 0, 0, 0.7); z-index: 10;
      
      &.offline {
        .large-icon { font-size: 64px; width: 64px; height: 64px; opacity: 0.4; margin-bottom: 16px; }
        h3 { margin: 0; font-size: 1.5rem; font-weight: 600; }
      }
    }
  }

  mat-card-actions {
    padding: 16px 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(0, 0, 0, 0.2);
    gap: 12px;
    button { height: 44px; font-weight: 600; min-width: 140px; border-radius: 8px; }
  }
}

// Painel de Alertas
.panel-right {
  display: flex; flex-direction: column; overflow: hidden;

  .alerts-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px; padding: 0 4px;
    h2 { margin: 0; font-weight: 700; color: #fff; font-size: 1.2rem; }
    button { color: rgba(255, 255, 255, 0.8); }
  }

  .alerts-list {
    flex-grow: 1; overflow-y: auto; padding-right: 6px;
    display: flex; flex-direction: column; gap: 16px;

    &::-webkit-scrollbar { width: 6px; }
    &::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    &::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }

    .alert-item {
      background: rgba(255, 255, 255, 0.05) !important;
      backdrop-filter: blur(8px) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      border-radius: 12px; padding: 16px; color: #fff;
      transition: transform 0.2s;

      &:hover { background: rgba(255, 255, 255, 0.08) !important; transform: translateY(-2px); }
      &.critical { border-left: 4px solid $warn !important; background: linear-gradient(90deg, rgba(244, 67, 54, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%) !important; }

      .alert-row { display: flex; gap: 16px; }
      .alert-icon {
        padding-top: 2px;
        mat-icon { color: rgba(255, 255, 255, 0.7); }
        .warn-icon { color: $warn; }
      }

      .alert-content {
        flex: 1; min-width: 0;

        .alert-top {
          display: flex; justify-content: space-between; margin-bottom: 6px;
          .type { font-weight: 700; font-size: 0.95rem; }
          .time { font-size: 0.8rem; opacity: 0.6; }
        }

        .desc { margin: 0 0 10px 0; font-size: 0.9rem; opacity: 0.8; line-height: 1.4; }

        .evidence-wrapper {
          position: relative; overflow: hidden;
          border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 12px;
          img { width: 100%; display: block; transition: transform 0.3s; cursor: zoom-in; &:hover { transform: scale(1.05); } }
        }

        /* üìç ESTILO DA BARRA DE GPS (NOVO) */
        .geo-tag-bar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 8px;

            .coords-info {
                display: flex; align-items: center; gap: 8px;
                font-size: 0.85rem; overflow: hidden;
                
                mat-icon { font-size: 18px; width: 18px; height: 18px; color: $primary; }

                .address-text {
                    font-weight: 500; color: #fff;
                    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
                    max-width: 180px;
                }

                .raw-coords {
                    color: rgba(255, 255, 255, 0.7);
                    font-family: 'Roboto Mono', monospace; font-size: 0.8rem;
                }
            }

			.btn-map-small {
			    /* 1. Trava as dimens√µes do container do bot√£o */
			    height: 26px !important;
			    min-height: 26px !important;
			    max-height: 26px !important;
			    padding: 0 12px !important; // Espa√ßamento lateral menor
			    min-width: auto !important;
			    border-radius: 13px !important; // Metade da altura para ficar redondo
			    
			    /* 2. Ajustes de Fonte */
			    font-size: 0.65rem !important;
			    font-weight: 700 !important;
			    letter-spacing: 0.5px;
			    text-transform: uppercase;

			    /* 3. Centraliza√ß√£o do Host */
			    display: inline-flex !important;
			    align-items: center !important;
			    justify-content: center !important;
			    
			    /* 4. Hack para matar o line-height padr√£o do Material */
			    line-height: 0 !important; 

			    /* 5. Acessa a estrutura interna do Angular Material (Label) */
			    & ::ng-deep .mdc-button__label {
			        display: flex !important;
			        align-items: center !important;
			        justify-content: center !important;
			        line-height: normal !important; /* Restaura line-height s√≥ para o texto */
			        height: 100%;
			        margin-top: 1px; /* Ajuste fino √≥tico vertical */
			    }

			    /* Caso voc√™ adicione √≠cone no futuro, garante que n√£o quebre */
			    & ::ng-deep mat-icon {
			        font-size: 14px !important;
			        width: 14px !important;
			        height: 14px !important;
			        margin-right: 4px;
			    }
			}
        }
      }

      .alert-action {
        display: flex; flex-direction: column; justify-content: center;
        .check-icon { color: $success; }
      }
    }

    .empty-state {
      text-align: center; padding: 40px; opacity: 0.5;
      mat-icon { font-size: 48px; width: 48px; height: 48px; margin-bottom: 12px; }
    }
  }
}

// Bot√µes Ovais
button[mat-stroked-button], button[mat-flat-button] {
  height: 45px; border-radius: 50px !important; min-width: 140px; padding: 0 24px;
  &:not(.btn-map-small) {
      .btn-label { display: flex; align-items: center; justify-content: center; line-height: 1; 
        mat-icon { margin-right: 8px; }
        span { display: inline-block; padding-top: 2px; }
      }
  }
}

@keyframes pulse {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.1); }
  100% { opacity: 1; transform: scale(1); }
}
</file>

<file path="safevision-ui/src/app/features/dashboard/dashboard.component.ts">
import { Component, inject, OnInit, DestroyRef, signal, ChangeDetectionStrategy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { HttpClient } from '@angular/common/http';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { DomSanitizer, SafeUrl } from '@angular/platform-browser';
import { switchMap, throwError } from 'rxjs';
import { Router } from '@angular/router'; // üìç 1. IMPORT NECESS√ÅRIO

// Services
import { AlertService } from '../../core/services/alert.service';
import { AuthService } from '../../core/services/auth.service';
import { VisionService } from '../../core/services/vision.service';
import { WebSocketService } from '../../core/services/websocket.service';
import { NotificationService } from '../../core/services/notification.service';
import { Alert } from '../../core/models/app.models';
import { environment } from '../../../environments/environment';

// Material Components
import { MatToolbarModule } from '@angular/material/toolbar';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';
import { MatCardModule } from '@angular/material/card';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatChipsModule } from '@angular/material/chips';
import { MatTooltipModule } from '@angular/material/tooltip';
import { MatDialog } from '@angular/material/dialog';
import { MapDialogComponent } from '../../shared/components/map_dialog/map-dialog.component';
import { HeaderComponent } from '../../shared/components/header/header.component'; // üëà Importar


@Component({
  selector: 'app-dashboard',
  standalone: true,
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [
    CommonModule,
    MatToolbarModule,
    MatButtonModule,
    MatIconModule,
    MatCardModule,
    MatProgressSpinnerModule,
    MatChipsModule,
    MatTooltipModule,
	HeaderComponent
  ],
  providers: [WebSocketService],
  templateUrl: './dashboard.component.html',
  styleUrls: ['./dashboard.component.scss']
})
export class DashboardComponent implements OnInit {

  // --- INJE√á√ÉO DE DEPEND√äNCIAS ---
  public auth = inject(AuthService);
  private alertService = inject(AlertService);
  private visionService = inject(VisionService);
  private webSocketService = inject(WebSocketService);
  private notifier = inject(NotificationService);
  private sanitizer = inject(DomSanitizer);
  private destroyRef = inject(DestroyRef);
  private http = inject(HttpClient);
  private dialog = inject(MatDialog);
  private router = inject(Router); // üìç 2. INJE√á√ÉO QUE FALTAVA

  // --- SIGNALS (ESTADO) ---
  alerts = signal<Alert[]>([]);
  isLoading = signal(false);
  isCameraActive = signal(false);
  videoStreamUrl = signal<SafeUrl | null>(null);

  ngOnInit() {
    this.loadAlerts();
    this.initWebSocket();
  }

  private initWebSocket() {
    const user = this.auth.currentUser();
    if (!user?.username) return;

    const userTopic = `/topic/alert/${user.username}`;

    this.webSocketService.watchAlerts(userTopic)
      .pipe(takeUntilDestroyed(this.destroyRef))
      .subscribe({
        next: (newAlert: Alert) => {
          this.alerts.update(list => [newAlert, ...list]);
          this.notifier.showError(`Amea√ßa Detectada: ${newAlert.alertType}`);
        },
        error: (err: any) => console.error('WebSocket Error:', err)
      });
  }

  toggleSystem(turnOn: boolean) {
    const user = this.auth.currentUser();
    if (!user?.username) return;

    this.isLoading.set(true);
    let request$;

    if (turnOn) {
      request$ = this.http.get<{ cameraUrl: string }>(`${environment.apiUrl}/auth/camera-url`).pipe(
        switchMap(res => {
          if (!res.cameraUrl) return throwError(() => new Error('NO_CAMERA_URL'));
          return this.visionService.startDetection(user.username, res.cameraUrl);
        })
      );
    } else {
      request$ = this.visionService.stopDetection(user.username);
    }

    request$.subscribe({
      next: () => {
        this.isLoading.set(false);
        this.isCameraActive.set(turnOn);
        if (turnOn) {
          this.generateVideoUrl(user.username);
          this.notifier.showSuccess('Monitoramento Ativado');
        } else {
          this.videoStreamUrl.set(null);
        }
      },
      error: (err) => {
        this.isLoading.set(false);
        if (turnOn) this.isCameraActive.set(false);
        this.notifier.showError('Erro ao comunicar com a c√¢mera.');
      }
    });
  }

  private generateVideoUrl(username: string) {
    const rawUrl = `${environment.visionAgentUrl}/video_feed/${username}?t=${Date.now()}`;
    this.videoStreamUrl.set(this.sanitizer.bypassSecurityTrustUrl(rawUrl));
  }

  onVideoError() {
    if (this.isCameraActive()) {
      this.isCameraActive.set(false);
      this.notifier.showError('Sinal de v√≠deo perdido.');
    }
  }

  loadAlerts() {
    const user = this.auth.currentUser();
    if (user?.username) {
      this.alertService.getRecentAlerts(user.username).subscribe({
        next: (data) => this.alerts.set(data),
        error: (err) => this.notifier.showError('Erro ao carregar hist√≥rico.')
      });
    }
  }

  ack(id: string) {
    this.alertService.acknowledge(id).subscribe(() => {
      this.alerts.update(list => list.map(a =>
        a.id === id ? { ...a, acknowledged: true } : a
      ));
    });
  }

  openLocation(alert: Alert) {
    if (!alert.latitude || !alert.longitude) {
      this.notifier.showError('GPS indispon√≠vel para este evento.');
      return;
    }

    this.dialog.open(MapDialogComponent, {
      width: '800px',
      maxWidth: '95vw',
      panelClass: 'glass-dialog',
      data: {
        lat: alert.latitude,
        lng: alert.longitude,
        label: alert.alertType,
        timestamp: alert.createdAt,
        address: alert.address
      }
    });
  }

  // üìç 3. AGORA ESTA FUN√á√ÉO VAI FUNCIONAR
  goToHistory() {
    this.router.navigate(['/history']);
  }
}
</file>

<file path="safevision-ui/src/index.html">
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SafeVision Monitor</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/jpeg" href="logo.jpeg">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' 'unsafe-inline' 'unsafe-eval' *;
    connect-src 'self' 
      http://localhost:* ws://localhost:* http://192.168.112.1:* ws://192.168.112.1:* http://*.nip.io:* ws://*.nip.io:* data: blob:;
    img-src 'self' 
      http://localhost:* http://192.168.112.1:* http://*.nip.io:* data: blob: 
      https://images.unsplash.com 
      https://*.basemaps.cartocdn.com 
      https://*.openstreetmap.org;
    media-src *;
    frame-src *;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com data:;
  ">
</head>
<body class="mat-typography">
  <app-root></app-root>
</body>
</html>
</file>

<file path="safevision-ui/src/styles.scss">
// Include theming for Angular Material with `mat.theme()`.
// This Sass mixin will define CSS variables that are used for styling Angular Material
// components according to the Material 3 design spec.
// Learn more about theming and how to use it for your application's
// custom components at https://material.angular.dev/guide/theming
@use '@angular/material' as mat;
/* ============================================================
   GLOBAL BACKGROUND (Safe Vision)
   Aplica o mesmo fundo moderno usado no login a todo o sistema
   ============================================================ */
body, app-root {
  position: relative;
  z-index: 0;
}
body, app-root {
  min-height: 100vh;
  margin: 0;
  padding: 0;

  background-image: url('/assets/bg-login.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  position: relative;
}

/* Overlay global com cor da marca */
body::before,
app-root::before {
  content: '';
  position: absolute;
  inset: 0;

  background: linear-gradient(
    120deg,
    rgba(192, 46, 95, 0.35),
    rgba(22, 22, 24, 0.85)
  );

  backdrop-filter: blur(6px);
  z-index: -5; /* Para n√£o sobrepor os componentes */
}

html {
  @include mat.theme((
    color: (
      primary: mat.$rose-palette,
      tertiary: mat.$red-palette,
    ),
    typography: Roboto,
    density: 0,
  ));
}

body {
  // Default the application to a light color theme. This can be changed to
  // `dark` to enable the dark color theme, or to `light dark` to defer to the
  // user's system settings.
  color-scheme: light;

  // Set a default background, font and text colors for the application using
  // Angular Material's system-level CSS variables. Learn more about these
  // variables at https://material.angular.dev/guide/system-variables
  background-color: var(--mat-sys-surface);
  color: var(--mat-sys-on-surface);
  font: var(--mat-sys-body-medium);

  // Reset the user agent margin.
  margin: 0;
}
:root {
  --color-brand-rose: #d63384;  /* A cor principal */
  --color-danger-red: #f44336;  /* Vermelho Material */
  --color-safe-cyan: #00bcd4;   /* Ciano (Substitui o verde comum) */
  --color-inactive: #424242;    /* Cinza escuro */
}

/* ============================================================
   SNACKBARS (Notifica√ß√µes)
   ============================================================ */

/* Sucesso/Monitorando (Agora √© CIANO para bater com o v√≠deo) */
.success-snackbar {
  --mdc-snackbar-container-color: var(--color-safe-cyan) !important;
  --mdc-snackbar-supporting-text-color: #ffffff !important;
  --mat-snack-bar-button-color: #ffffff !important;
  font-weight: 500;
}

/* Erro/Arma (Vermelho) */
.error-snackbar {
  --mdc-snackbar-container-color: var(--color-danger-red) !important;
  --mdc-snackbar-supporting-text-color: #ffffff !important;
  --mat-snack-bar-button-color: #ffffff !important;
  font-weight: 600;
}

/* Info/Aten√ß√£o (Rose - A cor da marca) */
.info-snackbar {
  --mdc-snackbar-container-color: var(--color-brand-rose) !important;
  --mdc-snackbar-supporting-text-color: #ffffff !important;
  --mat-snack-bar-button-color: #ffffff !important;
}

// Ajuste global para o corpo
html, body { height: 100%; }
body { margin: 0; font-family: Roboto, "Helvetica Neue", sans-serif; background-color: #f5f5f5; }

html, body { height: 100%; }
body { margin: 0; font-family: Roboto, "Helvetica Neue", sans-serif; }

.blur-backdrop {
    background-color: rgba(0, 0, 0, 0.85); /* Fundo bem escuro */
    backdrop-filter: blur(8px); /* Desfoque moderno */
}

/* Remove padding padr√£o do Dialog para a imagem ir at√© a borda se quiser */
.fullscreen-dialog .mat-mdc-dialog-container .mat-mdc-dialog-surface {
    background: transparent !important; /* Remove fundo branco padr√£o */
    box-shadow: none !important;
    overflow: hidden !important;
}
</file>

<file path="vision-agent/config.py">
import os

# --- RabbitMQ Connection ---
# O segundo parametro 'rabbitmq' √© o valor padr√£o se a variavel de ambiente falhar
RABBITMQ_HOST = os.environ.get('RABBITMQ_HOST', 'rabbitmq')

# Aqui corrigimos: Se n√£o achar a env, usa o valor que estava no seu .env (usersafevision)
USERNAME = os.environ.get('RABBITMQ_USERNAME', 'usersafevision')
PASSWORD = os.environ.get('RABBITMQ_PASSWORD', 'passwordsafevision')

# --- Queues ---
QUEUE_NAME = os.environ.get('VISION_QUEUE_NAME', 'safevision.vision.raw.tracking')


# --- MinIO (Armazenamento de Imagens) ---
MINIO_ENDPOINT = os.environ.get('MINIO_ENDPOINT', 'minio:9000')
MINIO_ACCESS_KEY = os.environ.get('MINIO_ACCESS_KEY', 'minioadmin')
MINIO_SECRET_KEY = os.environ.get('MINIO_SECRET_KEY', 'minioadmin')
MINIO_BUCKET = os.environ.get('MINIO_BUCKET_NAME', 'safevision-evidence')
MINIO_EXTERNAL_PREFIX = os.environ.get('MINIO_EXTERNAL_PREFIX', 'http://192.168.112.1:9000')
</file>

<file path="vision-agent/detectors/gaze_detector.py">
import cv2
import numpy as np
import mediapipe as mp

class GazeDetector:
    def __init__(self):
        self.mp_face_mesh = mp.solutions.face_mesh
        self.face_mesh = self.mp_face_mesh.FaceMesh(
            min_detection_confidence=0.5, 
            min_tracking_confidence=0.5, 
            max_num_faces=1
        )

    def process(self, frame, rgb_frame):
        img_h, img_w, _ = frame.shape
        results = self.face_mesh.process(rgb_frame)
        
        data = {
            "facing": False,
            "direction": "",
            "depth_score": 0
        }

        if results.multi_face_landmarks:
            for face_landmarks in results.multi_face_landmarks:
                
                # 1. Calcular Profundidade (Largura do rosto)
                left_x = face_landmarks.landmark[234].x
                right_x = face_landmarks.landmark[454].x
                data["depth_score"] = int(abs(left_x - right_x) * 200)

                # 2. Calcular Dire√ß√£o do Olhar (PnP)
                face_3d = []
                face_2d = []
                # Nariz, Queixo, Olhos, Boca
                key_points = [1, 152, 263, 33, 287, 57]
                
                for idx, lm in enumerate(face_landmarks.landmark):
                    if idx in key_points:
                        x, y = int(lm.x * img_w), int(lm.y * img_h)
                        face_2d.append([x, y])
                        face_3d.append([x, y, lm.z])

                face_2d = np.array(face_2d, dtype=np.float64)
                face_3d = np.array(face_3d, dtype=np.float64)
                focal_length = 1 * img_w
                cam_matrix = np.array([[focal_length, 0, img_h / 2], [0, focal_length, img_w / 2], [0, 0, 1]])
                dist_matrix = np.zeros((4, 1), dtype=np.float64)

                success, rot_vec, trans_vec = cv2.solvePnP(face_3d, face_2d, cam_matrix, dist_matrix)
                rmat, jac = cv2.Rodrigues(rot_vec)
                
                # Corre√ß√£o de vers√£o do OpenCV
                retval = cv2.RQDecomp3x3(rmat)
                angles = retval[0]

                x_angle = angles[0] * 360
                y_angle = angles[1] * 360

                if y_angle < -10: data["direction"] = "ESQUERDA"
                elif y_angle > 10: data["direction"] = "DIREITA"
                elif x_angle < -10: data["direction"] = "BAIXO"
                elif x_angle > 10: data["direction"] = "CIMA"
                else: 
                    data["direction"] = "FRENTE"
                    data["facing"] = True

                # Desenha caixa simples no rosto
                center_x = int(face_landmarks.landmark[1].x * img_w)
                center_y = int(face_landmarks.landmark[1].y * img_h)
                color = (0, 0, 255) if data["facing"] else (0, 255, 0)
                cv2.circle(frame, (center_x, center_y), 5, color, -1)

        return data
</file>

<file path="vision-agent/detectors/weapon_detector.py">
import cv2
import mediapipe as mp
from ultralytics import YOLO
from utils import calculate_distance

class WeaponDetector:
    def __init__(self):
        # Inicializa Pose (MediaPipe)
        # Otimiza√ß√£o: model_complexity=0 √© mais r√°pido e menos preciso (ideal para CPU)
        self.mp_pose = mp.solutions.pose
        self.pose = self.mp_pose.Pose(
            static_image_mode=False,
            model_complexity=0, 
            min_detection_confidence=0.5, 
            min_tracking_confidence=0.5
        )
        
        # Inicializa YOLO
        print("üîÑ Carregando modelo YOLO...")
        try:
            self.model = YOLO('yolov8n.pt')
        except:
            self.model = YOLO('yolov8n.pt') 
        
        # IDs das classes COCO: 43: Knife, 67: Cell phone (teste), 76: Scissors
        self.WEAPON_CLASSES = [43, 67, 76]
        self.WEAPON_MAPPING = {43: "FACA", 67: "ARMA", 76: "TESOURA"}

    def process(self, frame, rgb_frame):
        img_h, img_w, _ = frame.shape
        
        result = {
            "hasWeapon": False,
            "weaponType": "NONE",
            "weaponLocation": "NONE"
        }

        # ======================================================================
        # PASSO 1: YOLO PRIMEIRO (Filtro R√°pido)
        # ======================================================================
        # Se n√£o tiver arma, nem perdemos tempo procurando bra√ßos/corpo.
        # classes=self.WEAPON_CLASSES faz o YOLO ignorar pessoas, carros, etc.
        yolo_results = self.model(frame, verbose=False, conf=0.5, classes=self.WEAPON_CLASSES)
        
        # Verifica se detectou algo
        detected_boxes = []
        for r in yolo_results:
            for box in r.boxes:
                cls = int(box.cls[0])
                # Confirma√ß√£o dupla (embora o filtro classes j√° resolva)
                if cls in self.WEAPON_CLASSES:
                    detected_boxes.append(box)

        # ‚ö° OTIMIZA√á√ÉO CR√çTICA: Se n√£o tem arma, retorna AGORA.
        if not detected_boxes:
            return result

        # ======================================================================
        # PASSO 2: MEDIAPIPE (S√≥ roda se tiver arma)
        # ======================================================================
        # S√≥ gastamos CPU calculando esqueleto se j√° sabemos que tem uma arma na cena
        pose_results = self.pose.process(rgb_frame)
        body_points = {}

        if pose_results.pose_landmarks:
            landmarks = pose_results.pose_landmarks.landmark
            # Mapeia apenas o necess√°rio
            body_points['R_WRIST'] = (int(landmarks[16].x * img_w), int(landmarks[16].y * img_h))
            body_points['L_WRIST'] = (int(landmarks[15].x * img_w), int(landmarks[15].y * img_h))
            r_hip = (int(landmarks[24].x * img_w), int(landmarks[24].y * img_h))
            l_hip = (int(landmarks[23].x * img_w), int(landmarks[23].y * img_h))
            body_points['WAIST'] = (int((r_hip[0] + l_hip[0]) / 2), int((r_hip[1] + l_hip[1]) / 2))

        # ======================================================================
        # PASSO 3: DESENHO E CORRELA√á√ÉO
        # ======================================================================
        for box in detected_boxes:
            cls = int(box.cls[0])
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            obj_center = (int((x1 + x2) / 2), int((y1 + y2) / 2))
            label = self.WEAPON_MAPPING.get(cls, "ARMA")

            # Desenha caixa da arma
            cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 0, 255), 2)
            cv2.putText(frame, label, (x1, y1 - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 255), 2)

            # S√≥ conseguimos correlacionar se o MediaPipe achou algu√©m
            if body_points:
                threshold = img_w * 0.20  # Aumentei levemente a toler√¢ncia (20%)
                dist_r = calculate_distance(obj_center, body_points['R_WRIST'])
                dist_l = calculate_distance(obj_center, body_points['L_WRIST'])
                dist_w = calculate_distance(obj_center, body_points['WAIST'])

                if dist_r < threshold or dist_l < threshold:
                    result["hasWeapon"] = True
                    result["weaponType"] = label
                    result["weaponLocation"] = "MAO"
                    # Visualiza√ß√£o da linha
                    target = body_points['R_WRIST'] if dist_r < dist_l else body_points['L_WRIST']
                    cv2.line(frame, obj_center, target, (0, 255, 255), 2)
                
                elif dist_w < threshold:
                    result["hasWeapon"] = True
                    result["weaponType"] = label
                    result["weaponLocation"] = "CINTURA"
                    cv2.line(frame, obj_center, body_points['WAIST'], (0, 0, 255), 2)
            else:
                # Se achou arma mas n√£o achou corpo, ainda √© uma amea√ßa? 
                # Sim, mas sem localiza√ß√£o corporal.
                result["hasWeapon"] = True
                result["weaponType"] = label
                result["weaponLocation"] = "UNKNOWN"

        return result
</file>

<file path="vision-agent/Dockerfile">
# Usa a imagem oficial do YOLO (Vers√£o CPU)
FROM ultralytics/ultralytics:latest-cpu

# Define o diret√≥rio de trabalho
WORKDIR /app

# Evita buffer de logs e problemas de encoding
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# 1. Depend√™ncias do Sistema
RUN apt-get update && apt-get install -y \
    libgl1 \
    libsm6 \
    libxext6 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# 2. Depend√™ncias Python (O PULO DO GATO EST√Å AQUI)
# Removemos qualquer protobuf existente e instalamos a vers√£o 3.20.3
# Essa vers√£o √© o "ponto de paz" entre o YOLO e o MediaPipe
RUN pip uninstall -y protobuf && \
    pip install --no-cache-dir protobuf==3.20.3

# Instala o MediaPipe e as outras libs
RUN pip install --no-cache-dir \
    mediapipe==0.10.9 \
    pika \
    flask \
    flask-cors \
    minio \
    requests \
    pyserial \
    pynmea2

# 3. C√≥pia dos Arquivos
COPY . .

# 4. Comando de Execu√ß√£o
ENTRYPOINT ["python", "main.py"]
</file>

<file path="vision-agent/messaging.py">
import pika
import json
import time
import config

class RabbitMQClient:
    def __init__(self):
        self.connection = None
        self.channel = None
        # Tenta conectar imediatamente ao instanciar
        self.connect()

    def connect(self):
        """
        Estabelece a conex√£o com retry infinito.
        Configurado com heartbeat=0 para suportar picos de CPU da IA.
        """
        while True:
            try:
                credentials = pika.PlainCredentials(config.USERNAME, config.PASSWORD)
                
                parameters = pika.ConnectionParameters(
                    host=config.RABBITMQ_HOST,
                    port=5672,
                    credentials=credentials,
                    # üî• FIX CR√çTICO: heartbeat=0 desativa a verifica√ß√£o de pulso.
                    # Isso impede que o RabbitMQ derrube a conex√£o quando o Python
                    # congela momentaneamente processando a imagem pesada ou fazendo upload.
                    heartbeat=0, 
                    blocked_connection_timeout=300
                )
                
                self.connection = pika.BlockingConnection(parameters)
                self.channel = self.connection.channel()
                
                # Garante que a fila existe (durable=True para persist√™ncia)
                self.channel.queue_declare(queue=config.QUEUE_NAME, durable=True)
                
                print(f"‚úÖ [RabbitMQ] Conectado em {config.RABBITMQ_HOST}")
                return # Sai do loop se conectar com sucesso
                
            except Exception as e:
                print(f"‚ùå [RabbitMQ] Erro de conex√£o: {e}. Tentando em 5s...")
                time.sleep(5)

    def send_event(self, payload):
        """Envia mensagem com resili√™ncia: se falhar, reconecta e tenta de novo"""
        max_retries = 3
        
        for attempt in range(max_retries):
            try:
                # Verifica se precisa reconectar antes de tentar enviar
                if self.connection is None or self.connection.is_closed:
                    print("‚ö†Ô∏è [RabbitMQ] Conex√£o fechada/perdida. Reconectando...")
                    self.connect()

                self.channel.basic_publish(
                    exchange='',
                    routing_key=config.QUEUE_NAME,
                    body=json.dumps(payload),
                    properties=pika.BasicProperties(
                        delivery_mode=2,  # Mensagem persistente (salva em disco)
                    )
                )
                
                # Se chegou aqui, enviou com sucesso
                print(f"üì§ [RabbitMQ] Evento enviado com sucesso!")
                return 

            except (pika.exceptions.ConnectionClosed, pika.exceptions.StreamLostError, Exception) as e:
                print(f"‚ö†Ô∏è [RabbitMQ] Falha ao enviar (Tentativa {attempt+1}/{max_retries}): {e}")
                # For√ßa reset da conex√£o para recriar na pr√≥xima volta do loop
                self.connection = None 
                time.sleep(1)
        
        print("‚ùå [RabbitMQ] ERRO CR√çTICO: Mensagem descartada ap√≥s v√°rias tentativas.")

    def close(self):
        """Encerra a conex√£o de forma limpa (√∫til para o toggle/off)"""
        try:
            if self.connection and not self.connection.is_closed:
                self.connection.close()
                print("üîå [RabbitMQ] Conex√£o encerrada.")
        except Exception:
            pass
</file>

<file path="vision-agent/storage.py">
from minio import Minio
import io
import config
import json  # Import necess√°rio para criar a pol√≠tica

class MinioClient:
    def __init__(self):
        self.client = None
        try:
            # Acessando direto de config.VARIAVEL
            self.client = Minio(
                config.MINIO_ENDPOINT,
                access_key=config.MINIO_ACCESS_KEY,
                secret_key=config.MINIO_SECRET_KEY,
                secure=False
            )
            
            # Garante que o bucket existe
            bucket = config.MINIO_BUCKET
            if not self.client.bucket_exists(bucket):
                self.client.make_bucket(bucket)
                print(f"‚úÖ [MinIO] Bucket '{bucket}' criado.")
                # Se acabou de criar, aplica a pol√≠tica
                self._set_public_policy(bucket)
            else:
                # Mesmo se j√° existe, reaplica a pol√≠tica para corrigir buckets antigos
                self._set_public_policy(bucket)
            
        except Exception as e:
            print(f"‚ùå [MinIO] Erro ao conectar: {e}")

    def _set_public_policy(self, bucket_name):
        """
        Define o bucket como READ-ONLY para o mundo (P√∫blico).
        Isso permite acessar a imagem direto pela URL sem login/assinatura.
        """
        try:
            policy = {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {"AWS": ["*"]}, # "*" significa qualquer um (p√∫blico)
                        "Action": ["s3:GetObject"],   # Apenas permiss√£o de LEITURA
                        "Resource": [f"arn:aws:s3:::{bucket_name}/*"] # Em todos os arquivos
                    }
                ]
            }
            self.client.set_bucket_policy(bucket_name, json.dumps(policy))
            print(f"üîì [MinIO] Pol√≠tica p√∫blica aplicada ao bucket '{bucket_name}'")
        except Exception as e:
            print(f"‚ö†Ô∏è [MinIO] Falha ao aplicar pol√≠tica p√∫blica: {e}")

    def upload_frame(self, frame_bytes, filename):
        if not self.client:
            return None
            
        try:
            # Se frame_bytes for numpy array (imagem OpenCV), converte para bytes
            import numpy as np
            import cv2
            if isinstance(frame_bytes, np.ndarray):
                ret, buffer = cv2.imencode('.jpg', frame_bytes)
                if ret:
                    frame_bytes = buffer.tobytes()

            # Prepara o stream
            data_stream = io.BytesIO(frame_bytes)
            file_size = len(frame_bytes)
            
            # Upload
            self.client.put_object(
                config.MINIO_BUCKET,
                filename,
                data_stream,
                file_size,
                content_type='image/jpeg'
            )
            
            # Retorna a URL p√∫blica
            return f"{config.MINIO_EXTERNAL_PREFIX}/{config.MINIO_BUCKET}/{filename}"
            
        except Exception as e:
            print(f"‚ùå [MinIO] Erro upload: {e}")
            return None
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/RabbitMQConfig.java">
package com.safevision.alertservice.config;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;
import org.springframework.amqp.support.converter.MessageConverter;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * Configuration class for RabbitMQ infrastructure in the Alert Service.
 * Defines queues and message converters.
 */
@Slf4j
@Configuration
@RequiredArgsConstructor
@EnableConfigurationProperties(RabbitQueueProperties.class) 
public class RabbitMQConfig {

    private final RabbitQueueProperties queueProperties;

    /**
     * Exposes the alert queue name as a String Bean.
     * Useful for SpEL expressions in @RabbitListener.
     */
    @Bean
    public String alertsQueueName() {
        return queueProperties.alerts();
    }

    /**
     * Declares the physical Queue in RabbitMQ.
     * Marked as durable so messages persist if the broker restarts.
     */
    @Bean
    public Queue alertsQueue() {
        log.info("Configuring RabbitMQ Queue: {}", queueProperties.alerts());
        return new Queue(queueProperties.alerts(), true);
    }

    /**
     * Configures the Jackson converter to serialize/deserialize messages as JSON.
     * This allows interoperability between Python (producer) and Java (consumer).
     */
    @Bean
    public MessageConverter jsonMessageConverter() {
        return new Jackson2JsonMessageConverter();
    }
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/config/SecurityConfig.java">
package com.safevision.alertservice.config;

import java.util.List;

import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;

import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * Security configuration class for the Alert Service.
 * <p>
 * This configuration handles:
 * <ul>
 * <li>Stateless Session Management (JWT based)</li>
 * <li>CORS Configuration (Critical for WebSocket via Gateway)</li>
 * <li>Endpoint Authorization (Public vs Protected)</li>
 * </ul>
 * </p>
 */
@Slf4j
@Configuration
@EnableWebSecurity
@EnableMethodSecurity // Enables @PreAuthorize support at method level
@RequiredArgsConstructor
@EnableConfigurationProperties(JwtProperties.class)
public class SecurityConfig {

    private final JwtProperties jwtProperties;

    /**
     * List of endpoints that bypass authentication.
     * Note: "/ws/**" is critical for the initial WebSocket Handshake.
     */
    private static final String[] PUBLIC_ENDPOINTS = {
        "/v3/api-docs/**",
        "/swagger-ui/**",
        "/swagger-ui.html",
        "/actuator/**", // Health checks
        "/ws/**",
        "/alert/ws/**"
    };

    /**
     * Configures the HTTP security filter chain.
     *
     * @param http The HttpSecurity builder.
     * @return The built SecurityFilterChain.
     * @throws Exception If an error occurs during configuration.
     */
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        log.info("üîí Initializing Security Filter Chain for Alert Service...");

        http
            // 1. Disable CSRF (Not needed for stateless APIs)
            .csrf(AbstractHttpConfigurer::disable)
            
            // 2. Enable CORS (Cross-Origin Resource Sharing)
            // This is required because the Gateway/Frontend runs on a different port/origin logic
            .cors(AbstractHttpConfigurer::disable)
            
            // 3. Configure Stateless Session
            .sessionManagement(sess -> sess.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            
            // 4. Define Route Authorization
            .authorizeHttpRequests(auth -> auth
                .requestMatchers(PUBLIC_ENDPOINTS).permitAll() // Allow Handshake
                .anyRequest().authenticated()                  // All other API calls need JWT
            )
            
            // 5. Configure OAuth2 Resource Server (JWT)
            .oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()));

        return http.build();
    }

    /**
     * Configures CORS settings to allow WebSocket connections from the Gateway/Frontend.
     * * @return The CORS configuration source.
     */
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        
        // Allow all origins (In production, replace "*" with specific Gateway URL)
        configuration.setAllowedOriginPatterns(List.of("*")); 
        
        // Allow standard HTTP methods
        configuration.setAllowedMethods(List.of("GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"));
        
        // Allow all headers (Authorization, Content-Type, etc.)
        configuration.setAllowedHeaders(List.of("*"));
        
        // Critical for WebSocket: Allow credentials (cookies/auth headers)
        configuration.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }

    /**
     * Configures the JWT Decoder using the symmetric secret key.
     * * @return The JwtDecoder instance.
     */
    @Bean
    public JwtDecoder jwtDecoder() {
        byte[] keyBytes = jwtProperties.secret().getBytes();
        SecretKey originalKey = new SecretKeySpec(keyBytes, 0, keyBytes.length, "HmacSHA256");
        
        return NimbusJwtDecoder.withSecretKey(originalKey).build();
    }
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/service/TelephonyService.java">
package com.safevision.alertservice.service;

import com.safevision.alertservice.config.TelephonyProperties;
import com.safevision.alertservice.dto.AlertEventDTO;
import com.safevision.alertservice.dto.UserContactDTO;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestClient;
import org.springframework.web.client.RestTemplate;

import java.nio.charset.StandardCharsets;
import java.util.Base64;

@Slf4j
@Service
@EnableConfigurationProperties(TelephonyProperties.class) // Habilita o uso do Record
public class TelephonyService {

    private final RestTemplate twilioClient;
    private final RestClient authServiceClient;
    private final TelephonyProperties props;

    public TelephonyService(RestTemplate restTemplate, 
                            RestClient.Builder restClientBuilder, 
                            TelephonyProperties props) {
        this.twilioClient = restTemplate;
        this.props = props;
        this.authServiceClient = restClientBuilder.baseUrl("http://auth-service:8080").build();
    }

    /**
     * Orchestrates the sending of a critical SMS.
     * Steps: Validate -> Fetch Contact -> Build Request -> Send.
     */
    public void sendCriticalSms(AlertEventDTO alert) {
        if (!"CRITICAL".equalsIgnoreCase(alert.severity())) {
            return;
        }

        log.info("üö® Initiating Critical SMS sequence for event: {}", alert.alertType());

        // 1. Determine Target Phone Number
        String targetPhone = resolveUserPhoneNumber(alert.userId());
        
        // 2. Build Message
        String messageBody = """
            ALERTA CR√çTICO SAFEVISION
            Tipo: %s
            Descri√ß√£o: %s
            C√¢mera: %s
            A√á√ÉO IMEDIATA NECESS√ÅRIA!
            """.formatted(alert.alertType(), alert.description(), alert.cameraId());

        // Debug Log (Mock)
        logMockMessage(targetPhone, messageBody);

        // 3. Send Real SMS (Twilio)
        //executeTwilioRequest(targetPhone, messageBody);
        //sendSmsWithImage(targetPhone, messageBody, alert.snapshotUrl());
    }

    /**
     * Fetches user contact info from Auth Service via HTTP.
     * Falls back to the default system number if user is not found or service is down.
     */
    private String resolveUserPhoneNumber(String username) {
        try {
            var contact = authServiceClient.get()
                    .uri("/auth/contact/{username}", username)
                    .retrieve()
                    .body(UserContactDTO.class);

            if (contact != null && contact.phoneNumber() != null) {
                return contact.phoneNumber();
            }
        } catch (Exception e) {
            log.warn("‚ö†Ô∏è Could not fetch user contact from Auth Service: {}. Using fallback.", e.getMessage());
        }
        
        log.info("Using fallback system phone number.");
        return props.toNumber();
    }

    /**
     * Encapsulates the complexity of the Twilio API call.
     */
    private void executeTwilioRequest(String to, String body) {
        try {
            var headers = createTwilioHeaders();
            var payload = createTwilioPayload(to, body);
            var request = new HttpEntity<>(payload, headers);

            var response = twilioClient.exchange(
                props.baseUrl(),
                HttpMethod.POST,
                request,
                String.class
            );

            if (response.getStatusCode().is2xxSuccessful()) {
                log.info("‚úÖ SMS successfully sent to {}", to);
            } else {
                log.error("‚ùå Twilio API failed with status: {}", response.getStatusCode());
            }
        } catch (Exception e) {
            log.error("‚ùå Critical error sending SMS: {}", e.getMessage());
        }
    }

    private HttpHeaders createTwilioHeaders() {
        var headers = new HttpHeaders();
        String auth = props.accountSid() + ":" + props.authToken();
        String encodedAuth = Base64.getEncoder().encodeToString(auth.getBytes(StandardCharsets.UTF_8));
        
        headers.set("Authorization", "Basic " + encodedAuth);
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        return headers;
    }

    private MultiValueMap<String, String> createTwilioPayload(String to, String body) {
        var map = new LinkedMultiValueMap<String, String>();
        map.add("To", to);
        map.add("From", props.fromNumber());
        map.add("Body", body);
        return map;
    }
    /**
     * Sends an SMS/MMS with an image attachment (MediaUrl).
     * Twilio automatically converts to MMS when MediaUrl is provided.
     */
    public void sendSmsWithImage(String userId, String message, String imageUrl) {

        log.info("üì∏ Sending image MMS to user {} with image: {}", userId, imageUrl);

        // 1. Resolve phone number
        String targetPhone = resolveUserPhoneNumber(userId);

        // 2. Build Twilio message
        try {
            var headers = createTwilioHeaders();

            var payload = new LinkedMultiValueMap<String, String>();
            payload.add("To", targetPhone);
            payload.add("From", props.fromNumber());
            payload.add("Body", message);
            payload.add("MediaUrl", imageUrl); // <-- AQUI adiciona a foto

            var request = new HttpEntity<>(payload, headers);

            var response = twilioClient.exchange(
                    props.baseUrl(),
                    HttpMethod.POST,
                    request,
                    String.class
            );

            if (response.getStatusCode().is2xxSuccessful()) {
                log.info("‚úÖ MMS sent successfully to {}", targetPhone);
            } else {
                log.error("‚ùå Twilio returned error: {}", response.getStatusCode());
            }

        } catch (Exception e) {
            log.error("‚ùå Error sending MMS: {}", e.getMessage());
        }
    }


    private void logMockMessage(String phone, String message) {
        log.debug("\n=== [SMS MOCK] ===\nTo: {}\nMsg: {}\n==================", phone, message);
    }
}
</file>

<file path="alert-service/src/main/resources/application.yml">
server:
  port: 8080 

spring:
  application:
    name: alert-service
  flyway:
    enabled: true
    locations: classpath:db/migration
  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}      
    port: 5672
    username: ${RABBITMQ_USERNAME:user}
    password: ${RABBITMQ_PASSWORD:password}
    queues:
      alerts: ${ALERTS_QUEUE_NAME:safevision.alerts}

  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/safevision}
    username: ${SPRING_DATASOURCE_USERNAME:user}
    password: ${SPRING_DATASOURCE_PASSWORD:pass}
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: update 
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect

  # --- NOVO: CONFIGURA√á√ÉO SMTP (GMAIL) ---
  mail:
    host: ${SPRING_MAIL_HOST:smtp.gmail.com}
    port: ${SPRING_MAIL_PORT:587}
    username: ${SPRING_MAIL_USERNAME}
    password: ${SPRING_MAIL_PASSWORD}
    properties:
      mail:
        smtp:
          auth: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH:true}
          starttls:
            enable: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE:true}
          # Timeouts para n√£o travar o consumidor RabbitMQ se o Gmail demorar
          connectiontimeout: 5000
          timeout: 5000
          writetimeout: 5000

# --- CONFIGURA√á√ÉO ZIPKIN E METRICAS ---
management:
  endpoints:
    web:
      exposure:
        include: "health,info,prometheus"
  tracing:
    sampling:
      probability: 1.0 
  zipkin:
    tracing:
      endpoint: "http://zipkin:9411/api/v2/spans"

eureka:
  client:
    serviceUrl:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true

safevision:
  jwt:
    secret: ${SAFEVISION_JWT_SECRET:segredo_padrao_apenas_para_desenvolvimento_local_sem_docker}

# --- INTEGRA√á√ÉO 1: TWILIO (SMS/MMS) ---
telephony:
  account-sid: ${TELEPHONY_ACCOUNT_SID} 
  auth-token: ${TELEPHONY_AUTH_TOKEN}   
  from-number: ${TELEPHONY_FROM_NUMBER}
  to-number: ${ALERT_PHONE_NUMBER}
  base-url: https://api.twilio.com/2010-04-01/Accounts/${TELEPHONY_ACCOUNT_SID}/Messages.json

# --- NOVO: INTEGRA√á√ÉO 2: TELEGRAM BOT ---
telegram:
  enabled: ${TELEGRAM_ENABLED:false} # Padr√£o false para n√£o quebrar localmente
  bot-token: ${TELEGRAM_BOT_TOKEN}
  chat-id: ${TELEGRAM_CHAT_ID}

# --- NOVO: INTEGRA√á√ÉO 3: EMAIL ALERTS ---
app:
  email:
    enabled: ${APP_EMAIL_ENABLED:false}

    admin-address: ${APP_EMAIL_ADMIN_ADDRESS}

logging:
  file:
    name: /var/logs/${spring.application.name}.log 
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 7
  level:
    root: INFO
    com.safevision: DEBUG 
    org.springframework.amqp: INFO
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/config/SecurityConfig.java">
package com.safevision.authservice.config;

import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Slf4j
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@RequiredArgsConstructor
@EnableConfigurationProperties(JwtProperties.class)
public class SecurityConfig {

    private final JwtProperties jwtProperties;

    // Removemos a linha 'private final SecretKey key;' pois ela n√£o era um Bean.

    private static final String[] PUBLIC_ENDPOINTS = {
        "/auth/login",
        "/auth/register",
        "/v3/api-docs/**",
        "/swagger-ui/**",
        "/swagger-ui.html"
    };

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        log.info("Initializing Security Filter Chain for Auth Service...");

        http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(auth -> auth
                .requestMatchers(PUBLIC_ENDPOINTS).permitAll()
                .anyRequest().authenticated()
            )
            .sessionManagement(sess -> sess.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()))
            
            // üî• CORRE√á√ÉO: Usamos jwtProperties.secret() diretamente
            // Isso passa a String "404E63..." para o filtro comparar
            .addFilterBefore(
                new InternalKeyFilter(jwtProperties.secret()), 
                UsernamePasswordAuthenticationFilter.class
            );

        return http.build();
    }

    @Bean
    public JwtDecoder jwtDecoder() {
        // Aqui criamos a chave manualmente apenas para o Decoder, sem precisar injetar de fora
        byte[] keyBytes = jwtProperties.secret().getBytes();
        SecretKey originalKey = new SecretKeySpec(keyBytes, 0, keyBytes.length, "HmacSHA256");
        return NimbusJwtDecoder.withSecretKey(originalKey).build();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }

    @Bean
    public AuthenticationProvider authenticationProvider(UserDetailsService userDetailsService, PasswordEncoder passwordEncoder) {
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
        provider.setUserDetailsService(userDetailsService);
        provider.setPasswordEncoder(passwordEncoder);
        return provider;
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(4);
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/service/AuthenticationService.java">
package com.safevision.authservice.service;

import java.io.Serializable;
import java.util.List;
import java.util.stream.Collectors;

import org.apache.commons.lang3.StringUtils;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder; // üëà Import Adicionado
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.safevision.authservice.dto.LoginRequest;
import com.safevision.authservice.dto.RegisterRequest;
import com.safevision.authservice.dto.TokenResponse;
import com.safevision.authservice.dto.UserContactDTO;
import com.safevision.authservice.dto.UserProfileDTO;
import com.safevision.authservice.dto.UserResponse;
import com.safevision.authservice.dto.UserUpdateRequest;
import com.safevision.authservice.model.AlertPreference;
import com.safevision.authservice.model.User;
import com.safevision.common.enums.AlertType;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class AuthenticationService {

    private final UserService userService;
    private final JwtService jwtService;
    private final AuthenticationManager authenticationManager;
    private final PasswordEncoder passwordEncoder; // üëà Inje√ß√£o Obrigat√≥ria para o updateUser funcionar

    /**
     * DTO interno para enviar a mensagem ao Python (se necess√°rio futuramente)
     */
    public record CameraConfigMessage(String action, String userId, String cameraUrl) implements Serializable {}

    public UserResponse register(RegisterRequest request) {
        log.info("Processing registration for username: {}", request.username());
        User user = userService.createUser(request);
        
        log.info("User registered successfully. ID: {}", user.getId());
        return new UserResponse(user.getId(), user.getUsername(), user.getRoles());
    }

    public TokenResponse login(LoginRequest request) {
        Authentication auth = authenticationManager.authenticate(
            new UsernamePasswordAuthenticationToken(request.username(), request.password())
        );
        UserDetails userDetails = (UserDetails) auth.getPrincipal();
        User user = userService.getUserByUsername(userDetails.getUsername());
        String token = jwtService.generateToken(user);
        
        return new TokenResponse(token);
    }
    
    public String getUserCameraUrl(String username) {
        User user = userService.getUserByUsername(username);
        return user.getCameraConnectionUrl();
    }

    public UserContactDTO getUserContact(String username) {
        User user = userService.getUserByUsername(username);
        return new UserContactDTO(
            user.getId(),
            user.getUsername(),
            user.getPhoneNumber(),
            user.getEmail()
        );
    }

    /**
     * Atualiza o perfil do usu√°rio, incluindo prefer√™ncias de alerta (One-To-Many).
     */
    @Transactional
    public UserResponse updateUser(String username, UserUpdateRequest request) {
        log.info("Processing update request for user: {}", username);

        // 1. Busca Entidade Gerenciada (Managed State)
        User currentUser = userService.getUserByUsername(username);

        // 2. Atualiza√ß√£o de E-mail (Com Trim e Null Check do Commons Lang)
        if (StringUtils.isNotBlank(request.email())) {
            // Trim remove espa√ßos acidentais no in√≠cio/fim
            currentUser.setEmail(request.email().trim());
        }

        // 3. Atualiza√ß√£o de Telefone
        if (StringUtils.isNotBlank(request.phoneNumber())) {
            currentUser.setPhoneNumber(request.phoneNumber().trim());
        }

        // 4. Atualiza√ß√£o de C√¢mera
        // Aqui usamos stripToNull: se vier vazio ou espa√ßos, vira null no banco (limpa o campo)
        if (request.cameraConnectionUrl() != null) {
             currentUser.setCameraConnectionUrl(StringUtils.stripToNull(request.cameraConnectionUrl()));
        }

        // 5. Atualiza√ß√£o de Senha (CR√çTICO)
        if (StringUtils.isNotBlank(request.password())) {
            String rawPassword = request.password().trim();
            
            // Valida√ß√£o simples (pode ser expandida)
            if (rawPassword.length() < 6) {
                throw new IllegalArgumentException("A nova senha deve ter no m√≠nimo 6 caracteres.");
            }

            // CRIPTOGRAFIA ACONTECE AQUI (E S√ì AQUI)
            String encodedPassword = passwordEncoder.encode(rawPassword);
            currentUser.setPassword(encodedPassword);
            
            log.info("Password updated for user: {}", username);
        }

        // 6. Atualiza√ß√£o de Prefer√™ncias (One-To-Many)
        if (request.alertPreferences() != null) {
            // Limpa a cole√ß√£o existente (n√£o substitua a inst√¢ncia da lista para manter o Hibernate feliz)
            currentUser.getAlertPreferences().clear();

            if (!request.alertPreferences().isEmpty()) {
                request.alertPreferences().forEach(type -> {
                    AlertPreference pref = AlertPreference.builder()
                            .user(currentUser)
                            .alertType(type)
                            .build();
                    currentUser.getAlertPreferences().add(pref);
                });
            }
        }

        // 7. Chama o Executor para validar integridade e salvar
        User savedUser = userService.saveUser(currentUser);

        return new UserResponse(
            savedUser.getId(),
            savedUser.getUsername(),
            savedUser.getRoles()
        );
    }

    


    public UserProfileDTO getUserProfile(String username) {
        User user = userService.getUserByUsername(username);
        
       
        List<AlertType> prefs = (user.getAlertPreferences() == null) ? List.of() :
            user.getAlertPreferences().stream()
                .map(AlertPreference::getAlertType)
                .collect(Collectors.toList());

        return new UserProfileDTO(
            user.getId(),
            user.getUsername(),
            user.getEmail(),
            user.getPhoneNumber(),
            user.getCameraConnectionUrl(), 
            prefs
        );
    }
    
    
    

    public List<AlertType> getAlertPreferences(String username) {
        User user = userService.getUserByUsername(username);
        
        if (user.getAlertPreferences() == null) {
            return List.of();
        }

        // TRANSFORMA√á√ÉO:
        // Pega a lista de Entidades (AlertPreference) -> Extrai apenas o Enum (AlertType)
        return user.getAlertPreferences().stream()
                .map(AlertPreference::getAlertType)
                .collect(Collectors.toList());
    }
}
</file>

<file path="gateway-service/src/main/java/com/safevision/gatewayservice/config/CorsGlobalConfig.java">
package com.safevision.gatewayservice.config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.reactive.CorsConfigurationSource;
import org.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource;

import java.util.List;

/**
 * Global CORS configuration for the API Gateway.
 */
@Slf4j
@Configuration
public class CorsGlobalConfig {

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        log.info("Initializing Global CORS Configuration (WebSocket Compatible)...");

        CorsConfiguration config = new CorsConfiguration();

      
        config.setAllowedOriginPatterns(List.of("*"));

        // 2. Permitir Credenciais √© OBRIGAT√ìRIO para sess√µes WebSocket/STOMP est√°veis
        config.setAllowCredentials(true); 

        config.setAllowedMethods(List.of(
            HttpMethod.GET.name(),
            HttpMethod.POST.name(),
            HttpMethod.PUT.name(),
            HttpMethod.PATCH.name(),
            HttpMethod.DELETE.name(),
            HttpMethod.OPTIONS.name()
        ));

        config.setAllowedHeaders(List.of("*"));
        config.setExposedHeaders(List.of("Authorization", "Link", "X-Total-Count"));

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);

        return source;
    }
}
</file>

<file path="gateway-service/src/main/java/com/safevision/gatewayservice/GatewayServiceApplication.java">
package com.safevision.gatewayservice;

import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.EnableConfigurationProperties;

/**
 * Entry point for the API Gateway Service.
 * <p>
 * This microservice acts as the single entry point (Edge Server) for all external traffic.
 * Its responsibilities include:
 * <ul>
 * <li><b>Routing:</b> Forwarding requests to Auth, Alert, or Recognition services based on the URL path.</li>
 * <li><b>Security:</b> Validating JWT Tokens before requests reach the internal services.</li>
 * <li><b>Resilience:</b> Implementing Circuit Breakers to prevent cascading failures.</li>
 * <li><b>Load Balancing:</b> Distributing traffic via Eureka Service Discovery.</li>
 * </ul>
 * </p>
 */
@Slf4j
@SpringBootApplication
@EnableConfigurationProperties // Enables support for Type-Safe Configuration (Records)
public class GatewayServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(GatewayServiceApplication.class, args);
        log.info("üöÄ API Gateway started successfully on Java 21!");
    }
}
</file>

<file path="gateway-service/src/main/resources/application.yml">
server:
  port: 8080

spring:
  application:
    name: gateway-service
  
  cloud:
    gateway:
      discovery:
        locator:
          enabled: false 
          lower-case-service-id: true
      
      # Timeout da conex√£o HTTP
      httpclient:
        connect-timeout: 5000
        response-timeout: 20000 

      # --- FILTROS PADR√ÉO (Aplicados a todas as rotas) ---
      default-filters:
        # üëá 1. LIMPEZA DE CORS DUPLICADO (Novo)
        # Remove cabe√ßalhos duplicados vindos dos microsservi√ßos para evitar conflito com sua classe Java
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST
        
        # üëá 2. RETRY (Ajustado)
        - name: Retry
          args:
            retries: 3
            # Sem NOT_FOUND para login r√°pido
            statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,INTERNAL_SERVER_ERROR,SERVICE_UNAVAILABLE
            methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
            backoff:
              firstBackoff: 500ms 
              maxBackoff: 2000ms
              factor: 2
              basedOnPreviousValue: false

      routes:
        # --- AUTH SERVICE ---
        - id: auth-service-swagger
          uri: ${safevision.services.auth}
          predicates:
            - Path=/aggregate/auth-service/v3/api-docs
          filters:
            - RewritePath=/aggregate/auth-service/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback

        - id: auth-service
          uri: ${safevision.services.auth}
          predicates:
            - Path=/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback

        # --- ALERT SERVICE ---
        - id: alert-websocket
          uri: ${safevision.services.alert}
          predicates:
            - Path=/alert/ws/**
          filters:
            - RewritePath=/alert/ws/(?<segment>.*), /ws/${segment}
            - SaveSession
            # Headers essenciais para o Handshake WebSocket passar pelo Gateway
            - SetRequestHeader=Upgrade, websocket
            - SetRequestHeader=Connection, Upgrade

        - id: alert-service-swagger
          uri: ${safevision.services.alert}
          predicates:
            - Path=/aggregate/alert-service/v3/api-docs
          filters:
            - RewritePath=/aggregate/alert-service/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: alertServiceCircuitBreaker
                fallbackUri: forward:/fallback

        - id: alert-service
          uri: ${safevision.services.alert}
          predicates:
            - Path=/alert/**
          filters:
            - name: CircuitBreaker
              args:
                name: alertServiceCircuitBreaker
                fallbackUri: forward:/fallback

        # --- RECOGNITION SERVICE ---
        - id: recognition-service-swagger
          uri: ${safevision.services.recognition}
          predicates:
            - Path=/aggregate/recognition-service/v3/api-docs
          filters:
            - RewritePath=/aggregate/recognition-service/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: recognitionServiceCircuitBreaker
                fallbackUri: forward:/fallback

        - id: recognition-service
          uri: ${safevision.services.recognition}
          predicates:
            - Path=/recognition/**
          filters:
            - name: CircuitBreaker
              args:
                name: recognitionServiceCircuitBreaker
                fallbackUri: forward:/fallback

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://localhost:8761/eureka/}
    enabled: true
    register-with-eureka: true
    fetch-registry: true

safevision:
  services:
    auth: ${SAFEVISION_SERVICES_AUTH:lb://auth-service}
    alert: ${SAFEVISION_SERVICES_ALERT:lb://alert-service}
    recognition: ${SAFEVISION_SERVICES_RECOGNITION:lb://recognition-service}
  jwt:
    secret: ${SAFEVISION_JWT_SECRET:segredo_padrao_apenas_para_desenvolvimento_local_sem_docker}

resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        permittedNumberOfCallsInHalfOpenState: 3
        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.client.HttpServerErrorException
    instances:
      authServiceCircuitBreaker:
        baseConfig: default
      alertServiceCircuitBreaker:
        baseConfig: default
      recognitionServiceCircuitBreaker:
        baseConfig: default
  
  timelimiter:
    configs:
      default:
        timeoutDuration: 20s
        cancelRunningFuture: true

management:
  endpoints:
    web:
      exposure:
        include: "health,info,prometheus,metrics,gateway"
  tracing:
    sampling:
      probability: 1.0
  zipkin:
    tracing:
      endpoint: "http://zipkin:9411/api/v2/spans"

metrics:
    tags:
      application: ${spring.application.name}

logging:
  file:
    name: /var/logs/${spring.application.name}.log 
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 7
  level:
    root: INFO
    org.springframework.cloud.gateway: INFO 
    com.safevision: DEBUG
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?><project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0                              http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.3.4</version>
    <relativePath/>
  </parent>
  <groupId>com.safevision</groupId>
  <artifactId>safevision-modular</artifactId>
  <version>1.0.0</version>
  <packaging>pom</packaging>
  <modules>
    <module>eureka-server</module>
    <module>auth-service</module>
    <module>alert-service</module>
    <module>recognition-service</module>
    <module>gateway-service</module>
    <module>common</module>
  </modules>
  <properties>
    <java.version>21</java.version>
    <spring-cloud.version>2023.0.3</spring-cloud.version>
    <lombok.version>1.18.30</lombok.version>
  </properties>
  <dependencies>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <optional>true</optional>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-test</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
      <groupId>io.micrometer</groupId>
      <artifactId>micrometer-tracing-bridge-brave</artifactId>
    </dependency>
    <dependency>
      <groupId>io.zipkin.reporter2</groupId>
      <artifactId>zipkin-reporter-brave</artifactId>
    </dependency>
  </dependencies>
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-dependencies</artifactId>
        <version>${spring-cloud.version}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>
</project>
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/dto/AlertEventDTO.java">
package com.safevision.recognitionservice.dto;

import java.math.BigDecimal;

/**
 * Data Transfer Object (DTO) representing an Alert Event.
 * <p>
 * This object acts as the contract between the Recognition Service (Producer)
 * and the Alert Service (Consumer). It carries the threat analysis results
 * and the evidence link.
 * </p>
 *
 * @param userId      The UUID of the user who owns the monitoring session.
 * @param alertType   The classification of the event (e.g., "WEAPON_DETECTED", "THREAT_STARE").
 * @param description A human-readable description of what happened.
 * @param severity    The risk level (INFO, WARNING, CRITICAL).
 * @param cameraId    The identifier of the camera (physical or virtual) that captured the event.
 * @param snapshotUrl The public URL pointing to the evidence image stored in MinIO (can be null).
 */
public record AlertEventDTO(
	    
	    String userId,
	    String alertType,
	    String description,
	    String severity,
	    String cameraId,
	    String snapshotUrl,
	    BigDecimal latitude,
	    BigDecimal longitude,
	    String address // üìç Novo campo
) {}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/service/ThreatAnalysisService.java">
package com.safevision.recognitionservice.service;

import com.safevision.recognitionservice.dto.AlertEventDTO;
import com.safevision.recognitionservice.dto.RawTrackingEvent;
import com.safevision.recognitionservice.producer.AlertProducer;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Core Logic Service (The "Brain" of Recognition).
 * <p>
 * Analyzes raw tracking telemetry received from the Vision Agent (Edge)
 * and applies security rules (Business Logic) to determine if a critical
 * alert should be triggered.
 * </p>
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class ThreatAnalysisService {

    private final AlertProducer alertProducer;
    private final MovementHistoryService historyService;

    // --- STATE VARIABLES ---
    
    // Rule 1: Stare Counter (Persistence of Vision)
    private final Map<String, Integer> stareCountMap = new ConcurrentHashMap<>();
    
    // ‚ö†Ô∏è AJUSTE: Python roda a 0.5s (2 FPS). 
    // Para 5 segundos de detec√ß√£o: 5s / 0.5s = 10 frames.
    private static final int STARE_THRESHOLD = 10; 

    // Rule 2: Loitering Configurations
    // Janela de hist√≥rico ajustada para 5 segundos (10 frames)
    private static final int LOITERING_WINDOW = 10;
    private static final int PROXIMITY_DIFFERENCE = 15;

    // --- VISUAL MEMORY (EVIDENCE CACHE) ---
    // Stores the last valid snapshot URL for a detection ID.
    // Resolves the issue where some frames might detect a threat but fail to upload an image.
    private final Map<String, String> evidenceCache = new ConcurrentHashMap<>();

    /**
     * Main entry point for event analysis.
     * Orchestrates the execution of all security rules.
     *
     * @param event The raw tracking data from the Vision Agent.
     */
    public void analyze(RawTrackingEvent event) {
        if (event == null) return;
        
        String id = event.detectionId();
        log.trace("Analyzing event for ID: {}", event.detectionId());
        
        // 1. UPDATE EVIDENCE CACHE
        // If this packet contains a snapshot, save it as the "best evidence so far".
        if (event.snapshotUrl() != null && !event.snapshotUrl().isEmpty()) {
            evidenceCache.put(id, event.snapshotUrl());
            log.debug("üì∏ Evidence cached for ID: {}", id);
        }

        // 2. Rule: Weapon Detection (Highest Priority)
        analyzeWeaponRule(event);

        // 3. Rule: Persistent Stare (Behavioral)
        analyzeStareRule(event);

        // 4. Rule: Loitering / Approach (Behavioral)
        analyzeLoiteringRule(event);
        
        // Note: Cache cleanup should happen when object leaves the scene.
        // For MVP, we clean up when an alert is triggered or state resets.
    }

    // ==============================================================
    // RULE 0: WEAPON DETECTION
    // ==============================================================
    private void analyzeWeaponRule(RawTrackingEvent event) {
        if (event.hasWeapon()) {
            log.warn("üî´ WEAPON DETECTED! ID: {}", event.detectionId());
            sendCriticalAlert(
                event,
                event.weaponType() +"_DETECTADA",
                event.weaponType() + " foi localizada na " + event.weaponLocation()
            );
        }
    }

    // ==============================================================
    // RULE 1: STARE DETECTION
    // ==============================================================
    private void analyzeStareRule(RawTrackingEvent event) {
        String id = event.detectionId();

        if (event.isFacingCamera()) {
            // Incrementa o contador para este ID
            int currentCount = stareCountMap.merge(id, 1, Integer::sum);

            if (currentCount >= STARE_THRESHOLD) {
                log.warn("üëÅÔ∏è Persistent Stare Detected! ID: {}", id);
                
                // ‚ö†Ô∏è AJUSTE: C√°lculo de tempo baseado no intervalo de 0.5s
                double seconds = STARE_THRESHOLD * 0.5; 
                
                sendCriticalAlert(
                    event,
                    "OBSERVACAO_DETECTADA",
                    "Pessoa te observou por " + seconds + " segundos."
                );

                // Reset and Cleanup
                stareCountMap.remove(id);
                evidenceCache.remove(id); // Consume evidence
            }
        } else {
            // Reset counter if eye contact is broken
            stareCountMap.remove(id);
        }
    }

    // ==============================================================
    // RULE 2: LOITERING / APPROACH
    // ==============================================================
    private void analyzeLoiteringRule(RawTrackingEvent event) {
        historyService.recordEvent(event);
        
        String id = event.detectionId();
        List<Integer> depths = historyService.getDepths(id);

        if (depths.size() < LOITERING_WINDOW) return;

        int currentDepth = depths.get(0); 
        int initialDepth = depths.get(LOITERING_WINDOW - 1); 
        boolean isApproaching = (currentDepth - initialDepth) >= PROXIMITY_DIFFERENCE;

        if (isApproaching) {
            log.warn("üö∂ Threat Approaching! ID: {}", id);

            sendCriticalAlert(
                event,
                "PESSOA_APROXIMANDO",
                "Pessoa que est√° rondando e se aproximando rapidamente do per√≠metro de seguran√ßa."
            );

            historyService.clearHistory(id);
            evidenceCache.remove(id); 
        }
    }

    // ==============================================================
    // UNIFIED ALERT DISPATCHER
    // ==============================================================
    /**
     * Constructs the Alert DTO using the current event data and cached evidence,
     * then dispatches it to the Message Broker.
     */
    private void sendCriticalAlert(RawTrackingEvent event, String type, String description) {
        
        // 1. Try to get the snapshot from the current event
        String finalSnapshotUrl = event.snapshotUrl();

        // 2. If null, fallback to the Evidence Cache (best photo from previous frames)
        if (finalSnapshotUrl == null || finalSnapshotUrl.isEmpty()) {
            finalSnapshotUrl = evidenceCache.get(event.detectionId());
            if (finalSnapshotUrl != null) {
                log.info("üìé Attached cached evidence to alert: {}", finalSnapshotUrl);
            }
        }

        // 3. Create DTO with new GPS fields
        // Note: 'address' is null here because it's resolved asynchronously by the Alert Service later.
        AlertEventDTO finalAlert = new AlertEventDTO(
            event.userId(),
            type,
            description,
            "CRITICAL",
            event.cameraId(),
            finalSnapshotUrl, // Best available evidence
            event.latitude(), // üìç GPS Latitude from Python
            event.longitude(),// üìç GPS Longitude from Python
            null              // Address (to be resolved by Alert Service)
        );
        
        alertProducer.sendAlert(finalAlert);
    }
}
</file>

<file path="recognition-service/src/main/resources/application.yml">
server:
  port: 8080 

spring:
  application:
    name: recognition-service

  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}      
    port: 5672
    username: ${RABBITMQ_USERNAME:user}
    password: ${RABBITMQ_PASSWORD:password}
    queues:
      raw-tracking: ${VISION_QUEUE_NAME:safevision.vision.raw.tracking} 
      alerts: ${ALERTS_QUEUE_NAME:safevision.alerts}

# --- CONFIGURA√á√ÉO ZIPKIN E METRICAS ---
management:
  endpoints:
    web:
      exposure:
        include: "health,info,prometheus"
  tracing:
    sampling:
      probability: 1.0 
  zipkin:
    tracing:
      endpoint: "http://zipkin:9411/api/v2/spans"

eureka:
  client:
    serviceUrl:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true

safevision:
  services:
    alert: ${SAFEVISION_SERVICES_ALERT:http://alert-service:8080}
  jwt:
    secret: ${SAFEVISION_JWT_SECRET:segredo_padrao_apenas_para_desenvolvimento_local_sem_docker}

logging:
  file:
    name: /var/logs/${spring.application.name}.log 
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 7
  level:
    root: INFO
    com.safevision: DEBUG 
    org.springframework.amqp: INFO
</file>

<file path="alert-service/pom.xml">
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="
            http://maven.apache.org/POM/4.0.0
            http://maven.apache.org/xsd/maven-4.0.0.xsd">

    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.safevision</groupId>
        <artifactId>safevision-modular</artifactId>
        <version>1.0.0</version>
        <relativePath>../pom.xml</relativePath>
    </parent>

    <artifactId>alert-service</artifactId>
    <packaging>jar</packaging>
	<dependencyManagement>
    	<dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>2023.0.3</version> <!-- exemplo -->
            <type>pom</type>
            <scope>import</scope>
        	</dependency>
    	</dependencies>
	</dependencyManagement>
  

    <dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-amqp</artifactId>
		</dependency>
		<dependency>
		  <groupId>org.springframework.boot</groupId>
		  <artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		
		<dependency>
		  <groupId>org.postgresql</groupId>
		  <artifactId>postgresql</artifactId>
		  
		</dependency>
		
		<!-- Web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- Eureka Client -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>

      
	    <dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-security</artifactId>
		</dependency>
		<dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
		</dependency>
		<dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-websocket</artifactId>
		</dependency>
		<dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-mail</artifactId>
		</dependency>
		<dependency>
	    <groupId>com.safevision.common</groupId>
		    <artifactId>common</artifactId>
	    	<version>1.0.0</version>
		</dependency>
		
		<dependency>
		    <groupId>org.springframework.cloud</groupId>
		    <artifactId>spring-cloud-starter-openfeign</artifactId>
		</dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
               
            </plugin>
        </plugins>
    </build>

</project>
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/AlertServiceApplication.java">
package com.safevision.alertservice;

import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.annotation.Bean;
import org.springframework.data.web.config.EnableSpringDataWebSupport;
import org.springframework.web.client.RestTemplate;

@Slf4j
@SpringBootApplication
@EnableFeignClients(basePackages = "com.safevision.alertservice.client")
@EnableSpringDataWebSupport(pageSerializationMode = EnableSpringDataWebSupport.PageSerializationMode.VIA_DTO)
public class AlertServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(AlertServiceApplication.class, args);
        log.info("üöÄ Alert Service started successfully!");
    }

    /**
     * Bean para comunica√ß√£o HTTP s√≠ncrona.
     * Utilizado pelo TelephonyService para conectar na Twilio.
     */
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/controller/AlertController.java">
package com.safevision.alertservice.controller;

import java.util.List;

import org.springframework.data.domain.Page;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PatchMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.safevision.alertservice.dto.AlertEventDTO;
import com.safevision.alertservice.dto.AlertResponse;
import com.safevision.alertservice.service.AlertService;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * REST Controller for managing Alerts.
 * Exposed via API Gateway.
 * Handles both machine-generated events (fallback/testing) and user interactions.
 */
@Slf4j
@RestController
@RequestMapping("/alert") // Matches Gateway route predicate
@RequiredArgsConstructor
public class AlertController {

    private final AlertService alertService;

    /**
     * Endpoint for internal services or testing tools to push alerts via HTTP.
     * Note: In production, the primary flow is asynchronous via RabbitMQ.
     *
     * @param event The alert data.
     * @return 201 Created if successful, 400 Bad Request if invalid.
     */
    @PostMapping("/event")
    public ResponseEntity<Void> receiveEvent(@RequestBody AlertEventDTO event) {
        log.debug("Received HTTP alert event request: {}", event);

        if (isValidEvent(event)) {
            log.warn("Rejected invalid HTTP alert event: Missing required fields.");
            return ResponseEntity.badRequest().build();
        }

        alertService.createAlert(event);
        log.info("Alert created successfully via HTTP for user: {}", event.userId());

        return ResponseEntity.status(HttpStatus.CREATED).build();
    }

    /**
     * Retrieves alerts for the authenticated user.
     *
     * @param authentication The security context token.
     * @param unreadOnly     Query param to filter only unread alerts.
     * @return List of alerts.
     */
    @GetMapping("/user/{username}")
    public ResponseEntity<List<AlertResponse>> getMyAlerts(
            Authentication authentication,
            @RequestParam(defaultValue = "false") boolean unreadOnly) {

        var userId = authentication.getName();
        log.debug("Fetching alerts for user: {} [UnreadOnly: {}]", userId, unreadOnly);

        var alerts = alertService.getUserAlerts(userId, unreadOnly);

        return ResponseEntity.ok(alerts);
    }

    /**
     * Marks a specific alert as acknowledged (read).
     *
     * @param id             The Alert UUID.
     * @param authentication The security context token.
     * @return 204 No Content if successful, 404 if not found or unauthorized.
     */
    @PatchMapping("/{id}/ack")
    public ResponseEntity<Void> acknowledgeAlert(
            @PathVariable String id,
            Authentication authentication) {

        var userId = authentication.getName();
        log.debug("Request to acknowledge alert ID: {} by user: {}", id, userId);

        boolean success = alertService.acknowledgeAlert(id, userId);

        if (success) {
            log.info("Alert {} acknowledged by user {}", id, userId);
            return ResponseEntity.noContent().build();
        } else {
            log.warn("Failed to acknowledge alert {}. Not found or permission denied.", id);
            return ResponseEntity.status(HttpStatus.NOT_FOUND).build();
        }
    }

    /**
     * Helper method to validate the incoming event DTO.
     */
    private boolean isValidEvent(AlertEventDTO event) {
        return event == null || event.userId() == null || event.alertType() == null;
    }
    
    @GetMapping("/history/{userId}")
    public ResponseEntity<Page<AlertResponse>> getHistory(
            @PathVariable String userId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size
    ) {
        return ResponseEntity.ok(alertService.getUserAlertsPaginated(userId, page, size));
    }
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/model/Alert.java">
package com.safevision.alertservice.model;

import java.math.BigDecimal;
import java.time.LocalDateTime;

import org.hibernate.annotations.CreationTimestamp;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Index;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

/**
 * JPA Entity representing a persisted Security Alert.
 * <p>
 * This class maps to the 'alerts' table in PostgreSQL. It stores the full context
 * of a threat, including the visual evidence (snapshot) and physical location (GPS/Address).
 * </p>
 */
@Entity
@Table(name = "alerts", indexes = {
    @Index(name = "idx_alert_user_id", columnList = "userId"),
    @Index(name = "idx_alert_user_date", columnList = "userId, createdAt DESC")
})
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Alert {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(length = 36)
    private String id;

    @Column(nullable = false)
    private String userId;

    @Column(nullable = false)
    private String alertType;

    @Column
    private String severity;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column
    private String cameraId;

    @Column(length = 1024)
    private String snapshotUrl;

    // --- GEOLOCATION DATA ---

    /**
     * GPS Latitude. Nullable to allow operation in GPS-denied environments.
     */
    @Column(precision = 10, scale = 7)
    private BigDecimal latitude;

    /**
     * GPS Longitude. Nullable to allow operation in GPS-denied environments.
     */
    @Column(precision = 10, scale = 7)
    private BigDecimal longitude;

    /**
     * Human-readable address derived from Reverse Geocoding.
     * Example: "123 Main St, Springfield".
     */
    @Column(length = 500)
    private String address;

    // --- STATE ---

    @Builder.Default
    @Column(nullable = false)
    private boolean acknowledged = false;

    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;
}
</file>

<file path="alert-service/src/main/java/com/safevision/alertservice/service/AlertService.java">
package com.safevision.alertservice.service;

import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.safevision.alertservice.client.AlertPreferenceClient;
import com.safevision.alertservice.dto.AlertEventDTO;
import com.safevision.alertservice.dto.AlertResponse;
import com.safevision.alertservice.model.Alert;
import com.safevision.alertservice.repository.AlertRepository;
import com.safevision.common.enums.AlertType;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * Service layer for managing Alert business logic.
 * <p>
 * Responsibilities:
 * 1. Low-latency persistence of threats.
 * 2. Async data enrichment (Reverse Geocoding).
 * 3. Real-time WebSocket push.
 * </p>
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class AlertService {

    private final AlertRepository repository;
    private final TelephonyService telephonyService;
    private final SimpMessagingTemplate messagingTemplate;
    private final TelegramService telegramService;
    private final EmailAlertService emailService;
    private final AlertPreferenceClient preferenceClient;
    
    // üìç New Dependency for Reverse Geocoding
    private final GeocodingService geocodingService;

   
    public void createAlert(AlertEventDTO event) {
        log.info("üõ°Ô∏è Processing alert for user {} | Type {}", event.userId(), event.alertType());

        // 1. Build Initial Entity
        var alert = Alert.builder()
                .userId(event.userId())
                .alertType(event.alertType())
                .description(event.description())
                .severity(event.severity() != null ? event.severity() : "INFO")
                .cameraId(event.cameraId())
                .snapshotUrl(event.snapshotUrl())
                .latitude(event.latitude())
                .longitude(event.longitude())
                .acknowledged(false)
                .build();

        // 2. Persist Immediately
        var savedAlert = repository.save(alert);

        // 3. L√≥gica de Envio √önico (Fluxo Bifurcado)
        if (event.latitude() != null && event.longitude() != null) {
            // CASO A: Tem coordenadas -> Busca Endere√ßo -> Atualiza -> Envia
            geocodingService.getAddressFromCoordinates(event.latitude(), event.longitude())
                .thenAccept(address -> {
                    if (address != null) {
                        savedAlert.setAddress(address);
                        repository.save(savedAlert);
                        log.debug("üìç Address updated for alert {}: {}", savedAlert.getId(), address);
                    }
                    // ‚úÖ ENVIO 1 (Com endere√ßo)
                    dispatchNotifications(event, savedAlert);
                })
                .exceptionally(ex -> {
                    log.error("‚ö†Ô∏è Geocoding failed, sending alert without address.", ex);
                    // ‚úÖ ENVIO 1 (Fallback em caso de erro no Geo)
                    dispatchNotifications(event, savedAlert);
                    return null;
                });
        } else {
            // CASO B: N√£o tem coordenadas -> Envia Imediatamente
            // ‚úÖ ENVIO 1 (Sem endere√ßo)
            dispatchNotifications(event, savedAlert);
        }
    }

    /**
     * Centraliza o envio de WebSocket e Notifica√ß√µes Externas
     * para garantir que tudo ocorra no momento certo.
     */
    private void dispatchNotifications(AlertEventDTO event, Alert alertEntity) {
        // 1. Push WebSocket (Agora acontece uma √∫nica vez)
        sendWebSocket(event.userId(), alertEntity);

        // 2. Critical Notifications (SMS, Email, Telegram)
        if ("CRITICAL".equalsIgnoreCase(event.severity())) {
            Set<AlertType> preferences = getUserPreferences(event.userId());
            triggerCriticalNotifications(event, preferences);
        }
    }

    private Set<AlertType> getUserPreferences(String userId) {
        Set<AlertType> response = new HashSet<>();
        try {
            List<AlertType> types = preferenceClient.getPreferences(userId);
            if (types != null) {
                response.addAll(types);
            }
        } catch (Exception e) {
            log.error("‚ùå Failed to fetch alert preferences for user {}. Error: {}", userId, e.getMessage());
        }
        return response;
    }

    private void sendWebSocket(String userId, Alert savedAlert) {
        var response = toResponse(savedAlert);
        var topic = "/topic/alert/" + userId;
        try {
            messagingTemplate.convertAndSend(topic, response);
            log.info("üì° WebSocket pushed to {}", topic);
        } catch (Exception e) {
            log.error("‚ùå WebSocket failed: {}", e.getMessage());
        }
    }

    private void triggerCriticalNotifications(AlertEventDTO event, Set<AlertType> prefs) {
        if (prefs.contains(AlertType.SMS)) {
            telephonyService.sendCriticalSms(event);
        }
        if (prefs.contains(AlertType.TELEGRAM)) {
            telegramService.sendAlert(event);
        }
        if (prefs.contains(AlertType.EMAIL)) {
            emailService.sendHtmlAlert(event);
        }
    }

    public List<AlertResponse> getUserAlerts(String userId, boolean onlyUnread) {
        log.debug("Fetching alerts for user {} | unread={}", userId, onlyUnread);
        List<Alert> alerts = onlyUnread
                ? repository.findByUserIdAndAcknowledgedFalseOrderByCreatedAtDesc(userId)
                : repository.findByUserIdOrderByCreatedAtDesc(userId);

        return alerts.stream()
                .map(this::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional
    public boolean acknowledgeAlert(String alertId, String userId) {
        return repository.findById(alertId)
                .filter(a -> a.getUserId().equals(userId))
                .map(a -> {
                    a.setAcknowledged(true);
                    repository.save(a);
                    return true;
                })
                .orElse(false);
    }

    private AlertResponse toResponse(Alert alert) {
        return new AlertResponse(
                alert.getId(),
                alert.getAlertType(),
                alert.getDescription(),
                alert.getSeverity(),
                alert.getCameraId(),
                alert.isAcknowledged(),
                alert.getCreatedAt(),
                alert.getSnapshotUrl(),
                // üìç Include Geolocation Data in Response
                alert.getLatitude(),
                alert.getLongitude(),
                alert.getAddress()
        );
    }
    public Page<AlertResponse> getUserAlertsPaginated(String userId, int page, int size) {
        
        Pageable pageable = PageRequest.of(page, size, Sort.by("createdAt").descending());
        
        return repository.findByUserId(userId, pageable)
                .map(this::toResponse); // Convers√£o Entity -> DTO
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/dto/RegisterRequest.java">
package com.safevision.authservice.dto;

import java.util.Set;

/**
 * Data Transfer Object (DTO) for User Registration.
 * <p>
 * Defines the contract for the incoming JSON payload when creating a new account.
 * It leverages Java Records for immutability and concise syntax.
 * </p>
 *
 * @param username    The unique identifier for login.
 * @param password    The raw password (will be encrypted by the service).
 * @param email       The contact email for notifications and recovery.
 * @param phoneNumber The mobile number formatted for SMS alerts (Twilio, e.g., +55...).
 * @param cameraUrl   The connection string (RTSP/HTTP) for the Vision Agent.
 * @param roles       The set of permissions (e.g., "ADMIN", "USER"). Can be null (defaults to USER).
 */


import com.safevision.common.enums.AlertType;

import java.util.Set;

/**
 * RegisterRequest record - immutable DTO for registration payload.
 */
public record RegisterRequest(
    String username,
    String password,
    String email,
    String phoneNumber,
    String cameraUrl,
    Set<String> roles,
    Set<AlertType> alertTypes   // <-- agora usamos o enum
) {}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/repository/UserRepository.java">
package com.safevision.authservice.repository;

import com.safevision.authservice.model.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

/**
 * Repository interface for managing {@link User} entities.
 * <p>
 * This interface implements the **Repository Pattern**, abstracting the underlying
 * data access logic (PostgreSQL). It provides methods for authentication lookups
 * and registration validation.
 * </p>
 */
@Repository
public interface UserRepository extends JpaRepository<User, String> {

    /**
     * Finds a user by their unique username.
     * <p>
     * Critical for the {@code loadUserByUsername} method in Spring Security
     * during the login process.
     * </p>
     *
     * @param username The username to search for.
     * @return An {@link Optional} containing the user if found, or empty.
     */
    Optional<User> findByUsername(String username);

    /**
     * Finds a user by their email address.
     * Used for duplicate checks or alternative login methods.
     *
     * @param email The email address to search for.
     * @return An {@link Optional} containing the user if found.
     */
    Optional<User> findByEmail(String email);

    /**
     * efficient check to see if a username is already taken.
     * Used during the <b>Registration</b> process to fail fast.
     *
     * @param username The username to validate.
     * @return {@code true} if the user exists, {@code false} otherwise.
     */
    boolean existsByUsername(String username);

    /**
     * Efficient check to see if an email is already registered.
     * Used during the <b>Registration</b> process to ensure uniqueness.
     *
     * @param email The email to validate.
     * @return {@code true} if the email exists, {@code false} otherwise.
     */
    boolean existsByEmail(String email);
    
    boolean existsByEmailAndIdNot(String email, String id);
    
    
    boolean existsByPhoneNumberAndIdNot(String phoneNumber, String id);
}
</file>

<file path="gateway-service/src/main/java/com/safevision/gatewayservice/config/SecurityConfig.java">
package com.safevision.gatewayservice.config;

import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.oauth2.jose.jws.MacAlgorithm;
import org.springframework.security.oauth2.jwt.NimbusReactiveJwtDecoder;
import org.springframework.security.oauth2.jwt.ReactiveJwtDecoder;
import org.springframework.security.web.server.SecurityWebFilterChain;

/**
 * Security Configuration for the API Gateway (Reactive).
 * <p>
 * This class acts as the first line of defense. It validates JWT tokens
 * for all incoming requests before routing them to microservices.
 * </p>
 */
@Slf4j
@Configuration
@EnableWebFluxSecurity
@RequiredArgsConstructor
@EnableConfigurationProperties(JwtProperties.class)
public class SecurityConfig {

    private final JwtProperties jwtProperties;

    // List of public endpoints (Whitelist)
    private static final String[] PUBLIC_ENDPOINTS = {
        "/swagger-ui.html",
        "/swagger-ui/**",
        "/v3/api-docs/**",
        "/swagger-resources/**",
        "/auth/login",
        "/auth/register",
        "/alert/event", // Allow internal/machine event push
        "/alert/ws/**",
        "/actuator/**", // Health checks
        "/ws/**",
        "/alert/ws/**"
    };

    /**
     * Configures the Reactive Security Filter Chain.
     */
    @Bean
    public SecurityWebFilterChain securityWebFilterChain(ServerHttpSecurity http) {
        log.info("Initializing Reactive Security Filter Chain for Gateway...");

        http
            // Enable CORS (Cross-Origin Resource Sharing) using global config
            .cors(Customizer.withDefaults())
            
            // Disable CSRF (Stateful protection not needed for stateless REST APIs)
            .csrf(ServerHttpSecurity.CsrfSpec::disable)
            
            .authorizeExchange(exchanges -> exchanges
                // 1. Allow whitelisted endpoints
                .pathMatchers(PUBLIC_ENDPOINTS).permitAll()
                
                // 2. Require authentication for everything else
                .anyExchange().authenticated()
            )
            
            // Validate JWT Tokens (Resource Server)
            .oauth2ResourceServer(oauth2 -> oauth2.jwt(Customizer.withDefaults()));

        return http.build();
    }

    /**
     * Configures the Reactive JWT Decoder.
     * Uses the shared secret key to verify the HMAC signature of incoming tokens.
     */
    @Bean
    public ReactiveJwtDecoder jwtDecoder() {
        byte[] keyBytes = jwtProperties.secret().getBytes();
        SecretKey originalKey = new SecretKeySpec(keyBytes, 0, keyBytes.length, MacAlgorithm.HS256.getName());
        
        return NimbusReactiveJwtDecoder.withSecretKey(originalKey)
                .macAlgorithm(MacAlgorithm.HS256)
                .build();
    }
}
</file>

<file path="recognition-service/src/main/java/com/safevision/recognitionservice/RecognitionServiceApplication.java">
package com.safevision.recognitionservice;

import com.safevision.recognitionservice.config.RabbitQueueProperties;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.EnableConfigurationProperties;

/**
 * Entry point for the Recognition Service (The "Brain" of the architecture).
 * <p>
 * This microservice is responsible for:
 * <ul>
 * <li>Consuming raw tracking data from the Vision Agent (Python) via RabbitMQ.</li>
 * <li>Analyzing behavioral patterns (e.g., Persistent Stare, Loitering).</li>
 * <li>Filtering noise and producing confirmed Critical Alerts to the Alert Service.</li>
 * </ul>
 * </p>
 */
@Slf4j
@SpringBootApplication
public class RecognitionServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(RecognitionServiceApplication.class, args);
        log.info("üöÄ Recognition Service (Analysis Engine) started successfully on Java 21!");
    }
}
</file>

<file path="auth-service/pom.xml">
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="
            http://maven.apache.org/POM/4.0.0
            http://maven.apache.org/xsd/maven-4.0.0.xsd">

  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>com.safevision</groupId>
    <artifactId>safevision-modular</artifactId>
    <version>1.0.0</version>
    <relativePath>../pom.xml</relativePath>
  </parent>

  <artifactId>auth-service</artifactId>
  <packaging>jar</packaging>

 

  <dependencies>

  
    <!-- Spring Web -->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Eureka Client -->
    <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
	<dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
	</dependency>
	
	<dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-webflux</artifactId>
    </dependency>

  
       
    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-oauth2-jose</artifactId>
    </dependency>

   
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-api</artifactId>
        <version>0.12.6</version>
    </dependency>
    
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-impl</artifactId>
        <version>0.12.6</version>
        <scope>runtime</scope>
    </dependency>
    
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-jackson</artifactId>
        <version>0.12.6</version>
        <scope>runtime</scope>
    </dependency>
    <!-- Spring Data JPA -->
	<dependency>
	  <groupId>org.springframework.boot</groupId>
	  <artifactId>spring-boot-starter-data-jpa</artifactId>
	</dependency>
	
	<!-- PostgreSQL driver -->
	<dependency>
	  <groupId>org.postgresql</groupId>
	  <artifactId>postgresql</artifactId>
	 
	</dependency>
	
	<!-- Springdoc OpenAPI -->
	<dependency>
	  <groupId>org.springdoc</groupId>
	  <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
	  <version>2.1.0</version>
	</dependency>
	<dependency>
	    <groupId>org.springframework.boot</groupId>
	    <artifactId>spring-boot-starter-security</artifactId>
	</dependency>
	
	<dependency>
	    <groupId>org.springframework.boot</groupId>
	    <artifactId>spring-boot-starter-amqp</artifactId>
	</dependency>
	
	<dependency>
	    <groupId>com.safevision.common</groupId>
	    <artifactId>common</artifactId>
    	<version>1.0.0</version>
	</dependency>

  </dependencies>
  
  
	
	
  <build>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
      </plugin>
     
    </plugins>
  </build>

</project>
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/controller/AuthController.java">
package com.safevision.authservice.controller;

import com.safevision.authservice.dto.*;
import com.safevision.authservice.service.AuthenticationService;
import com.safevision.common.enums.AlertType;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

import java.util.List;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

/**
 * REST Controller for handling Authentication and User Management.
 * Exposed via API Gateway under /auth path.
 */
@Slf4j
@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class AuthController {

    private final AuthenticationService authenticationService;

    /**
     * Registers a new user in the system.
     *
     * @param request The registration details (username, password, contacts).
     * @return The created user details (excluding password).
     */
    @PostMapping("/register")
    public ResponseEntity<UserResponse> register(@RequestBody RegisterRequest request) {
        log.info("Registering new user: {}", request.username());
        return ResponseEntity.ok(authenticationService.register(request));
    }

    /**
     * Authenticates a user and returns a JWT Token.
     *
     * @param request The login credentials.
     * @return A JWT token if successful.
     */
    @PostMapping("/login")
    public ResponseEntity<TokenResponse> login(@RequestBody LoginRequest request) {
        log.debug("Login attempt for user: {}", request.username());
        return ResponseEntity.ok(authenticationService.login(request));
    }
    
    /**
     * Internal endpoint used by Alert Service to fetch user contact info for notifications.
     *
     * @param username The username to look up.
     * @return Contact details (phone, email).
     */
    @GetMapping("/contact/{username}")
    public ResponseEntity<UserContactDTO> getUserContact(@PathVariable String username) {
        return ResponseEntity.ok(authenticationService.getUserContact(username));
    }

    /**
     * Updates the authenticated user's profile (e.g., camera URL, phone number).
     *
     * @param request        The fields to update.
     * @param authentication The security context (current user).
     * @return The updated user details.
     */
    @PutMapping("/update")
    public ResponseEntity<UserResponse> updateUser(
            @RequestBody UserUpdateRequest request, 
            Authentication authentication) {
        
        String currentUsername = authentication.getName();
        log.info("Updating profile for user: {}", currentUsername);
        
        return ResponseEntity.ok(
            authenticationService.updateUser(currentUsername, request)
        );
    }

    /**
     * Simple endpoint to validate if a Token is active.
     */
    @GetMapping("/validate")
    public ResponseEntity<String> validateToken() {
        return ResponseEntity.ok("Token is valid");
    }
    @GetMapping("/camera-url")
    public ResponseEntity<Map<String, String>> getCameraUrl(Authentication authentication) {
        // O Spring injeta o usu√°rio logado automaticamente no objeto 'authentication'
        String username = authentication.getName();
        
        String url = authenticationService.getUserCameraUrl(username);
        
        // Retorna um JSON simples: { "cameraUrl": "http://..." }
        return ResponseEntity.ok(Map.of("cameraUrl", url != null ? url : ""));
    }
    
    
    @GetMapping("/profile/{username}")
    public ResponseEntity<UserProfileDTO> getUserProfile(@PathVariable String username) {
        return ResponseEntity.ok(authenticationService.getUserProfile(username));
    }
    
 
    @GetMapping("/alert-preferences/{username}")
    public ResponseEntity<List<AlertType>> getPreferences(@PathVariable String username) {
        return ResponseEntity.ok(authenticationService.getAlertPreferences(username));
    }
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/model/User.java">
package com.safevision.authservice.model;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.CreationTimestamp;

import java.time.LocalDateTime;
import java.util.Collection;
import java.util.HashSet;
import java.util.Set;

/**
 * JPA Entity representing a Registered User.
 * <p>
 * This class maps to the 'users' table and holds authentication credentials,
 * contact information for alerts, and configuration for external devices (Vision Agent).
 * </p>
 */
@Entity
@Table(name = "users")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class User {

    // ========================================================================
    // IDENTITY
    // ========================================================================

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(length = 36, updatable = false, nullable = false)
    private String id;

    // ========================================================================
    // AUTHENTICATION CREDENTIALS
    // ========================================================================

    @Column(nullable = false, unique = true)
    private String username;

    @Column(nullable = false)
    private String password;

    // ========================================================================
    // CONTACT INFORMATION (For Alerts/Notifications)
    // ========================================================================

    @Column(unique = true)
    private String email;

    /**
     * Mobile number formatted for SMS providers (e.g., Twilio E.164 format).
     */
    @Column(name = "phone_number")
    private String phoneNumber;

    // ========================================================================
    // DEVICE CONFIGURATION (Vision Agent)
    // ========================================================================

    /**
     * The RTSP or HTTP URL of the camera stream associated with this user.
     * Used by the Vision Agent to capture video.
     */
    @Column(name = "camera_connection_url")
    private String cameraConnectionUrl;

    /**
     * A friendly name for the user's device (e.g., "Body Cam 01").
     */
    @Column(name = "device_name")
    private String deviceName;

    // ========================================================================
    // SECURITY & ROLES
    // ========================================================================

    /**
     * Roles assigned to the user (e.g., "USER", "ADMIN").
     * Fetched EAGERly to ensure Spring Security has permissions available during the login context.
     */
    @ElementCollection(fetch = FetchType.EAGER)
    @CollectionTable(name = "user_roles", joinColumns = @JoinColumn(name = "user_id"))
    @Column(name = "role")
    @Builder.Default
    private Set<String> roles = new HashSet<>();

    // ========================================================================
    // AUDIT
    // ========================================================================

    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    
    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true, fetch = FetchType.EAGER)
    @Builder.Default
    private Set<AlertPreference> alertPreferences = new HashSet<>();

	
}
</file>

<file path="auth-service/src/main/java/com/safevision/authservice/service/UserService.java">
package com.safevision.authservice.service;

import com.safevision.authservice.dto.RegisterRequest;
import com.safevision.authservice.model.AlertPreference;
import com.safevision.authservice.model.User;
import com.safevision.authservice.repository.AlertPreferenceRepository;
import com.safevision.authservice.repository.UserRepository;
import com.safevision.common.enums.AlertType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.HashSet;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
/**
 * Core service for User Management.
 * Implements Spring Security's UserDetailsService for authentication.
 * Handles CRUD operations and triggers configuration updates via RabbitMQ.
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class UserService implements UserDetailsService {

    private final UserRepository repository;
    private final PasswordEncoder passwordEncoder;
    private final AlertPreferenceRepository alertPreferenceRepository;

    

    /**
     * Creates a new user after validating uniqueness.
     */
    
	 public User createUser(RegisterRequest request) {
	        log.debug("Attempting to create user: {}", request.username());
	
	        if (repository.existsByUsername(request.username())) {
	            throw new RuntimeException("Usuario ja cadastrado.");
	        }
	        if (request.email() != null && repository.existsByEmail(request.email())) {
	            throw new RuntimeException("Email ja cadastrado");
	        }
	
	        var user = User.builder()
	                .username(request.username())
	                .password(passwordEncoder.encode(request.password()))
	                .email(request.email())
	                .phoneNumber(request.phoneNumber())
	                .cameraConnectionUrl(request.cameraUrl())
	                .roles(request.roles() != null ? request.roles() : Set.of("USER"))
	                .build();
	
	        var savedUser = repository.save(user);
	
	        // Persist alert preferences
	        Set<AlertType> selectedTypes = request.alertTypes() == null || request.alertTypes().isEmpty()
	                ? new HashSet<>()
	                : request.alertTypes();
	
	        for (AlertType t : selectedTypes) {
	            var pref = AlertPreference.builder()
	                    .user(savedUser)
	                    .alertType(t)
	                    .build();
	            alertPreferenceRepository.save(pref);
	        }
	
	        log.info("User {} created with {} alert preferences", savedUser.getUsername(), selectedTypes.size());
	
	        
	
	        return savedUser;
	    }


    /**
     * Loads user by username (Spring Security contract).
     */
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        var user = getUserByUsername(username);
        
        // Convert Set<String> roles to String[] for Spring Security
        String[] roles = user.getRoles().toArray(new String[0]);

        return org.springframework.security.core.userdetails.User
                .withUsername(user.getUsername())
                .password(user.getPassword())
                .roles(roles)
                .build();
    }

    

    public Optional<User> getUser(String id) {
        return repository.findById(id);
    }

    /**
     * Updates an existing user profile.
     * Triggers a RabbitMQ event if the camera URL changes.
     */
    public User updateUser(User updatedData) {
        var existingUser = repository.findById(updatedData.getId())
                .orElseThrow(() -> new RuntimeException("User not found for update"));

       

        // Partial Update Logic
        if (updatedData.getUsername() != null) existingUser.setUsername(updatedData.getUsername());
        if (updatedData.getEmail() != null) existingUser.setEmail(updatedData.getEmail());
        if (updatedData.getPhoneNumber() != null) existingUser.setPhoneNumber(updatedData.getPhoneNumber());

        // Check for Camera URL change
        if (updatedData.getCameraConnectionUrl() != null) {
            String oldUrl = existingUser.getCameraConnectionUrl();
            String newUrl = updatedData.getCameraConnectionUrl();
            
            if (!newUrl.equals(oldUrl)) 
                existingUser.setCameraConnectionUrl(newUrl);
                
        }

        // Update password if provided
       
        var savedUser = repository.save(existingUser);

       

        return savedUser;
    }

    public void deleteUser(String id) {
        repository.deleteById(id);
    }
    
    public User getUserByUsername(String username) {
        return repository.findByUsername(username)
                .orElseThrow(() -> new UsernameNotFoundException("User not found: " + username));
    }

    /**
     * Valida integridade e persiste as altera√ß√µes.
     * N√ÉO realiza criptografia de senha (responsabilidade do Auth Service).
     */
    public User saveUser(User userToSave) {
        // Valida√ß√£o de Integridade 1: E-mail √önico
        // Verifica se o email existe em ALGUM registro cujo ID N√ÉO SEJA o meu
        if (userToSave.getEmail() != null) {
            boolean emailTaken = repository.existsByEmailAndIdNot(userToSave.getEmail(), userToSave.getId());
            if (emailTaken) {
                throw new IllegalArgumentException("Este e-mail j√° est√° em uso por outro usu√°rio.");
            }
        }

        // Valida√ß√£o de Integridade 2: Telefone √önico (Opcional, mas recomendado)
        if (userToSave.getPhoneNumber() != null) {
            boolean phoneTaken = repository.existsByPhoneNumberAndIdNot(userToSave.getPhoneNumber(), userToSave.getId());
            if (phoneTaken) {
                throw new IllegalArgumentException("Este telefone j√° est√° em uso por outro usu√°rio.");
            }
        }

        // Salvamento Limpo
        // O JPA detecta que o ID existe e faz um UPDATE
        return repository.save(userToSave);
    }

   
}
</file>

<file path="auth-service/src/main/resources/application.yml">
server:
  port: 8080

spring:
  application:
    name: auth-service

  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/safevision}
    username: ${SPRING_DATASOURCE_USERNAME:user}
    password: ${SPRING_DATASOURCE_PASSWORD:pass}
    driver-class-name: org.postgresql.Driver
    
    # --- CORRE√á√ÉO PRINCIPAL: TUNING DO POOL DE CONEX√ïES (HikariCP) ---
    hikari:
      # Mant√©m 5 conex√µes abertas e prontas, mesmo sem ningu√©m usar.
      # Isso elimina o tempo de espera no primeiro login.
      minimum-idle: 5
      
      # M√°ximo de conex√µes simult√¢neas (evita travar o banco).
      maximum-pool-size: 20
      
      # Tempo (ms) que a aplica√ß√£o espera por uma conex√£o livre antes de dar erro.
      # 30000ms = 30 segundos (Aumentamos a paci√™ncia do servi√ßo).
      connection-timeout: 30000
      
      # Tempo m√°ximo de vida de uma conex√£o (30 min). Evita conex√µes "velhas" e quebradas.
      max-lifetime: 1800000
      
      # Tempo que uma conex√£o pode ficar parada antes de ser reciclada.
      idle-timeout: 300000

  jpa:
    # Fecha a conex√£o com o banco assim que o Service termina (libera mais r√°pido).
    open-in-view: false
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        # (Opcional) Melhora performance de inserts em lote
        jdbc:
          batch_size: 50

management:
  endpoints:
    web:
      exposure:
        include: "health,info,prometheus"
  tracing:
    sampling:
      probability: 1.0
  zipkin:
    tracing:
      endpoint: "http://zipkin:9411/api/v2/spans"

eureka:
  client:
    serviceUrl:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true

safevision:
  jwt:
    secret: ${SAFEVISION_JWT_SECRET:segredo_padrao_apenas_para_desenvolvimento_local_sem_docker}
    expiration-ms: 86400000

logging:
  file:
    name: /var/logs/${spring.application.name}.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 7
  level:
    root: INFO
    org.springframework.security: DEBUG
    com.safevision: DEBUG
    # Debug para ver se o pool de conex√µes est√° funcionando
    com.zaxxer.hikari: INFO
</file>

<file path="docker-compose.yml">
version: '3.8'

# ==============================================================================
# ‚öì ANCORAS DE CONFIGURA√á√ÉO
# ==============================================================================
x-common-env: &common-env
  SAFEVISION_JWT_SECRET: "${JWT_SECRET}"
  TZ: "America/Sao_Paulo"

# ‚òï Otimiza√ß√£o JAVA (Baixo consumo de RAM/CPU)
x-java-opts: &java-opts
  JAVA_TOOL_OPTIONS: >
    -Djava.security.egd=file:/dev/./urandom
    -XX:+UseSerialGC
    -Xss512k
    -XX:TieredStopAtLevel=1

# üêç Otimiza√ß√£o PYTHON (Single Thread)
x-python-opts: &python-opts
  PYTHONUNBUFFERED: "1"
  OMP_NUM_THREADS: "1"
  MKL_NUM_THREADS: "1"
  OPENBLAS_NUM_THREADS: "1"
  MALLOC_ARENA_MAX: "2"

services:
  # ============================================================================
  # INFRAESTRUTURA
  # ============================================================================

  zipkin:
    image: openzipkin/zipkin
    container_name: zipkin
    restart: always
    ports:
      - "9411:9411"
    environment:
      <<: *common-env
    networks:
      - safevision-net

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      <<: *common-env
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - safevision-net

  postgres:
    image: postgres:16
    container_name: postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      <<: *common-env
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - safevision-net

  minio:
    image: minio/minio
    container_name: minio
    restart: always
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      <<: *common-env
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_EXTERNAL_PREFIX: ${MINIO_EXTERNAL_PREFIX}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 15s
    networks:
      - safevision-net

  eureka-server:
    build: ./eureka-server
    container_name: eureka-server
    restart: on-failure
    ports:
      - "8761:8761"
    environment:
      <<: [*common-env, *java-opts]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - safevision-net

  # ============================================================================
  # CORE DO SISTEMA
  # ============================================================================

  vision-agent:
    build: ./vision-agent
    container_name: vision-agent
    restart: on-failure
    # ‚ö†Ô∏è CONFIGURA√á√ÉO CR√çTICA PARA GPS ‚ö†Ô∏è
    # Permite acesso ao hardware USB do Host
    privileged: true 
    devices:
      # Mapeia a porta serial do Host para o Container
      # Formato: "/caminho/no/host:/caminho/no/container"
      # Se estiver no Windows ou sem GPS, COMENTE a linha abaixo para n√£o dar erro
      - "/dev/ttyUSB0:/dev/ttyUSB0" 
    ports:
      - "5000:5000"
    environment:
      <<: [*common-env, *python-opts]
      # Configura√ß√£o do GPS para o script Python
      GPS_SERIAL_PORT: "/dev/ttyUSB0"
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASS}
      VISION_QUEUE_NAME: ${QUEUE_RAW}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: ${MINIO_BUCKET_NAME}
      MINIO_EXTERNAL_PREFIX: ${MINIO_EXTERNAL_PREFIX}
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - safevision-net

  auth-service:
    build: ./auth-service
    container_name: auth-service
    restart: on-failure
    ports:
      - "8081:8080"
    volumes:
      - ./logs:/var/logs
    environment:
      <<: [*common-env, *java-opts]
      SPRING_APPLICATION_NAME: auth-service
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASS}
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      zipkin:
        condition: service_started
    networks:
      - safevision-net

  alert-service:
    build: ./alert-service
    container_name: alert-service
    restart: on-failure
    ports:
      - "8082:8080"
    volumes:
      - ./logs:/var/logs
    environment:
      <<: [*common-env, *java-opts]
      SPRING_APPLICATION_NAME: alert-service
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASS}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASS}
      ALERTS_QUEUE_NAME: ${QUEUE_ALERTS}
      TELEPHONY_ACCOUNT_SID: ${TWILIO_SID}
      TELEPHONY_AUTH_TOKEN: ${TWILIO_TOKEN}
      TELEPHONY_FROM_NUMBER: ${TWILIO_FROM_NUMBER}
      TELEGRAM_ENABLED: "true"
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
      APP_EMAIL_ENABLED: "true"
      APP_EMAIL_ADMIN_ADDRESS: ${ADRESS_PROVIDER_EMAIL}
      SPRING_MAIL_HOST: smtp.gmail.com
      SPRING_MAIL_PORT: 587
      SPRING_MAIL_USERNAME: ${ADRESS_PROVIDER_EMAIL}
      SPRING_MAIL_PASSWORD: ${EMAIL_PASSWORD}
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: "true"
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      zipkin:
        condition: service_started
    networks:
      - safevision-net

  recognition-service:
    build: ./recognition-service
    container_name: recognition-service
    restart: on-failure
    ports:
      - "8083:8080"
    volumes:
      - ./logs:/var/logs
    environment:
      <<: [*common-env, *java-opts]
      SPRING_APPLICATION_NAME: recognition-service
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASS}
      VISION_QUEUE_NAME: ${QUEUE_RAW}
      ALERTS_QUEUE_NAME: ${QUEUE_ALERTS}
    depends_on:
      eureka-server:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      zipkin:
        condition: service_started
    networks:
      - safevision-net

  gateway-service:
    build: ./gateway-service
    container_name: gateway-service
    restart: on-failure
    ports:
      - "8080:8080"
    volumes:
      - ./logs:/var/logs
    environment:
      <<: [*common-env, *java-opts]
      SPRING_APPLICATION_NAME: gateway-service
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      SAFEVISION_SERVICES_AUTH: lb://auth-service
      SAFEVISION_SERVICES_ALERT: lb://alert-service
      SAFEVISION_SERVICES_RECOGNITION: lb://recognition-service
    depends_on:
      eureka-server:
        condition: service_healthy
      auth-service:
        condition: service_started
      alert-service:
        condition: service_started
      recognition-service:
        condition: service_started
      zipkin:
        condition: service_started
    networks:
      - safevision-net

volumes:
  postgres_data:
  minio_data:

networks:
  safevision-net:
    driver: bridge
</file>

<file path="vision-agent/main.py">
import cv2
import time
import json
import threading
import uuid
import queue
import numpy as np
from flask import Flask, Response, request, jsonify
from flask_cors import CORS

# Local Modules
import config
from messaging import RabbitMQClient
from detectors.weapon_detector import WeaponDetector
from detectors.gaze_detector import GazeDetector
from storage import MinioClient
from services.gps_service import GPSService 

app = Flask(__name__)
# Configura√ß√£o CORS permissiva
CORS(app, resources={r"/*": {"origins": "*"}})

# ==============================================================================
# UI CONFIGURATION
# ==============================================================================
COLOR_BRAND_ROSE = (132, 51, 214) 
COLOR_DANGER_RED = (82, 82, 255)
COLOR_NEON_GREY = (128, 128, 128)
COLOR_TEXT_WHITE = (255, 255, 255)

# ==============================================================================
# ASYNC MESSAGING
# ==============================================================================
alert_queue = queue.Queue()

def async_alert_worker():
    print("‚ö° [System] Starting Async Messaging Worker...")
    try:
        rabbit_client = RabbitMQClient()
    except Exception as e:
        print(f"‚ùå [System] Fatal RabbitMQ Connection Error: {e}")
        return

    while True:
        try:
            payload = alert_queue.get()
            rabbit_client.send_event(payload)
            alert_queue.task_done()
        except Exception as e:
            print(f"‚ùå [Worker] Error processing message: {e}")

threading.Thread(target=async_alert_worker, daemon=True).start()

# ==============================================================================
# GPS SERVICE INITIALIZATION (HTTP MODE)
# ==============================================================================
gps_service = GPSService() 
gps_service.start()

# ==============================================================================
# THREADED CAMERA CAPTURE
# ==============================================================================
class ThreadedCamera:
    def __init__(self, src):
        self.src = src
        self.capture = None
        self.status = False
        self.frame = None
        self.stopped = False
        self.lock = threading.Lock()
        
        try:
            self.capture = cv2.VideoCapture(src)
            # Buffer size 1 √© crucial para evitar delay acumulado
            self.capture.set(cv2.CAP_PROP_BUFFERSIZE, 1)
            self.status, self.frame = self.capture.read()
        except Exception as e:
            print(f"‚ö†Ô∏è Erro ao conectar na c√¢mera {src}: {e}")

    def start(self):
        t = threading.Thread(target=self.update, args=(), daemon=True)
        t.start()
        return self

    def update(self):
        while not self.stopped:
            if not self.capture or not self.capture.isOpened():
                time.sleep(1.0)
                continue
            
            # L√™ o frame mais recente
            status, frame = self.capture.read()
            
            with self.lock:
                if status:
                    self.status = status
                    self.frame = frame
                else:
                    self.status = False
            
            time.sleep(0.005)

    def read(self):
        with self.lock:
            return self.status, self.frame.copy() if self.frame is not None else None

    def stop(self):
        self.stopped = True
        if self.capture:
            self.capture.release()

# ==============================================================================
# USER SESSION CONTEXT
# ==============================================================================
def create_placeholder_frame(text="AGUARDANDO..."):
    img = np.zeros((480, 640, 3), dtype=np.uint8)
    img[:] = (30, 30, 30)
    font = cv2.FONT_HERSHEY_SIMPLEX
    text_size = cv2.getTextSize(text, font, 0.8, 1)[0]
    text_x = (640 - text_size[0]) // 2
    text_y = (480 + text_size[1]) // 2
    cv2.putText(img, text, (text_x, text_y), font, 0.8, (200, 200, 200), 1, cv2.LINE_AA)
    
    ts = time.strftime("%H:%M:%S")
    cv2.putText(img, ts, (10, 470), font, 0.5, (100, 255, 100), 1)

    ret, buffer = cv2.imencode('.jpg', img)
    return buffer.tobytes()

active_sessions = {}
sessions_lock = threading.Lock()

class UserSessionContext:
    def __init__(self, user_id, camera_url):
        self.user_id = user_id
        self.camera_url = camera_url
        self.lock = threading.Lock()
        self.is_armed = True 
        self.current_frame = create_placeholder_frame("INICIANDO...")
        self.is_active = True 
        
        print(f"üîß Carregando IA para {user_id}...")
        self.weapon_detector = WeaponDetector()
        self.gaze_detector = GazeDetector()
        
        self.snapshot_taken = False
        self.is_uploading = False
        
        self.last_threat_time = 0
        self.last_weapon_data = {'hasWeapon': False, 'weaponType': 'NONE', 'weaponLocation': 'NONE'}
        self.last_gaze_data = {'facing': False, 'direction': 'unknown', 'depth_score': 0}
        self.last_tracking_alert = 0
        
        # ‚úÖ CORRE√á√ÉO CR√çTICA: ID Persistente
        # Usamos este ID para toda a sess√£o, permitindo que o Java conte o tempo de olhar.
        self.current_tracking_id = str(uuid.uuid4())

    def update_frame(self, frame_bytes):
        with self.lock:
            self.current_frame = frame_bytes

    def get_frame(self):
        with self.lock:
            return self.current_frame
    
    def set_armed(self, armed: bool):
        with self.lock:
            self.is_armed = armed

    def stop(self):
        self.is_active = False

# ==============================================================================
# SURVEILLANCE LOGIC (MAIN CONSUMER)
# ==============================================================================
class SurveillanceThread(threading.Thread):
    def __init__(self, context):
        super().__init__()
        self.context = context
        self.daemon = True
        self.minio_client = MinioClient()
        
        # OTIMIZA√á√ÉO: 0.5s para equilibrar performance e detec√ß√£o
        self.ai_interval = 0.5 
        self.last_ai_time = 0
        self.EVENT_RESET_TIMEOUT = 5.0

    def run(self):
        print(f"üöÄ [Thread {self.context.user_id}] Conectando na c√¢mera: {self.context.camera_url}")
        
        camera_stream = ThreadedCamera(self.context.camera_url).start()
        time.sleep(1.0) 

        while self.context.is_active:
            success, frame = camera_stream.read()
            
            if not success or frame is None:
                self.context.update_frame(create_placeholder_frame("SEM SINAL"))
                time.sleep(0.5)
                continue

            try:
                # Resize (480p)
                h, w = frame.shape[:2]
                target_w = 480 
                if w != target_w:
                    scale = target_w / w
                    new_h = int(h * scale)
                    frame = cv2.resize(frame, (target_w, new_h))
                
                frame = frame[:, :-2] # Trim borders
                clean_frame = frame.copy()

                # IA Scheduling
                now = time.time()
                should_run_ai = (now - self.last_ai_time) > self.ai_interval

                if self.context.is_armed and should_run_ai:
                    self.last_ai_time = now
                    rgb_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                    
                    self.context.last_weapon_data = self.context.weapon_detector.process(frame, rgb_frame)
                    # Gaze roda sempre que a IA roda
                    self.context.last_gaze_data = self.context.gaze_detector.process(frame, rgb_frame)
                    
                    threading.Thread(target=self.check_threats, args=(clean_frame,)).start()
                    
                self.draw_overlay(frame)
                
                # Compress√£o JPEG Quality 50
                ret, buffer = cv2.imencode('.jpg', frame, [int(cv2.IMWRITE_JPEG_QUALITY), 50])
                if ret:
                    self.context.update_frame(buffer.tobytes())
                
                time.sleep(0.01)

            except Exception as e:
                print(f"‚ùå [Thread] Error: {e}")
                time.sleep(0.1)

        camera_stream.stop()
        print(f"üõë Thread finished for {self.context.user_id}")

    def check_threats(self, clean_frame):
        try:
            weapon = self.context.last_weapon_data
            gaze = self.context.last_gaze_data
            is_threat = weapon['hasWeapon'] or gaze['facing']

            if is_threat:
                self.context.last_threat_time = time.time()
                snapshot_url = None
                
                if not self.context.snapshot_taken and not self.context.is_uploading:
                    self.context.is_uploading = True 
                    print(f"üì∏ Threat Detected! Uploading Snapshot...")
                    filename = f"{self.context.user_id}_{int(time.time())}_{uuid.uuid4().hex[:6]}.jpg"
                    snapshot_url = self.minio_client.upload_frame(clean_frame, filename)
                    self.context.snapshot_taken = True
                    self.context.is_uploading = False 
                    
                self.queue_alert(weapon, gaze, snapshot_url)

            else:
                if self.context.snapshot_taken:
                    if (time.time() - self.context.last_threat_time) > self.EVENT_RESET_TIMEOUT:
                        self.context.snapshot_taken = False
                
                # Envia tracking mesmo sem amea√ßa expl√≠cita (para loitering)
                if gaze['depth_score'] > 0:
                     now = time.time()
                     if (now - self.context.last_tracking_alert) > 1.0:
                        self.queue_alert(weapon, gaze, None)
                        self.context.last_tracking_alert = now

        except Exception as e:
            print(f"Error in check_threats: {e}")
            self.context.is_uploading = False

    def queue_alert(self, weapon, gaze, snapshot_url):
        try:
            # üìç Busca coordenadas (com Mock ou Real)
            lat, lon = gps_service.get_coordinates()

            payload = {
                # ‚úÖ CORRE√á√ÉO: Usa o ID persistente da sess√£o
                "detectionId": self.context.current_tracking_id,
                
                "timestamp": int(time.time()),
                "isFacingCamera": gaze['facing'],
                "depthPosition": gaze.get('depth_score', 0),
                "gazeDirection": gaze['direction'],
                "cameraId": "VISION-AGENT",
                "userId": self.context.user_id,
                "hasWeapon": weapon['hasWeapon'],
                "weaponType": weapon['weaponType'],
                "weaponLocation": weapon['weaponLocation'],
                "snapshotUrl": snapshot_url,
                "latitude": lat,
                "longitude": lon
            }
            alert_queue.put(payload)
        except Exception as e:
            print(f"Error enqueueing alert: {e}")

    def draw_overlay(self, frame):
        img_h, img_w = frame.shape[:2]
        
        if not self.context.is_armed:
            bg_color = COLOR_NEON_GREY
            status_text = f"SISTEMA EM STANDBY"
        else:
            weapon = self.context.last_weapon_data
            gaze = self.context.last_gaze_data
            
            if weapon['hasWeapon']:
                bg_color = COLOR_DANGER_RED
                status_text = f" [!] AMEACA: {weapon['weaponType']}"
            elif gaze['facing']:
                bg_color = COLOR_DANGER_RED
                status_text = f"DETECCAO FACIAL"
            else:
                bg_color = COLOR_BRAND_ROSE
                status_text = f"MONITORANDO...."
        
        cv2.rectangle(frame, (0, 0), (img_w + 10, 35), bg_color, -1)
        cv2.line(frame, (0, 35), (img_w + 10, 35), (255, 255, 255), 1)
        font = cv2.FONT_HERSHEY_SIMPLEX
        cv2.putText(frame, status_text, (10, 25), font, 0.6, COLOR_TEXT_WHITE, 1, cv2.LINE_AA)

# ==============================================================================
# FLASK ROUTES
# ==============================================================================
@app.route('/toggle/on', methods=['POST'])
def turn_on():
    try:
        data = request.get_json()
        user_id = data.get('userId')
        camera_url = data.get('cameraUrl')
        
        if not user_id: return jsonify({"error": "userId required"}), 400

        if camera_url:
            gps_service.set_target_from_camera_url(camera_url)

        with sessions_lock:
            if user_id in active_sessions:
                active_sessions[user_id]['context'].set_armed(True)
                if camera_url and camera_url != active_sessions[user_id]['context'].camera_url:
                    active_sessions[user_id]['context'].stop()
                    time.sleep(0.5)
                    del active_sessions[user_id]
                else:
                    return jsonify({"status": "active", "userId": user_id})

            if user_id not in active_sessions:
                if not camera_url: return jsonify({"error": "cameraUrl required"}), 400
                ctx = UserSessionContext(user_id, camera_url)
                t = SurveillanceThread(ctx)
                t.start()
                active_sessions[user_id] = {"context": ctx, "thread": t}
                return jsonify({"status": "created", "userId": user_id})
                
        return jsonify({"status": "error"}), 500

    except Exception as e:
        print(f"‚ùå Error turning on: {e}")
        return jsonify({"error": str(e)}), 500

@app.route('/toggle/off', methods=['POST'])
def turn_off():
    try:
        data = request.get_json()
        user_id = data.get('userId')
        if not user_id: return jsonify({"error": "userId required"}), 400

        with sessions_lock:
            if user_id in active_sessions:
                active_sessions[user_id]['context'].stop()
                del active_sessions[user_id]
                return jsonify({"status": "stopped", "userId": user_id})
            else:
                return jsonify({"status": "already_stopped", "userId": user_id})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

def gen_frames(user_id):
    while True:
        session = None
        with sessions_lock:
            session = active_sessions.get(user_id)
        
        if not session:
            yield (b'--frame\r\n' b'Content-Type: image/jpeg\r\n\r\n' + create_placeholder_frame("OFFLINE") + b'\r\n')
            time.sleep(1)
        else:
            frame = session['context'].get_frame()
            if frame:
                yield (b'--frame\r\n' b'Content-Type: image/jpeg\r\n\r\n' + frame + b'\r\n')
            time.sleep(0.04)

@app.route('/video_feed/<user_id>')
def video_feed(user_id):
    return Response(gen_frames(user_id), mimetype='multipart/x-mixed-replace; boundary=frame')

@app.route('/health')
def health():
    lat, lon = gps_service.get_coordinates()
    gps_active = lat != 0.0
    return jsonify({
        "status": "ok", 
        "sessions": len(active_sessions), 
        "gps_active": gps_active,
        "gps_data": {"lat": lat, "lon": lon}
    })

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)
</file>

</files>
