server:
  port: 8080

spring:
  application:
    name: gateway-service
  
  cloud:
    gateway:
      discovery:
        locator:
          enabled: false 
          lower-case-service-id: true
      
      # Timeout da conexÃ£o HTTP
      httpclient:
        connect-timeout: 5000
        response-timeout: 20000 

      # --- FILTROS PADRÃƒO (Aplicados a todas as rotas) ---
      default-filters:
        # ðŸ‘‡ 1. LIMPEZA DE CORS DUPLICADO (Novo)
        # Remove cabeÃ§alhos duplicados vindos dos microsserviÃ§os para evitar conflito com sua classe Java
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST
        
        # ðŸ‘‡ 2. RETRY (Ajustado)
        - name: Retry
          args:
            retries: 3
            # Sem NOT_FOUND para login rÃ¡pido
            statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,INTERNAL_SERVER_ERROR,SERVICE_UNAVAILABLE
            methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
            backoff:
              firstBackoff: 500ms 
              maxBackoff: 2000ms
              factor: 2
              basedOnPreviousValue: false

      routes:
        # --- AUTH SERVICE ---
        - id: auth-service-swagger
          uri: ${safevision.services.auth}
          predicates:
            - Path=/aggregate/auth-service/v3/api-docs
          filters:
            - RewritePath=/aggregate/auth-service/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback

        - id: auth-service
          uri: ${safevision.services.auth}
          predicates:
            - Path=/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback

        # --- ALERT SERVICE ---
        - id: alert-websocket
          uri: ${safevision.services.alert}
          predicates:
            - Path=/alert/ws/**
          filters:
            - RewritePath=/alert/ws/(?<segment>.*), /ws/${segment}
            - SaveSession
            # Headers essenciais para o Handshake WebSocket passar pelo Gateway
            - SetRequestHeader=Upgrade, websocket
            - SetRequestHeader=Connection, Upgrade

        - id: alert-service-swagger
          uri: ${safevision.services.alert}
          predicates:
            - Path=/aggregate/alert-service/v3/api-docs
          filters:
            - RewritePath=/aggregate/alert-service/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: alertServiceCircuitBreaker
                fallbackUri: forward:/fallback

        - id: alert-service
          uri: ${safevision.services.alert}
          predicates:
            - Path=/alert/**
          filters:
            - name: CircuitBreaker
              args:
                name: alertServiceCircuitBreaker
                fallbackUri: forward:/fallback

        # --- RECOGNITION SERVICE ---
        - id: recognition-service-swagger
          uri: ${safevision.services.recognition}
          predicates:
            - Path=/aggregate/recognition-service/v3/api-docs
          filters:
            - RewritePath=/aggregate/recognition-service/(?<segment>.*), /${segment}
            - name: CircuitBreaker
              args:
                name: recognitionServiceCircuitBreaker
                fallbackUri: forward:/fallback

        - id: recognition-service
          uri: ${safevision.services.recognition}
          predicates:
            - Path=/recognition/**
          filters:
            - name: CircuitBreaker
              args:
                name: recognitionServiceCircuitBreaker
                fallbackUri: forward:/fallback

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://localhost:8761/eureka/}
    enabled: true
    register-with-eureka: true
    fetch-registry: true

safevision:
  services:
    auth: ${SAFEVISION_SERVICES_AUTH:lb://auth-service}
    alert: ${SAFEVISION_SERVICES_ALERT:lb://alert-service}
    recognition: ${SAFEVISION_SERVICES_RECOGNITION:lb://recognition-service}
  jwt:
    secret: ${SAFEVISION_JWT_SECRET:segredo_padrao_apenas_para_desenvolvimento_local_sem_docker}

resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        permittedNumberOfCallsInHalfOpenState: 3
        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.client.HttpServerErrorException
    instances:
      authServiceCircuitBreaker:
        baseConfig: default
      alertServiceCircuitBreaker:
        baseConfig: default
      recognitionServiceCircuitBreaker:
        baseConfig: default
  
  timelimiter:
    configs:
      default:
        timeoutDuration: 20s
        cancelRunningFuture: true

management:
  endpoints:
    web:
      exposure:
        include: "health,info,prometheus,metrics,gateway"
  tracing:
    sampling:
      probability: 1.0
  zipkin:
    tracing:
      endpoint: "http://zipkin:9411/api/v2/spans"

metrics:
    tags:
      application: ${spring.application.name}

logging:
  file:
    name: /var/logs/${spring.application.name}.log 
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 7
  level:
    root: INFO
    org.springframework.cloud.gateway: INFO 
    com.safevision: DEBUG